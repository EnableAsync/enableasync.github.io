<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Internlm-01-ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹å…¨é“¾è·¯å¼€æºä½“ç³»</title>
    <url>/internlm/internlm-01/</url>
    <content><![CDATA[<h1 id="ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹å…¨é“¾è·¯å¼€æºä½“ç³»"><a href="#ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹å…¨é“¾è·¯å¼€æºä½“ç³»" class="headerlink" title="ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹å…¨é“¾è·¯å¼€æºä½“ç³»"></a>ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹å…¨é“¾è·¯å¼€æºä½“ç³»</h1><h2 id="å¤§æ¨¡å‹æ¦‚è¿°"><a href="#å¤§æ¨¡å‹æ¦‚è¿°" class="headerlink" title="å¤§æ¨¡å‹æ¦‚è¿°"></a>å¤§æ¨¡å‹æ¦‚è¿°</h2><h3 id="å¤§æ¨¡å‹æˆä¸ºäº†çƒ­é—¨å…³é”®è¯"><a href="#å¤§æ¨¡å‹æˆä¸ºäº†çƒ­é—¨å…³é”®è¯" class="headerlink" title="å¤§æ¨¡å‹æˆä¸ºäº†çƒ­é—¨å…³é”®è¯"></a>å¤§æ¨¡å‹æˆä¸ºäº†çƒ­é—¨å…³é”®è¯</h3><p>å¤§æ¨¡å‹æˆä¸ºå‘å±•é€šç”¨äººå·¥æ™ºèƒ½çš„é‡è¦é€”ç»ï¼Œå›¾ä¸­å±•ç¤ºäº†å¤§æ¨¡å‹çš„çƒ­åº¦å¢é•¿å’Œ OpenAI GPT ç³»åˆ—çš„è¿­ä»£è¿‡ç¨‹ã€‚</p>
<p><img  src="image.png"  ><span class="image-caption">å¤§æ¨¡å‹æˆä¸ºçƒ­é—¨å…³é”®è¯</span></p>
<h3 id="å¤§æ¨¡å‹æˆä¸ºäº†å‘å±•é€šç”¨äººå·¥æ™ºèƒ½çš„é‡è¦é€”å¾„"><a href="#å¤§æ¨¡å‹æˆä¸ºäº†å‘å±•é€šç”¨äººå·¥æ™ºèƒ½çš„é‡è¦é€”å¾„" class="headerlink" title="å¤§æ¨¡å‹æˆä¸ºäº†å‘å±•é€šç”¨äººå·¥æ™ºèƒ½çš„é‡è¦é€”å¾„"></a>å¤§æ¨¡å‹æˆä¸ºäº†å‘å±•é€šç”¨äººå·¥æ™ºèƒ½çš„é‡è¦é€”å¾„</h3><p><img  src="image-20240104194412083.png"  ><span class="image-caption">å¤§æ¨¡å‹æˆä¸ºäº†å‘å±•é€šç”¨äººå·¥æ™ºèƒ½çš„é‡è¦é€”å¾„</span></p>
<h2 id="ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹"><a href="#ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹" class="headerlink" title="ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹"></a>ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹</h2><h3 id="å¼€æºå†ç¨‹"><a href="#å¼€æºå†ç¨‹" class="headerlink" title="å¼€æºå†ç¨‹"></a>å¼€æºå†ç¨‹</h3><p><img  src="image-20240104194442165.png"  ><span class="image-caption">ä¹¦ç”ŸÂ·æµ¦è¯­çš„å¼€æºå†ç¨‹</span></p>
<p>ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹ä» 6.7 å¼€å§‹ï¼Œå¼€æºäº† InternLM-7Bã€InternLM-Chat-7Bã€Lagentã€InternLM-20B ç­‰é¡¹ç›®ã€‚</p>
<h3 id="ç³»åˆ—æ¨¡å‹"><a href="#ç³»åˆ—æ¨¡å‹" class="headerlink" title="ç³»åˆ—æ¨¡å‹"></a>ç³»åˆ—æ¨¡å‹</h3><p><img  src="image-20240104194623711.png"  ><span class="image-caption">ä¹¦ç”ŸÂ·æµ¦è¯­ç³»åˆ—æ¨¡å‹</span></p>
<h3 id="æ€§èƒ½æ¯”è¾ƒ"><a href="#æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="æ€§èƒ½æ¯”è¾ƒ"></a>æ€§èƒ½æ¯”è¾ƒ</h3><p><img  src="image-20240104194715248.png"  ><span class="image-caption">æ€§èƒ½æ¯”è¾ƒ</span></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œä¹¦ç”ŸÂ·æµ¦è¯­ 20B æ¨¡å‹å…¨é¢é¢†å…ˆç›¸è¿‘é‡çº§çš„å¼€æºæ¨¡å‹ï¼Œå¹¶ä¸”è¾¾åˆ°äº†å’Œ Llama2-70B ç›¸è¿‘çš„æ°´å¹³ã€‚</p>
<h2 id="ä¹¦ç”ŸÂ·æµ¦è¯­å…¨é“¾æ¡å¼€æºä½“ç³»"><a href="#ä¹¦ç”ŸÂ·æµ¦è¯­å…¨é“¾æ¡å¼€æºä½“ç³»" class="headerlink" title="ä¹¦ç”ŸÂ·æµ¦è¯­å…¨é“¾æ¡å¼€æºä½“ç³»"></a>ä¹¦ç”ŸÂ·æµ¦è¯­å…¨é“¾æ¡å¼€æºä½“ç³»</h2><h3 id="ä½“ç³»æ¦‚è¿°"><a href="#ä½“ç³»æ¦‚è¿°" class="headerlink" title="ä½“ç³»æ¦‚è¿°"></a>ä½“ç³»æ¦‚è¿°</h3><p><strong><a href="https://github.com/orgs/InternLM/repositories?type=all">InternLM (github.com)</a></strong></p>
<p><img  src="image-20240104194911061.png"  ><span class="image-caption">ä½“ç³»æ¦‚è¿°</span></p>
<h3 id="æ•°æ®å¼€æº"><a href="#æ•°æ®å¼€æº" class="headerlink" title="æ•°æ®å¼€æº"></a>æ•°æ®å¼€æº</h3><p><img  src="image-20240104194948553.png"  ><span class="image-caption">æ•°æ®å¼€æº</span></p>
<h3 id="é¢„è®­ç»ƒå¼€æº"><a href="#é¢„è®­ç»ƒå¼€æº" class="headerlink" title="é¢„è®­ç»ƒå¼€æº"></a>é¢„è®­ç»ƒå¼€æº</h3><p><img  src="image-20240104195041865.png"  ><span class="image-caption">é¢„è®­ç»ƒå¼€æº</span></p>
<h3 id="å¾®è°ƒå¼€æº"><a href="#å¾®è°ƒå¼€æº" class="headerlink" title="å¾®è°ƒå¼€æº"></a>å¾®è°ƒå¼€æº</h3><p><strong><a href="https://github.com/InternLM/xtuner">InternLM/xtuner: A toolkit for efficiently fine-tuning LLM (InternLM, Llama, Baichuan, Qwen, ChatGLM) (github.com)</a></strong></p>
<p><img  src="image-20240104195250624.png"  ><span class="image-caption">å¾®è°ƒå¼€æº</span></p>
<h3 id="è¯„æµ‹å¼€æº"><a href="#è¯„æµ‹å¼€æº" class="headerlink" title="è¯„æµ‹å¼€æº"></a>è¯„æµ‹å¼€æº</h3><p><strong><a href="https://github.com/open-compass/OpenCompass/">open-compass/opencompass: OpenCompass is an LLM evaluation platform, supporting a wide range of models (LLaMA, LLaMa2, ChatGLM2, ChatGPT, Claude, etc) over 50+ datasets. (github.com)</a></strong></p>
<p><img  src="image-20240104195322676.png"  ><span class="image-caption">è¯„æµ‹å¼€æº-é¢˜ç›®ç±»å‹</span></p>
<p><img  src="image-20240104195342281.png"  ><span class="image-caption">è¯„æµ‹å¼€æº-OpenCompass</span></p>
<p><img  src="image-20240104195354357.png"  ><span class="image-caption">OpenCompass æ¶æ„</span></p>
<h3 id="éƒ¨ç½²å¼€æº"><a href="#éƒ¨ç½²å¼€æº" class="headerlink" title="éƒ¨ç½²å¼€æº"></a>éƒ¨ç½²å¼€æº</h3><p><strong><a href="https://github.com/InternLM/lmdeploy">InternLM/lmdeploy: LMDeploy is a toolkit for compressing, deploying, and serving LLMs. (github.com)</a></strong></p>
<p><img  src="image-20240104195614821.png"  ><span class="image-caption">éƒ¨ç½²å¼€æº</span></p>
<h3 id="æ™ºèƒ½ä½“å¼€æº"><a href="#æ™ºèƒ½ä½“å¼€æº" class="headerlink" title="æ™ºèƒ½ä½“å¼€æº"></a>æ™ºèƒ½ä½“å¼€æº</h3><p><strong><a href="https://github.com/InternLM/lagent">InternLM/lagent: A lightweight framework for building LLM-based agents (github.com)</a></strong></p>
<p><img  src="image-20240104195658280.png"  ><span class="image-caption">æ™ºèƒ½ä½“å¼€æº</span></p>
<h3 id="æ™ºèƒ½ä½“å·¥å…·ç®±"><a href="#æ™ºèƒ½ä½“å·¥å…·ç®±" class="headerlink" title="æ™ºèƒ½ä½“å·¥å…·ç®±"></a>æ™ºèƒ½ä½“å·¥å…·ç®±</h3><p><strong><a href="https://github.com/InternLM/agentlego">InternLM/agentlego: Enhance LLM agents with versatile tool APIs (github.com)</a></strong></p>
<p><img  src="image-20240104195750076.png"  ><span class="image-caption">æ™ºèƒ½ä½“å·¥å…·ç®±</span></p>
<h2 id="ä»æ¨¡å‹åˆ°åº”ç”¨"><a href="#ä»æ¨¡å‹åˆ°åº”ç”¨" class="headerlink" title="ä»æ¨¡å‹åˆ°åº”ç”¨"></a>ä»æ¨¡å‹åˆ°åº”ç”¨</h2><p><img  src="image-20240104194844022.png"  ><span class="image-caption">å¦‚ä½•ä»æ¨¡å‹åˆ°åº”ç”¨</span></p>
]]></content>
      <categories>
        <category>internlm</category>
      </categories>
  </entry>
  <entry>
    <title>Internlm-02-æµ¦è¯­å¤§æ¨¡å‹è¶£å‘³ Demo</title>
    <url>/internlm/internlm-02/</url>
    <content><![CDATA[<h1 id="æµ¦è¯­å¤§æ¨¡å‹è¶£å‘³-Demo"><a href="#æµ¦è¯­å¤§æ¨¡å‹è¶£å‘³-Demo" class="headerlink" title="æµ¦è¯­å¤§æ¨¡å‹è¶£å‘³ Demo"></a>æµ¦è¯­å¤§æ¨¡å‹è¶£å‘³ Demo</h1><h2 id="å¤§æ¨¡å‹åŠ-InternLM-æ¨¡å‹ç®€ä»‹"><a href="#å¤§æ¨¡å‹åŠ-InternLM-æ¨¡å‹ç®€ä»‹" class="headerlink" title="å¤§æ¨¡å‹åŠ InternLM æ¨¡å‹ç®€ä»‹"></a>å¤§æ¨¡å‹åŠ InternLM æ¨¡å‹ç®€ä»‹</h2><h3 id="ä»€ä¹ˆæ˜¯å¤§æ¨¡å‹"><a href="#ä»€ä¹ˆæ˜¯å¤§æ¨¡å‹" class="headerlink" title="ä»€ä¹ˆæ˜¯å¤§æ¨¡å‹"></a>ä»€ä¹ˆæ˜¯å¤§æ¨¡å‹</h3><p>å¤§æ¨¡å‹æ˜¯æŒ‡åœ¨æœºå™¨å­¦ä¹ æˆ–äººå·¥æ™ºèƒ½é¢†åŸŸä¸­å…·æœ‰å·¨å¤§å‚æ•°æ•°é‡å’Œå¼ºå¤§è®¡ç®—èƒ½åŠ›çš„æ¨¡å‹ã€‚å®ƒä»¬åˆ©ç”¨æµ·é‡æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œæ‹¥æœ‰æ•°åäº¿ç”šè‡³æ•°åƒäº¿ä¸ªå‚æ•°ã€‚å¤§æ¨¡å‹çš„å´›èµ·å½’å› äºæ•°æ®é‡å¢é•¿ã€è®¡ç®—èƒ½åŠ›æå‡å’Œç®—æ³•ä¼˜åŒ–ç­‰å› ç´ ã€‚å®ƒä»¬åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ã€è®¡ç®—æœºè§†è§‰ã€è¯­éŸ³è¯†åˆ«ç­‰ä»»åŠ¡ä¸­å±•ç°å‡ºæƒŠäººæ€§èƒ½ï¼Œå¸¸é‡‡ç”¨æ·±åº¦ç¥ç»ç½‘ç»œç»“æ„ï¼Œå¦‚Transformerã€BERTã€GPTç­‰ã€‚</p>
<p>è¿™äº›æ¨¡å‹çš„ä¼˜åŠ¿åœ¨äºèƒ½å¤Ÿæ•æ‰å’Œç†è§£æ•°æ®ä¸­æ›´å¤æ‚ã€æŠ½è±¡çš„ç‰¹å¾å’Œå…³ç³»ã€‚é€šè¿‡å¤§è§„æ¨¡å‚æ•°çš„å­¦ä¹ ï¼Œå®ƒä»¬å¯ä»¥æé«˜æ³›åŒ–èƒ½åŠ›ï¼Œåœ¨æœªç»å¤§é‡ç‰¹å®šé¢†åŸŸæ•°æ®è®­ç»ƒçš„æƒ…å†µä¸‹è¡¨ç°ä¼˜å¼‚ã€‚ç„¶è€Œï¼Œå®ƒä»¬ä¹Ÿé¢ä¸´ç€æŒ‘æˆ˜ï¼Œå¦‚å·¨å¤§è®¡ç®—èµ„æºéœ€æ±‚ã€é«˜æ˜‚è®­ç»ƒæˆæœ¬ã€å¯¹å¤§è§„æ¨¡æ•°æ®çš„ä¾èµ–å’Œå¯è§£é‡Šæ€§ç­‰é—®é¢˜ã€‚å› æ­¤ï¼Œåœ¨æ€§èƒ½ã€æˆæœ¬å’Œé“å¾·ç­‰æ–¹é¢éœ€è¦æƒè¡¡è€ƒé‡å…¶åº”ç”¨å’Œå‘å±•ã€‚</p>
<h2 id="InternLM-æ¨¡å‹å…¨é“¾æ¡å¼€æº"><a href="#InternLM-æ¨¡å‹å…¨é“¾æ¡å¼€æº" class="headerlink" title="InternLM æ¨¡å‹å…¨é“¾æ¡å¼€æº"></a>InternLM æ¨¡å‹å…¨é“¾æ¡å¼€æº</h2><p>åŒ…æ‹¬äº† InternLMã€Lagentã€æµ¦è¯­Â·çµç¬”ç­‰é¡¹ç›®ï¼Œè¯¦æƒ…å¯è§ï¼š<br><a href="https://github.com/InternLM/InternLM">InternLM</a><br><a href="https://enableasync.github.io/internlm/internlm-01/">EnableAsync çš„åšå®¢</a></p>
<h2 id="InternLM-Chat-7B-æ™ºèƒ½å¯¹è¯-Demo"><a href="#InternLM-Chat-7B-æ™ºèƒ½å¯¹è¯-Demo" class="headerlink" title="InternLM-Chat-7B æ™ºèƒ½å¯¹è¯ Demo"></a>InternLM-Chat-7B æ™ºèƒ½å¯¹è¯ Demo</h2><p>InternLMå·²ç»å¼€æºäº†ä¸€ä¸ª70äº¿å‚æ•°çš„åŸºç¡€æ¨¡å‹å’Œä¸€ä¸ªä¸“ä¸ºå®é™…åœºæ™¯é‡èº«å®šåˆ¶çš„èŠå¤©æ¨¡å‹ã€‚è¯¥æ¨¡å‹å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å®ƒåˆ©ç”¨æ•°ä¸‡äº¿é«˜è´¨é‡æ ‡è®°è¿›è¡Œè®­ç»ƒï¼Œå»ºç«‹äº†å¼ºå¤§çš„çŸ¥è¯†åº“ã€‚</li>
<li>æ”¯æŒ8,000çš„ä¸Šä¸‹æ–‡çª—å£é•¿åº¦ï¼Œèƒ½å¤Ÿå¤„ç†æ›´é•¿çš„è¾“å…¥åºåˆ—å¹¶å…·å¤‡æ›´å¼ºçš„æ¨ç†èƒ½åŠ›ã€‚</li>
<li>ä¸ºç”¨æˆ·æä¾›äº†å¤šåŠŸèƒ½å·¥å…·é›†ï¼Œçµæ´»æ„å»ºè‡ªå·±çš„å·¥ä½œæµç¨‹ã€‚</li>
</ul>
<h3 id="demo-ä»£ç "><a href="#demo-ä»£ç " class="headerlink" title="demo ä»£ç "></a>demo ä»£ç </h3><p>æœ€ç®€å•çš„ <code>cli_demo</code> ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer, AutoModelForCausalLM<br><br><br>model_name_or_path = <span class="hljs-string">&quot;/root/model/Shanghai_AI_Laboratory/internlm-chat-7b&quot;</span><br><br>tokenizer = AutoTokenizer.from_pretrained(model_name_or_path, trust_remote_code=<span class="hljs-literal">True</span>)<br>model = AutoModelForCausalLM.from_pretrained(model_name_or_path, trust_remote_code=<span class="hljs-literal">True</span>, torch_dtype=torch.bfloat16, device_map=<span class="hljs-string">&#x27;auto&#x27;</span>)<br>model = model.<span class="hljs-built_in">eval</span>()<br><br>system_prompt = <span class="hljs-string">&quot;&quot;&quot;You are an AI assistant whose name is InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­).</span><br><span class="hljs-string">- InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) is a conversational language model that is developed by Shanghai AI Laboratory (ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤). It is designed to be helpful, honest, and harmless.</span><br><span class="hljs-string">- InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) can understand and communicate fluently in the language chosen by the user such as English and ä¸­æ–‡.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>messages = [(system_prompt, <span class="hljs-string">&#x27;&#x27;</span>)]<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=============Welcome to InternLM chatbot, type &#x27;exit&#x27; to exit.=============&quot;</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    input_text = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;User  &gt;&gt;&gt; &quot;</span>)<br>    input_text.replace(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> input_text == <span class="hljs-string">&quot;exit&quot;</span>:<br>        <span class="hljs-keyword">break</span><br>    response, history = model.chat(tokenizer, input_text, history=messages)<br>    messages.append((input_text, response))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;robot &gt;&gt;&gt; <span class="hljs-subst">&#123;response&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<h3 id="è¿è¡Œæ•ˆæœ"><a href="#è¿è¡Œæ•ˆæœ" class="headerlink" title="è¿è¡Œæ•ˆæœ"></a>è¿è¡Œæ•ˆæœ</h3><p>è¿è¡Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img  src="story.png"  ><span class="image-caption">InternLMç”Ÿæˆå°æ•…äº‹</span></p>
<h2 id="Lagent-æ™ºèƒ½ä½“å·¥å…·è°ƒç”¨-Demo"><a href="#Lagent-æ™ºèƒ½ä½“å·¥å…·è°ƒç”¨-Demo" class="headerlink" title="Lagent æ™ºèƒ½ä½“å·¥å…·è°ƒç”¨ Demo"></a>Lagent æ™ºèƒ½ä½“å·¥å…·è°ƒç”¨ Demo</h2><p>Lagent æ˜¯ä¸€ä¸ªè½»é‡çº§ã€å¼€æºçš„åŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æ™ºèƒ½ä½“ï¼ˆagentï¼‰æ¡†æ¶ï¼Œæ”¯æŒç”¨æˆ·å¿«é€Ÿåœ°å°†ä¸€ä¸ªå¤§è¯­è¨€æ¨¡å‹è½¬å˜ä¸ºå¤šç§ç±»å‹çš„æ™ºèƒ½ä½“ï¼Œå¹¶æä¾›äº†ä¸€äº›å…¸å‹å·¥å…·ä¸ºå¤§è¯­è¨€æ¨¡å‹èµ‹èƒ½ã€‚é€šè¿‡ Lagent æ¡†æ¶å¯ä»¥æ›´å¥½çš„å‘æŒ¥ InternLM çš„å…¨éƒ¨æ€§èƒ½ã€‚</p>
<h3 id="demo-ä»£ç -1"><a href="#demo-ä»£ç -1" class="headerlink" title="demo ä»£ç "></a>demo ä»£ç </h3><p>æ•™ç¨‹ä¸­æä¾›äº†ä¸€ä¸ª web demo å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> copy<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st<br><span class="hljs-keyword">from</span> streamlit.logger <span class="hljs-keyword">import</span> get_logger<br><br><span class="hljs-keyword">from</span> lagent.actions <span class="hljs-keyword">import</span> ActionExecutor, GoogleSearch, PythonInterpreter<br><span class="hljs-keyword">from</span> lagent.agents.react <span class="hljs-keyword">import</span> ReAct<br><span class="hljs-keyword">from</span> lagent.llms <span class="hljs-keyword">import</span> GPTAPI<br><span class="hljs-keyword">from</span> lagent.llms.huggingface <span class="hljs-keyword">import</span> HFTransformerCasualLM<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionState</span>:<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_state</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Initialize session state variables.&quot;&quot;&quot;</span><br>        st.session_state[<span class="hljs-string">&#x27;assistant&#x27;</span>] = []<br>        st.session_state[<span class="hljs-string">&#x27;user&#x27;</span>] = []<br><br>        <span class="hljs-comment">#action_list = [PythonInterpreter(), GoogleSearch()]</span><br>        action_list = [PythonInterpreter()]<br>        st.session_state[<span class="hljs-string">&#x27;plugin_map&#x27;</span>] = &#123;<br>            action.name: action<br>            <span class="hljs-keyword">for</span> action <span class="hljs-keyword">in</span> action_list<br>        &#125;<br>        st.session_state[<span class="hljs-string">&#x27;model_map&#x27;</span>] = &#123;&#125;<br>        st.session_state[<span class="hljs-string">&#x27;model_selected&#x27;</span>] = <span class="hljs-literal">None</span><br>        st.session_state[<span class="hljs-string">&#x27;plugin_actions&#x27;</span>] = <span class="hljs-built_in">set</span>()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_state</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Clear the existing session state.&quot;&quot;&quot;</span><br>        st.session_state[<span class="hljs-string">&#x27;assistant&#x27;</span>] = []<br>        st.session_state[<span class="hljs-string">&#x27;user&#x27;</span>] = []<br>        st.session_state[<span class="hljs-string">&#x27;model_selected&#x27;</span>] = <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chatbot&#x27;</span> <span class="hljs-keyword">in</span> st.session_state:<br>            st.session_state[<span class="hljs-string">&#x27;chatbot&#x27;</span>]._session_history = []<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamlitUI</span>:<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, session_state: SessionState</span>):<br>        self.init_streamlit()<br>        self.session_state = session_state<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_streamlit</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Initialize Streamlit&#x27;s UI settings.&quot;&quot;&quot;</span><br>        st.set_page_config(<br>            layout=<span class="hljs-string">&#x27;wide&#x27;</span>,<br>            page_title=<span class="hljs-string">&#x27;lagent-web&#x27;</span>,<br>            page_icon=<span class="hljs-string">&#x27;./docs/imgs/lagent_icon.png&#x27;</span>)<br>        <span class="hljs-comment"># st.header(&#x27;:robot_face: :blue[Lagent] Web Demo &#x27;, divider=&#x27;rainbow&#x27;)</span><br>        st.sidebar.title(<span class="hljs-string">&#x27;æ¨¡å‹æ§åˆ¶&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_sidebar</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Setup the sidebar for model and plugin selection.&quot;&quot;&quot;</span><br>        model_name = st.sidebar.selectbox(<br>            <span class="hljs-string">&#x27;æ¨¡å‹é€‰æ‹©ï¼š&#x27;</span>, options=[<span class="hljs-string">&#x27;gpt-3.5-turbo&#x27;</span>,<span class="hljs-string">&#x27;internlm&#x27;</span>])<br>        <span class="hljs-keyword">if</span> model_name != st.session_state[<span class="hljs-string">&#x27;model_selected&#x27;</span>]:<br>            model = self.init_model(model_name)<br>            self.session_state.clear_state()<br>            st.session_state[<span class="hljs-string">&#x27;model_selected&#x27;</span>] = model_name<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chatbot&#x27;</span> <span class="hljs-keyword">in</span> st.session_state:<br>                <span class="hljs-keyword">del</span> st.session_state[<span class="hljs-string">&#x27;chatbot&#x27;</span>]<br>        <span class="hljs-keyword">else</span>:<br>            model = st.session_state[<span class="hljs-string">&#x27;model_map&#x27;</span>][model_name]<br><br>        plugin_name = st.sidebar.multiselect(<br>            <span class="hljs-string">&#x27;æ’ä»¶é€‰æ‹©&#x27;</span>,<br>            options=<span class="hljs-built_in">list</span>(st.session_state[<span class="hljs-string">&#x27;plugin_map&#x27;</span>].keys()),<br>            default=[<span class="hljs-built_in">list</span>(st.session_state[<span class="hljs-string">&#x27;plugin_map&#x27;</span>].keys())[<span class="hljs-number">0</span>]],<br>        )<br><br>        plugin_action = [<br>            st.session_state[<span class="hljs-string">&#x27;plugin_map&#x27;</span>][name] <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> plugin_name<br>        ]<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chatbot&#x27;</span> <span class="hljs-keyword">in</span> st.session_state:<br>            st.session_state[<span class="hljs-string">&#x27;chatbot&#x27;</span>]._action_executor = ActionExecutor(<br>                actions=plugin_action)<br>        <span class="hljs-keyword">if</span> st.sidebar.button(<span class="hljs-string">&#x27;æ¸…ç©ºå¯¹è¯&#x27;</span>, key=<span class="hljs-string">&#x27;clear&#x27;</span>):<br>            self.session_state.clear_state()<br>        uploaded_file = st.sidebar.file_uploader(<br>            <span class="hljs-string">&#x27;ä¸Šä¼ æ–‡ä»¶&#x27;</span>, <span class="hljs-built_in">type</span>=[<span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>, <span class="hljs-string">&#x27;mp4&#x27;</span>, <span class="hljs-string">&#x27;mp3&#x27;</span>, <span class="hljs-string">&#x27;wav&#x27;</span>])<br>        <span class="hljs-keyword">return</span> model_name, model, plugin_action, uploaded_file<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_model</span>(<span class="hljs-params">self, option</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Initialize the model based on the selected option.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> option <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state[<span class="hljs-string">&#x27;model_map&#x27;</span>]:<br>            <span class="hljs-keyword">if</span> option.startswith(<span class="hljs-string">&#x27;gpt&#x27;</span>):<br>                st.session_state[<span class="hljs-string">&#x27;model_map&#x27;</span>][option] = GPTAPI(<br>                    model_type=option)<br>            <span class="hljs-keyword">else</span>:<br>                st.session_state[<span class="hljs-string">&#x27;model_map&#x27;</span>][option] = HFTransformerCasualLM(<br>                    <span class="hljs-string">&#x27;/root/model/Shanghai_AI_Laboratory/internlm-chat-7b&#x27;</span>)<br>        <span class="hljs-keyword">return</span> st.session_state[<span class="hljs-string">&#x27;model_map&#x27;</span>][option]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize_chatbot</span>(<span class="hljs-params">self, model, plugin_action</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Initialize the chatbot with the given model and plugin actions.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> ReAct(<br>            llm=model, action_executor=ActionExecutor(actions=plugin_action))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">render_user</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span></span>):<br>        <span class="hljs-keyword">with</span> st.chat_message(<span class="hljs-string">&#x27;user&#x27;</span>):<br>            st.markdown(prompt)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">render_assistant</span>(<span class="hljs-params">self, agent_return</span>):<br>        <span class="hljs-keyword">with</span> st.chat_message(<span class="hljs-string">&#x27;assistant&#x27;</span>):<br>            <span class="hljs-keyword">for</span> action <span class="hljs-keyword">in</span> agent_return.actions:<br>                <span class="hljs-keyword">if</span> (action):<br>                    self.render_action(action)<br>            st.markdown(agent_return.response)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">render_action</span>(<span class="hljs-params">self, action</span>):<br>        <span class="hljs-keyword">with</span> st.expander(action.<span class="hljs-built_in">type</span>, expanded=<span class="hljs-literal">True</span>):<br>            st.markdown(<br>                <span class="hljs-string">&quot;&lt;p style=&#x27;text-align: left;display:flex;&#x27;&gt; &lt;span style=&#x27;font-size:14px;font-weight:600;width:70px;text-align-last: justify;&#x27;&gt;æ’    ä»¶&lt;/span&gt;&lt;span style=&#x27;width:14px;text-align:left;display:block;&#x27;&gt;:&lt;/span&gt;&lt;span style=&#x27;flex:1;&#x27;&gt;&quot;</span>  <span class="hljs-comment"># noqa E501</span><br>                + action.<span class="hljs-built_in">type</span> + <span class="hljs-string">&#x27;&lt;/span&gt;&lt;/p&gt;&#x27;</span>,<br>                unsafe_allow_html=<span class="hljs-literal">True</span>)<br>            st.markdown(<br>                <span class="hljs-string">&quot;&lt;p style=&#x27;text-align: left;display:flex;&#x27;&gt; &lt;span style=&#x27;font-size:14px;font-weight:600;width:70px;text-align-last: justify;&#x27;&gt;æ€è€ƒæ­¥éª¤&lt;/span&gt;&lt;span style=&#x27;width:14px;text-align:left;display:block;&#x27;&gt;:&lt;/span&gt;&lt;span style=&#x27;flex:1;&#x27;&gt;&quot;</span>  <span class="hljs-comment"># noqa E501</span><br>                + action.thought + <span class="hljs-string">&#x27;&lt;/span&gt;&lt;/p&gt;&#x27;</span>,<br>                unsafe_allow_html=<span class="hljs-literal">True</span>)<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isinstance</span>(action.args, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;text&#x27;</span> <span class="hljs-keyword">in</span> action.args):<br>                st.markdown(<br>                    <span class="hljs-string">&quot;&lt;p style=&#x27;text-align: left;display:flex;&#x27;&gt;&lt;span style=&#x27;font-size:14px;font-weight:600;width:70px;text-align-last: justify;&#x27;&gt; æ‰§è¡Œå†…å®¹&lt;/span&gt;&lt;span style=&#x27;width:14px;text-align:left;display:block;&#x27;&gt;:&lt;/span&gt;&lt;/p&gt;&quot;</span>,  <span class="hljs-comment"># noqa E501</span><br>                    unsafe_allow_html=<span class="hljs-literal">True</span>)<br>                st.markdown(action.args[<span class="hljs-string">&#x27;text&#x27;</span>])<br>            self.render_action_results(action)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">render_action_results</span>(<span class="hljs-params">self, action</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Render the results of action, including text, images, videos, and</span><br><span class="hljs-string">        audios.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isinstance</span>(action.result, <span class="hljs-built_in">dict</span>)):<br>            st.markdown(<br>                <span class="hljs-string">&quot;&lt;p style=&#x27;text-align: left;display:flex;&#x27;&gt;&lt;span style=&#x27;font-size:14px;font-weight:600;width:70px;text-align-last: justify;&#x27;&gt; æ‰§è¡Œç»“æœ&lt;/span&gt;&lt;span style=&#x27;width:14px;text-align:left;display:block;&#x27;&gt;:&lt;/span&gt;&lt;/p&gt;&quot;</span>,  <span class="hljs-comment"># noqa E501</span><br>                unsafe_allow_html=<span class="hljs-literal">True</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;text&#x27;</span> <span class="hljs-keyword">in</span> action.result:<br>                st.markdown(<br>                    <span class="hljs-string">&quot;&lt;p style=&#x27;text-align: left;&#x27;&gt;&quot;</span> + action.result[<span class="hljs-string">&#x27;text&#x27;</span>] +<br>                    <span class="hljs-string">&#x27;&lt;/p&gt;&#x27;</span>,<br>                    unsafe_allow_html=<span class="hljs-literal">True</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;image&#x27;</span> <span class="hljs-keyword">in</span> action.result:<br>                image_path = action.result[<span class="hljs-string">&#x27;image&#x27;</span>]<br>                image_data = <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>                st.image(image_data, caption=<span class="hljs-string">&#x27;Generated Image&#x27;</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;video&#x27;</span> <span class="hljs-keyword">in</span> action.result:<br>                video_data = action.result[<span class="hljs-string">&#x27;video&#x27;</span>]<br>                video_data = <span class="hljs-built_in">open</span>(video_data, <span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>                st.video(video_data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;audio&#x27;</span> <span class="hljs-keyword">in</span> action.result:<br>                audio_data = action.result[<span class="hljs-string">&#x27;audio&#x27;</span>]<br>                audio_data = <span class="hljs-built_in">open</span>(audio_data, <span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>                st.audio(audio_data)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    logger = get_logger(__name__)<br>    <span class="hljs-comment"># Initialize Streamlit UI and setup sidebar</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;ui&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:<br>        session_state = SessionState()<br>        session_state.init_state()<br>        st.session_state[<span class="hljs-string">&#x27;ui&#x27;</span>] = StreamlitUI(session_state)<br><br>    <span class="hljs-keyword">else</span>:<br>        st.set_page_config(<br>            layout=<span class="hljs-string">&#x27;wide&#x27;</span>,<br>            page_title=<span class="hljs-string">&#x27;lagent-web&#x27;</span>,<br>            page_icon=<span class="hljs-string">&#x27;./docs/imgs/lagent_icon.png&#x27;</span>)<br>        <span class="hljs-comment"># st.header(&#x27;:robot_face: :blue[Lagent] Web Demo &#x27;, divider=&#x27;rainbow&#x27;)</span><br>    model_name, model, plugin_action, uploaded_file = st.session_state[<br>        <span class="hljs-string">&#x27;ui&#x27;</span>].setup_sidebar()<br><br>    <span class="hljs-comment"># Initialize chatbot if it is not already initialized</span><br>    <span class="hljs-comment"># or if the model has changed</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chatbot&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state <span class="hljs-keyword">or</span> model != st.session_state[<br>            <span class="hljs-string">&#x27;chatbot&#x27;</span>]._llm:<br>        st.session_state[<span class="hljs-string">&#x27;chatbot&#x27;</span>] = st.session_state[<br>            <span class="hljs-string">&#x27;ui&#x27;</span>].initialize_chatbot(model, plugin_action)<br><br>    <span class="hljs-keyword">for</span> prompt, agent_return <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(st.session_state[<span class="hljs-string">&#x27;user&#x27;</span>],<br>                                    st.session_state[<span class="hljs-string">&#x27;assistant&#x27;</span>]):<br>        st.session_state[<span class="hljs-string">&#x27;ui&#x27;</span>].render_user(prompt)<br>        st.session_state[<span class="hljs-string">&#x27;ui&#x27;</span>].render_assistant(agent_return)<br>    <span class="hljs-comment"># User input form at the bottom (this part will be at the bottom)</span><br>    <span class="hljs-comment"># with st.form(key=&#x27;my_form&#x27;, clear_on_submit=True):</span><br><br>    <span class="hljs-keyword">if</span> user_input := st.chat_input(<span class="hljs-string">&#x27;&#x27;</span>):<br>        st.session_state[<span class="hljs-string">&#x27;ui&#x27;</span>].render_user(user_input)<br>        st.session_state[<span class="hljs-string">&#x27;user&#x27;</span>].append(user_input)<br>        <span class="hljs-comment"># Add file uploader to sidebar</span><br>        <span class="hljs-keyword">if</span> uploaded_file:<br>            file_bytes = uploaded_file.read()<br>            file_type = uploaded_file.<span class="hljs-built_in">type</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;image&#x27;</span> <span class="hljs-keyword">in</span> file_type:<br>                st.image(file_bytes, caption=<span class="hljs-string">&#x27;Uploaded Image&#x27;</span>)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;video&#x27;</span> <span class="hljs-keyword">in</span> file_type:<br>                st.video(file_bytes, caption=<span class="hljs-string">&#x27;Uploaded Video&#x27;</span>)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;audio&#x27;</span> <span class="hljs-keyword">in</span> file_type:<br>                st.audio(file_bytes, caption=<span class="hljs-string">&#x27;Uploaded Audio&#x27;</span>)<br>            <span class="hljs-comment"># Save the file to a temporary location and get the path</span><br>            file_path = os.path.join(root_dir, uploaded_file.name)<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> tmpfile:<br>                tmpfile.write(file_bytes)<br>            st.write(<span class="hljs-string">f&#x27;File saved at: <span class="hljs-subst">&#123;file_path&#125;</span>&#x27;</span>)<br>            user_input = <span class="hljs-string">&#x27;æˆ‘ä¸Šä¼ äº†ä¸€ä¸ªå›¾åƒï¼Œè·¯å¾„ä¸º: &#123;file_path&#125;. &#123;user_input&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>                file_path=file_path, user_input=user_input)<br>        agent_return = st.session_state[<span class="hljs-string">&#x27;chatbot&#x27;</span>].chat(user_input)<br>        st.session_state[<span class="hljs-string">&#x27;assistant&#x27;</span>].append(copy.deepcopy(agent_return))<br>        logger.info(agent_return.inner_steps)<br>        st.session_state[<span class="hljs-string">&#x27;ui&#x27;</span>].render_assistant(agent_return)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    root_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))<br>    root_dir = os.path.join(root_dir, <span class="hljs-string">&#x27;tmp_dir&#x27;</span>)<br>    os.makedirs(root_dir, exist_ok=<span class="hljs-literal">True</span>)<br>    main()<br><br></code></pre></td></tr></table></figure></p>
<h3 id="demo-è¿è¡Œæ–¹å¼"><a href="#demo-è¿è¡Œæ–¹å¼" class="headerlink" title="demo è¿è¡Œæ–¹å¼"></a>demo è¿è¡Œæ–¹å¼</h3><p>demo è¿è¡Œæ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">streamlit run /root/code/lagent/examples/react_web_demo.py --server.address 127.0.0.1 --server.port 6006<br></code></pre></td></tr></table></figure>
<h3 id="æ•ˆæœå±•ç¤º"><a href="#æ•ˆæœå±•ç¤º" class="headerlink" title="æ•ˆæœå±•ç¤º"></a>æ•ˆæœå±•ç¤º</h3><p><img  src="lagent-1.png"  ><span class="image-caption">Lagentæ•ˆæœå±•ç¤º1</span></p>
<p><img  src="lagent-2.png"  ><span class="image-caption">Lagentæ•ˆæœå±•ç¤º2</span></p>
<p><img  src="lagent-3.png"  ><span class="image-caption">Lagentæ•ˆæœå±•ç¤º3</span></p>
<p><img  src="lagent-4.png"  ><span class="image-caption">Lagentæ•ˆæœå±•ç¤º4</span></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œlagentèƒ½å¤Ÿé€šè¿‡ python ä»£ç è§£å†³ä¸€äº›æ•°å­¦é—®é¢˜ï¼Œè€Œå¯¹äºå¾ˆå›°éš¾çš„æ•°å­¦é—®é¢˜ï¼Œè§£å†³èµ·æ¥ä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚</p>
<h2 id="æµ¦è¯­Â·çµç¬”å›¾æ–‡ç†è§£åˆ›ä½œ-Demo"><a href="#æµ¦è¯­Â·çµç¬”å›¾æ–‡ç†è§£åˆ›ä½œ-Demo" class="headerlink" title="æµ¦è¯­Â·çµç¬”å›¾æ–‡ç†è§£åˆ›ä½œ Demo"></a>æµ¦è¯­Â·çµç¬”å›¾æ–‡ç†è§£åˆ›ä½œ Demo</h2><p><strong>æµ¦è¯­Â·çµç¬”</strong>æ˜¯åŸºäº<a href="https://github.com/InternLM/InternLM/tree/main">ä¹¦ç”ŸÂ·æµ¦è¯­</a>å¤§è¯­è¨€æ¨¡å‹ç ”å‘çš„è§†è§‰-è¯­è¨€å¤§æ¨¡å‹ï¼Œæä¾›å‡ºè‰²çš„å›¾æ–‡ç†è§£å’Œåˆ›ä½œèƒ½åŠ›ï¼Œå…·æœ‰å¤šé¡¹ä¼˜åŠ¿ï¼š</p>
<ul>
<li><p><strong>å›¾æ–‡äº¤é”™åˆ›ä½œ</strong>: æµ¦è¯­Â·çµç¬”å¯ä»¥ä¸ºç”¨æˆ·æ‰“é€ å›¾æ–‡å¹¶è²Œçš„ä¸“å±æ–‡ç« ã€‚ç”Ÿæˆçš„æ–‡ç« æ–‡é‡‡æ–ç„¶ï¼Œå›¾æ–‡ç›¸å¾—ç›Šå½°ï¼Œæä¾›æ²‰æµ¸å¼çš„é˜…è¯»ä½“éªŒã€‚è¿™ä¸€èƒ½åŠ›ç”±ä»¥ä¸‹æ­¥éª¤å®ç°ï¼š</p>
<ol>
<li><strong>ç†è§£ç”¨æˆ·æŒ‡ä»¤ï¼Œåˆ›ä½œç¬¦åˆè¦æ±‚çš„é•¿æ–‡ç« </strong>ã€‚</li>
<li><strong>æ™ºèƒ½åˆ†ææ–‡ç« ï¼Œè‡ªåŠ¨è§„åˆ’æ’å›¾çš„ç†æƒ³ä½ç½®ï¼Œç¡®å®šå›¾åƒå†…å®¹éœ€æ±‚ã€‚</strong></li>
<li><strong>å¤šå±‚æ¬¡æ™ºèƒ½ç­›é€‰ï¼Œä»å›¾åº“ä¸­é”å®šæœ€å®Œç¾çš„å›¾ç‰‡ã€‚</strong></li>
</ol>
</li>
<li><p><strong>åŸºäºä¸°å¯Œå¤šæ¨¡æ€çŸ¥è¯†çš„å›¾æ–‡ç†è§£</strong>: æµ¦è¯­Â·çµç¬”è®¾è®¡äº†é«˜æ•ˆçš„è®­ç»ƒç­–ç•¥ï¼Œä¸ºæ¨¡å‹æ³¨å…¥æµ·é‡çš„å¤šæ¨¡æ€æ¦‚å¿µå’ŒçŸ¥è¯†æ•°æ®ï¼Œèµ‹äºˆå…¶å¼ºå¤§çš„å›¾æ–‡ç†è§£å’Œå¯¹è¯èƒ½åŠ›ã€‚</p>
</li>
<li><strong>æ°å‡ºæ€§èƒ½</strong>: æµ¦è¯­Â·çµç¬”åœ¨å¤šé¡¹è§†è§‰è¯­è¨€å¤§æ¨¡å‹çš„ä¸»æµè¯„æµ‹ä¸Šå‡å–å¾—äº†æœ€ä½³æ€§èƒ½ï¼ŒåŒ…æ‹¬<a href="https://github.com/BradyFU/Awesome-Multimodal-Large-Language-Models/tree/Evaluation">MME Benchmark</a> (è‹±æ–‡è¯„æµ‹), <a href="https://opencompass.org.cn/leaderboard-multimodal">MMBench</a> (è‹±æ–‡è¯„æµ‹), <a href="https://huggingface.co/spaces/AILab-CVC/SEED-Bench_Leaderboard">Seed-Bench</a> (è‹±æ–‡è¯„æµ‹), <a href="https://opencompass.org.cn/leaderboard-multimodal">CCBench</a>(ä¸­æ–‡è¯„æµ‹), <a href="https://opencompass.org.cn/leaderboard-multimodal">MMBench-CN</a> (ä¸­æ–‡è¯„æµ‹)ã€‚<h3 id="demo-ä»£ç -2"><a href="#demo-ä»£ç -2" class="headerlink" title="demo ä»£ç "></a>demo ä»£ç </h3></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /root/code<br>git <span class="hljs-built_in">clone</span> https://gitee.com/internlm/InternLM-XComposer.git<br><span class="hljs-built_in">cd</span> /root/code/InternLM-XComposer<br>git checkout 3e8c79051a1356b9c388a6447867355c0634932d  <span class="hljs-comment"># æœ€å¥½ä¿è¯å’Œæ•™ç¨‹çš„ commit ç‰ˆæœ¬ä¸€è‡´</span><br></code></pre></td></tr></table></figure>
<h3 id="demo-è¿è¡Œæ–¹å¼-1"><a href="#demo-è¿è¡Œæ–¹å¼-1" class="headerlink" title="demo è¿è¡Œæ–¹å¼"></a>demo è¿è¡Œæ–¹å¼</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /root/code/InternLM-XComposer<br>python examples/web_demo.py  \<br>    --folder /root/model/Shanghai_AI_Laboratory/internlm-xcomposer-7b \<br>    --num_gpus 1 \<br>    --port 6006<br></code></pre></td></tr></table></figure>
<h3 id="æ•ˆæœå±•ç¤º-1"><a href="#æ•ˆæœå±•ç¤º-1" class="headerlink" title="æ•ˆæœå±•ç¤º"></a>æ•ˆæœå±•ç¤º</h3><p><img  src="çµç¬”-1.png"  ><span class="image-caption">æµ¦è¯­Â·çµç¬”æ•ˆæœå±•ç¤º1</span></p>
<p><img  src="çµç¬”-2.png"  ><span class="image-caption">æµ¦è¯­Â·çµç¬”æ•ˆæœå±•ç¤º2</span></p>
<p><img  src="çµç¬”-3.png"  ><span class="image-caption">æµ¦è¯­Â·çµç¬”æ•ˆæœå±•ç¤º3</span></p>
<h2 id="huggingface-hub-ä¸‹è½½æ–‡ä»¶"><a href="#huggingface-hub-ä¸‹è½½æ–‡ä»¶" class="headerlink" title="huggingface_hub ä¸‹è½½æ–‡ä»¶"></a>huggingface_hub ä¸‹è½½æ–‡ä»¶</h2><p><img  src="huggingface_hub_download.png"  ><span class="image-caption">ä½¿ç”¨ huggingface_hub åº“ä¸‹è½½æ–‡ä»¶</span></p>
]]></content>
      <categories>
        <category>internlm</category>
      </categories>
  </entry>
  <entry>
    <title>Kind çš„ä¸€äº›ä½¿ç”¨å¿ƒå¾—</title>
    <url>/uncategorized/kind/</url>
    <content><![CDATA[<h1 id="Kind-çš„ä¸€äº›ä½¿ç”¨å¿ƒå¾—"><a href="#Kind-çš„ä¸€äº›ä½¿ç”¨å¿ƒå¾—" class="headerlink" title="Kind çš„ä¸€äº›ä½¿ç”¨å¿ƒå¾—"></a>Kind çš„ä¸€äº›ä½¿ç”¨å¿ƒå¾—</h1><p>å› ä¸º Kind å¯åŠ¨ç›¸æ¯”äº Minikube æ›´å¿«ï¼Œè€Œä¸”æ”¯æŒå¤š Nodeï¼Œæ‰€ä»¥ç°åœ¨æ¢æˆäº† Kindï¼Œè¿™é‡Œè®°å½•ä¸€äº› Kind çš„ä½¿ç”¨å¿ƒå¾—ã€‚</p>
<h2 id="1-Kind-å®‰è£…"><a href="#1-Kind-å®‰è£…" class="headerlink" title="1. Kind å®‰è£…"></a>1. Kind å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.11.1/kind-linux-amd64<br><span class="hljs-built_in">chmod</span> +x ./kind<br><span class="hljs-built_in">mv</span> ./kind /usr/bin/kind<br></code></pre></td></tr></table></figure>
<h2 id="2-ä½¿ç”¨-Kind-åˆ›å»ºå«æœ‰ä¸¤ä¸ª-Node-çš„-kubernetes-é›†ç¾¤"><a href="#2-ä½¿ç”¨-Kind-åˆ›å»ºå«æœ‰ä¸¤ä¸ª-Node-çš„-kubernetes-é›†ç¾¤" class="headerlink" title="2. ä½¿ç”¨ Kind åˆ›å»ºå«æœ‰ä¸¤ä¸ª Node çš„ kubernetes é›†ç¾¤"></a>2. ä½¿ç”¨ Kind åˆ›å»ºå«æœ‰ä¸¤ä¸ª Node çš„ kubernetes é›†ç¾¤</h2><h3 id="1-åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#1-åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="1. åˆ›å»ºé…ç½®æ–‡ä»¶"></a>1. åˆ›å»ºé…ç½®æ–‡ä»¶</h3><p>è¿™é‡Œæˆ‘åˆ›å»ºäº†ä¸¤ä¸ª Nodeï¼Œä½¿ç”¨ä»¥ä¸‹é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘½åä¸º <code>kind.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># a cluster with 1 control-plane nodes and 2 workers</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kind.x-k8s.io/v1alpha4</span><br><span class="hljs-attr">nodes:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">control-plane</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span><br></code></pre></td></tr></table></figure>
<h3 id="2-åˆ›å»ºé›†ç¾¤"><a href="#2-åˆ›å»ºé›†ç¾¤" class="headerlink" title="2. åˆ›å»ºé›†ç¾¤"></a>2. åˆ›å»ºé›†ç¾¤</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo kind create cluster --config kind.yaml<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„ç‚¹æœ‰ï¼š</p>
<ol>
<li>ä¸è¦è®¾ç½®é›†ç¾¤ nameï¼Œåœ¨æˆ‘æœ¬åœ°ï¼Œå¦‚æœè®¾ç½®äº† name ä¼šå¯¼è‡´ kubeconfig æ— æ³•å¯¼å‡ºã€‚</li>
<li>è¦ä½¿ç”¨ sudoï¼Œåœ¨æˆ‘æœ¬åœ°ï¼Œå¦‚æœä¸ä½¿ç”¨ sudo ä¼šå¯¼è‡´æ— æ³•åˆ›å»ºé›†ç¾¤ï¼ŒåŸå› æœªçŸ¥ã€‚</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">Creating cluster <span class="hljs-string">&quot;kind&quot;</span> ...<br> âœ“ Ensuring node image (kindest/node:v1.21.1) ğŸ–¼<br> âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦  <br> âœ“ Writing configuration ğŸ“œ <br> âœ“ Starting control-plane ğŸ•¹ï¸ <br> âœ“ Installing CNI ğŸ”Œ <br> âœ“ Installing StorageClass ğŸ’¾ <br> âœ“ Joining worker nodes ğŸšœ <br>Set kubectl context to <span class="hljs-string">&quot;kind-kind&quot;</span><br>You can now use your cluster with:<br><br>kubectl cluster-info --context kind-kind<br></code></pre></td></tr></table></figure>
<p>å¦‚æœå‡ºç°ä»¥ä¸Šä¿¡æ¯è¡¨ç¤ºåˆ›å»ºæˆåŠŸï¼Œå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥ã€‚</p>
<h3 id="3-å¯¼å‡º-kubeconfig"><a href="#3-å¯¼å‡º-kubeconfig" class="headerlink" title="3. å¯¼å‡º kubeconfig"></a>3. å¯¼å‡º kubeconfig</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">kind export kubeconfig<br></code></pre></td></tr></table></figure>
<p>å¦‚æœä¸ä½¿ç”¨è¿™ä¸€æ­¥ï¼Œä¼šå¯¼è‡´ä½¿ç”¨ <code>kubectl</code> çš„æ—¶å€™å¿…é¡»åŠ ä¸Š <code>sudo</code>ï¼Œå¦åˆ™æ— æ³•è¿æ¥åˆ° kubernetesã€‚</p>
<h2 id="3-å®‰è£…-kubernetes-dashboard"><a href="#3-å®‰è£…-kubernetes-dashboard" class="headerlink" title="3. å®‰è£… kubernetes-dashboard"></a>3. å®‰è£… kubernetes-dashboard</h2><h3 id="1-ä½¿ç”¨-helm-å®‰è£…-dashboard"><a href="#1-ä½¿ç”¨-helm-å®‰è£…-dashboard" class="headerlink" title="1. ä½¿ç”¨ helm å®‰è£… dashboard"></a>1. ä½¿ç”¨ helm å®‰è£… dashboard</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Add kubernetes-dashboard repository</span><br>helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/<br>helm repo update<br><span class="hljs-comment"># Deploy a Helm Release named &quot;dashboard&quot; using the kubernetes-dashboard chart</span><br>helm install dashboard kubernetes-dashboard/kubernetes-dashboard<br></code></pre></td></tr></table></figure>
<h3 id="2-è½¬å‘-dashboard-pod"><a href="#2-è½¬å‘-dashboard-pod" class="headerlink" title="2. è½¬å‘ dashboard pod"></a>2. è½¬å‘ dashboard pod</h3><p>è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯åœ¨æœ¬åœ°è®¿é—®éƒ¨ç½²äº† dashboard çš„ pod</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> POD_NAME=$(kubectl get pods -n default -l <span class="hljs-string">&quot;app.kubernetes.io/name=kubernetes-dashboard,app.kubernetes.io/instance=dashboard&quot;</span> -o jsonpath=<span class="hljs-string">&quot;&#123;.items[0].metadata.name&#125;&quot;</span>)<br>  <span class="hljs-built_in">echo</span> https://127.0.0.1:8443/<br>  kubectl -n default port-forward <span class="hljs-variable">$POD_NAME</span> 8443:8443<br></code></pre></td></tr></table></figure>
<p>ä¹‹åä¼šæç¤º</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">Forwarding from 127.0.0.1:8443 -&gt; 8443<br>Forwarding from [::1]:8443 -&gt; 8443<br></code></pre></td></tr></table></figure>
<p>è¯´æ˜è½¬å‘æˆåŠŸï¼Œæ­¤æ—¶è®¿é—® <a href="https://127.0.0.1:8443/">https://127.0.0.1:8443/</a> ï¼Œæ³¨æ„æ˜¯ https</p>
<h3 id="2-1-æˆ–è€…å¯ä»¥ä¸è½¬å‘ä½¿ç”¨-service-æš´éœ²æœåŠ¡"><a href="#2-1-æˆ–è€…å¯ä»¥ä¸è½¬å‘ä½¿ç”¨-service-æš´éœ²æœåŠ¡" class="headerlink" title="2.1 æˆ–è€…å¯ä»¥ä¸è½¬å‘ä½¿ç”¨ service æš´éœ²æœåŠ¡"></a>2.1 æˆ–è€…å¯ä»¥ä¸è½¬å‘ä½¿ç”¨ service æš´éœ²æœåŠ¡</h3><p>è¿™é‡Œä¸ºäº†æµ‹è¯•ä½¿ç”¨äº† NodePort æ–¹å¼æš´éœ²</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl expose deploy dashboard-kubernetes-dashboard --name dashboard-nodeport --port 8443 --target-port=8443 --<span class="hljs-built_in">type</span>=NodePort<br></code></pre></td></tr></table></figure>
<h3 id="3-ç”Ÿæˆ-token"><a href="#3-ç”Ÿæˆ-token" class="headerlink" title="3. ç”Ÿæˆ token"></a>3. ç”Ÿæˆ token</h3><p>ä¸å‡ºæ„å¤– dashboard éœ€è¦ token æ¥ç™»å½•ï¼Œä½¿ç”¨ä»¥ä¸‹æ­¥éª¤æ¥ç”Ÿæˆ tokenï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl create serviceaccount dashboard -n default<br>kubectl create rolebinding def-ns-admin --clusterrole=admin --serviceaccount=default:def-ns-admin<br>kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=default:dashboard<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl describe sa dashboard<br>Name:                dashboard<br>Namespace:           default<br>Labels:              &lt;none&gt;<br>Annotations:         &lt;none&gt;<br>Image pull secrets:  &lt;none&gt;<br>Mountable secrets:   dashboard-token-vzzjn<br>Tokens:              dashboard-token-vzzjn<br>Events:              &lt;none&gt;<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ° <code>dashboard-token-vzzjn</code> å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ tokenï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ˜¾ç¤ºå…·ä½“å†…å®¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl describe secret dashboard-token-vzzjn<br></code></pre></td></tr></table></figure>
<p>ä¹‹åå°±å¯ä»¥å°†å…·ä½“çš„ token ç²˜è´´åœ¨ dashboard ä¸­ç™»å½•ã€‚</p>
]]></content>
      <tags>
        <tag>k8s, kind</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux çš„ä¸€äº›ä½¿ç”¨å¿ƒå¾—</title>
    <url>/linux/linux/</url>
    <content><![CDATA[<h1 id="å…³é—­-kde-æ–‡ä»¶ç´¢å¼•ç¨‹åº"><a href="#å…³é—­-kde-æ–‡ä»¶ç´¢å¼•ç¨‹åº" class="headerlink" title="å…³é—­ kde æ–‡ä»¶ç´¢å¼•ç¨‹åº"></a>å…³é—­ kde æ–‡ä»¶ç´¢å¼•ç¨‹åº</h1><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">balooctl <span class="hljs-built_in">suspend</span><br>balooctl <span class="hljs-built_in">disable</span><br></code></pre></td></tr></table></figure>
<h1 id="Linux-ä¸‹æŠ“-HTTPS-åŒ…"><a href="#Linux-ä¸‹æŠ“-HTTPS-åŒ…" class="headerlink" title="Linux ä¸‹æŠ“ HTTPS åŒ…"></a>Linux ä¸‹æŠ“ HTTPS åŒ…</h1><h2 id="ä½¿ç”¨-MITMProxy"><a href="#ä½¿ç”¨-MITMProxy" class="headerlink" title="ä½¿ç”¨ MITMProxy"></a>ä½¿ç”¨ MITMProxy</h2><ol>
<li>è¿è¡Œ MITMProxy</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker run --<span class="hljs-built_in">rm</span> -it -p 18080:8080 -p 127.0.0.1:8081:8081 -v ~/.mitmproxy:/home/mitmproxy/.mitmproxy  mitmproxy/mitmproxy mitmweb --web-host 0.0.0.0 --<span class="hljs-built_in">set</span> block_global=<span class="hljs-literal">false</span> --<span class="hljs-built_in">set</span> ssl_insecure=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<ol>
<li>å¯¼å…¥è¯ä¹¦è‡³æµè§ˆå™¨æˆ–å…¶ä»–å·¥å…·</li>
<li>ä½¿ç”¨ä»£ç†è®¿é—® HTTPS é¡µé¢</li>
</ol>
<h1 id="æ›´æ–°-ubuntu-22-04-ä¹‹åç½‘æ˜“äº‘éŸ³ä¹æ— æ³•ä½¿ç”¨"><a href="#æ›´æ–°-ubuntu-22-04-ä¹‹åç½‘æ˜“äº‘éŸ³ä¹æ— æ³•ä½¿ç”¨" class="headerlink" title="æ›´æ–° ubuntu 22.04 ä¹‹åç½‘æ˜“äº‘éŸ³ä¹æ— æ³•ä½¿ç”¨"></a>æ›´æ–° ubuntu 22.04 ä¹‹åç½‘æ˜“äº‘éŸ³ä¹æ— æ³•ä½¿ç”¨</h1><p>ä¿®æ”¹ <code>/opt/netease/netease-cloud-music/netease-cloud-music.bash</code> ä¸ºä»¥ä¸‹å†…å®¹<br><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>HERE=<span class="hljs-string">&quot;<span class="hljs-subst">$(dirname <span class="hljs-string">&quot;<span class="hljs-subst">$(readlink -f <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;0&#125;</span>&quot;</span>)</span>&quot;</span>)</span>&quot;</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;HERE&#125;</span>&quot;</span>/libs<br><span class="hljs-built_in">export</span> QT_PLUGIN_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;HERE&#125;</span>&quot;</span>/plugins <br><span class="hljs-built_in">export</span> QT_QPA_PLATFORM_PLUGIN_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;HERE&#125;</span>&quot;</span>/plugins/platforms<br><span class="hljs-built_in">cd</span> /lib/x86_64-linux-gnu/<br><span class="hljs-built_in">exec</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;HERE&#125;</span>&quot;</span>/netease-cloud-music <span class="hljs-variable">$@</span><br><br></code></pre></td></tr></table></figure></p>
<h1 id="å…³é—­æ— ç”¨å¯åŠ¨é¡¹"><a href="#å…³é—­æ— ç”¨å¯åŠ¨é¡¹" class="headerlink" title="å…³é—­æ— ç”¨å¯åŠ¨é¡¹"></a>å…³é—­æ— ç”¨å¯åŠ¨é¡¹</h1><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŸ¥çœ‹å¯åŠ¨é¡¹</span><br><span class="hljs-built_in">ls</span> -l /etc/xdg/autostart<br><br><span class="hljs-comment"># é‡å‘½å</span><br>sudo <span class="hljs-built_in">mv</span> something something.bak<br></code></pre></td></tr></table></figure>
<h1 id="Vmware-æ›´æ–°å†…æ ¸å¤±è´¥"><a href="#Vmware-æ›´æ–°å†…æ ¸å¤±è´¥" class="headerlink" title="Vmware æ›´æ–°å†…æ ¸å¤±è´¥"></a>Vmware æ›´æ–°å†…æ ¸å¤±è´¥</h1><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/mkubecek/vmware-host-modules.git<br>git checkout &lt;your_version&gt;<br>sudo make<br>sudo make install<br></code></pre></td></tr></table></figure>
<h1 id="åŒç³»ç»Ÿ-Windows-æ›´æ–°å¤±è´¥"><a href="#åŒç³»ç»Ÿ-Windows-æ›´æ–°å¤±è´¥" class="headerlink" title="åŒç³»ç»Ÿ Windows æ›´æ–°å¤±è´¥"></a>åŒç³»ç»Ÿ Windows æ›´æ–°å¤±è´¥</h1><p>æˆ‘è¿™é‡ŒåŒç³»ç»Ÿ Windows æ›´æ–°å¤±è´¥çš„åŸå› æ˜¯ Windows å¼•å¯¼å‡ºç°äº†é—®é¢˜ï¼Œå¯ä»¥è¿›å…¥ Windows è¾“å…¥ <code>msconfig</code> æŸ¥çœ‹å¼•å¯¼é€‰é¡¹å¡ä¸‹æ˜¯å¦æœ‰å†…å®¹ï¼Œæˆ‘æ˜¯ç”¨è¿‡ systemd boot æ¥å¼•å¯¼çš„ Windowsï¼Œæ‰€ä»¥æ²¡æœ‰å‡ºç°å†…å®¹ã€‚</p>
<p>åœ¨ BIOS ä¸­æ›´æ”¹æˆç›´æ¥å¼•å¯¼ Windows ä¹‹åä¾¿å¯ä»¥æ­£å¸¸æ›´æ–°äº†ã€‚</p>
<h1 id="æŒ‰æ—¶é—´é™åºæœ€è¿‘å®‰è£…çš„ç¨‹åº"><a href="#æŒ‰æ—¶é—´é™åºæœ€è¿‘å®‰è£…çš„ç¨‹åº" class="headerlink" title="æŒ‰æ—¶é—´é™åºæœ€è¿‘å®‰è£…çš„ç¨‹åº"></a>æŒ‰æ—¶é—´é™åºæœ€è¿‘å®‰è£…çš„ç¨‹åº</h1><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">ls</span> -1t /var/log/dpkg.log*); <span class="hljs-keyword">do</span> <br>      zcat -f <span class="hljs-variable">$x</span> |<span class="hljs-built_in">tac</span> |grep -e <span class="hljs-string">&quot; install &quot;</span> -e <span class="hljs-string">&quot; upgrade &quot;</span>; <br><span class="hljs-keyword">done</span> | awk -F <span class="hljs-string">&quot;:a&quot;</span> <span class="hljs-string">&#x27;&#123;print $1 &quot; :a&quot; $2&#125;&#x27;</span> |column -t<br></code></pre></td></tr></table></figure>
<h1 id="å¸¸ç”¨çš„ä¸€äº›-gnome-extensions"><a href="#å¸¸ç”¨çš„ä¸€äº›-gnome-extensions" class="headerlink" title="å¸¸ç”¨çš„ä¸€äº› gnome extensions"></a>å¸¸ç”¨çš„ä¸€äº› gnome extensions</h1><h2 id="Unite"><a href="#Unite" class="headerlink" title="Unite"></a>Unite</h2><p>æœ€å¤§åŒ–æ—¶éšè—æ ‡é¢˜æ </p>
<h2 id="Clear-Top-Bar"><a href="#Clear-Top-Bar" class="headerlink" title="Clear Top Bar"></a>Clear Top Bar</h2><p>çŠ¶æ€æ å˜æˆé€æ˜çš„</p>
<h2 id="ddterm"><a href="#ddterm" class="headerlink" title="ddterm"></a>ddterm</h2><p>æŒ‰ <code>F10</code> å¿«é€Ÿå¯åŠ¨å‘½ä»¤è¡Œï¼Œå†æŒ‰ <code>F10</code> éšè—ï¼Œååˆ†æ–¹ä¾¿</p>
<h2 id="Desktop-Icons-NG-DING"><a href="#Desktop-Icons-NG-DING" class="headerlink" title="Desktop Icons NG(DING)"></a>Desktop Icons NG(DING)</h2><p>åœ¨æ¡Œé¢ä¸Šæ˜¾ç¤ºå›¾æ ‡</p>
<h2 id="Lock-Keys"><a href="#Lock-Keys" class="headerlink" title="Lock Keys"></a>Lock Keys</h2><p>å¯ä»¥æ˜¾ç¤ºå½“å‰å¤§å°å†™çŠ¶å†µ</p>
<h2 id="NetSpeed"><a href="#NetSpeed" class="headerlink" title="NetSpeed"></a>NetSpeed</h2><p>æ˜¾ç¤ºå½“å‰ç½‘é€Ÿ</p>
<h2 id="TopIcons-Plusï¼ˆåœ¨-gnome-40-ä¹‹åä½¿ç”¨-Ubuntu-Appindicators-æ›¿ä»£ï¼‰"><a href="#TopIcons-Plusï¼ˆåœ¨-gnome-40-ä¹‹åä½¿ç”¨-Ubuntu-Appindicators-æ›¿ä»£ï¼‰" class="headerlink" title="TopIcons Plusï¼ˆåœ¨ gnome 40 ä¹‹åä½¿ç”¨ Ubuntu Appindicators æ›¿ä»£ï¼‰"></a>TopIcons Plusï¼ˆåœ¨ gnome 40 ä¹‹åä½¿ç”¨ Ubuntu Appindicators æ›¿ä»£ï¼‰</h2><p>åœ¨é¡¶éƒ¨æ˜¾ç¤ºå›¾æ ‡</p>
<h2 id="Dash-to-Dock"><a href="#Dash-to-Dock" class="headerlink" title="Dash to Dock"></a>Dash to Dock</h2><p>åœ¨åº•éƒ¨æ™ºèƒ½æ˜¾ç¤ºä¸€ä¸ª Dock</p>
<h1 id="æ¢-MAC-åœ°å€"><a href="#æ¢-MAC-åœ°å€" class="headerlink" title="æ¢ MAC åœ°å€"></a>æ¢ MAC åœ°å€</h1><p>æœ‰çš„æ—¶å€™éœ€è¦æ›´æ¢ linux çš„ ip åœ°å€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo ifconfig eth0 down<br>sudo ifconfig wlo1 hw ether 02:42:41:7d:b7:6e<br>sudo ifconfig wlo1 up<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œ <code>eth0</code> æ˜¯ç½‘ç»œ interfaceï¼Œether ä¹‹åçš„å‚æ•°å°±æ˜¯ MAC åœ°å€</p>
<h1 id="è¾“å…¥æ³•"><a href="#è¾“å…¥æ³•" class="headerlink" title="è¾“å…¥æ³•"></a>è¾“å…¥æ³•</h1><h2 id="Fcitx-å¤±æ•ˆ"><a href="#Fcitx-å¤±æ•ˆ" class="headerlink" title="Fcitx å¤±æ•ˆ"></a>Fcitx å¤±æ•ˆ</h2><ul>
<li><p>ä½¿ç”¨ im-config ä¿®å¤</p>
</li>
<li><p>å¯èƒ½æ˜¯ fcitx æ²¡æœ‰æ­£å¸¸å¯åŠ¨ï¼Œå³è¿˜æ˜¯ ibusï¼Œå¯ä»¥ä¿®æ”¹ ~/.pam_environment</p>
</li>
<li><p>ä½¿ç”¨ <code>fcitx5-diagnose</code> å‘½ä»¤æ ¹æ®æç¤ºè®¾ç½®ç¯å¢ƒå˜é‡</p>
</li>
<li><p>åˆ é™¤ <code>/etc/profile.d/pop-im-ibus.sh</code> ï¼ˆpop osï¼‰</p>
<p> <code>/etc/profile.d/pop-im-ibus.sh</code> ï¼ˆæºæ–‡ä»¶ï¼š /etc/gdm3/Xsession ï¼‰è®¾ç½®äº†ç¯å¢ƒå˜é‡ <code>XMODIFIERS</code> ï¼Œåœ¨ <code>/etc/X11/Xsession.d/70im-config_launch</code> ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼š</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$XMODIFIERS</span>&quot;</span> ] &amp;&amp; \  <span class="hljs-comment"># å¦‚æœç¯å¢ƒå˜é‡ XMODIFIERS æ²¡æœ‰è¢«è®¾ç½®</span><br>   ...<br>   <span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡ä»¥å¯åŠ¨ç”¨æˆ·æŒ‡å®šçš„è¾“å…¥æ³•</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>
<p> å› ä¸º <code>XMODIFIERS</code> è¢«è®¾ç½®äº†ï¼Œæ‰€ä»¥ <code>è®¾ç½®ç¯å¢ƒå˜é‡ä»¥å¯åŠ¨ç”¨æˆ·æŒ‡å®šçš„è¾“å…¥æ³•</code> æ²¡æœ‰æ‰§è¡Œï¼Œæ‰€ä»¥ fcitx æ²¡æœ‰è¢«å¯åŠ¨ã€‚</p>
<p> <code>/etc/profile.d/pop-im-ibus.sh</code> ç¬¬ä¸€æ¬¡å‡ºç°äº <code>pop-os_20.10_amd64_intel_4.iso</code> ï¼ˆå‘å¸ƒäº 2020 å¹´ 12 æœˆä¸­æ—¬ï¼‰</p>
<p> ç›¸å…³ issueï¼Œ<a href="https://github.com/pop-os/pop/issues/1445">https://github.com/pop-os/pop/issues/1445</a></p>
</li>
</ul>
<h1 id="Dash-to-dock"><a href="#Dash-to-dock" class="headerlink" title="Dash to dock"></a>Dash to dock</h1><h2 id="Dash-to-dock-é‡å é—®é¢˜"><a href="#Dash-to-dock-é‡å é—®é¢˜" class="headerlink" title="Dash to dock é‡å é—®é¢˜"></a>Dash to dock é‡å é—®é¢˜</h2><p>   Pop os è‡ªå¸¦çš„ Dock ä¸ Dash to dock å‘ç”Ÿäº†é‡å </p>
   <figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cd /usr/share/gnome-shell/extensions<br>sudo mv cosmic-dock@system76.com cosmic-dock@system76.com.bak # å…³é—­è‡ªå¸¦çš„ dock<br></code></pre></td></tr></table></figure>
<p>   ä¹‹åé‡å¯ gnome å³å¯è§£å†³</p>
<h1 id="Alt-Tab-æ—¶é˜»æ­¢ç›¸åŒåº”ç”¨å åŠ "><a href="#Alt-Tab-æ—¶é˜»æ­¢ç›¸åŒåº”ç”¨å åŠ " class="headerlink" title="Alt + Tab æ—¶é˜»æ­¢ç›¸åŒåº”ç”¨å åŠ "></a>Alt + Tab æ—¶é˜»æ­¢ç›¸åŒåº”ç”¨å åŠ </h1><p>åœ¨ gnome è®¾ç½®ä¸­ï¼Œæ‰“å¼€ keyboard shortcutï¼Œå°† <code>Switch windows</code> è®¾ç½®ä¸º <code>Alt + Tab</code> ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ <code>Switch applications</code>ã€‚</p>
<p>å‚è€ƒï¼š<a href="https://superuser.com/questions/394376/how-to-prevent-gnome-shells-alttab-from-grouping-windows-from-similar-apps">https://superuser.com/questions/394376/how-to-prevent-gnome-shells-alttab-from-grouping-windows-from-similar-apps</a></p>
<h1 id="fluxion"><a href="#fluxion" class="headerlink" title="fluxion"></a>fluxion</h1><h2 id="æ‰«æä¸åˆ°çƒ­ç‚¹"><a href="#æ‰«æä¸åˆ°çƒ­ç‚¹" class="headerlink" title="æ‰«æä¸åˆ°çƒ­ç‚¹"></a>æ‰«æä¸åˆ°çƒ­ç‚¹</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">sudo airmon-ng<br>sudo airmon-ng start fluxwl0<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> FLUXIONAirmonNG=1<br></code></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤åå†è¿è¡Œ fluxion å³å¯ã€‚</p>
<h2 id="è§£é™¤-53-ç«¯å£è¢«-systemd-resolved-å ç”¨"><a href="#è§£é™¤-53-ç«¯å£è¢«-systemd-resolved-å ç”¨" class="headerlink" title="è§£é™¤ 53 ç«¯å£è¢« systemd-resolved å ç”¨"></a>è§£é™¤ 53 ç«¯å£è¢« systemd-resolved å ç”¨</h2><ol>
<li>å…ˆåœç”¨ systemd-resolved æœåŠ¡</li>
</ol>
<figure class="highlight nsis"><table><tr><td class="code"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl stop <span class="hljs-params">system</span>d-resolved<br></code></pre></td></tr></table></figure>
<ol>
<li>ç¼–è¾‘ /etc/systemd/resolved.conf æ–‡ä»¶</li>
</ol>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">vi <span class="hljs-regexp">/etc/</span>systemd/resolved.conf<br></code></pre></td></tr></table></figure>
<ol>
<li>æ¢ä¸‹é¢è¯´æ˜æ›´æ”¹ï¼Œç„¶åæŒ‰ä¸€ä¸‹â€œescâ€é”®ï¼Œå†è¾“å…¥â€œ:wqâ€ï¼ˆä¸è¦è¾“å…¥å¼•å·ï¼‰ï¼Œå›è½¦ä¿å­˜å³å¯ã€‚</li>
</ol>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Resolve]</span><br><span class="hljs-attr">DNS</span>=<span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>  <span class="hljs-comment">#å–æ¶ˆæ³¨é‡Šï¼Œå¢åŠ dns</span><br><span class="hljs-comment">#FallbackDNS=</span><br><span class="hljs-comment">#Domains=</span><br><span class="hljs-comment">#LLMNR=no</span><br><span class="hljs-comment">#MulticastDNS=no</span><br><span class="hljs-comment">#DNSSEC=no</span><br><span class="hljs-comment">#Cache=yes</span><br><span class="hljs-attr">DNSStubListener</span>=<span class="hljs-literal">no</span>  <span class="hljs-comment">#å–æ¶ˆæ³¨é‡Šï¼ŒæŠŠyesæ”¹ä¸ºno</span><br></code></pre></td></tr></table></figure>
<ol>
<li>æœ€åè¿è¡Œä¸‹é¢å‘½ä»¤å³å¯ã€‚</li>
</ol>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">ln -sf <span class="hljs-regexp">/run/</span>systemd<span class="hljs-regexp">/resolve/</span>resolv.conf <span class="hljs-regexp">/etc/</span>resolv.conf<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
  </entry>
  <entry>
    <title>Rustçš„ä¸€äº›å­¦ä¹ å¿ƒå¾—</title>
    <url>/rust/rust/</url>
    <content><![CDATA[<h1 id="Rust-æ ‡å‡†åº“-trait"><a href="#Rust-æ ‡å‡†åº“-trait" class="headerlink" title="Rust æ ‡å‡†åº“ trait"></a>Rust æ ‡å‡†åº“ trait</h1><p>å‡è®¾æœ‰ä»¥ä¸‹å˜é‡ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">t</span> = T::<span class="hljs-title function_ invoke__">new</span>()<br></code></pre></td></tr></table></figure>
<h2 id="impl-From-lt-U-gt-for-T"><a href="#impl-From-lt-U-gt-for-T" class="headerlink" title="impl From&lt;U&gt; for T"></a><code>impl From&lt;U&gt; for T</code></h2><p>å¦‚æœä¸º <code>T</code> å®ç°äº† <code>From&lt;U&gt;</code> åˆ™å¯ä»¥é€šè¿‡ <code>T::from(U)</code> å¾—åˆ° <code>T</code>ã€‚</p>
<p>ä¾‹å¦‚ <code>String</code> å®ç°äº† <code>From&lt;&amp;str&gt;</code>ï¼Œæ‰€ä»¥ <code>String</code> å¯ä»¥ä» <code>&amp;str</code> ç”Ÿæˆã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">string</span> = <span class="hljs-string">&quot;hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">other_string</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br><br><span class="hljs-built_in">assert_eq!</span>(string, other_string);<br></code></pre></td></tr></table></figure>
<p><code>impl Into&lt;U&gt; for T</code></p>
<p>å¦‚æœä¸º <code>T</code> å®ç°äº† <code>Into&lt;U&gt;</code> åˆ™å¯ä»¥é€šè¿‡ <code>t.into()</code> æ¶ˆè€—è‡ªå·±å¾—åˆ° <code>U</code>ã€‚</p>
<p>ä¾‹å¦‚ <code>String</code> ç±»å‹å®ç°äº† <code>Into&lt;Vec&lt;u8&gt;&gt;</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">is_hello</span>&lt;T: <span class="hljs-built_in">Into</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;&gt;&gt;(s: T) &#123;<br>   <span class="hljs-keyword">let</span> <span class="hljs-variable">bytes</span> = <span class="hljs-string">b&quot;hello&quot;</span>.<span class="hljs-title function_ invoke__">to_vec</span>();<br>   <span class="hljs-built_in">assert_eq!</span>(bytes, s.<span class="hljs-title function_ invoke__">into</span>());<br>&#125;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-string">&quot;hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br><span class="hljs-title function_ invoke__">is_hello</span>(s);<br></code></pre></td></tr></table></figure>
<p>åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œç”¨æ¥æ¥æ”¶å¤šç§ç±»å‹çš„å‚æ•°ï¼Œå¦‚ <code>Into&lt;String&gt;</code> å¯ä»¥åŒæ—¶æ¥æ”¶ <code>String</code> å’Œ <code>&amp;str</code>ã€‚</p>
<h2 id="impl-AsRef-lt-U-gt-for-T"><a href="#impl-AsRef-lt-U-gt-for-T" class="headerlink" title="impl AsRef&lt;U&gt; for T"></a><code>impl AsRef&lt;U&gt; for T</code></h2><p>å¦‚æœä¸º <code>T</code> å®ç°äº† <code>AsRef&lt;U&gt;</code> åˆ™å¯ä»¥é€šè¿‡ <code>t.as_ref()</code> å¾—åˆ° <code>&amp;U</code>ã€‚</p>
<p>æ³¨ï¼š</p>
<ol>
<li>ä¸ <code>Into&lt;U&gt;</code> ä¸åŒçš„æ˜¯ï¼Œ<code>AsRef&lt;U&gt;</code> åªæ˜¯ç±»å‹è½¬æ¢ï¼Œ<code>t</code> å¯¹è±¡æœ¬èº«æ²¡æœ‰è¢«æ¶ˆè€—ï¼›</li>
<li><code>T: AsRef&lt;U&gt;</code> ä¸­çš„ <code>T</code>ï¼Œå¯ä»¥æ¥å— èµ„æºæ‹¥æœ‰è€…ï¼ˆownedï¼‰ç±»å‹ï¼Œå…±äº«å¼•ç”¨ï¼ˆshared referrenceï¼‰ç±»å‹ ï¼Œå¯å˜å¼•ç”¨ï¼ˆmutable referrenceï¼‰ç±»å‹ã€‚</li>
</ol>
<p>ä¾‹å¦‚ <code>String</code> å’Œ <code>&amp;str</code> éƒ½å®ç°äº† <code>AsRef&lt;str&gt;</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">is_hello</span>&lt;T: <span class="hljs-built_in">AsRef</span>&lt;<span class="hljs-type">str</span>&gt;&gt;(s: T) &#123;<br>   <span class="hljs-built_in">assert_eq!</span>(<span class="hljs-string">&quot;hello&quot;</span>, s.<span class="hljs-title function_ invoke__">as_ref</span>());<br>&#125;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-string">&quot;hello&quot;</span>;<br><span class="hljs-title function_ invoke__">is_hello</span>(s);<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-string">&quot;hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br><span class="hljs-title function_ invoke__">is_hello</span>(s);<br></code></pre></td></tr></table></figure>
<h2 id="impl-AsMut-lt-U-gt-for-T"><a href="#impl-AsMut-lt-U-gt-for-T" class="headerlink" title="impl AsMut&lt;U&gt; for T"></a><code>impl AsMut&lt;U&gt; for T</code></h2><p>å¦‚æœä¸º <code>T</code> å®ç°äº† <code>AsRef&lt;U&gt;</code> åˆ™å¯ä»¥é€šè¿‡ <code>t.as_mut()</code> å¾—åˆ° <code>&amp;mut U</code>ã€‚</p>
<h2 id="impl-Borror-lt-U-gt-for-T"><a href="#impl-Borror-lt-U-gt-for-T" class="headerlink" title="impl Borror&lt;U&gt; for T"></a><code>impl Borror&lt;U&gt; for T</code></h2><p>å¦‚æœ <code>T</code> å®ç°äº† <code>Borrow&lt;U&gt;</code>ï¼Œé‚£ä¹ˆï¼Œ<code>t</code> å¯æ‰§è¡Œ <code>.borrow()</code> æ“ä½œï¼Œå³ <code>t.borrow()</code>ã€‚æ“ä½œçš„ç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç±»å‹ä¸º <code>&amp;U</code> çš„æ–°å¼•ç”¨ã€‚</p>
<p><code>Borrow</code> å¯ä»¥è®¤ä¸ºæ˜¯ <code>AsRef</code> çš„ä¸¥æ ¼ç‰ˆæœ¬ï¼Œå®ƒå¯¹æ™®é€‚å¼•ç”¨æ“ä½œçš„å‰åç±»å‹ä¹‹é—´é™„åŠ äº†ä¸€äº›å…¶å®ƒé™åˆ¶ã€‚</p>
<p><code>Borrow</code> çš„å‰åç±»å‹ä¹‹é—´è¦æ±‚å¿…é¡»æœ‰å†…éƒ¨ç­‰ä»·æ€§ã€‚ä¸å…·æœ‰è¿™ä¸ªç­‰ä»·æ€§çš„ä¸¤ä¸ªç±»å‹ä¹‹é—´ï¼Œä¸èƒ½å®ç° <code>Borrow</code>ã€‚</p>
<p><code>AsRef</code> æ›´é€šç”¨ï¼Œæ›´æ™®éï¼Œè¦†ç›–ç±»å‹æ›´å¤šï¼Œæ˜¯ <code>Borrow</code> çš„è¶…é›†ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::borrow::Borrow;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">check</span>&lt;T: Borrow&lt;<span class="hljs-type">str</span>&gt;&gt;(s: T) &#123;<br>    <span class="hljs-built_in">assert_eq!</span>(<span class="hljs-string">&quot;Hello&quot;</span>, s.<span class="hljs-title function_ invoke__">borrow</span>());<br>&#125;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-string">&quot;Hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br><br><span class="hljs-title function_ invoke__">check</span>(s);<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-string">&quot;Hello&quot;</span>;<br><br><span class="hljs-title function_ invoke__">check</span>(s);<br></code></pre></td></tr></table></figure>
<h2 id="impl-BorrowMut-lt-U-gt-for-T"><a href="#impl-BorrowMut-lt-U-gt-for-T" class="headerlink" title="impl BorrowMut&lt;U&gt; for T"></a><code>impl BorrowMut&lt;U&gt; for T</code></h2><p>å¦‚æœ <code>T</code> å®ç°äº† <code>BorrowMut&lt;U&gt;</code>ï¼Œé‚£ä¹ˆï¼Œ<code>t</code> å¯æ‰§è¡Œ <code>.borrow_mut()</code> æ“ä½œï¼Œå³ <code>t.borrow_mut()</code>ã€‚æ“ä½œçš„ç»“æœæˆ‘ä»¬å¾—åˆ°ç±»å‹ä¸º <code>&amp;mut U</code> çš„ä¸€ä¸ªå¯å˜ï¼ˆmutableï¼‰å¼•ç”¨ã€‚</p>
<h2 id="impl-ToOwned-for-T"><a href="#impl-ToOwned-for-T" class="headerlink" title="impl ToOwned for T"></a><code>impl ToOwned for T</code></h2><p><code>ToOwned</code> ä¸º <code>Clone</code> çš„æ™®é€‚ç‰ˆæœ¬ã€‚å®ƒæä¾›äº† <code>.to_owned()</code> æ–¹æ³•ï¼Œç”¨äºç±»å‹è½¬æ¢ã€‚</p>
<p>æœ‰äº›å®ç°äº† <code>Clone</code> çš„ç±»å‹ <code>T</code> å¯ä»¥ä»å¼•ç”¨çŠ¶æ€å®ä¾‹ <code>&amp;T</code> é€šè¿‡ <code>.clone()</code> æ–¹æ³•ï¼Œç”Ÿæˆå…·æœ‰æ‰€æœ‰æƒçš„ <code>T</code> çš„å®ä¾‹ã€‚ä½†æ˜¯å®ƒåªèƒ½ç”± <code>&amp;T</code> ç”Ÿæˆ <code>T</code>ã€‚è€Œå¯¹äºå…¶å®ƒå½¢å¼çš„å¼•ç”¨ï¼Œ<code>Clone</code> å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚</p>
<p>è€Œ <code>ToOwned</code> trait èƒ½å¤Ÿä»ä»»æ„å¼•ç”¨ç±»å‹å®ä¾‹ï¼Œç”Ÿæˆå…·æœ‰æ‰€æœ‰æƒçš„ç±»å‹å®ä¾‹ã€‚</p>
<h2 id="impl-Deref-for-T"><a href="#impl-Deref-for-T" class="headerlink" title="impl Deref for T"></a><code>impl Deref for T</code></h2><p><code>Deref</code> æ˜¯ <code>deref</code> æ“ä½œç¬¦ <code>*</code> çš„ traitï¼Œæ¯”å¦‚ <code>*v</code>ã€‚</p>
<p>ä¸€èˆ¬ç†è§£ï¼Œ<code>*t</code> æ“ä½œï¼Œæ˜¯ <code>&amp;t</code> çš„åå‘æ“ä½œï¼Œå³è¯•å›¾ç”±èµ„æºçš„å¼•ç”¨è·å–åˆ°èµ„æºçš„æ‹·è´ï¼ˆå¦‚æœèµ„æºç±»å‹å®ç°äº† <code>Copy</code>ï¼‰ï¼Œæˆ–æ‰€æœ‰æƒï¼ˆèµ„æºç±»å‹æ²¡æœ‰å®ç° <code>Copy</code>ï¼‰ã€‚</p>
<p>Rust ä¸­ï¼Œæœ¬æ“ä½œç¬¦è¡Œä¸ºå¯ä»¥é‡è½½ã€‚è¿™ä¹Ÿæ˜¯ Rust æ“ä½œç¬¦çš„åŸºæœ¬ç‰¹ç‚¹ã€‚æœ¬èº«æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ã€‚</p>
<h3 id="å¼ºåˆ¶éšå¼è½¬æ¢ï¼ˆcoercionï¼‰"><a href="#å¼ºåˆ¶éšå¼è½¬æ¢ï¼ˆcoercionï¼‰" class="headerlink" title="å¼ºåˆ¶éšå¼è½¬æ¢ï¼ˆcoercionï¼‰"></a>å¼ºåˆ¶éšå¼è½¬æ¢ï¼ˆcoercionï¼‰</h3><p><code>Deref</code> ç¥å¥‡çš„åœ°æ–¹å¹¶ä¸åœ¨æœ¬èº« <code>è§£å¼•</code> è¿™ä¸ªæ„ä¹‰ä¸Šï¼ŒRust çš„è®¾è®¡è€…åœ¨å®ƒä¹‹ä¸Šé™„åŠ äº†ä¸€ä¸ªç‰¹æ€§ï¼š<code>å¼ºåˆ¶éšå¼è½¬æ¢</code>ï¼Œè¿™æ‰æ˜¯å®ƒç¥å¥‡ä¹‹å¤„ã€‚</p>
<p>è¿™ç§éšå¼è½¬æ¢çš„è§„åˆ™ä¸ºï¼š</p>
<p>ä¸€ä¸ªç±»å‹ä¸º <code>T</code> çš„å¯¹è±¡ <code>t</code>ï¼Œå¦‚æœ <code>T: Deref&lt;Target=U&gt;</code>ï¼Œé‚£ä¹ˆï¼Œç›¸å…³ <code>t</code> çš„æŸä¸ªæ™ºèƒ½æŒ‡é’ˆæˆ–å¼•ç”¨ï¼ˆæ¯”å¦‚ <code>&amp;foo</code>ï¼‰åœ¨åº”ç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨è½¬æ¢æˆ <code>&amp;U</code>ã€‚</p>
<p>ç²—çœ‹è¿™æ¡è§„åˆ™ï¼Œè²Œä¼¼æœ‰ç‚¹ç±»ä¼¼äº <code>AsRef</code>ï¼Œè€Œè·Ÿ <code>è§£å¼•</code> ä¼¼ä¹é£é©¬ç‰›ä¸ç›¸åŠã€‚å®é™…é‡Œé¢æœ‰äº›ç„å¦™ä¹‹å¤„ã€‚</p>
<p>Rust ç¼–è¯‘å™¨ä¼šåœ¨åš <code>*v</code> æ“ä½œçš„æ—¶å€™ï¼Œè‡ªåŠ¨å…ˆæŠŠ <code>v</code> åšå¼•ç”¨å½’ä¸€åŒ–æ“ä½œï¼Œå³è½¬æ¢æˆå†…éƒ¨é€šç”¨å¼•ç”¨çš„å½¢å¼ <code>&amp;v</code>ï¼Œæ•´ä¸ªè¡¨è¾¾å¼å°±å˜æˆ <code>*&amp;v</code>ã€‚è¿™é‡Œé¢æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>æŠŠå…¶å®ƒç±»å‹çš„æŒ‡é’ˆï¼ˆæ¯”å¦‚åœ¨åº“ä¸­å®šä¹‰çš„ï¼Œ<code>Box</code>, <code>Rc</code>, <code>Arc</code>, <code>Cow</code> ç­‰ï¼‰ï¼Œè½¬æˆå†…éƒ¨æ ‡å‡†å½¢å¼ <code>&amp;v</code>ï¼›</li>
<li>æŠŠå¤šé‡ <code>&amp;</code> ï¼ˆæ¯”å¦‚ï¼š<code>&amp;&amp;&amp;&amp;&amp;&amp;&amp;v</code>ï¼‰ï¼Œç®€åŒ–æˆ <code>&amp;v</code>ï¼ˆé€šè¿‡æ’å…¥è¶³å¤Ÿæ•°é‡çš„ <code>*</code> è¿›è¡Œè§£å¼•ï¼‰ã€‚</li>
</ol>
<p>æ‰€ä»¥ï¼Œå®ƒå®é™…ä¸Šåœ¨è§£å¼•ç”¨ä¹‹å‰åšäº†ä¸€ä¸ªå¼•ç”¨çš„å½’ä¸€åŒ–æ“ä½œã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦è½¬å‘¢ï¼Ÿ å› ä¸ºç¼–è¯‘å™¨è®¾è®¡çš„èƒ½åŠ›æ˜¯ï¼Œåªèƒ½å¤Ÿå¯¹ <code>&amp;v</code> è¿™ç§å¼•ç”¨è¿›è¡Œè§£å¼•ç”¨ã€‚å…¶å®ƒå½¢å¼çš„å®ƒä¸è®¤è¯†ï¼Œæ‰€ä»¥è¦åšå¼•ç”¨å½’ä¸€åŒ–æ“ä½œã€‚</p>
<p>ä½¿ç”¨å¼•ç”¨è¿›è¡Œè¿‡æ¸¡ä¹Ÿæ˜¯ä¸ºäº†èƒ½å¤Ÿé˜²æ­¢ä¸å¿…è¦çš„æ‹·è´ã€‚</p>
<p>ä¸‹é¢ä¸¾ä¸€äº›ä¾‹å­ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo</span>(s: &amp;<span class="hljs-type">str</span>) &#123;<br>    <span class="hljs-comment">// borrow a string for a second</span><br>&#125;<br><br><span class="hljs-comment">// String implements Deref&lt;Target=str&gt;</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">owned</span> = <span class="hljs-string">&quot;Hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br><br><span class="hljs-comment">// therefore, this works:</span><br><span class="hljs-title function_ invoke__">foo</span>(&amp;owned);<br></code></pre></td></tr></table></figure>
<p>å› ä¸º <code>String</code> å®ç°äº† <code>Deref&lt;Target=str&gt;</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::rc::Rc;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo</span>(s: &amp;<span class="hljs-type">str</span>) &#123;<br>    <span class="hljs-comment">// borrow a string for a second</span><br>&#125;<br><br><span class="hljs-comment">// String implements Deref&lt;Target=str&gt;</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">owned</span> = <span class="hljs-string">&quot;Hello&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br><span class="hljs-keyword">let</span> <span class="hljs-variable">counted</span> = Rc::<span class="hljs-title function_ invoke__">new</span>(owned);<br><br><span class="hljs-comment">// therefore, this works:</span><br><span class="hljs-title function_ invoke__">foo</span>(&amp;counted);<br></code></pre></td></tr></table></figure>
<p>å› ä¸º <code>Rc&lt;T&gt;</code> å®ç°äº† <code>Deref&lt;Target=T&gt;</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo</span>(s: &amp;[<span class="hljs-type">i32</span>]) &#123;<br>    <span class="hljs-comment">// borrow a slice for a second</span><br>&#125;<br><br><span class="hljs-comment">// Vec&lt;T&gt; implements Deref&lt;Target=[T]&gt;</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">owned</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br><br><span class="hljs-title function_ invoke__">foo</span>(&amp;owned);<br></code></pre></td></tr></table></figure>
<p>å› ä¸º <code>Vec&lt;T&gt;</code> å®ç°äº† <code>Deref&lt;Target=[T]&gt;</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Foo</span>;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Foo</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo</span>(&amp;<span class="hljs-keyword">self</span>) &#123; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Foo&quot;</span>); &#125;<br>&#125;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">f</span> = &amp;&amp;Foo;<br><br>f.<span class="hljs-title function_ invoke__">foo</span>();<br>(&amp;f).<span class="hljs-title function_ invoke__">foo</span>();<br>(&amp;&amp;f).<span class="hljs-title function_ invoke__">foo</span>();<br>(&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;f).<span class="hljs-title function_ invoke__">foo</span>();<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢é‚£å‡ ç§å‡½æ•°çš„è°ƒç”¨ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>
<p><code>coercion</code> çš„è®¾è®¡ï¼Œæ˜¯ Rust ä¸­ä»…æœ‰çš„ç±»å‹éšå¼è½¬æ¢ï¼Œè®¾è®¡å®ƒçš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†ç®€åŒ–ç¨‹åºçš„ä¹¦å†™ï¼Œè®©ä»£ç ä¸è‡³äºè¿‡äºç¹çã€‚æŠŠäººä»æ— å°½çš„ç±»å‹ç»†èŠ‚ä¸­è§£è„±å‡ºæ¥ï¼Œè®©ä¹¦å†™ Rust ä»£ç å˜æˆä¸€ä»¶å¿«ä¹çš„äº‹æƒ…ã€‚</p>
<h2 id="Cow"><a href="#Cow" class="headerlink" title="Cow"></a><code>Cow</code></h2><p><code>Clone-on-write</code>ï¼Œå³å†™æ—¶å…‹éš†ã€‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆã€‚</p>
<p>å®ƒæœ‰ä¸¤ä¸ªå¯é€‰å€¼ï¼š</p>
<ul>
<li><code>Borrowed</code>ï¼Œç”¨äºåŒ…è£¹å¯¹è±¡çš„å¼•ç”¨ï¼ˆé€šç”¨å¼•ç”¨ï¼‰ï¼›</li>
<li><code>Owned</code>ï¼Œç”¨äºåŒ…è£¹å¯¹è±¡çš„æ‰€æœ‰è€…ï¼›</li>
</ul>
<p><code>Cow</code> æä¾›</p>
<ol>
<li>å¯¹æ­¤å¯¹è±¡çš„ä¸å¯å˜è®¿é—®ï¼ˆæ¯”å¦‚å¯ç›´æ¥è°ƒç”¨æ­¤å¯¹è±¡åŸæœ‰çš„ä¸å¯å˜æ–¹æ³•ï¼‰ï¼›</li>
<li>å¦‚æœé‡åˆ°éœ€è¦ä¿®æ”¹æ­¤å¯¹è±¡ï¼Œæˆ–è€…éœ€è¦è·å¾—æ­¤å¯¹è±¡çš„æ‰€æœ‰æƒçš„æƒ…å†µï¼Œ<code>Cow</code> æä¾›æ–¹æ³•åšå…‹éš†å¤„ç†ï¼Œå¹¶é¿å…å¤šæ¬¡é‡å¤å…‹éš†ã€‚</li>
</ol>
<p><code>Cow</code> çš„è®¾è®¡ç›®çš„æ˜¯æé«˜æ€§èƒ½ï¼ˆå‡å°‘å¤åˆ¶ï¼‰åŒæ—¶å¢åŠ çµæ´»æ€§ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸šåŠ¡åœºæ™¯éƒ½æ˜¯è¯»å¤šå†™å°‘ã€‚åˆ©ç”¨ <code>Cow</code>ï¼Œå¯ä»¥ç”¨ç»Ÿä¸€ï¼Œè§„èŒƒçš„å½¢å¼å®ç°ï¼Œéœ€è¦å†™çš„æ—¶å€™æ‰åšä¸€æ¬¡å¯¹è±¡å¤åˆ¶ã€‚è¿™æ ·å°±å¯èƒ½ä¼šå¤§å¤§å‡å°‘å¤åˆ¶çš„æ¬¡æ•°ã€‚</p>
<p>å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªè¦ç‚¹éœ€è¦æŒæ¡ï¼š</p>
<ol>
<li><code>Cow&lt;T&gt;</code> èƒ½ç›´æ¥è°ƒç”¨ <code>T</code> çš„ä¸å¯å˜æ–¹æ³•ï¼Œå› ä¸º <code>Cow</code> è¿™ä¸ªæšä¸¾ï¼Œå®ç°äº† <code>Deref</code>ï¼›</li>
<li>åœ¨éœ€è¦å†™ <code>T</code>çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ <code>.to_mut()</code> æ–¹æ³•å¾—åˆ°ä¸€ä¸ªå…·æœ‰æ‰€æœ‰æƒçš„å€¼çš„å¯å˜å€Ÿç”¨ï¼›<ol>
<li>æ³¨æ„ï¼Œè°ƒç”¨ <code>.to_mut()</code> ä¸ä¸€å®šä¼šäº§ç”Ÿå…‹éš†ï¼›</li>
<li>åœ¨å·²ç»å…·æœ‰æ‰€æœ‰æƒçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ <code>.to_mut()</code> æœ‰æ•ˆï¼Œä½†æ˜¯ä¸ä¼šäº§ç”Ÿæ–°çš„å…‹éš†ï¼›</li>
<li>å¤šæ¬¡è°ƒç”¨ <code>.to_mut()</code> åªä¼šäº§ç”Ÿä¸€æ¬¡å…‹éš†ã€‚</li>
</ol>
</li>
<li>åœ¨éœ€è¦å†™ <code>T</code> çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ <code>.into_owned()</code> åˆ›å»ºæ–°çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾€å¾€æ„å‘³ç€å†…å­˜æ‹·è´å¹¶åˆ›å»ºæ–°å¯¹è±¡ï¼›<ol>
<li>å¦‚æœä¹‹å‰ <code>Cow</code> ä¸­çš„å€¼æ˜¯å€Ÿç”¨çŠ¶æ€ï¼Œè°ƒç”¨æ­¤æ“ä½œå°†æ‰§è¡Œå…‹éš†ï¼›</li>
<li>æœ¬æ–¹æ³•ï¼Œå‚æ•°æ˜¯<code>self</code>ç±»å‹ï¼Œå®ƒä¼šâ€œåƒæ‰â€åŸå…ˆçš„é‚£ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨ä¹‹ååŸå…ˆçš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå°±æˆªæ­¢äº†ï¼Œåœ¨ <code>Cow</code> ä¸Šä¸èƒ½è°ƒç”¨å¤šæ¬¡ï¼›</li>
</ol>
</li>
</ol>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p><code>.to_mut()</code> ä¸¾ä¾‹</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::borrow::Cow;<br><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cow</span>: Cow&lt;[_]&gt; = Cow::<span class="hljs-title function_ invoke__">Owned</span>(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">hello</span> = cow.<span class="hljs-title function_ invoke__">to_mut</span>();<br><br><span class="hljs-built_in">assert_eq!</span>(hello, &amp;[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);<br></code></pre></td></tr></table></figure>
<p><code>.into_owned()</code> ä¸¾ä¾‹</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::borrow::Cow;<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">cow</span>: Cow&lt;[_]&gt; = Cow::<span class="hljs-title function_ invoke__">Owned</span>(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);<br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">hello</span> = cow.<span class="hljs-title function_ invoke__">into_owned</span>();<br><br><span class="hljs-built_in">assert_eq!</span>(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], hello);<br></code></pre></td></tr></table></figure>
<p>ç»¼åˆä¸¾ä¾‹</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::borrow::Cow;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">abs_all</span>(input: &amp;<span class="hljs-keyword">mut</span> Cow&lt;[<span class="hljs-type">i32</span>]&gt;) &#123;<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..input.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = input[i];<br>        <span class="hljs-keyword">if</span> v &lt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">// clones into a vector the first time (if not already owned)</span><br>            input.<span class="hljs-title function_ invoke__">to_mut</span>()[i] = -v;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="æ›´å¤šçš„ä¾‹å­"><a href="#æ›´å¤šçš„ä¾‹å­" class="headerlink" title="æ›´å¤šçš„ä¾‹å­"></a>æ›´å¤šçš„ä¾‹å­</h3><p>é¢˜ç›®ï¼šå†™ä¸€ä¸ªå‡½æ•°ï¼Œè¿‡æ»¤æ‰è¾“å…¥çš„å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ç©ºæ ¼å­—ç¬¦ï¼Œå¹¶è¿”å›è¿‡æ»¤åçš„å­—ç¬¦ä¸²ã€‚</p>
<p>å¯¹è¿™ä¸ªç®€å•çš„é—®é¢˜ï¼Œä¸ç”¨æ€è€ƒï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å¾ˆå¿«å†™å‡ºä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">remove_spaces</span>(input: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;<br>   <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buf</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(input.<span class="hljs-title function_ invoke__">len</span>());<br><br>   <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> input.<span class="hljs-title function_ invoke__">chars</span>() &#123;<br>      <span class="hljs-keyword">if</span> c != <span class="hljs-string">&#x27; &#x27;</span> &#123;<br>         buf.<span class="hljs-title function_ invoke__">push</span>(c);<br>      &#125;<br>   &#125;<br><br>   buf<br>&#125;<br></code></pre></td></tr></table></figure>
<p>è®¾è®¡å‡½æ•°è¾“å…¥å‚æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåœé¡¿ä¸€ä¸‹ï¼Œè¿™é‡Œï¼Œç”¨ <code>&amp;str</code> å¥½å‘¢ï¼Œè¿˜æ˜¯ <code>String</code> å¥½å‘¢ï¼Ÿæ€è€ƒä¸€ç•ªï¼Œä»æ€§èƒ½ä¸Šè€ƒè™‘ï¼Œæœ‰å¦‚ä¸‹ç»“è®ºï¼š</p>
<ol>
<li>å¦‚æœä½¿ç”¨ <code>String</code> åˆ™å¤–éƒ¨åœ¨è°ƒç”¨æ­¤å‡½æ•°çš„æ—¶å€™ï¼Œ<ol>
<li>å¦‚æœå¤–éƒ¨çš„å­—ç¬¦ä¸²æ˜¯ <code>&amp;str</code>ï¼Œé‚£ä¹ˆï¼Œå®ƒéœ€è¦åšä¸€æ¬¡å…‹éš†ï¼Œæ‰èƒ½è°ƒç”¨æ­¤å‡½æ•°ï¼›</li>
<li>å¦‚æœå¤–éƒ¨çš„å­—ç¬¦ä¸²æ˜¯ <code>String</code>ï¼Œé‚£ä¹ˆï¼Œå®ƒä¸éœ€è¦åšå…‹éš†ï¼Œå°±å¯ä»¥è°ƒç”¨æ­¤å‡½æ•°ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦è°ƒç”¨åï¼Œå¤–éƒ¨é‚£ä¸ªå­—ç¬¦ä¸²çš„æ‰€æœ‰æƒå°±è¢« <code>move</code> åˆ°æ­¤å‡½æ•°ä¸­äº†ï¼Œå¤–éƒ¨çš„åç»­ä»£ç å°†æ— æ³•å†ä½¿ç”¨åŸå­—ç¬¦ä¸²ã€‚</li>
</ol>
</li>
<li>å¦‚æœä½¿ç”¨ <code>&amp;str</code>ï¼Œåˆ™ä¸å­˜åœ¨ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ã€‚ä½†å¯èƒ½ä¼šé‡åˆ°ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜ï¼Œéœ€è¦æ³¨æ„ã€‚</li>
</ol>
<p>ç»§ç»­åˆ†æä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å‘ç°ï¼Œåœ¨å‡½æ•°ä½“å†…ï¼Œåšäº†ä¸€æ¬¡æ–°å­—ç¬¦ä¸²å¯¹è±¡çš„ç”Ÿæˆå’Œæ‹·è´ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥ä»”ç»†åˆ†æä¸€ä¸‹ä¸šåŠ¡éœ€æ±‚ã€‚æœ€åçš„æƒ…å†µä¸‹ï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸­æ²¡æœ‰ç©ºç™½å­—ç¬¦ï¼Œé‚£æœ€å¥½æ˜¯ç›´æ¥åŸæ ·è¿”å›ã€‚è¿™ç§æƒ…å†µåšè¿™æ ·ä¸€æ¬¡å¯¹è±¡çš„æ‹·è´ï¼Œå®Œå…¨å°±æ˜¯æµªè´¹äº†ã€‚</p>
<p>äºæ˜¯æˆ‘ä»¬å¿ƒæƒ³æ”¹è¿›è¿™ä¸ªç®—æ³•ã€‚å¾ˆå¿«ï¼Œåˆé‡åˆ°äº†å¦ä¸€ä¸ªé—®é¢˜ï¼Œè¿”å›å€¼æ˜¯ <code>String</code> çš„å˜›ï¼Œæˆ‘ä¸è®ºæ€æ ·ï¼Œè¦æŠŠ <code>&amp;str</code> è½¬æ¢æˆ <code>String</code> è¿”å›ï¼Œå§‹ç»ˆéƒ½è¦ç»å†ä¸€æ¬¡å¤åˆ¶ã€‚äºæ˜¯æˆ‘ä»¬å¿«è¦æ”¾å¼ƒäº†ã€‚</p>
<p>å¥½å§ï¼Œ<code>Cow</code> å›è¿™æ—¶å‡ºé©¬äº†ã€‚å†™å‡ºäº†å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::borrow::Cow;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">remove_spaces</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(input: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> Cow&lt;<span class="hljs-symbol">&#x27;a</span>, <span class="hljs-type">str</span>&gt; &#123;<br>    <span class="hljs-keyword">if</span> input.<span class="hljs-title function_ invoke__">contains</span>(<span class="hljs-string">&#x27; &#x27;</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buf</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(input.<span class="hljs-title function_ invoke__">len</span>());<br><br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">c</span> <span class="hljs-keyword">in</span> input.<span class="hljs-title function_ invoke__">chars</span>() &#123;<br>            <span class="hljs-keyword">if</span> c != <span class="hljs-string">&#x27; &#x27;</span> &#123;<br>                buf.<span class="hljs-title function_ invoke__">push</span>(c);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> Cow::<span class="hljs-title function_ invoke__">Owned</span>(buf);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> Cow::<span class="hljs-title function_ invoke__">Borrowed</span>(input);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å®Œç¾è§£å†³äº†ä¸šåŠ¡é€»è¾‘ä¸è¿”å›å€¼ç±»å‹å†²çªçš„é—®é¢˜ã€‚æœ¬ä¾‹å¯ç»†ç»†å“å‘³ã€‚</p>
<p>å¤–éƒ¨ç¨‹åºï¼Œæ‹¿åˆ°è¿™ä¸ª <code>Cow</code> è¿”å›å€¼åï¼ŒæŒ‰ç…§æˆ‘ä»¬ä¸Šæ–‡æè¿°çš„ <code>Cow</code> çš„ç‰¹æ€§ä½¿ç”¨å°±å¥½äº†ã€‚</p>
<h2 id="Send-å’Œ-Sync"><a href="#Send-å’Œ-Sync" class="headerlink" title="Send å’Œ Sync"></a><code>Send</code> å’Œ <code>Sync</code></h2><p><code>std::marker</code> æ¨¡å—ä¸­ï¼Œæœ‰ä¸¤ä¸ª traitï¼š<code>Send</code> å’Œ <code>Sync</code>ï¼Œå®ƒä»¬ä¸å¤šçº¿ç¨‹å®‰å…¨ç›¸å…³ã€‚</p>
<p>æ ‡è®°ä¸º <code>marker trait</code> çš„ traitï¼Œå®ƒå®é™…å°±æ˜¯ä¸€ç§çº¦å®šï¼Œæ²¡æœ‰æ–¹æ³•çš„å®šä¹‰ï¼Œä¹Ÿæ²¡æœ‰å…³è”å…ƒç´ ï¼ˆassociated itemsï¼‰ã€‚ä»…ä»…æ˜¯ä¸€ç§çº¦å®šï¼Œå®ç°äº†å®ƒçš„ç±»å‹å¿…é¡»æ»¡è¶³è¿™ç§çº¦å®šã€‚ä¸€ç§ç±»å‹æ˜¯å¦åŠ ä¸Šè¿™ç§çº¦å®šï¼Œè¦ä¹ˆæ˜¯ç¼–è¯‘å™¨çš„è¡Œä¸ºï¼Œè¦ä¹ˆæ˜¯äººå·¥æ‰‹åŠ¨çš„è¡Œä¸ºã€‚</p>
<p><code>Send</code> å’Œ <code>Sync</code> åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ˆé’ˆå¯¹ Rust çš„åŸºç¡€ç±»å‹å’Œ std ä¸­çš„å¤§éƒ¨åˆ†ç±»å‹ï¼‰ï¼Œä¼šç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼å‡ºæ¥ã€‚å¯¹äºä¸èƒ½ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼å‡ºæ¥çš„ç±»å‹ï¼Œè¦ä½¿å®ƒä»¬å…·æœ‰ <code>Send</code> æˆ– <code>Sync</code> çš„çº¦å®šï¼Œå¯ä»¥ç”±äººæ‰‹åŠ¨å®ç°ã€‚å®ç°çš„æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨ <code>unsafe</code> å‰ç¼€ï¼Œå› ä¸º Rust é»˜è®¤ä¸ä¿¡ä»»ç¨‹åºå‘˜ï¼Œç”±ç¨‹åºå‘˜è‡ªå·±æ§åˆ¶çš„ä¸œè¥¿ï¼Œç»Ÿç»Ÿæ ‡è®°ä¸º <code>unsafe</code>ï¼Œå‡ºäº†é—®é¢˜ï¼ˆæ¯”å¦‚ï¼ŒæŠŠä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„å¯¹è±¡åŠ ä¸Š <code>Sync</code> çº¦å®šï¼‰ç”±ç¨‹åºå‘˜è‡ªè¡Œè´Ÿè´£ã€‚</p>
<p>å®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>å¦‚æœ <code>T: Send</code>ï¼Œé‚£ä¹ˆå°† <code>T</code> ä¼ åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ—¶ï¼ˆæŒ‰å€¼ä¼ é€ï¼‰ï¼Œä¸ä¼šå¯¼è‡´æ•°æ®ç«äº‰æˆ–å…¶å®ƒä¸å®‰å…¨æƒ…å†µã€‚</p>
<ol>
<li><code>Send</code> æ˜¯å¯¹è±¡å¯ä»¥å®‰å…¨å‘é€åˆ°å¦ä¸€ä¸ªæ‰§è¡Œä½“ä¸­ï¼›</li>
<li><code>Send</code> ä½¿è¢«å‘é€å¯¹è±¡å¯ä»¥å’Œäº§ç”Ÿå®ƒçš„çº¿ç¨‹è§£è€¦ï¼Œé˜²æ­¢åŸçº¿ç¨‹å°†æ­¤èµ„æºé‡Šæ”¾åï¼Œåœ¨ç›®æ ‡çº¿ç¨‹ä¸­ä½¿ç”¨å‡ºé”™ï¼ˆuse after freeï¼‰ã€‚</li>
</ol>
<p>å¦‚æœ <code>T: Sync</code>ï¼Œé‚£ä¹ˆå°† <code>&amp;T</code> ä¼ åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ—¶ï¼Œä¸ä¼šå¯¼è‡´æ•°æ®ç«äº‰æˆ–å…¶å®ƒä¸å®‰å…¨æƒ…å†µã€‚</p>
<ol>
<li><code>Sync</code> æ˜¯å¯ä»¥è¢«åŒæ—¶å¤šä¸ªæ‰§è¡Œä½“è®¿é—®è€Œä¸å‡ºé”™ï¼›</li>
<li><code>Sync</code> é˜²æ­¢çš„æ˜¯ç«äº‰ï¼›</li>
</ol>
<p>æ¨è®ºï¼š</p>
<ol>
<li><code>T: Sync</code> æ„å‘³ç€ <code>&amp;T: Send</code>ï¼›</li>
<li><code>Sync + Copy = Send</code>ï¼›</li>
<li>å½“ <code>T: Send</code> æ—¶ï¼Œå¯æ¨å¯¼å‡º <code>&amp;mut T: Send</code>ï¼›</li>
<li>å½“ <code>T: Sync</code> æ—¶ï¼Œå¯æ¨å¯¼å‡º <code>&amp;mut T: Sync</code>ï¼›</li>
<li>å½“ <code>&amp;mut T: Send</code> æ—¶ï¼Œä¸èƒ½æ¨å¯¼å‡º <code>T: Send</code>ï¼›</li>
</ol>
<p>ï¼ˆæ³¨ï¼š<code>T</code>, <code>&amp;T</code>, <code>&amp;mut T</code>ï¼Œ<code>Box&lt;T&gt;</code> ç­‰éƒ½æ˜¯ä¸åŒçš„ç±»å‹ï¼‰</p>
<p>å…·ä½“çš„ç±»å‹ï¼š</p>
<ol>
<li>åŸå§‹ç±»å‹ï¼ˆæ¯”å¦‚ï¼š u8, f64ï¼‰ï¼Œéƒ½æ˜¯ <code>Sync</code>ï¼Œéƒ½æ˜¯ <code>Copy</code>ï¼Œå› æ­¤éƒ½æ˜¯ <code>Send</code>ï¼›</li>
<li>åªåŒ…å«åŸå§‹ç±»å‹çš„å¤åˆç±»å‹ï¼Œéƒ½æ˜¯ <code>Sync</code>ï¼Œéƒ½æ˜¯ <code>Copy</code>ï¼Œå› æ­¤éƒ½æ˜¯ <code>Send</code>ï¼›</li>
<li>å½“ <code>T: Sync</code>ï¼Œ<code>Box&lt;T&gt;</code>, <code>Vec&lt;T&gt;</code> ç­‰é›†åˆç±»å‹æ˜¯ <code>Sync</code>ï¼›</li>
<li>å…·æœ‰å†…éƒ¨å¯å˜æ€§çš„çš„æŒ‡é’ˆï¼Œä¸æ˜¯ <code>Sync</code> çš„ï¼Œæ¯”å¦‚ <code>Cell</code>, <code>RefCell</code>, <code>UnsafeCell</code>ï¼›</li>
<li><code>Rc</code> ä¸æ˜¯ <code>Sync</code>ã€‚å› ä¸ºåªè¦ä¸€åš <code>&amp;Rc&lt;T&gt;</code> æ“ä½œï¼Œå°±ä¼šå…‹éš†ä¸€ä¸ªæ–°å¼•ç”¨ï¼Œå®ƒä¼šä»¥éåŸå­æ€§çš„æ–¹å¼ä¿®æ”¹å¼•ç”¨è®¡æ•°ï¼Œæ‰€ä»¥æ˜¯ä¸å®‰å…¨çš„ï¼›</li>
<li>è¢« <code>Mutex</code> å’Œ <code>RWLock</code> é”ä½çš„ç±»å‹ <code>T: Send</code>ï¼Œæ˜¯ <code>Sync</code> çš„ï¼›</li>
<li>åŸå§‹æŒ‡é’ˆï¼ˆ<code>*mut</code>, <code>*const</code>ï¼‰æ—¢ä¸æ˜¯ <code>Send</code> ä¹Ÿä¸æ˜¯ <code>Sync</code>ï¼›</li>
</ol>
<p>Rust æ­£æ˜¯é€šè¿‡è¿™ä¸¤å¤§æ­¦å™¨ï¼š<code>æ‰€æœ‰æƒå’Œç”Ÿå‘½å‘¨æœŸ</code> + <code>Send å’Œ Sync</code>ï¼ˆæœ¬è´¨ä¸Šä¸ºç±»å‹ç³»ç»Ÿï¼‰æ¥ä¸ºå¹¶å‘ç¼–ç¨‹æä¾›äº†å®‰å…¨å¯é çš„åŸºç¡€è®¾æ–½ã€‚ä½¿å¾—ç¨‹åºå‘˜å¯ä»¥æ”¾å¿ƒåœ¨å…¶ä¸Šæ„å»ºç¨³å¥çš„å¹¶å‘æ¨¡å‹ã€‚è¿™ä¹Ÿæ­£æ˜¯ Rust çš„æ ¸å¿ƒè®¾è®¡è§‚çš„ä½“ç°ï¼šå†…æ ¸åªæä¾›æœ€åŸºç¡€çš„åŸè¯­ï¼ŒçœŸæ­£çš„å®ç°èƒ½åˆ†ç¦»å‡ºå»å°±åˆ†ç¦»å‡ºå»ã€‚å¹¶å‘ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p>
<h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><ol>
<li><a href="https://github.com/rustcc/RustPrimer">https://github.com/rustcc/RustPrimer</a></li>
</ol>
]]></content>
      <categories>
        <category>rust</category>
      </categories>
      <tags>
        <tag>rust</tag>
      </tags>
  </entry>
  <entry>
    <title>Internlm-03-åŸºäº InternLM å’Œ LangChain æ­å»ºä½ çš„çŸ¥è¯†åº“</title>
    <url>/internlm/internlm-03/</url>
    <content><![CDATA[<h1 id="åŸºäº-InternLM-å’Œ-LangChain-æ­å»ºä½ çš„çŸ¥è¯†åº“"><a href="#åŸºäº-InternLM-å’Œ-LangChain-æ­å»ºä½ çš„çŸ¥è¯†åº“" class="headerlink" title="åŸºäº InternLM å’Œ LangChain æ­å»ºä½ çš„çŸ¥è¯†åº“"></a>åŸºäº InternLM å’Œ LangChain æ­å»ºä½ çš„çŸ¥è¯†åº“</h1><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><h3 id="InternLM-ç¯å¢ƒ"><a href="#InternLM-ç¯å¢ƒ" class="headerlink" title="InternLM ç¯å¢ƒ"></a>InternLM ç¯å¢ƒ</h3><p>å¼€å‘ç¯å¢ƒé™¤äº† <code>pytorch</code> ç­‰åº“ä»¥å¤–ï¼Œè¿˜éœ€è¦å®‰è£…ä»¥ä¸‹åº“</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å‡çº§pip</span><br>python -m pip install --upgrade pip<br><br>pip install modelscope==1.9.5<br>pip install transformers==4.35.2<br>pip install streamlit==1.24.0<br>pip install sentencepiece==0.1.99<br>pip install accelerate==0.24.1<br></code></pre></td></tr></table></figure>
<h3 id="æ¨¡å‹ä¸‹è½½"><a href="#æ¨¡å‹ä¸‹è½½" class="headerlink" title="æ¨¡å‹ä¸‹è½½"></a>æ¨¡å‹ä¸‹è½½</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">import torch<br>from modelscope import snapshot_download, AutoModel, AutoTokenizer<br>import os<br>model_dir = snapshot_download(<span class="hljs-string">&#x27;Shanghai_AI_Laboratory/internlm-chat-7b&#x27;</span>, cache_dir=<span class="hljs-string">&#x27;/root/data/model&#x27;</span>, revision=<span class="hljs-string">&#x27;v1.0.3&#x27;</span>)<br></code></pre></td></tr></table></figure>
<h3 id="é…ç½®-Langchain"><a href="#é…ç½®-Langchain" class="headerlink" title="é…ç½® Langchain"></a>é…ç½® Langchain</h3><p>é™¤äº†é…ç½®å¤§æ¨¡å‹çš„è¿è¡Œç¯å¢ƒä»¥å¤–ï¼Œè¿˜éœ€è¦é…ç½® Langchain è¿è¡Œç¯å¢ƒã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip install langchain==0.0.292<br>pip install gradio==4.4.0<br>pip install chromadb==0.4.15<br>pip install sentence-transformers==2.2.2<br>pip install unstructured==0.10.30<br>pip install markdown==3.3.7<br></code></pre></td></tr></table></figure>
<p><img  src="å®‰è£…ä¾èµ–.png"  ><span class="image-caption">å®‰è£…ä¾èµ–</span></p>
<h3 id="ä¸‹è½½-Embedding-æ¨¡å‹"><a href="#ä¸‹è½½-Embedding-æ¨¡å‹" class="headerlink" title="ä¸‹è½½ Embedding æ¨¡å‹"></a>ä¸‹è½½ Embedding æ¨¡å‹</h3><p>åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°å¼€æºè¯å‘é‡æ¨¡å‹ <a href="https://huggingface.co/sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2">Sentence Transformer - paraphrase-multilingual-MiniLM-L12-v2</a>:ï¼ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰ç”¨åˆ«çš„å¼€æºè¯å‘é‡æ¨¡å‹æ¥è¿›è¡Œ Embeddingï¼Œæ•™ç¨‹ä¸­é€‰ç”¨è¿™ä¸ªæ¨¡å‹æ˜¯ç›¸å¯¹è½»é‡ã€æ”¯æŒä¸­æ–‡ä¸”æ•ˆæœè¾ƒå¥½çš„ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©ä½¿ç”¨äº†æ›´ä¸ºå¥½ç”¨çš„ bge ç³»åˆ—çš„ Embedding æ¨¡å‹ <a href="[BAAI/bge-large-zh-v1.5 Â· Hugging Face](https://huggingface.co/BAAI/bge-large-zh-v1.5">BAAI/bge-large-zh-v1.5</a>)ï¼‰</p>
<p>é¦–å…ˆéœ€è¦ä½¿ç”¨ <code>huggingface</code> å®˜æ–¹æä¾›çš„ <code>huggingface-cli</code> å‘½ä»¤è¡Œå·¥å…·ã€‚å®‰è£…ä¾èµ–:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip install -U huggingface_hub<br></code></pre></td></tr></table></figure>
<p>ç„¶ååœ¨å’Œ <code>/root/data</code> ç›®å½•ä¸‹æ–°å»ºpythonæ–‡ä»¶ <code>download_hf.py</code>ï¼Œå¡«å…¥ä»¥ä¸‹ä»£ç ï¼š</p>
<ul>
<li>resume-downloadï¼šæ–­ç‚¹ç»­ä¸‹</li>
<li>local-dirï¼šæœ¬åœ°å­˜å‚¨è·¯å¾„ã€‚ï¼ˆlinuxç¯å¢ƒä¸‹éœ€è¦å¡«å†™ç»å¯¹è·¯å¾„ï¼‰</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># ä¸‹è½½æ¨¡å‹</span><br>os.system(<span class="hljs-string">&#x27;huggingface-cli download --resume-download BAAI/bge-large-zh-v1.5 --local-dir /root/data/model/bge-large-zh-v1.5&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œä½¿ç”¨ huggingface ä¸‹è½½å¯èƒ½é€Ÿåº¦è¾ƒæ…¢ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ huggingface é•œåƒä¸‹è½½ã€‚ä¸ä½¿ç”¨hugginge faceä¸‹è½½ç›¸åŒï¼Œåªéœ€è¦å¡«å…¥é•œåƒåœ°å€å³å¯ã€‚</p>
<p>å°† <code>download_hf.py</code> ä¸­çš„ä»£ç ä¿®æ”¹ä¸ºä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span><br>os.environ[<span class="hljs-string">&#x27;HF_ENDPOINT&#x27;</span>] = <span class="hljs-string">&#x27;https://hf-mirror.com&#x27;</span><br><br><span class="hljs-comment"># ä¸‹è½½æ¨¡å‹</span><br>os.system(<span class="hljs-string">&#x27;huggingface-cli download --resume-download BAAI/bge-large-zh-v1.5 --local-dir /root/data/model/bge-large-zh-v1.5&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>ç„¶åï¼Œåœ¨ <code>/root/data</code> ç›®å½•ä¸‹æ‰§è¡Œè¯¥è„šæœ¬å³å¯è‡ªåŠ¨å¼€å§‹ä¸‹è½½ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python download_hf.py<br></code></pre></td></tr></table></figure>
<p><img  src="ä¸‹è½½bge.png"  ><span class="image-caption">ä¸‹è½½bgeæ¨¡å‹</span></p>
<h3 id="ä¸‹è½½-NLTK-ç›¸å…³èµ„æº"><a href="#ä¸‹è½½-NLTK-ç›¸å…³èµ„æº" class="headerlink" title="ä¸‹è½½ NLTK ç›¸å…³èµ„æº"></a>ä¸‹è½½ NLTK ç›¸å…³èµ„æº</h3><p>æˆ‘ä»¬åœ¨ä½¿ç”¨å¼€æºè¯å‘é‡æ¨¡å‹æ„å»ºå¼€æºè¯å‘é‡çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹åº“ <code>nltk</code> çš„ä¸€äº›èµ„æºã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…¶ä¼šè‡ªåŠ¨ä»äº’è”ç½‘ä¸Šä¸‹è½½ï¼Œä½†å¯èƒ½ç”±äºç½‘ç»œåŸå› ä¼šå¯¼è‡´ä¸‹è½½ä¸­æ–­ï¼Œæ­¤å¤„æˆ‘ä»¬å¯ä»¥ä»å›½å†…ä»“åº“é•œåƒåœ°å€ä¸‹è½½ç›¸å…³èµ„æºï¼Œä¿å­˜åˆ°æœåŠ¡å™¨ä¸Šã€‚</p>
<p>æˆ‘ä»¬ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½ nltk èµ„æºå¹¶è§£å‹åˆ°æœåŠ¡å™¨ä¸Šï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /root<br>git <span class="hljs-built_in">clone</span> https://gitee.com/yzy0612/nltk_data.git  --branch gh-pages<br><span class="hljs-built_in">cd</span> nltk_data<br><span class="hljs-built_in">mv</span> packages/*  ./<br><span class="hljs-built_in">cd</span> tokenizers<br>unzip punkt.zip<br><span class="hljs-built_in">cd</span> ../taggers<br>unzip averaged_perceptron_tagger.zip<br></code></pre></td></tr></table></figure>
<p>ä¹‹åä½¿ç”¨æ—¶æœåŠ¡å™¨å³ä¼šè‡ªåŠ¨ä½¿ç”¨å·²æœ‰èµ„æºï¼Œæ— éœ€å†æ¬¡ä¸‹è½½ã€‚</p>
<h3 id="ä¸‹è½½æ•™ç¨‹ä»£ç "><a href="#ä¸‹è½½æ•™ç¨‹ä»£ç " class="headerlink" title="ä¸‹è½½æ•™ç¨‹ä»£ç "></a>ä¸‹è½½æ•™ç¨‹ä»£ç </h3><p>æˆ‘ä»¬åœ¨ä»“åº“ä¸­åŒæ­¥æä¾›äº†æ‰€æœ‰è„šæœ¬ï¼Œå¯ä»¥æŸ¥çœ‹è¯¥æ•™ç¨‹æ–‡ä»¶çš„åŒçº§ç›®å½•çš„ <code>demo</code> æ–‡ä»¶å¤¹ã€‚</p>
<p>å»ºè®®é€šè¿‡ä»¥ä¸‹ç›®å½•å°†ä»“åº“ clone åˆ°æœ¬åœ°ï¼Œå¯ä»¥ç›´æ¥åœ¨æœ¬åœ°è¿è¡Œç›¸å…³ä»£ç ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /root/data<br>git <span class="hljs-built_in">clone</span> https://github.com/InternLM/tutorial<br></code></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šè¿°å‘½ä»¤ï¼Œå¯ä»¥å°†æœ¬ä»“åº“ clone åˆ°æœ¬åœ° <code>root/data/tutorial</code> ç›®å½•ä¸‹ï¼Œåœ¨ä¹‹åçš„è¿‡ç¨‹ä¸­å¯ä»¥å¯¹ç…§ä»“åº“ä¸­çš„è„šæœ¬æ¥å®Œæˆè‡ªå·±çš„ä»£ç ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ä»“åº“ä¸­çš„è„šæœ¬ã€‚</p>
<h2 id="çŸ¥è¯†åº“æ­å»º"><a href="#çŸ¥è¯†åº“æ­å»º" class="headerlink" title="çŸ¥è¯†åº“æ­å»º"></a>çŸ¥è¯†åº“æ­å»º</h2><h3 id="æ•°æ®æ”¶é›†"><a href="#æ•°æ®æ”¶é›†" class="headerlink" title="æ•°æ®æ”¶é›†"></a>æ•°æ®æ”¶é›†</h3><p>æ•™ç¨‹é€‰æ‹©äº†ç”±ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤å¼€æºçš„ä¸€ç³»åˆ—å¤§æ¨¡å‹å·¥å…·å¼€æºä»“åº“ä½œä¸ºè¯­æ–™åº“æ¥æºï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><a href="https://gitee.com/open-compass/opencompass">OpenCompass</a>ï¼šé¢å‘å¤§æ¨¡å‹è¯„æµ‹çš„ä¸€ç«™å¼å¹³å°</li>
<li><a href="https://gitee.com/InternLM/lmdeploy">IMDeploy</a>ï¼šæ¶µç›–äº† LLM ä»»åŠ¡çš„å…¨å¥—è½»é‡åŒ–ã€éƒ¨ç½²å’ŒæœåŠ¡è§£å†³æ–¹æ¡ˆçš„é«˜æ•ˆæ¨ç†å·¥å…·ç®±</li>
<li><a href="https://gitee.com/InternLM/xtuner">XTuner</a>ï¼šè½»é‡çº§å¾®è°ƒå¤§è¯­è¨€æ¨¡å‹çš„å·¥å…·åº“</li>
<li><a href="https://gitee.com/InternLM/InternLM-XComposer">InternLM-XComposer</a>ï¼šæµ¦è¯­Â·çµç¬”ï¼ŒåŸºäºä¹¦ç”ŸÂ·æµ¦è¯­å¤§è¯­è¨€æ¨¡å‹ç ”å‘çš„è§†è§‰-è¯­è¨€å¤§æ¨¡å‹</li>
<li><a href="https://gitee.com/InternLM/lagent">Lagent</a>ï¼šä¸€ä¸ªè½»é‡çº§ã€å¼€æºçš„åŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æ™ºèƒ½ä½“ï¼ˆagentï¼‰æ¡†æ¶</li>
<li><a href="https://gitee.com/InternLM/InternLM">InternLM</a>ï¼šä¸€ä¸ªå¼€æºçš„è½»é‡çº§è®­ç»ƒæ¡†æ¶ï¼Œæ—¨åœ¨æ”¯æŒå¤§æ¨¡å‹è®­ç»ƒè€Œæ— éœ€å¤§é‡çš„ä¾èµ–</li>
</ul>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†ä¸Šè¿°è¿œç¨‹å¼€æºä»“åº“ Clone åˆ°æœ¬åœ°ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># è¿›å…¥åˆ°æ•°æ®åº“ç›˜</span><br>cd <span class="hljs-regexp">/root/</span>data<br><span class="hljs-comment"># clone ä¸Šè¿°å¼€æºä»“åº“</span><br>git clone https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/open-compass/</span>opencompass.git<br>git clone https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/InternLM/</span>lmdeploy.git<br>git clone https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/InternLM/</span>xtuner.git<br>git clone https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/InternLM/</span>InternLM-XComposer.git<br>git clone https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/InternLM/</span>lagent.git<br>git clone https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/InternLM/</span>InternLM.git<br></code></pre></td></tr></table></figure>
<p>æ¥ç€ï¼Œä¸ºè¯­æ–™å¤„ç†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†é€‰ç”¨ä¸Šè¿°ä»“åº“ä¸­æ‰€æœ‰çš„ markdownã€txt æ–‡ä»¶ä½œä¸ºç¤ºä¾‹è¯­æ–™åº“ã€‚æ³¨æ„ï¼Œä¹Ÿå¯ä»¥é€‰ç”¨å…¶ä¸­çš„ä»£ç æ–‡ä»¶åŠ å…¥åˆ°çŸ¥è¯†åº“ä¸­ï¼Œä½†éœ€è¦é’ˆå¯¹ä»£ç æ–‡ä»¶æ ¼å¼è¿›è¡Œé¢å¤–å¤„ç†ï¼ˆå› ä¸ºä»£ç æ–‡ä»¶å¯¹é€»è¾‘è”ç³»è¦æ±‚è¾ƒé«˜ï¼Œä¸”è§„èŒƒæ€§è¾ƒå¼ºï¼Œåœ¨åˆ†å‰²æ—¶æœ€å¥½åŸºäºä»£ç æ¨¡å—è¿›è¡Œåˆ†å‰²å†åŠ å…¥å‘é‡æ•°æ®åº“ï¼‰ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆå°†ä¸Šè¿°ä»“åº“ä¸­æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„æ–‡ä»¶è·¯å¾„æ‰¾å‡ºæ¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†é€’å½’æŒ‡å®šæ–‡ä»¶å¤¹è·¯å¾„ï¼Œè¿”å›å…¶ä¸­æ‰€æœ‰æ»¡è¶³æ¡ä»¶ï¼ˆå³åç¼€åä¸º .md æˆ–è€… .txt çš„æ–‡ä»¶ï¼‰çš„æ–‡ä»¶è·¯å¾„ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_files</span>(<span class="hljs-params">dir_path</span>):<br>    <span class="hljs-comment"># argsï¼šdir_pathï¼Œç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„</span><br>    file_list = []<br>    <span class="hljs-keyword">for</span> filepath, dirnames, filenames <span class="hljs-keyword">in</span> os.walk(dir_path):<br>        <span class="hljs-comment"># os.walk å‡½æ•°å°†é€’å½’éå†æŒ‡å®šæ–‡ä»¶å¤¹</span><br>        <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> filenames:<br>            <span class="hljs-comment"># é€šè¿‡åç¼€ååˆ¤æ–­æ–‡ä»¶ç±»å‹æ˜¯å¦æ»¡è¶³è¦æ±‚</span><br>            <span class="hljs-keyword">if</span> filename.endswith(<span class="hljs-string">&quot;.md&quot;</span>):<br>                <span class="hljs-comment"># å¦‚æœæ»¡è¶³è¦æ±‚ï¼Œå°†å…¶ç»å¯¹è·¯å¾„åŠ å…¥åˆ°ç»“æœåˆ—è¡¨</span><br>                file_list.append(os.path.join(filepath, filename))<br>            <span class="hljs-keyword">elif</span> filename.endswith(<span class="hljs-string">&quot;.txt&quot;</span>):<br>                file_list.append(os.path.join(filepath, filename))<br>    <span class="hljs-keyword">return</span> file_list<br></code></pre></td></tr></table></figure>
<h3 id="åŠ è½½æ•°æ®"><a href="#åŠ è½½æ•°æ®" class="headerlink" title="åŠ è½½æ•°æ®"></a>åŠ è½½æ•°æ®</h3><p>å¾—åˆ°æ‰€æœ‰ç›®æ ‡æ–‡ä»¶è·¯å¾„ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ LangChain æä¾›çš„ FileLoader å¯¹è±¡æ¥åŠ è½½ç›®æ ‡æ–‡ä»¶ï¼Œå¾—åˆ°ç”±ç›®æ ‡æ–‡ä»¶è§£æå‡ºçš„çº¯æ–‡æœ¬å†…å®¹ã€‚ç”±äºä¸åŒç±»å‹çš„æ–‡ä»¶éœ€è¦å¯¹åº”ä¸åŒçš„ FileLoaderï¼Œæˆ‘ä»¬åˆ¤æ–­ç›®æ ‡æ–‡ä»¶ç±»å‹ï¼Œå¹¶é’ˆå¯¹æ€§è°ƒç”¨å¯¹åº”ç±»å‹çš„ FileLoaderï¼ŒåŒæ—¶ï¼Œè°ƒç”¨ FileLoader å¯¹è±¡çš„ load æ–¹æ³•æ¥å¾—åˆ°åŠ è½½ä¹‹åçš„çº¯æ–‡æœ¬å¯¹è±¡ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">from</span> langchain.document_loaders <span class="hljs-keyword">import</span> UnstructuredFileLoader<br><span class="hljs-keyword">from</span> langchain.document_loaders <span class="hljs-keyword">import</span> UnstructuredMarkdownLoader<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_text</span>(<span class="hljs-params">dir_path</span>):<br>    <span class="hljs-comment"># argsï¼šdir_pathï¼Œç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„</span><br>    <span class="hljs-comment"># é¦–å…ˆè°ƒç”¨ä¸Šæ–‡å®šä¹‰çš„å‡½æ•°å¾—åˆ°ç›®æ ‡æ–‡ä»¶è·¯å¾„åˆ—è¡¨</span><br>    file_lst = get_files(dir_path)<br>    <span class="hljs-comment"># docs å­˜æ”¾åŠ è½½ä¹‹åçš„çº¯æ–‡æœ¬å¯¹è±¡</span><br>    docs = []<br>    <span class="hljs-comment"># éå†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶</span><br>    <span class="hljs-keyword">for</span> one_file <span class="hljs-keyword">in</span> tqdm(file_lst):<br>        file_type = one_file.split(<span class="hljs-string">&#x27;.&#x27;</span>)[-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> file_type == <span class="hljs-string">&#x27;md&#x27;</span>:<br>            loader = UnstructuredMarkdownLoader(one_file)<br>        <span class="hljs-keyword">elif</span> file_type == <span class="hljs-string">&#x27;txt&#x27;</span>:<br>            loader = UnstructuredFileLoader(one_file)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># å¦‚æœæ˜¯ä¸ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼Œç›´æ¥è·³è¿‡</span><br>            <span class="hljs-keyword">continue</span><br>        docs.extend(loader.load())<br>    <span class="hljs-keyword">return</span> docs<br></code></pre></td></tr></table></figure>
<p>ä½¿ç”¨ä¸Šæ–‡å‡½æ•°ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ <code>docs</code> ä¸ºä¸€ä¸ªçº¯æ–‡æœ¬å¯¹è±¡å¯¹åº”çš„åˆ—è¡¨ã€‚</p>
<h3 id="æ„å»ºå‘é‡æ•°æ®åº“"><a href="#æ„å»ºå‘é‡æ•°æ®åº“" class="headerlink" title="æ„å»ºå‘é‡æ•°æ®åº“"></a>æ„å»ºå‘é‡æ•°æ®åº“</h3><p>å¾—åˆ°è¯¥åˆ—è¡¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å®ƒå¼•å…¥åˆ° LangChain æ¡†æ¶ä¸­æ„å»ºå‘é‡æ•°æ®åº“ã€‚ç”±çº¯æ–‡æœ¬å¯¹è±¡æ„å»ºå‘é‡æ•°æ®åº“ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹æ–‡æœ¬è¿›è¡Œåˆ†å—ï¼Œæ¥ç€å¯¹æ–‡æœ¬å—è¿›è¡Œå‘é‡åŒ–ã€‚</p>
<p>LangChain æä¾›äº†å¤šç§æ–‡æœ¬åˆ†å—å·¥å…·ï¼Œæ­¤å¤„æˆ‘ä»¬ä½¿ç”¨å­—ç¬¦ä¸²é€’å½’åˆ†å‰²å™¨ï¼Œå¹¶é€‰æ‹©åˆ†å—å¤§å°ä¸º 500ï¼Œå—é‡å é•¿åº¦ä¸º 150ï¼ˆç”±äºç¯‡å¹…é™åˆ¶ï¼Œæ­¤å¤„æ²¡æœ‰å±•ç¤ºåˆ‡å‰²æ•ˆæœï¼Œå­¦ä¹ è€…å¯ä»¥è‡ªè¡Œå°è¯•ä¸€ä¸‹ï¼Œæƒ³è¦æ·±å…¥å­¦ä¹  LangChain æ–‡æœ¬åˆ†å—å¯ä»¥å‚è€ƒæ•™ç¨‹ <a href="https://github.com/datawhalechina/prompt-engineering-for-developers/blob/9dbcb48416eb8af9ff9447388838521dc0f9acb0/content/LangChain Chat with Your Data/1.ç®€ä»‹ Introduction.md">ã€ŠLangChain - Chat With Your Dataã€‹</a>ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br><br>text_splitter = RecursiveCharacterTextSplitter(<br>    chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">150</span>)<br>split_docs = text_splitter.split_documents(docs)<br></code></pre></td></tr></table></figure>
<p>æ¥ç€æˆ‘ä»¬é€‰ç”¨å¼€æºè¯å‘é‡æ¨¡å‹ <a href="https://huggingface.co/sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2">Sentence Transformer</a> æ¥è¿›è¡Œæ–‡æœ¬å‘é‡åŒ–ã€‚LangChain æä¾›äº†ç›´æ¥å¼•å…¥ HuggingFace å¼€æºç¤¾åŒºä¸­çš„æ¨¡å‹è¿›è¡Œå‘é‡åŒ–çš„æ¥å£ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.embeddings.huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings<br><br>embeddings = HuggingFaceEmbeddings(model_name=<span class="hljs-string">&quot;/root/data/model/bge-large-zh-v1.5&quot;</span>)<br></code></pre></td></tr></table></figure>
<p>åŒæ—¶ï¼Œè€ƒè™‘åˆ° Chroma æ˜¯ç›®å‰æœ€å¸¸ç”¨çš„å…¥é—¨æ•°æ®åº“ï¼Œæˆ‘ä»¬é€‰æ‹© Chroma ä½œä¸ºå‘é‡æ•°æ®åº“ï¼ŒåŸºäºä¸Šæ–‡åˆ†å—åçš„æ–‡æ¡£ä»¥åŠåŠ è½½çš„å¼€æºå‘é‡åŒ–æ¨¡å‹ï¼Œå°†è¯­æ–™åŠ è½½åˆ°æŒ‡å®šè·¯å¾„ä¸‹çš„å‘é‡æ•°æ®åº“ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<br><br><span class="hljs-comment"># å®šä¹‰æŒä¹…åŒ–è·¯å¾„</span><br>persist_directory = <span class="hljs-string">&#x27;data_base/vector_db/chroma&#x27;</span><br><span class="hljs-comment"># åŠ è½½æ•°æ®åº“</span><br>vectordb = Chroma.from_documents(<br>    documents=split_docs,<br>    embedding=embeddings,<br>    persist_directory=persist_directory  <span class="hljs-comment"># å…è®¸æˆ‘ä»¬å°†persist_directoryç›®å½•ä¿å­˜åˆ°ç£ç›˜ä¸Š</span><br>)<br><span class="hljs-comment"># å°†åŠ è½½çš„å‘é‡æ•°æ®åº“æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Š</span><br>vectordb.persist()<br></code></pre></td></tr></table></figure>
<h3 id="æ•´ä½“è„šæœ¬"><a href="#æ•´ä½“è„šæœ¬" class="headerlink" title="æ•´ä½“è„šæœ¬"></a>æ•´ä½“è„šæœ¬</h3><p>å°†ä¸Šè¿°ä»£ç æ•´åˆåœ¨ä¸€èµ·ä¸ºçŸ¥è¯†åº“æ­å»ºçš„è„šæœ¬ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># é¦–å…ˆå¯¼å…¥æ‰€éœ€ç¬¬ä¸‰æ–¹åº“</span><br><span class="hljs-keyword">from</span> langchain.document_loaders <span class="hljs-keyword">import</span> UnstructuredFileLoader<br><span class="hljs-keyword">from</span> langchain.document_loaders <span class="hljs-keyword">import</span> UnstructuredMarkdownLoader<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<br><span class="hljs-keyword">from</span> langchain.embeddings.huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># è·å–æ–‡ä»¶è·¯å¾„å‡½æ•°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_files</span>(<span class="hljs-params">dir_path</span>):<br>    <span class="hljs-comment"># argsï¼šdir_pathï¼Œç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„</span><br>    file_list = []<br>    <span class="hljs-keyword">for</span> filepath, dirnames, filenames <span class="hljs-keyword">in</span> os.walk(dir_path):<br>        <span class="hljs-comment"># os.walk å‡½æ•°å°†é€’å½’éå†æŒ‡å®šæ–‡ä»¶å¤¹</span><br>        <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> filenames:<br>            <span class="hljs-comment"># é€šè¿‡åç¼€ååˆ¤æ–­æ–‡ä»¶ç±»å‹æ˜¯å¦æ»¡è¶³è¦æ±‚</span><br>            <span class="hljs-keyword">if</span> filename.endswith(<span class="hljs-string">&quot;.md&quot;</span>):<br>                <span class="hljs-comment"># å¦‚æœæ»¡è¶³è¦æ±‚ï¼Œå°†å…¶ç»å¯¹è·¯å¾„åŠ å…¥åˆ°ç»“æœåˆ—è¡¨</span><br>                file_list.append(os.path.join(filepath, filename))<br>            <span class="hljs-keyword">elif</span> filename.endswith(<span class="hljs-string">&quot;.txt&quot;</span>):<br>                file_list.append(os.path.join(filepath, filename))<br>    <span class="hljs-keyword">return</span> file_list<br><br><span class="hljs-comment"># åŠ è½½æ–‡ä»¶å‡½æ•°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_text</span>(<span class="hljs-params">dir_path</span>):<br>    <span class="hljs-comment"># argsï¼šdir_pathï¼Œç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„</span><br>    <span class="hljs-comment"># é¦–å…ˆè°ƒç”¨ä¸Šæ–‡å®šä¹‰çš„å‡½æ•°å¾—åˆ°ç›®æ ‡æ–‡ä»¶è·¯å¾„åˆ—è¡¨</span><br>    file_lst = get_files(dir_path)<br>    <span class="hljs-comment"># docs å­˜æ”¾åŠ è½½ä¹‹åçš„çº¯æ–‡æœ¬å¯¹è±¡</span><br>    docs = []<br>    <span class="hljs-comment"># éå†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶</span><br>    <span class="hljs-keyword">for</span> one_file <span class="hljs-keyword">in</span> tqdm(file_lst):<br>        file_type = one_file.split(<span class="hljs-string">&#x27;.&#x27;</span>)[-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> file_type == <span class="hljs-string">&#x27;md&#x27;</span>:<br>            loader = UnstructuredMarkdownLoader(one_file)<br>        <span class="hljs-keyword">elif</span> file_type == <span class="hljs-string">&#x27;txt&#x27;</span>:<br>            loader = UnstructuredFileLoader(one_file)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># å¦‚æœæ˜¯ä¸ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼Œç›´æ¥è·³è¿‡</span><br>            <span class="hljs-keyword">continue</span><br>        docs.extend(loader.load())<br>    <span class="hljs-keyword">return</span> docs<br><br><span class="hljs-comment"># ç›®æ ‡æ–‡ä»¶å¤¹</span><br>tar_dir = [<br>    <span class="hljs-string">&quot;/root/data/InternLM&quot;</span>,<br>    <span class="hljs-string">&quot;/root/data/InternLM-XComposer&quot;</span>,<br>    <span class="hljs-string">&quot;/root/data/lagent&quot;</span>,<br>    <span class="hljs-string">&quot;/root/data/lmdeploy&quot;</span>,<br>    <span class="hljs-string">&quot;/root/data/opencompass&quot;</span>,<br>    <span class="hljs-string">&quot;/root/data/xtuner&quot;</span><br>]<br><br><span class="hljs-comment"># åŠ è½½ç›®æ ‡æ–‡ä»¶</span><br>docs = []<br><span class="hljs-keyword">for</span> dir_path <span class="hljs-keyword">in</span> tar_dir:<br>    docs.extend(get_text(dir_path))<br><br><span class="hljs-comment"># å¯¹æ–‡æœ¬è¿›è¡Œåˆ†å—</span><br>text_splitter = RecursiveCharacterTextSplitter(<br>    chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">150</span>)<br>split_docs = text_splitter.split_documents(docs)<br><br><span class="hljs-comment"># åŠ è½½å¼€æºè¯å‘é‡æ¨¡å‹</span><br>embeddings = HuggingFaceEmbeddings(model_name=<span class="hljs-string">&quot;/root/data/model/bge-large-zh-v1.5&quot;</span>)<br><br><span class="hljs-comment"># æ„å»ºå‘é‡æ•°æ®åº“</span><br><span class="hljs-comment"># å®šä¹‰æŒä¹…åŒ–è·¯å¾„</span><br>persist_directory = <span class="hljs-string">&#x27;data_base/vector_db/chroma&#x27;</span><br><span class="hljs-comment"># åŠ è½½æ•°æ®åº“</span><br>vectordb = Chroma.from_documents(<br>    documents=split_docs,<br>    embedding=embeddings,<br>    persist_directory=persist_directory  <span class="hljs-comment"># å…è®¸æˆ‘ä»¬å°†persist_directoryç›®å½•ä¿å­˜åˆ°ç£ç›˜ä¸Š</span><br>)<br><span class="hljs-comment"># å°†åŠ è½½çš„å‘é‡æ•°æ®åº“æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Š</span><br>vectordb.persist()<br></code></pre></td></tr></table></figure>
<p>å¯ä»¥åœ¨ <code>/root/data</code> ä¸‹æ–°å»ºä¸€ä¸ª <code>demo</code>ç›®å½•ï¼Œå°†è¯¥è„šæœ¬å’Œåç»­è„šæœ¬å‡æ”¾åœ¨è¯¥ç›®å½•ä¸‹è¿è¡Œã€‚è¿è¡Œä¸Šè¿°è„šæœ¬ï¼Œå³å¯åœ¨æœ¬åœ°æ„å»ºå·²æŒä¹…åŒ–çš„å‘é‡æ•°æ®åº“ï¼Œåç»­ç›´æ¥å¯¼å…¥è¯¥æ•°æ®åº“å³å¯ï¼Œæ— éœ€é‡å¤æ„å»ºã€‚</p>
<h2 id="InternLM-æ¥å…¥-LangChain"><a href="#InternLM-æ¥å…¥-LangChain" class="headerlink" title="InternLM æ¥å…¥ LangChain"></a>InternLM æ¥å…¥ LangChain</h2><p>ä¸ºä¾¿æ·æ„å»º LLM åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦åŸºäºæœ¬åœ°éƒ¨ç½²çš„ InternLMï¼Œç»§æ‰¿ LangChain çš„ LLM ç±»è‡ªå®šä¹‰ä¸€ä¸ª InternLM LLM å­ç±»ï¼Œä»è€Œå®ç°å°† InternLM æ¥å…¥åˆ° LangChain æ¡†æ¶ä¸­ã€‚å®Œæˆ LangChain çš„è‡ªå®šä¹‰ LLM å­ç±»ä¹‹åï¼Œå¯ä»¥ä»¥å®Œå…¨ä¸€è‡´çš„æ–¹å¼è°ƒç”¨ LangChain çš„æ¥å£ï¼Œè€Œæ— éœ€è€ƒè™‘åº•å±‚æ¨¡å‹è°ƒç”¨çš„ä¸ä¸€è‡´ã€‚</p>
<p>åŸºäºæœ¬åœ°éƒ¨ç½²çš„ InternLM è‡ªå®šä¹‰ LLM ç±»å¹¶ä¸å¤æ‚ï¼Œæˆ‘ä»¬åªéœ€ä» LangChain.llms.base.LLM ç±»ç»§æ‰¿ä¸€ä¸ªå­ç±»ï¼Œå¹¶é‡å†™æ„é€ å‡½æ•°ä¸ <code>_call</code> å‡½æ•°å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.llms.base <span class="hljs-keyword">import</span> LLM<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span><br><span class="hljs-keyword">from</span> langchain.callbacks.manager <span class="hljs-keyword">import</span> CallbackManagerForLLMRun<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer, AutoModelForCausalLM<br><span class="hljs-keyword">import</span> torch<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">InternLM_LLM</span>(<span class="hljs-title class_ inherited__">LLM</span>):<br>    <span class="hljs-comment"># åŸºäºæœ¬åœ° InternLM è‡ªå®šä¹‰ LLM ç±»</span><br>    tokenizer : AutoTokenizer = <span class="hljs-literal">None</span><br>    model: AutoModelForCausalLM = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_path :<span class="hljs-built_in">str</span></span>):<br>        <span class="hljs-comment"># model_path: InternLM æ¨¡å‹è·¯å¾„</span><br>        <span class="hljs-comment"># ä»æœ¬åœ°åˆå§‹åŒ–æ¨¡å‹</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ­£åœ¨ä»æœ¬åœ°åŠ è½½æ¨¡å‹...&quot;</span>)<br>        self.tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=<span class="hljs-literal">True</span>)<br>        self.model = AutoModelForCausalLM.from_pretrained(model_path, trust_remote_code=<span class="hljs-literal">True</span>).to(torch.bfloat16).cuda()<br>        self.model = self.model.<span class="hljs-built_in">eval</span>()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å®Œæˆæœ¬åœ°æ¨¡å‹çš„åŠ è½½&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_call</span>(<span class="hljs-params">self, prompt : <span class="hljs-built_in">str</span>, stop: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]] = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">                run_manager: <span class="hljs-type">Optional</span>[CallbackManagerForLLMRun] = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">                **kwargs: <span class="hljs-type">Any</span></span>):<br>        <span class="hljs-comment"># é‡å†™è°ƒç”¨å‡½æ•°</span><br>        system_prompt = <span class="hljs-string">&quot;&quot;&quot;You are an AI assistant whose name is InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­).</span><br><span class="hljs-string">        - InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) is a conversational language model that is developed by Shanghai AI Laboratory (ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤). It is designed to be helpful, honest, and harmless.</span><br><span class="hljs-string">        - InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) can understand and communicate fluently in the language chosen by the user such as English and ä¸­æ–‡.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <br>        messages = [(system_prompt, <span class="hljs-string">&#x27;&#x27;</span>)]<br>        response, history = self.model.chat(self.tokenizer, prompt , history=messages)<br>        <span class="hljs-keyword">return</span> response<br>        <br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_llm_type</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;InternLM&quot;</span><br></code></pre></td></tr></table></figure>
<p>åœ¨ä¸Šè¿°ç±»å®šä¹‰ä¸­ï¼Œé‡å†™äº†æ„é€ å‡½æ•°å’Œ <code>_call</code> å‡½æ•°ï¼šå¯¹äºæ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨å¯¹è±¡å®ä¾‹åŒ–çš„ä¸€å¼€å§‹åŠ è½½æœ¬åœ°éƒ¨ç½²çš„ InternLM æ¨¡å‹ï¼Œä»è€Œé¿å…æ¯ä¸€æ¬¡è°ƒç”¨éƒ½éœ€è¦é‡æ–°åŠ è½½æ¨¡å‹å¸¦æ¥çš„æ—¶é—´è¿‡é•¿ï¼›<code>_call</code> å‡½æ•°æ˜¯ LLM ç±»çš„æ ¸å¿ƒå‡½æ•°ï¼ŒLangChain ä¼šè°ƒç”¨è¯¥å‡½æ•°æ¥è°ƒç”¨ LLMï¼Œåœ¨è¯¥å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨å·²å®ä¾‹åŒ–æ¨¡å‹çš„ chat æ–¹æ³•ï¼Œä»è€Œå®ç°å¯¹æ¨¡å‹çš„è°ƒç”¨å¹¶è¿”å›è°ƒç”¨ç»“æœã€‚</p>
<p>åœ¨æ•´ä½“é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ä¸Šè¿°ä»£ç å°è£…ä¸º LLM.pyï¼Œåç»­å°†ç›´æ¥ä»è¯¥æ–‡ä»¶ä¸­å¼•å…¥è‡ªå®šä¹‰çš„ LLM ç±»ã€‚</p>
<h2 id="æ„å»ºæ£€ç´¢é—®ç­”é“¾"><a href="#æ„å»ºæ£€ç´¢é—®ç­”é“¾" class="headerlink" title="æ„å»ºæ£€ç´¢é—®ç­”é“¾"></a>æ„å»ºæ£€ç´¢é—®ç­”é“¾</h2><p>LangChain é€šè¿‡æä¾›æ£€ç´¢é—®ç­”é“¾å¯¹è±¡æ¥å®ç°å¯¹äº RAG å…¨æµç¨‹çš„å°è£…ã€‚æ‰€è°“æ£€ç´¢é—®ç­”é“¾ï¼Œå³é€šè¿‡ä¸€ä¸ªå¯¹è±¡å®Œæˆæ£€ç´¢å¢å¼ºé—®ç­”ï¼ˆå³RAGï¼‰çš„å…¨æµç¨‹ï¼Œé’ˆå¯¹ RAG çš„æ›´å¤šæ¦‚å¿µï¼Œæˆ‘ä»¬ä¼šåœ¨è§†é¢‘å†…å®¹ä¸­è®²è§£ï¼Œä¹Ÿæ¬¢è¿è¯»è€…æŸ¥é˜…è¯¥æ•™ç¨‹æ¥è¿›ä¸€æ­¥äº†è§£ï¼š<a href="https://github.com/datawhalechina/llm-universe/tree/main">ã€ŠLLM Universeã€‹</a>ã€‚æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä¸€ä¸ª LangChain æä¾›çš„ <code>RetrievalQA</code> å¯¹è±¡ï¼Œé€šè¿‡åˆå§‹åŒ–æ—¶å¡«å…¥å·²æ„å»ºçš„æ•°æ®åº“å’Œè‡ªå®šä¹‰ LLM ä½œä¸ºå‚æ•°ï¼Œæ¥ç®€ä¾¿åœ°å®Œæˆæ£€ç´¢å¢å¼ºé—®ç­”çš„å…¨æµç¨‹ï¼ŒLangChain ä¼šè‡ªåŠ¨å®ŒæˆåŸºäºç”¨æˆ·æé—®è¿›è¡Œæ£€ç´¢ã€è·å–ç›¸å…³æ–‡æ¡£ã€æ‹¼æ¥ä¸ºåˆé€‚çš„ Prompt å¹¶äº¤ç»™ LLM é—®ç­”çš„å…¨éƒ¨æµç¨‹ã€‚</p>
<h3 id="åŠ è½½å‘é‡æ•°æ®åº“"><a href="#åŠ è½½å‘é‡æ•°æ®åº“" class="headerlink" title="åŠ è½½å‘é‡æ•°æ®åº“"></a>åŠ è½½å‘é‡æ•°æ®åº“</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†ä¸Šæ–‡æ„å»ºçš„å‘é‡æ•°æ®åº“å¯¼å…¥è¿›æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ Chroma ä»¥åŠä¸Šæ–‡å®šä¹‰çš„è¯å‘é‡æ¨¡å‹æ¥åŠ è½½å·²æ„å»ºçš„æ•°æ®åº“ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<br><span class="hljs-keyword">from</span> langchain.embeddings.huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># å®šä¹‰ Embeddings</span><br>embeddings = HuggingFaceEmbeddings(model_name=<span class="hljs-string">&quot;/root/data/model/bge-large-zh-v1.5&quot;</span>)<br><br><span class="hljs-comment"># å‘é‡æ•°æ®åº“æŒä¹…åŒ–è·¯å¾„</span><br>persist_directory = <span class="hljs-string">&#x27;data_base/vector_db/chroma&#x27;</span><br><br><span class="hljs-comment"># åŠ è½½æ•°æ®åº“</span><br>vectordb = Chroma(<br>    persist_directory=persist_directory, <br>    embedding_function=embeddings<br>)<br></code></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç å¾—åˆ°çš„ <code>vectordb</code> å¯¹è±¡å³ä¸ºæˆ‘ä»¬å·²æ„å»ºçš„å‘é‡æ•°æ®åº“å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥é’ˆå¯¹ç”¨æˆ·çš„ <code>query</code> è¿›è¡Œè¯­ä¹‰å‘é‡æ£€ç´¢ï¼Œå¾—åˆ°ä¸ç”¨æˆ·æé—®ç›¸å…³çš„çŸ¥è¯†ç‰‡æ®µã€‚</p>
<h3 id="å®ä¾‹åŒ–è‡ªå®šä¹‰-LLM-ä¸-Prompt-Template"><a href="#å®ä¾‹åŒ–è‡ªå®šä¹‰-LLM-ä¸-Prompt-Template" class="headerlink" title="å®ä¾‹åŒ–è‡ªå®šä¹‰ LLM ä¸ Prompt Template"></a>å®ä¾‹åŒ–è‡ªå®šä¹‰ LLM ä¸ Prompt Template</h3><p>æ¥ç€ï¼Œæˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªåŸºäº InternLM è‡ªå®šä¹‰çš„ LLM å¯¹è±¡ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> LLM <span class="hljs-keyword">import</span> InternLM_LLM<br>llm = InternLM_LLM(model_path = <span class="hljs-string">&quot;/root/data/model/Shanghai_AI_Laboratory/internlm-chat-7b&quot;</span>)<br>llm.predict(<span class="hljs-string">&quot;ä½ æ˜¯è°&quot;</span>)<br></code></pre></td></tr></table></figure>
<p>æ„å»ºæ£€ç´¢é—®ç­”é“¾ï¼Œè¿˜éœ€è¦æ„å»ºä¸€ä¸ª Prompt Templateï¼Œè¯¥ Template å…¶å®åŸºäºä¸€ä¸ªå¸¦å˜é‡çš„å­—ç¬¦ä¸²ï¼Œåœ¨æ£€ç´¢ä¹‹åï¼ŒLangChain ä¼šå°†æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£ç‰‡æ®µå¡«å…¥åˆ° Template çš„å˜é‡ä¸­ï¼Œä»è€Œå®ç°å¸¦çŸ¥è¯†çš„ Prompt æ„å»ºã€‚æˆ‘ä»¬å¯ä»¥åŸºäº LangChain çš„ Template åŸºç±»æ¥å®ä¾‹åŒ–è¿™æ ·ä¸€ä¸ª Template å¯¹è±¡ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><br><span class="hljs-comment"># æˆ‘ä»¬æ‰€æ„é€ çš„ Prompt æ¨¡æ¿</span><br>template = <span class="hljs-string">&quot;&quot;&quot;ä½¿ç”¨ä»¥ä¸‹ä¸Šä¸‹æ–‡æ¥å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œå°±è¯´ä½ ä¸çŸ¥é“ã€‚æ€»æ˜¯ä½¿ç”¨ä¸­æ–‡å›ç­”ã€‚</span><br><span class="hljs-string">é—®é¢˜: &#123;question&#125;</span><br><span class="hljs-string">å¯å‚è€ƒçš„ä¸Šä¸‹æ–‡ï¼š</span><br><span class="hljs-string">Â·Â·Â·</span><br><span class="hljs-string">&#123;context&#125;</span><br><span class="hljs-string">Â·Â·Â·</span><br><span class="hljs-string">å¦‚æœç»™å®šçš„ä¸Šä¸‹æ–‡æ— æ³•è®©ä½ åšå‡ºå›ç­”ï¼Œè¯·å›ç­”ä½ ä¸çŸ¥é“ã€‚</span><br><span class="hljs-string">æœ‰ç”¨çš„å›ç­”:&quot;&quot;&quot;</span><br><br><span class="hljs-comment"># è°ƒç”¨ LangChain çš„æ–¹æ³•æ¥å®ä¾‹åŒ–ä¸€ä¸ª Template å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº† context å’Œ question ä¸¤ä¸ªå˜é‡ï¼Œåœ¨å®é™…è°ƒç”¨æ—¶ï¼Œè¿™ä¸¤ä¸ªå˜é‡ä¼šè¢«æ£€ç´¢åˆ°çš„æ–‡æ¡£ç‰‡æ®µå’Œç”¨æˆ·æé—®å¡«å……</span><br>QA_CHAIN_PROMPT = PromptTemplate(input_variables=[<span class="hljs-string">&quot;context&quot;</span>,<span class="hljs-string">&quot;question&quot;</span>],template=template)<br></code></pre></td></tr></table></figure>
<h3 id="æ„å»ºæ£€ç´¢é—®ç­”é“¾-1"><a href="#æ„å»ºæ£€ç´¢é—®ç­”é“¾-1" class="headerlink" title="æ„å»ºæ£€ç´¢é—®ç­”é“¾"></a>æ„å»ºæ£€ç´¢é—®ç­”é“¾</h3><p>æœ€åï¼Œå¯ä»¥è°ƒç”¨ LangChain æä¾›çš„æ£€ç´¢é—®ç­”é“¾æ„é€ å‡½æ•°ï¼ŒåŸºäºæˆ‘ä»¬çš„è‡ªå®šä¹‰ LLMã€Prompt Template å’Œå‘é‡çŸ¥è¯†åº“æ¥æ„å»ºä¸€ä¸ªåŸºäº InternLM çš„æ£€ç´¢é—®ç­”é“¾ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA<br><br>qa_chain = RetrievalQA.from_chain_type(llm,retriever=vectordb.as_retriever(),return_source_documents=<span class="hljs-literal">True</span>,chain_type_kwargs=&#123;<span class="hljs-string">&quot;prompt&quot;</span>:QA_CHAIN_PROMPT&#125;)<br></code></pre></td></tr></table></figure>
<p>å¾—åˆ°çš„ <code>qa_chain</code> å¯¹è±¡å³å¯ä»¥å®ç°æˆ‘ä»¬çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå³åŸºäº InternLM æ¨¡å‹çš„ä¸“ä¸šçŸ¥è¯†åº“åŠ©æ‰‹ã€‚æˆ‘ä»¬å¯ä»¥å¯¹æ¯”è¯¥æ£€ç´¢é—®ç­”é“¾å’Œçº¯ LLM çš„é—®ç­”æ•ˆæœï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># æ£€ç´¢é—®ç­”é“¾å›ç­”æ•ˆæœ</span><br>question = <span class="hljs-string">&quot;ä»€ä¹ˆæ˜¯InternLM&quot;</span><br>result = qa_chain(&#123;<span class="hljs-string">&quot;query&quot;</span>: question&#125;)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ£€ç´¢é—®ç­”é“¾å›ç­” question çš„ç»“æœï¼š&quot;</span>)<br><span class="hljs-built_in">print</span>(result[<span class="hljs-string">&quot;result&quot;</span>])<br><br><span class="hljs-comment"># ä»… LLM å›ç­”æ•ˆæœ</span><br>result_2 = llm(question)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å¤§æ¨¡å‹å›ç­” question çš„ç»“æœï¼š&quot;</span>)<br><span class="hljs-built_in">print</span>(result_2)<br></code></pre></td></tr></table></figure>
<h2 id="éƒ¨ç½²ä¸€ä¸ª-Web-Demo"><a href="#éƒ¨ç½²ä¸€ä¸ª-Web-Demo" class="headerlink" title="éƒ¨ç½²ä¸€ä¸ª Web Demo"></a>éƒ¨ç½²ä¸€ä¸ª Web Demo</h2><p>ä¹‹åæˆ‘ä»¬å¯ä»¥åŸºäº Gradio æ¡†æ¶å°†å…¶éƒ¨ç½²åˆ° Web ç½‘é¡µï¼Œä»è€Œæ­å»ºä¸€ä¸ªå°å‹ Demoï¼Œä¾¿äºæµ‹è¯•ä¸ä½¿ç”¨ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å¯¼å…¥å¿…è¦çš„åº“</span><br><span class="hljs-keyword">import</span> gradio <span class="hljs-keyword">as</span> gr<br><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<br><span class="hljs-keyword">from</span> langchain.embeddings.huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> LLM <span class="hljs-keyword">import</span> InternLM_LLM<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_chain</span>():<br>    <span class="hljs-comment"># åŠ è½½é—®ç­”é“¾</span><br>    <span class="hljs-comment"># å®šä¹‰ Embeddings</span><br>    embeddings = HuggingFaceEmbeddings(model_name=<span class="hljs-string">&quot;/root/data/model/bge-large-zh-v1.5&quot;</span>)<br><br>    <span class="hljs-comment"># å‘é‡æ•°æ®åº“æŒä¹…åŒ–è·¯å¾„</span><br>    persist_directory = <span class="hljs-string">&#x27;data_base/vector_db/chroma&#x27;</span><br><br>    <span class="hljs-comment"># åŠ è½½æ•°æ®åº“</span><br>    vectordb = Chroma(<br>        persist_directory=persist_directory,  <span class="hljs-comment"># å…è®¸æˆ‘ä»¬å°†persist_directoryç›®å½•ä¿å­˜åˆ°ç£ç›˜ä¸Š</span><br>        embedding_function=embeddings<br>    )<br><br>    llm = InternLM_LLM(model_path = <span class="hljs-string">&quot;/root/data/model/Shanghai_AI_Laboratory/internlm-chat-7b&quot;</span>)<br><br>    template = <span class="hljs-string">&quot;&quot;&quot;ä½¿ç”¨ä»¥ä¸‹ä¸Šä¸‹æ–‡æ¥å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œå°±è¯´ä½ ä¸çŸ¥é“ã€‚æ€»æ˜¯ä½¿ç”¨ä¸­æ–‡å›ç­”ã€‚</span><br><span class="hljs-string">    é—®é¢˜: &#123;question&#125;</span><br><span class="hljs-string">    å¯å‚è€ƒçš„ä¸Šä¸‹æ–‡ï¼š</span><br><span class="hljs-string">    Â·Â·Â·</span><br><span class="hljs-string">    &#123;context&#125;</span><br><span class="hljs-string">    Â·Â·Â·</span><br><span class="hljs-string">    å¦‚æœç»™å®šçš„ä¸Šä¸‹æ–‡æ— æ³•è®©ä½ åšå‡ºå›ç­”ï¼Œè¯·å›ç­”ä½ ä¸çŸ¥é“ã€‚</span><br><span class="hljs-string">    æœ‰ç”¨çš„å›ç­”:&quot;&quot;&quot;</span><br><br>    QA_CHAIN_PROMPT = PromptTemplate(input_variables=[<span class="hljs-string">&quot;context&quot;</span>,<span class="hljs-string">&quot;question&quot;</span>],<br>                                    template=template)<br><br>    <span class="hljs-comment"># è¿è¡Œ chain</span><br>    <span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA<br><br>    qa_chain = RetrievalQA.from_chain_type(llm,<br>                                        retriever=vectordb.as_retriever(),<br>                                        return_source_documents=<span class="hljs-literal">True</span>,<br>                                        chain_type_kwargs=&#123;<span class="hljs-string">&quot;prompt&quot;</span>:QA_CHAIN_PROMPT&#125;)<br>    <br>    <span class="hljs-keyword">return</span> qa_chain<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model_center</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    å­˜å‚¨é—®ç­” Chain çš„å¯¹è±¡ </span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.chain = load_chain()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">qa_chain_self_answer</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span>, chat_history: <span class="hljs-built_in">list</span> = []</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        è°ƒç”¨ä¸å¸¦å†å²è®°å½•çš„é—®ç­”é“¾è¿›è¡Œå›ç­”</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> question == <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(question) &lt; <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, chat_history<br>        <span class="hljs-keyword">try</span>:<br>            chat_history.append(<br>                (question, self.chain(&#123;<span class="hljs-string">&quot;query&quot;</span>: question&#125;)[<span class="hljs-string">&quot;result&quot;</span>]))<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, chat_history<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> e, chat_history<br><br><br>model_center = Model_center()<br><br>block = gr.Blocks()<br><span class="hljs-keyword">with</span> block <span class="hljs-keyword">as</span> demo:<br>    <span class="hljs-keyword">with</span> gr.Row(equal_height=<span class="hljs-literal">True</span>):   <br>        <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">15</span>):<br>            gr.Markdown(<span class="hljs-string">&quot;&quot;&quot;&lt;h1&gt;&lt;center&gt;InternLM&lt;/center&gt;&lt;/h1&gt;</span><br><span class="hljs-string">                &lt;center&gt;ä¹¦ç”Ÿæµ¦è¯­&lt;/center&gt;</span><br><span class="hljs-string">                &quot;&quot;&quot;</span>)<br>        <span class="hljs-comment"># gr.Image(value=LOGO_PATH, scale=1, min_width=10,show_label=False, show_download_button=False)</span><br><br>    <span class="hljs-keyword">with</span> gr.Row():<br>        <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">4</span>):<br>            chatbot = gr.Chatbot(height=<span class="hljs-number">450</span>, show_copy_button=<span class="hljs-literal">True</span>)<br>            <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ¡†ç»„ä»¶ï¼Œç”¨äºè¾“å…¥ promptã€‚</span><br>            msg = gr.Textbox(label=<span class="hljs-string">&quot;Prompt/é—®é¢˜&quot;</span>)<br><br>            <span class="hljs-keyword">with</span> gr.Row():<br>                <span class="hljs-comment"># åˆ›å»ºæäº¤æŒ‰é’®ã€‚</span><br>                db_wo_his_btn = gr.Button(<span class="hljs-string">&quot;Chat&quot;</span>)<br>            <span class="hljs-keyword">with</span> gr.Row():<br>                <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªæ¸…é™¤æŒ‰é’®ï¼Œç”¨äºæ¸…é™¤èŠå¤©æœºå™¨äººç»„ä»¶çš„å†…å®¹ã€‚</span><br>                clear = gr.ClearButton(<br>                    components=[chatbot], value=<span class="hljs-string">&quot;Clear console&quot;</span>)<br>                <br>        <span class="hljs-comment"># è®¾ç½®æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ã€‚å½“ç‚¹å‡»æ—¶ï¼Œè°ƒç”¨ä¸Šé¢å®šä¹‰çš„ qa_chain_self_answer å‡½æ•°ï¼Œå¹¶ä¼ å…¥ç”¨æˆ·çš„æ¶ˆæ¯å’ŒèŠå¤©å†å²è®°å½•ï¼Œç„¶åæ›´æ–°æ–‡æœ¬æ¡†å’ŒèŠå¤©æœºå™¨äººç»„ä»¶ã€‚</span><br>        db_wo_his_btn.click(model_center.qa_chain_self_answer, inputs=[<br>                            msg, chatbot], outputs=[msg, chatbot])<br>        <br>    gr.Markdown(<span class="hljs-string">&quot;&quot;&quot;æé†’ï¼š&lt;br&gt;</span><br><span class="hljs-string">    1. åˆå§‹åŒ–æ•°æ®åº“æ—¶é—´å¯èƒ½è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚</span><br><span class="hljs-string">    2. ä½¿ç”¨ä¸­å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œå°†ä¼šåœ¨æ–‡æœ¬è¾“å…¥æ¡†è¿›è¡Œå±•ç¤ºï¼Œè¯·ä¸è¦æƒŠæ…Œã€‚ &lt;br&gt;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>)<br><span class="hljs-comment"># threads to consume the request</span><br>gr.close_all()<br><span class="hljs-comment"># å¯åŠ¨æ–°çš„ Gradio åº”ç”¨ï¼Œè®¾ç½®åˆ†äº«åŠŸèƒ½ä¸º Trueï¼Œå¹¶ä½¿ç”¨ç¯å¢ƒå˜é‡ PORT1 æŒ‡å®šæœåŠ¡å™¨ç«¯å£ã€‚</span><br><span class="hljs-comment"># demo.launch(share=True, server_port=int(os.environ[&#x27;PORT1&#x27;]))</span><br><span class="hljs-comment"># ç›´æ¥å¯åŠ¨</span><br>demo.launch()<br></code></pre></td></tr></table></figure>
<p>è¿è¡Œæˆªå›¾å¦‚ä¸‹ï¼š</p>
<p><img  src="gradio.png"  ><span class="image-caption">è¿è¡Œgradio</span></p>
<p><img  src="Langchain+InternLMé—®ç­”.png"  ><span class="image-caption">Langchain+InternLMé—®ç­”</span></p>
<p>å¦‚å›¾ï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°å›ç­”çŸ¥è¯†åº“ä¸­çš„çŸ¥è¯†ã€‚</p>
<h2 id="é—®é¢˜è§£å†³ä»¥åŠ-Langchain-è°ƒè¯•"><a href="#é—®é¢˜è§£å†³ä»¥åŠ-Langchain-è°ƒè¯•" class="headerlink" title="é—®é¢˜è§£å†³ä»¥åŠ Langchain è°ƒè¯•"></a>é—®é¢˜è§£å†³ä»¥åŠ Langchain è°ƒè¯•</h2><p>æˆ‘ä»¬åœ¨é‡åˆ°å¥‡æ€ªé—®é¢˜çš„æ—¶å€™ï¼Œæƒ³è¦è°ƒè¯• Langchainï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å€ŸåŠ© Langchain çš„å…¨å±€è®¾ç½®è®¾ç½®è°ƒè¯•æ¨¡å¼ï¼Œè®¾ç½®æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><a href="https://python.langchain.com/docs/guides/debugging">Debugging | ğŸ¦œï¸ğŸ”— Langchain</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.<span class="hljs-built_in">globals</span> <span class="hljs-keyword">import</span> set_verbose <span class="hljs-comment"># æˆ‘è¿™é‡Œç”¨çš„ langchain ç‰ˆæœ¬ä¸º 0.1.0</span><br><br>set_verbose(<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>
<p><img  src="langchain-debug.png"  ><span class="image-caption">langchain çš„è°ƒè¯•è¾“å‡º</span></p>
<h2 id="å°†åº”ç”¨éƒ¨ç½²åœ¨-OpenXLab-ä¸Š"><a href="#å°†åº”ç”¨éƒ¨ç½²åœ¨-OpenXLab-ä¸Š" class="headerlink" title="å°†åº”ç”¨éƒ¨ç½²åœ¨ OpenXLab ä¸Š"></a>å°†åº”ç”¨éƒ¨ç½²åœ¨ OpenXLab ä¸Š</h2><p><a href="https://openxlab.org.cn/apps/detail/EnableAsync/network-bot">è®¡ç®—æœºç½‘ç»œé—®ç­”æœºå™¨äºº</a></p>
<h3 id="Sqlite-é—®é¢˜1"><a href="#Sqlite-é—®é¢˜1" class="headerlink" title="Sqlite é—®é¢˜1"></a>Sqlite é—®é¢˜<sup><a href="#fn_1" id="reffn_1">1</a></sup></h3><p>OpenXLab ä¸Šçš„ sqlite3 ç‰ˆæœ¬ä½äºæˆ‘ä»¬é¡¹ç›®ç”¨çš„ Chroma è¦æ±‚ã€‚å¯å‚è€ƒ<a href="https://link.zhihu.com/?target=https%3A//docs.trychroma.com/troubleshooting%23sqlite"> Troubleshooting | Chroma (trychroma.com)</a>ï¼Œåœ¨ <code>requirements.txt</code> ä¸­æ·»åŠ  <code>pysqlite3-binary</code> ï¼Œä¹‹ååŠ è½½ sqlite3 åº“æ¥ç»•è¿‡è¿™ä¸ªé—®é¢˜ã€‚å¦åˆ™å°±è¦å†™è„šæœ¬åœ¨è¿è¡Œæ—¶è‡ªå·±å®‰è£…ä¸Šæ›´æ–°ç‰ˆæœ¬çš„sqlite3äº†ã€‚ä¸‹é¢æ˜¯ä¿®æ”¹åŠ è½½ sqlite3 åº“çš„ trick å‘½ä»¤ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;pysqlite3&#x27;</span>)<br><span class="hljs-keyword">import</span> sys<br>sys.modules[<span class="hljs-string">&#x27;sqlite3&#x27;</span>] = sys.modules.pop(<span class="hljs-string">&#x27;pysqlite3&#x27;</span>)<br></code></pre></td></tr></table></figure>
<h3 id="è¿è¡Œæˆªå›¾"><a href="#è¿è¡Œæˆªå›¾" class="headerlink" title="è¿è¡Œæˆªå›¾"></a>è¿è¡Œæˆªå›¾</h3><p><img  src="openxlab-deploy.png"  ><span class="image-caption">openxlab-deploy</span></p>
<p><img  src="loading.png"  ><span class="image-caption">åŠ è½½æ¨¡å‹</span></p>
<p><img  src="éƒ¨ç½².png"  ><span class="image-caption">éƒ¨ç½²</span></p>
<p><img  src="è¿è¡Œæ—¥å¿—.png"  ><span class="image-caption">è¿è¡Œæ—¥å¿—</span></p>
<h2 id="å‚è€ƒå†…å®¹"><a href="#å‚è€ƒå†…å®¹" class="headerlink" title="å‚è€ƒå†…å®¹"></a>å‚è€ƒå†…å®¹</h2><blockquote id="fn_1">
<sup>1</sup>. <a href="https://zhuanlan.zhihu.com/p/676719586">ä¹¦ç”Ÿãƒ»æµ¦è¯­å¤§æ¨¡å‹å®æˆ˜è¥ç¬¬ä¸‰è¯¾ä½œä¸š(åŸºç¡€+è¿›é˜¶) - çŸ¥ä¹ (zhihu.com)</a><a href="#reffn_1" title="Jump back to footnote [1] in the text."> &#8617;</a>
</blockquote>
]]></content>
      <categories>
        <category>internlm</category>
      </categories>
  </entry>
  <entry>
    <title>Internlm-04-XTuner å¤§æ¨¡å‹å•å¡ä½æˆæœ¬å¾®è°ƒå®æˆ˜</title>
    <url>/internlm/internlm-04/</url>
    <content><![CDATA[<h1 id="XTuner-å¤§æ¨¡å‹å•å¡ä½æˆæœ¬å¾®è°ƒå®æˆ˜"><a href="#XTuner-å¤§æ¨¡å‹å•å¡ä½æˆæœ¬å¾®è°ƒå®æˆ˜" class="headerlink" title="XTuner å¤§æ¨¡å‹å•å¡ä½æˆæœ¬å¾®è°ƒå®æˆ˜"></a>XTuner å¤§æ¨¡å‹å•å¡ä½æˆæœ¬å¾®è°ƒå®æˆ˜</h1><p>å¾®è°ƒå‰<br><img  src="å®˜æ–¹å›ç­”.png"  ><span class="image-caption">å®˜æ–¹å›ç­”</span></p>
<p>å¾®è°ƒå<br><img  src="å¾®è°ƒå.png"  ><span class="image-caption">å¾®è°ƒå.png</span></p>
<h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1 æ¦‚è¿°"></a>1 æ¦‚è¿°</h2><h3 id="1-1-XTuner"><a href="#1-1-XTuner" class="headerlink" title="1.1 XTuner"></a>1.1 XTuner</h3><p>ä¸€ä¸ªå¤§è¯­è¨€æ¨¡å‹å¾®è°ƒå·¥å…·ç®±ã€‚ç”± MMRazor å’Œ MMDeploy è”åˆå¼€å‘ã€‚</p>
<h3 id="1-2-æ”¯æŒçš„å¼€æºLLM-2023-11-01"><a href="#1-2-æ”¯æŒçš„å¼€æºLLM-2023-11-01" class="headerlink" title="1.2 æ”¯æŒçš„å¼€æºLLM (2023.11.01)"></a>1.2 æ”¯æŒçš„å¼€æºLLM (2023.11.01)</h3><ul>
<li><a href="https://huggingface.co/internlm/internlm-7b">InternLM</a></li>
<li><a href="https://huggingface.co/meta-llama">Llamaï¼ŒLlama2</a></li>
<li><a href="https://huggingface.co/THUDM/chatglm2-6b">ChatGLM2</a>ï¼Œ<a href="https://huggingface.co/THUDM/chatglm3-6b-base">ChatGLM3</a></li>
<li><a href="https://huggingface.co/Qwen/Qwen-7B">Qwen</a></li>
<li><a href="https://huggingface.co/baichuan-inc/Baichuan-7B">Baichuan</a>ï¼Œ<a href="https://huggingface.co/baichuan-inc/Baichuan2-7B-Base">Baichuan2</a></li>
<li><a href="https://huggingface.co/HuggingFaceH4/zephyr-7b-beta">Zephyr</a> </li>
</ul>
<h3 id="1-3-ç‰¹è‰²"><a href="#1-3-ç‰¹è‰²" class="headerlink" title="1.3 ç‰¹è‰²"></a>1.3 ç‰¹è‰²</h3><ul>
<li><strong>å‚»ç“œåŒ–ï¼š</strong> ä»¥ é…ç½®æ–‡ä»¶ çš„å½¢å¼å°è£…äº†å¤§éƒ¨åˆ†å¾®è°ƒåœºæ™¯ï¼Œ<strong>0åŸºç¡€çš„éä¸“ä¸šäººå‘˜ä¹Ÿèƒ½ä¸€é”®å¼€å§‹å¾®è°ƒ</strong>ã€‚</li>
<li><strong>è½»é‡çº§ï¼š</strong> å¯¹äº 7B å‚æ•°é‡çš„LLMï¼Œ<strong>å¾®è°ƒæ‰€éœ€çš„æœ€å°æ˜¾å­˜ä»…ä¸º 8GB</strong></li>
</ul>
<h3 id="1-4-å¾®è°ƒåŸç†"><a href="#1-4-å¾®è°ƒåŸç†" class="headerlink" title="1.4 å¾®è°ƒåŸç†"></a>1.4 å¾®è°ƒåŸç†</h3><blockquote>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ä¸ªè¶…å¤§çš„ç©å…·ï¼Œç°åœ¨ä½ æƒ³æ”¹é€ è¿™ä¸ªè¶…å¤§çš„ç©å…·ã€‚ä½†æ˜¯ï¼Œ<strong>å¯¹æ•´ä¸ªç©å…·è¿›è¡Œå…¨é¢çš„æ”¹åŠ¨ä¼šéå¸¸æ˜‚è´µ</strong>ã€‚</p>
</blockquote>
<p>â€» å› æ­¤ï¼Œä½ æ‰¾åˆ°äº†ä¸€ç§å« <strong>LoRA</strong> çš„æ–¹æ³•ï¼š<strong>åªå¯¹ç©å…·ä¸­çš„æŸäº›é›¶ä»¶è¿›è¡Œæ”¹åŠ¨ï¼Œè€Œä¸æ˜¯å¯¹æ•´ä¸ªç©å…·è¿›è¡Œå…¨é¢æ”¹åŠ¨</strong>ã€‚</p>
<p>â€» è€Œ <strong>QLoRA</strong> æ˜¯ LoRA çš„ä¸€ç§æ”¹è¿›</p>
<h2 id="2-å¿«é€Ÿä¸Šæ‰‹"><a href="#2-å¿«é€Ÿä¸Šæ‰‹" class="headerlink" title="2 å¿«é€Ÿä¸Šæ‰‹"></a>2 å¿«é€Ÿä¸Šæ‰‹</h2><h3 id="2-1-å¹³å°"><a href="#2-1-å¹³å°" class="headerlink" title="2.1 å¹³å°"></a>2.1 å¹³å°</h3><p>Ubuntu + Anaconda + CUDA/CUDNN + 8GB nvidiaæ˜¾å¡</p>
<h3 id="2-2-å®‰è£…"><a href="#2-2-å®‰è£…" class="headerlink" title="2.2 å®‰è£…"></a>2.2 å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¦‚æœä½ æ˜¯åœ¨ InternStudio å¹³å°ï¼Œåˆ™ä»æœ¬åœ° clone ä¸€ä¸ªå·²æœ‰ pytorch 2.0.1 çš„ç¯å¢ƒï¼š</span><br>/root/share/install_conda_env_internlm_base.sh xtuner0.1.9<br><span class="hljs-comment"># å¦‚æœä½ æ˜¯åœ¨å…¶ä»–å¹³å°ï¼š</span><br>conda create --name xtuner0.1.9 python=3.10 -y<br><br><span class="hljs-comment"># æ¿€æ´»ç¯å¢ƒ</span><br>conda activate xtuner0.1.9<br><span class="hljs-comment"># è¿›å…¥å®¶ç›®å½• ï¼ˆ~çš„æ„æ€æ˜¯ â€œå½“å‰ç”¨æˆ·çš„homeè·¯å¾„â€ï¼‰</span><br><span class="hljs-built_in">cd</span> ~<br><span class="hljs-comment"># åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶å¤¹å¹¶è¿›å…¥ï¼Œä»¥è·Ÿéšæœ¬æ•™ç¨‹</span><br><span class="hljs-built_in">mkdir</span> xtuner019 &amp;&amp; <span class="hljs-built_in">cd</span> xtuner019<br><br><br><span class="hljs-comment"># æ‹‰å– 0.1.9 çš„ç‰ˆæœ¬æºç </span><br>git <span class="hljs-built_in">clone</span> -b v0.1.9  https://github.com/InternLM/xtuner<br><span class="hljs-comment"># æ— æ³•è®¿é—®githubçš„ç”¨æˆ·è¯·ä» gitee æ‹‰å–:</span><br><span class="hljs-comment"># git clone -b v0.1.9 https://gitee.com/Internlm/xtuner</span><br><br><span class="hljs-comment"># è¿›å…¥æºç ç›®å½•</span><br><span class="hljs-built_in">cd</span> xtuner<br><br><span class="hljs-comment"># ä»æºç å®‰è£… XTuner</span><br>pip install -e <span class="hljs-string">&#x27;.[all]&#x27;</span><br></code></pre></td></tr></table></figure>
<p>å®‰è£…å®Œåï¼Œå°±å¼€å§‹ææå‡†å¤‡å·¥ä½œäº†ã€‚ï¼ˆå‡†å¤‡åœ¨ oasst1 æ•°æ®é›†ä¸Šå¾®è°ƒ internlm-7b-chatï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªå¾®è°ƒ oasst1 æ•°æ®é›†çš„å·¥ä½œè·¯å¾„ï¼Œè¿›å…¥</span><br><span class="hljs-built_in">mkdir</span> ~/ft-oasst1 &amp;&amp; <span class="hljs-built_in">cd</span> ~/ft-oasst1<br></code></pre></td></tr></table></figure>
<h3 id="2-3-å¾®è°ƒ"><a href="#2-3-å¾®è°ƒ" class="headerlink" title="2.3 å¾®è°ƒ"></a>2.3 å¾®è°ƒ</h3><h4 id="2-3-1-å‡†å¤‡é…ç½®æ–‡ä»¶"><a href="#2-3-1-å‡†å¤‡é…ç½®æ–‡ä»¶" class="headerlink" title="2.3.1 å‡†å¤‡é…ç½®æ–‡ä»¶"></a>2.3.1 å‡†å¤‡é…ç½®æ–‡ä»¶</h4><p>XTuner æä¾›å¤šä¸ªå¼€ç®±å³ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># åˆ—å‡ºæ‰€æœ‰å†…ç½®é…ç½®</span><br>xtuner list-cfg<br></code></pre></td></tr></table></figure>
<blockquote>
<p>å‡å¦‚æ˜¾ç¤ºbash: xtuner: command not foundçš„è¯å¯ä»¥è€ƒè™‘åœ¨ç»ˆç«¯è¾“å…¥ export PATH=$PATH:â€™/root/.local/binâ€™</p>
</blockquote>
<p><img  src="cfg-list.png"  ><span class="image-caption">éƒ¨åˆ†é…ç½®æ–‡ä»¶å±•ç¤º</span></p>
<p>æ‹·è´ä¸€ä¸ªé…ç½®æ–‡ä»¶åˆ°å½“å‰ç›®å½•ï¼š<br><code># xtuner copy-cfg $&#123;CONFIG_NAME&#125; $&#123;SAVE_PATH&#125;</code></p>
<p>åœ¨æœ¬æ¡ˆä¾‹ä¸­å³ï¼šï¼ˆæ³¨æ„æœ€åæœ‰ä¸ªè‹±æ–‡å¥å·ï¼Œä»£è¡¨å¤åˆ¶åˆ°å½“å‰è·¯å¾„ï¼‰<br><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash"><span class="hljs-built_in">cd</span> ~/ft-oasst1<br>xtuner copy-cfg internlm_chat_7b_qlora_oasst1_e3 .<br></code></pre></td></tr></table></figure></p>
<p>é…ç½®æ–‡ä»¶åçš„è§£é‡Šï¼š</p>
<blockquote>
<p>xtuner copy-cfg internlm_chat_7b_qlora_oasst1_e3 .</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>æ¨¡å‹å</th>
<th>internlm_chat_7b</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä½¿ç”¨ç®—æ³•</td>
<td>qlora</td>
</tr>
<tr>
<td>æ•°æ®é›†</td>
<td>oasst1</td>
</tr>
<tr>
<td>æŠŠæ•°æ®é›†è·‘å‡ æ¬¡</td>
<td>è·‘3æ¬¡ï¼še3 (epoch 3 )</td>
</tr>
</tbody>
</table>
</div>
<p>*æ—  chatæ¯”å¦‚ <code>internlm-7b</code> ä»£è¡¨æ˜¯åŸºåº§(base)æ¨¡å‹</p>
<h4 id="2-3-2-æ¨¡å‹ä¸‹è½½"><a href="#2-3-2-æ¨¡å‹ä¸‹è½½" class="headerlink" title="2.3.2 æ¨¡å‹ä¸‹è½½"></a>2.3.2 æ¨¡å‹ä¸‹è½½</h4><blockquote>
<p>ç”±äºä¸‹è½½æ¨¡å‹å¾ˆæ…¢ï¼Œç”¨æ•™å­¦å¹³å°çš„åŒå­¦å¯ä»¥ç›´æ¥å¤åˆ¶æ¨¡å‹ã€‚</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash"><span class="hljs-built_in">cp</span> -r /root/share/temp/model_repos/internlm-chat-7b ~/ft-oasst1/<br></code></pre></td></tr></table></figure>
<blockquote>
<p>ä»¥ä¸‹æ˜¯è‡ªå·±ä¸‹è½½æ¨¡å‹çš„æ­¥éª¤ã€‚</p>
</blockquote>
<p>ä¸ç”¨ xtuner é»˜è®¤çš„<code>ä» huggingface æ‹‰å–æ¨¡å‹</code>ï¼Œè€Œæ˜¯æå‰ä» ModelScope ä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œæ”¾æ¨¡å‹æ–‡ä»¶ï¼Œé˜²æ­¢æ•£è½ä¸€åœ°</span><br><span class="hljs-built_in">mkdir</span> ~/ft-oasst1/internlm-chat-7b<br><br><span class="hljs-comment"># è£…ä¸€ä¸‹æ‹‰å–æ¨¡å‹æ–‡ä»¶è¦ç”¨çš„åº“</span><br>pip install modelscope<br><br><span class="hljs-comment"># ä» modelscope ä¸‹è½½ä¸‹è½½æ¨¡å‹æ–‡ä»¶</span><br><span class="hljs-built_in">cd</span> ~/ft-oasst1<br>apt install git git-lfs -y<br>git lfs install<br>git lfs <span class="hljs-built_in">clone</span> https://modelscope.cn/Shanghai_AI_Laboratory/internlm-chat-7b.git -b v1.0.3<br></code></pre></td></tr></table></figure>
<h4 id="2-3-3-æ•°æ®é›†ä¸‹è½½"><a href="#2-3-3-æ•°æ®é›†ä¸‹è½½" class="headerlink" title="2.3.3 æ•°æ®é›†ä¸‹è½½"></a>2.3.3 æ•°æ®é›†ä¸‹è½½</h4><blockquote>
<p><a href="https://huggingface.co/datasets/timdettmers/openassistant-guanaco/tree/main">https://huggingface.co/datasets/timdettmers/openassistant-guanaco/tree/main</a></p>
</blockquote>
<p>ç”±äº huggingface ç½‘ç»œé—®é¢˜ï¼Œå’±ä»¬å·²ç»ç»™å¤§å®¶æå‰ä¸‹è½½å¥½äº†ï¼Œå¤åˆ¶åˆ°æ­£ç¡®ä½ç½®å³å¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/ft-oasst1<br><span class="hljs-comment"># ...-guanaco åé¢æœ‰ä¸ªç©ºæ ¼å’Œè‹±æ–‡å¥å·å•Š</span><br><span class="hljs-built_in">cp</span> -r /root/share/temp/datasets/openassistant-guanaco .<br></code></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œå½“å‰è·¯å¾„çš„æ–‡ä»¶åº”è¯¥é•¿è¿™æ ·ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">|-- internlm-chat-7b<br>|   |-- README.md<br>|   |-- config.json<br>|   |-- configuration.json<br>|   |-- configuration_internlm.py<br>|   |-- generation_config.json<br>|   |-- modeling_internlm.py<br>|   |-- pytorch_model-00001-of-00008.bin<br>|   |-- pytorch_model-00002-of-00008.bin<br>|   |-- pytorch_model-00003-of-00008.bin<br>|   |-- pytorch_model-00004-of-00008.bin<br>|   |-- pytorch_model-00005-of-00008.bin<br>|   |-- pytorch_model-00006-of-00008.bin<br>|   |-- pytorch_model-00007-of-00008.bin<br>|   |-- pytorch_model-00008-of-00008.bin<br>|   |-- pytorch_model.bin.index.json<br>|   |-- special_tokens_map.json<br>|   |-- tokenization_internlm.py<br>|   |-- tokenizer.model<br>|   `-- tokenizer_config.json<br>|-- internlm_chat_7b_qlora_oasst1_e3_copy.py<br>`-- openassistant-guanaco<br>    |-- openassistant_best_replies_eval.jsonl<br>    `-- openassistant_best_replies_train.jsonl<br></code></pre></td></tr></table></figure>
<h4 id="2-3-4-ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#2-3-4-ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="2.3.4 ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>2.3.4 ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><p>ä¿®æ”¹å…¶ä¸­çš„æ¨¡å‹å’Œæ•°æ®é›†ä¸º æœ¬åœ°è·¯å¾„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/ft-oasst1<br>vim internlm_chat_7b_qlora_oasst1_e3_copy.py<br></code></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨vimç•Œé¢å®Œæˆä¿®æ”¹åï¼Œè¯·è¾“å…¥:wqé€€å‡ºã€‚å‡å¦‚è®¤ä¸ºæ”¹é”™äº†å¯ä»¥ç”¨:q!é€€å‡ºä¸”ä¸ä¿å­˜ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘æ‰“å¼€pythonæ–‡ä»¶ç›´æ¥ä¿®æ”¹ï¼Œä½†æ³¨æ„ä¿®æ”¹å®Œåéœ€è¦æŒ‰ä¸‹Ctrl+Sè¿›è¡Œä¿å­˜ã€‚</p>
</blockquote>
<p>å‡å·ä»£è¡¨è¦åˆ é™¤çš„è¡Œï¼ŒåŠ å·ä»£è¡¨è¦å¢åŠ çš„è¡Œã€‚<br><figure class="highlight diff"><table><tr><td class="code"><pre><code class="hljs diff"># ä¿®æ”¹æ¨¡å‹ä¸ºæœ¬åœ°è·¯å¾„<br><span class="hljs-deletion">- pretrained_model_name_or_path = &#x27;internlm/internlm-chat-7b&#x27;</span><br><span class="hljs-addition">+ pretrained_model_name_or_path = &#x27;./internlm-chat-7b&#x27;</span><br><br># ä¿®æ”¹è®­ç»ƒæ•°æ®é›†ä¸ºæœ¬åœ°è·¯å¾„<br><span class="hljs-deletion">- data_path = &#x27;timdettmers/openassistant-guanaco&#x27;</span><br><span class="hljs-addition">+ data_path = &#x27;./openassistant-guanaco&#x27;</span><br></code></pre></td></tr></table></figure></p>
<p><strong>å¸¸ç”¨è¶…å‚</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>å‚æ•°å</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>data_path</strong></td>
<td>æ•°æ®è·¯å¾„æˆ– HuggingFace ä»“åº“å</td>
</tr>
<tr>
<td>max_length</td>
<td>å•æ¡æ•°æ®æœ€å¤§ Token æ•°ï¼Œè¶…è¿‡åˆ™æˆªæ–­</td>
</tr>
<tr>
<td>pack_to_max_length</td>
<td>æ˜¯å¦å°†å¤šæ¡çŸ­æ•°æ®æ‹¼æ¥åˆ° max_lengthï¼Œæé«˜ GPU åˆ©ç”¨ç‡</td>
</tr>
<tr>
<td>accumulative_counts</td>
<td>æ¢¯åº¦ç´¯ç§¯ï¼Œæ¯å¤šå°‘æ¬¡ backward æ›´æ–°ä¸€æ¬¡å‚æ•°</td>
</tr>
<tr>
<td>evaluation_inputs</td>
<td>è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä¼šæ ¹æ®ç»™å®šçš„é—®é¢˜è¿›è¡Œæ¨ç†ï¼Œä¾¿äºè§‚æµ‹è®­ç»ƒçŠ¶æ€</td>
</tr>
<tr>
<td>evaluation_freq</td>
<td>Evaluation çš„è¯„æµ‹é—´éš” iter æ•°</td>
</tr>
<tr>
<td>â€¦â€¦</td>
<td>â€¦â€¦</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>å¦‚æœæƒ³æŠŠæ˜¾å¡çš„ç°å­˜åƒæ»¡ï¼Œå……åˆ†åˆ©ç”¨æ˜¾å¡èµ„æºï¼Œå¯ä»¥å°† <code>max_length</code> å’Œ <code>batch_size</code> è¿™ä¸¤ä¸ªå‚æ•°è°ƒå¤§ã€‚</p>
</blockquote>
<h4 id="2-3-5-å¼€å§‹å¾®è°ƒ"><a href="#2-3-5-å¼€å§‹å¾®è°ƒ" class="headerlink" title="2.3.5 å¼€å§‹å¾®è°ƒ"></a>2.3.5 å¼€å§‹å¾®è°ƒ</h4><p><strong>è®­ç»ƒï¼š</strong></p>
<p>xtuner train ${CONFIG_NAME_OR_PATH}</p>
<p><strong>ä¹Ÿå¯ä»¥å¢åŠ  deepspeed è¿›è¡Œè®­ç»ƒåŠ é€Ÿï¼š</strong></p>
<p>xtuner train ${CONFIG_NAME_OR_PATH} â€”deepspeed deepspeed_zero2</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ QLoRA ç®—æ³•åœ¨ oasst1 æ•°æ®é›†ä¸Šå¾®è°ƒ InternLM-7Bï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># å•å¡</span><br><span class="hljs-comment">## ç”¨åˆšæ‰æ”¹å¥½çš„configæ–‡ä»¶è®­ç»ƒ</span><br>xtuner train ./internlm_chat_7b_qlora_oasst1_e3_copy.py<br><br><span class="hljs-comment"># å¤šå¡</span><br>NPROC_PER_NODE=<span class="hljs-variable">$&#123;GPU_NUM&#125;</span> xtuner train ./internlm_chat_7b_qlora_oasst1_e3_copy.py<br><br><span class="hljs-comment"># è‹¥è¦å¼€å¯ deepspeed åŠ é€Ÿï¼Œå¢åŠ  --deepspeed deepspeed_zero2 å³å¯</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>å¾®è°ƒå¾—åˆ°çš„ PTH æ¨¡å‹æ–‡ä»¶å’Œå…¶ä»–æ‚ä¸ƒæ‚å…«çš„æ–‡ä»¶éƒ½é»˜è®¤åœ¨å½“å‰çš„ <code>./work_dirs</code> ä¸­ã€‚</p>
</blockquote>
<p><img  src="train.png"  ><span class="image-caption">è®­ç»ƒæˆªå›¾</span></p>
<p>è·‘å®Œè®­ç»ƒåï¼Œå½“å‰è·¯å¾„åº”è¯¥é•¿è¿™æ ·ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash">|-- internlm-chat-7b<br>|-- internlm_chat_7b_qlora_oasst1_e3_copy.py<br>|-- openassistant-guanaco<br>|   |-- openassistant_best_replies_eval.jsonl<br>|   `-- openassistant_best_replies_train.jsonl<br>`-- work_dirs<br>    `-- internlm_chat_7b_qlora_oasst1_e3_copy<br>        |-- 20231101_152923<br>        |   |-- 20231101_152923.<span class="hljs-built_in">log</span><br>        |   `-- vis_data<br>        |       |-- 20231101_152923.json<br>        |       |-- config.py<br>        |       `-- scalars.json<br>        |-- epoch_1.pth<br>        |-- epoch_2.pth<br>        |-- epoch_3.pth<br>        |-- internlm_chat_7b_qlora_oasst1_e3_copy.py<br>        `-- last_checkpoint<br></code></pre></td></tr></table></figure>
<h4 id="2-3-6-å°†å¾—åˆ°çš„-PTH-æ¨¡å‹è½¬æ¢ä¸º-HuggingFace-æ¨¡å‹ï¼Œå³ï¼šç”Ÿæˆ-Adapter-æ–‡ä»¶å¤¹"><a href="#2-3-6-å°†å¾—åˆ°çš„-PTH-æ¨¡å‹è½¬æ¢ä¸º-HuggingFace-æ¨¡å‹ï¼Œå³ï¼šç”Ÿæˆ-Adapter-æ–‡ä»¶å¤¹" class="headerlink" title="2.3.6 å°†å¾—åˆ°çš„ PTH æ¨¡å‹è½¬æ¢ä¸º HuggingFace æ¨¡å‹ï¼Œå³ï¼šç”Ÿæˆ Adapter æ–‡ä»¶å¤¹"></a>2.3.6 å°†å¾—åˆ°çš„ PTH æ¨¡å‹è½¬æ¢ä¸º HuggingFace æ¨¡å‹ï¼Œ<strong>å³ï¼šç”Ÿæˆ Adapter æ–‡ä»¶å¤¹</strong></h4><p><code>xtuner convert pth_to_hf $&#123;CONFIG_NAME_OR_PATH&#125; $&#123;PTH_file_dir&#125; $&#123;SAVE_PATH&#125;</code></p>
<p>åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œä¸ºï¼š<br><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> hf<br><span class="hljs-built_in">export</span> MKL_SERVICE_FORCE_INTEL=1<br><br>xtuner convert pth_to_hf ./internlm_chat_7b_qlora_oasst1_e3_copy.py ./work_dirs/internlm_chat_7b_qlora_oasst1_e3_copy/epoch_1.pth ./hf<br></code></pre></td></tr></table></figure><br>æ­¤æ—¶ï¼Œè·¯å¾„ä¸­åº”è¯¥é•¿è¿™æ ·ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash">|-- internlm-chat-7b<br>|-- internlm_chat_7b_qlora_oasst1_e3_copy.py<br>|-- openassistant-guanaco<br>|   |-- openassistant_best_replies_eval.jsonl<br>|   `-- openassistant_best_replies_train.jsonl<br>|-- hf<br>|   |-- README.md<br>|   |-- adapter_config.json<br>|   |-- adapter_model.bin<br>|   `-- xtuner_config.py<br>`-- work_dirs<br>    `-- internlm_chat_7b_qlora_oasst1_e3_copy<br>        |-- 20231101_152923<br>        |   |-- 20231101_152923.<span class="hljs-built_in">log</span><br>        |   `-- vis_data<br>        |       |-- 20231101_152923.json<br>        |       |-- config.py<br>        |       `-- scalars.json<br>        |-- epoch_1.pth<br>        |-- epoch_2.pth<br>        |-- epoch_3.pth<br>        |-- internlm_chat_7b_qlora_oasst1_e3_copy.py<br>        `-- last_checkpoint<br></code></pre></td></tr></table></figure>
<p><span style="color: red;"><strong>æ­¤æ—¶ï¼Œhf æ–‡ä»¶å¤¹å³ä¸ºæˆ‘ä»¬å¹³æ—¶æ‰€ç†è§£çš„æ‰€è°“ â€œLoRA æ¨¡å‹æ–‡ä»¶â€</strong></span></p>
<blockquote>
<p>å¯ä»¥ç®€å•ç†è§£ï¼šLoRA æ¨¡å‹æ–‡ä»¶ = Adapter</p>
</blockquote>
<h3 id="2-4-éƒ¨ç½²ä¸æµ‹è¯•"><a href="#2-4-éƒ¨ç½²ä¸æµ‹è¯•" class="headerlink" title="2.4 éƒ¨ç½²ä¸æµ‹è¯•"></a>2.4 éƒ¨ç½²ä¸æµ‹è¯•</h3><h4 id="2-4-1-å°†-HuggingFace-adapter-åˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼š"><a href="#2-4-1-å°†-HuggingFace-adapter-åˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼š" class="headerlink" title="2.4.1 å°† HuggingFace adapter åˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼š"></a>2.4.1 å°† HuggingFace adapter åˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼š</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash">xtuner convert merge ./internlm-chat-7b ./hf ./merged --max-shard-size 2GB<br><span class="hljs-comment"># xtuner convert merge \</span><br><span class="hljs-comment">#     $&#123;NAME_OR_PATH_TO_LLM&#125; \</span><br><span class="hljs-comment">#     $&#123;NAME_OR_PATH_TO_ADAPTER&#125; \</span><br><span class="hljs-comment">#     $&#123;SAVE_PATH&#125; \</span><br><span class="hljs-comment">#     --max-shard-size 2GB</span><br></code></pre></td></tr></table></figure>
<h4 id="2-4-2-ä¸åˆå¹¶åçš„æ¨¡å‹å¯¹è¯ï¼š"><a href="#2-4-2-ä¸åˆå¹¶åçš„æ¨¡å‹å¯¹è¯ï¼š" class="headerlink" title="2.4.2 ä¸åˆå¹¶åçš„æ¨¡å‹å¯¹è¯ï¼š"></a>2.4.2 ä¸åˆå¹¶åçš„æ¨¡å‹å¯¹è¯ï¼š</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash"><span class="hljs-comment"># åŠ è½½ Adapter æ¨¡å‹å¯¹è¯ï¼ˆFloat 16ï¼‰</span><br>xtuner chat ./merged --prompt-template internlm_chat<br><br><span class="hljs-comment"># 4 bit é‡åŒ–åŠ è½½</span><br><span class="hljs-comment"># xtuner chat ./merged --bits 4 --prompt-template internlm_chat</span><br></code></pre></td></tr></table></figure>
<h4 id="2-4-3-Demo"><a href="#2-4-3-Demo" class="headerlink" title="2.4.3 Demo"></a>2.4.3 Demo</h4><ul>
<li>ä¿®æ”¹ <code>cli_demo.py</code> ä¸­çš„æ¨¡å‹è·¯å¾„<figure class="highlight diff"><table><tr><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">- model_name_or_path = &quot;/root/model/Shanghai_AI_Laboratory/internlm-chat-7b&quot;</span><br><span class="hljs-addition">+ model_name_or_path = &quot;merged&quot;</span><br></code></pre></td></tr></table></figure></li>
<li>è¿è¡Œ <code>cli_demo.py</code> ä»¥ç›®æµ‹å¾®è°ƒæ•ˆæœ<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python ./cli_demo.py<br></code></pre></td></tr></table></figure>
</li>
</ul>
<p><strong><code>xtuner chat</code></strong> <strong>çš„å¯åŠ¨å‚æ•°</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>å¯åŠ¨å‚æ•°</th>
<th>å¹²å“ˆæ»´</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>â€”prompt-template</strong></td>
<td>æŒ‡å®šå¯¹è¯æ¨¡æ¿</td>
</tr>
<tr>
<td>â€”system</td>
<td>æŒ‡å®šSYSTEMæ–‡æœ¬</td>
</tr>
<tr>
<td>â€”system-template</td>
<td>æŒ‡å®šSYSTEMæ¨¡æ¿</td>
</tr>
<tr>
<td>-<strong>-bits</strong></td>
<td>LLMä½æ•°</td>
</tr>
<tr>
<td>â€”bot-name</td>
<td>botåç§°</td>
</tr>
<tr>
<td>â€”with-plugins</td>
<td>æŒ‡å®šè¦ä½¿ç”¨çš„æ’ä»¶</td>
</tr>
<tr>
<td><strong>â€”no-streamer</strong></td>
<td>æ˜¯å¦å¯ç”¨æµå¼ä¼ è¾“</td>
</tr>
<tr>
<td><strong>â€”lagent</strong></td>
<td>æ˜¯å¦ä½¿ç”¨lagent</td>
</tr>
<tr>
<td>â€”command-stop-word</td>
<td>å‘½ä»¤åœæ­¢è¯</td>
</tr>
<tr>
<td>â€”answer-stop-word</td>
<td>å›ç­”åœæ­¢è¯</td>
</tr>
<tr>
<td>â€”offload-folder</td>
<td>å­˜æ”¾æ¨¡å‹æƒé‡çš„æ–‡ä»¶å¤¹ï¼ˆæˆ–è€…å·²ç»å¸è½½æ¨¡å‹æƒé‡çš„æ–‡ä»¶å¤¹ï¼‰</td>
</tr>
<tr>
<td>â€”max-new-tokens</td>
<td>ç”Ÿæˆæ–‡æœ¬ä¸­å…è®¸çš„æœ€å¤§ <code>token</code> æ•°é‡</td>
</tr>
<tr>
<td><strong>â€”temperature</strong></td>
<td>æ¸©åº¦å€¼</td>
</tr>
<tr>
<td>â€”top-k</td>
<td>ä¿ç•™ç”¨äºé¡¶kç­›é€‰çš„æœ€é«˜æ¦‚ç‡è¯æ±‡æ ‡è®°æ•°</td>
</tr>
<tr>
<td>â€”top-p</td>
<td>å¦‚æœè®¾ç½®ä¸ºå°äº1çš„æµ®ç‚¹æ•°ï¼Œä»…ä¿ç•™æ¦‚ç‡ç›¸åŠ é«˜äº <code>top_p</code> çš„æœ€å°ä¸€ç»„æœ€æœ‰å¯èƒ½çš„æ ‡è®°</td>
</tr>
<tr>
<td>â€”seed</td>
<td>ç”¨äºå¯é‡ç°æ–‡æœ¬ç”Ÿæˆçš„éšæœºç§å­</td>
</tr>
</tbody>
</table>
</div>
<h2 id="3-è‡ªå®šä¹‰å¾®è°ƒ"><a href="#3-è‡ªå®šä¹‰å¾®è°ƒ" class="headerlink" title="3 è‡ªå®šä¹‰å¾®è°ƒ"></a>3 è‡ªå®šä¹‰å¾®è°ƒ</h2><blockquote>
<p>ä»¥ <strong><a href="https://github.com/abachaa/Medication_QA_MedInfo2019">Medication QA</a></strong> <strong>æ•°æ®é›†</strong>ä¸ºä¾‹</p>
</blockquote>
<h3 id="3-1-æ¦‚è¿°"><a href="#3-1-æ¦‚è¿°" class="headerlink" title="3.1 æ¦‚è¿°"></a>3.1 æ¦‚è¿°</h3><h4 id="3-1-1-åœºæ™¯éœ€æ±‚"><a href="#3-1-1-åœºæ™¯éœ€æ±‚" class="headerlink" title="3.1.1 åœºæ™¯éœ€æ±‚"></a>3.1.1 <strong>åœºæ™¯éœ€æ±‚</strong></h4><p>   åŸºäº InternLM-chat-7B æ¨¡å‹ï¼Œç”¨ MedQA æ•°æ®é›†è¿›è¡Œå¾®è°ƒï¼Œå°†å…¶å¾€<code>åŒ»å­¦é—®ç­”</code>é¢†åŸŸå¯¹é½ã€‚</p>
<h4 id="3-1-2-çœŸå®æ•°æ®é¢„è§ˆ"><a href="#3-1-2-çœŸå®æ•°æ®é¢„è§ˆ" class="headerlink" title="3.1.2 çœŸå®æ•°æ®é¢„è§ˆ"></a>3.1.2 <strong>çœŸå®æ•°æ®é¢„è§ˆ</strong></h4><div class="table-container">
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>ç­”æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>What are ketorolac eye drops?ï¼ˆä»€ä¹ˆæ˜¯é…®å’¯é…¸æ»´çœ¼æ¶²ï¼Ÿï¼‰</td>
<td>Ophthalmic   ketorolac is used to treat itchy eyes caused by allergies. It also is used to   treat swelling and redness (inflammation) that can occur after cataract   surgery. Ketorolac is in a class of medications called nonsteroidal   anti-inflammatory drugs (NSAIDs). It works by stopping the release of   substances that cause allergy symptoms and inflammation.</td>
</tr>
<tr>
<td>What medicines raise blood sugar? ï¼ˆä»€ä¹ˆè¯ç‰©ä¼šå‡é«˜è¡€ç³–ï¼Ÿï¼‰</td>
<td>Some   medicines for conditions other than diabetes can raise your blood sugar   level. This is a concern when you have diabetes. Make sure every doctor you   see knows about all of the medicines, vitamins, or herbal supplements you   take. This means anything you take with or without a prescription. Examples include:     Barbiturates.     Thiazide diuretics.     Corticosteroids.     Birth control pills (oral contraceptives) and progesterone.     Catecholamines.     Decongestants that contain beta-adrenergic agents, such as pseudoephedrine.     The B vitamin niacin. The risk of high blood sugar from niacin lowers after you have taken it for a few months. The antipsychotic medicine olanzapine (Zyprexa).</td>
</tr>
</tbody>
</table>
</div>
<h3 id="3-2-æ•°æ®å‡†å¤‡"><a href="#3-2-æ•°æ®å‡†å¤‡" class="headerlink" title="3.2 æ•°æ®å‡†å¤‡"></a>3.2 æ•°æ®å‡†å¤‡</h3><blockquote>
<p><strong>ä»¥</strong> <strong><a href="https://github.com/abachaa/Medication_QA_MedInfo2019">Medication QA</a></strong> <strong>æ•°æ®é›†ä¸ºä¾‹</strong></p>
</blockquote>
<p><strong>åŸæ ¼å¼ï¼š(.xlsx)</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>é—®é¢˜</strong></th>
<th>è¯ç‰©ç±»å‹</th>
<th>é—®é¢˜ç±»å‹</th>
<th><strong>å›ç­”</strong></th>
<th>ä¸»é¢˜</th>
<th>URL</th>
</tr>
</thead>
<tbody>
<tr>
<td>aaa</td>
<td>bbb</td>
<td>ccc</td>
<td>ddd</td>
<td>eee</td>
<td>fff</td>
</tr>
</tbody>
</table>
</div>
<h4 id="3-2-1-å°†æ•°æ®è½¬ä¸º-XTuner-çš„æ•°æ®æ ¼å¼"><a href="#3-2-1-å°†æ•°æ®è½¬ä¸º-XTuner-çš„æ•°æ®æ ¼å¼" class="headerlink" title="3.2.1 å°†æ•°æ®è½¬ä¸º XTuner çš„æ•°æ®æ ¼å¼"></a>3.2.1 å°†æ•°æ®è½¬ä¸º XTuner çš„æ•°æ®æ ¼å¼</h4><p><strong>ç›®æ ‡æ ¼å¼ï¼š(.jsonL)</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;conversation&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;system&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xxx&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;input&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xxx&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;output&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xxx&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;conversation&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;system&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xxx&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;input&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xxx&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;output&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xxx&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>
<p>é€šè¿‡ pytho nè„šæœ¬ï¼šå°† <code>.xlsx</code> ä¸­çš„ é—®é¢˜ å’Œ å›ç­” ä¸¤åˆ— æå–å‡ºæ¥ï¼Œå†æ”¾å…¥ <code>.jsonL</code> æ–‡ä»¶çš„æ¯ä¸ª conversation çš„ input å’Œ output ä¸­ã€‚</p>
<blockquote>
<p>è¿™ä¸€æ­¥çš„ python è„šæœ¬å¯ä»¥è¯· ChatGPT æ¥å®Œæˆã€‚</p>
</blockquote>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">Write a python file for me. using openpyxl. input file name is MedQA2019.xlsx<br>Step1: The input file is .xlsx. Exact the column A and column D in the sheet named &quot;DrugQA&quot; .<br>Step2: Put each value in column A into each &quot;input&quot; of each &quot;conversation&quot;. Put each value in column D into each &quot;output&quot; of each &quot;conversation&quot;.<br>Step3: The output file is .jsonL. It looks like:<br>[&#123;<br>    &quot;conversation&quot;:[<br>        &#123;<br>            &quot;system&quot;: &quot;xxx&quot;,<br>            &quot;input&quot;: &quot;xxx&quot;,<br>            &quot;output&quot;: &quot;xxx&quot;<br>        &#125;<br>    ]<br>&#125;,<br>&#123;<br>    &quot;conversation&quot;:[<br>        &#123;<br>            &quot;system&quot;: &quot;xxx&quot;,<br>            &quot;input&quot;: &quot;xxx&quot;,<br>            &quot;output&quot;: &quot;xxx&quot;<br>        &#125;<br>    ]<br>&#125;]<br>Step4: All &quot;system&quot; value changes to &quot;You are a professional, highly experienced doctor professor. You always provide accurate, comprehensive, and detailed answers based on the patients&#x27; questions.&quot;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>ChatGPT ç”Ÿæˆçš„ python ä»£ç è§æœ¬ä»“åº“çš„ <a href="./xlsx2jsonl.py">xlsx2jsonl.py</a></p>
</blockquote>
<p>æ‰§è¡Œ python è„šæœ¬ï¼Œè·å¾—æ ¼å¼åŒ–åçš„æ•°æ®é›†ï¼š<br><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python xlsx2jsonl.py<br></code></pre></td></tr></table></figure></p>
<p>æ­¤æ—¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å¯¹æ•°æ®è¿›è¡Œè®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„åˆ†å‰²ï¼ŒåŒæ ·å¯ä»¥è®© ChatGPT å†™ python ä»£ç ã€‚å½“ç„¶å¦‚æœä½ æ²¡æœ‰ä¸¥æ ¼çš„ç§‘ç ”éœ€æ±‚ã€ä¸åœ¨ä¹â€œè®­ç»ƒé›†æ³„éœ²â€çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä¸åšè®­ç»ƒé›†ä¸æµ‹è¯•é›†çš„åˆ†å‰²ã€‚</p>
<h4 id="3-2-2-åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†"><a href="#3-2-2-åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†" class="headerlink" title="3.2.2 åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†"></a>3.2.2 åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†</h4><figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">my .jsonL file looks like:<br>[&#123;<br>    &quot;conversation&quot;:[<br>        &#123;<br>            &quot;system&quot;: &quot;xxx&quot;,<br>            &quot;input&quot;: &quot;xxx&quot;,<br>            &quot;output&quot;: &quot;xxx&quot;<br>        &#125;<br>    ]<br>&#125;,<br>&#123;<br>    &quot;conversation&quot;:[<br>        &#123;<br>            &quot;system&quot;: &quot;xxx&quot;,<br>            &quot;input&quot;: &quot;xxx&quot;,<br>            &quot;output&quot;: &quot;xxx&quot;<br>        &#125;<br>    ]<br>&#125;]<br>Step1, read the .jsonL file.<br>Step2, count the amount of the &quot;conversation&quot; elements.<br>Step3, randomly split all &quot;conversation&quot; elements by 7:3. Targeted structure is same as the input.<br>Step4, save the 7/10 part as train.jsonl. save the 3/10 part as test.jsonl<br></code></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„pythonä»£ç è§ <a href="./split2train_and_test.py">split2train_and_test.py</a></p>
<h3 id="3-3-å¼€å§‹è‡ªå®šä¹‰å¾®è°ƒ"><a href="#3-3-å¼€å§‹è‡ªå®šä¹‰å¾®è°ƒ" class="headerlink" title="3.3 å¼€å§‹è‡ªå®šä¹‰å¾®è°ƒ"></a>3.3 å¼€å§‹è‡ªå®šä¹‰å¾®è°ƒ</h3><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬é‡æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹æ¥ç©â€œå¾®è°ƒè‡ªå®šä¹‰æ•°æ®é›†â€<br><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> ~/ft-medqa &amp;&amp; <span class="hljs-built_in">cd</span> ~/ft-medqa<br></code></pre></td></tr></table></figure></p>
<p>æŠŠå‰é¢ä¸‹è½½å¥½çš„internlm-chat-7bæ¨¡å‹æ–‡ä»¶å¤¹æ‹·è´è¿‡æ¥ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> -r ~/ft-oasst1/internlm-chat-7b .<br></code></pre></td></tr></table></figure>
<p>åˆ«å¿˜äº†æŠŠè‡ªå®šä¹‰æ•°æ®é›†ï¼Œå³å‡ ä¸ª <code>.jsonL</code>ï¼Œä¹Ÿä¼ åˆ°æœåŠ¡å™¨ä¸Šã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/InternLM/tutorial<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> ~/tutorial/xtuner/MedQA2019-structured-train.jsonl .<br></code></pre></td></tr></table></figure>
<h4 id="3-3-1-å‡†å¤‡é…ç½®æ–‡ä»¶"><a href="#3-3-1-å‡†å¤‡é…ç½®æ–‡ä»¶" class="headerlink" title="3.3.1 å‡†å¤‡é…ç½®æ–‡ä»¶"></a>3.3.1 å‡†å¤‡é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å½“å‰ç›®å½•</span><br>xtuner copy-cfg internlm_chat_7b_qlora_oasst1_e3 .<br><span class="hljs-comment"># æ”¹ä¸ªæ–‡ä»¶å</span><br><span class="hljs-built_in">mv</span> internlm_chat_7b_qlora_oasst1_e3_copy.py internlm_chat_7b_qlora_medqa2019_e3.py<br><br><span class="hljs-comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶å†…å®¹</span><br>vim internlm_chat_7b_qlora_medqa2019_e3.py<br></code></pre></td></tr></table></figure>
<p>å‡å·ä»£è¡¨è¦åˆ é™¤çš„è¡Œï¼ŒåŠ å·ä»£è¡¨è¦å¢åŠ çš„è¡Œã€‚<br><figure class="highlight diff"><table><tr><td class="code"><pre><code class="hljs diff"># ä¿®æ”¹importéƒ¨åˆ†<br><span class="hljs-deletion">- from xtuner.dataset.map_fns import oasst1_map_fn, template_map_fn_factory</span><br><span class="hljs-addition">+ from xtuner.dataset.map_fns import template_map_fn_factory</span><br><br># ä¿®æ”¹æ¨¡å‹ä¸ºæœ¬åœ°è·¯å¾„<br><span class="hljs-deletion">- pretrained_model_name_or_path = &#x27;internlm/internlm-chat-7b&#x27;</span><br><span class="hljs-addition">+ pretrained_model_name_or_path = &#x27;./internlm-chat-7b&#x27;</span><br><br># ä¿®æ”¹è®­ç»ƒæ•°æ®ä¸º MedQA2019-structured-train.jsonl è·¯å¾„<br><span class="hljs-deletion">- data_path = &#x27;timdettmers/openassistant-guanaco&#x27;</span><br><span class="hljs-addition">+ data_path = &#x27;MedQA2019-structured-train.jsonl&#x27;</span><br><br># ä¿®æ”¹ train_dataset å¯¹è±¡<br>train_dataset = dict(<br>    type=process_hf_dataset,<br><span class="hljs-deletion">-   dataset=dict(type=load_dataset, path=data_path),</span><br><span class="hljs-addition">+   dataset=dict(type=load_dataset, path=&#x27;json&#x27;, data_files=dict(train=data_path)),</span><br>    tokenizer=tokenizer,<br>    max_length=max_length,<br><span class="hljs-deletion">-   dataset_map_fn=alpaca_map_fn,</span><br><span class="hljs-addition">+   dataset_map_fn=None,</span><br>    template_map_fn=dict(<br>        type=template_map_fn_factory, template=prompt_template),<br>    remove_unused_columns=True,<br>    shuffle_before_pack=True,<br>    pack_to_max_length=pack_to_max_length)<br></code></pre></td></tr></table></figure></p>
<h4 id="3-3-2-XTunerï¼å¯åŠ¨ï¼"><a href="#3-3-2-XTunerï¼å¯åŠ¨ï¼" class="headerlink" title="3.3.2 XTunerï¼å¯åŠ¨ï¼"></a>3.3.2 <strong>XTunerï¼å¯åŠ¨ï¼</strong></h4><p><img  src="imgs/ysqd.png"  ><span class="image-caption">tH8udZzECYl5are.png</span></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">xtuner train internlm_chat_7b_qlora_medqa2019_e3.py --deepspeed deepspeed_zero2<br></code></pre></td></tr></table></figure>
<h4 id="3-3-3-pth-è½¬-huggingface"><a href="#3-3-3-pth-è½¬-huggingface" class="headerlink" title="3.3.3 pth è½¬ huggingface"></a>3.3.3 pth è½¬ huggingface</h4><p>åŒå‰è¿°ï¼Œè¿™é‡Œä¸èµ˜è¿°äº†ã€‚<a href="#236-å°†å¾—åˆ°çš„-pth-æ¨¡å‹è½¬æ¢ä¸º-huggingface-æ¨¡å‹å³ç”Ÿæˆadapteræ–‡ä»¶å¤¹">å°†å¾—åˆ°çš„-pth-æ¨¡å‹è½¬æ¢ä¸º-huggingface-æ¨¡å‹å³ç”Ÿæˆadapteræ–‡ä»¶å¤¹</a>  </p>
<h4 id="3-3-4-éƒ¨ç½²ä¸æµ‹è¯•"><a href="#3-3-4-éƒ¨ç½²ä¸æµ‹è¯•" class="headerlink" title="3.3.4 éƒ¨ç½²ä¸æµ‹è¯•"></a>3.3.4 éƒ¨ç½²ä¸æµ‹è¯•</h4><p>åŒå‰è¿°ã€‚<a href="#24-éƒ¨ç½²ä¸æµ‹è¯•">éƒ¨ç½²ä¸æµ‹è¯•</a></p>
<h2 id="4-ç”¨-MS-Agent-æ•°æ®é›†-èµ‹äºˆ-LLM-ä»¥-Agent-èƒ½åŠ›"><a href="#4-ç”¨-MS-Agent-æ•°æ®é›†-èµ‹äºˆ-LLM-ä»¥-Agent-èƒ½åŠ›" class="headerlink" title="4 ç”¨ MS-Agent æ•°æ®é›† èµ‹äºˆ LLM ä»¥ Agent èƒ½åŠ›"></a>4 ç”¨ MS-Agent æ•°æ®é›† èµ‹äºˆ LLM ä»¥ Agent èƒ½åŠ›</h2><h3 id="4-1-æ¦‚è¿°"><a href="#4-1-æ¦‚è¿°" class="headerlink" title="4.1 æ¦‚è¿°"></a>4.1 æ¦‚è¿°</h3><p>MSAgent æ•°æ®é›†æ¯æ¡æ ·æœ¬åŒ…å«ä¸€ä¸ªå¯¹è¯åˆ—è¡¨ï¼ˆconversationsï¼‰ï¼Œå…¶é‡Œé¢åŒ…å«äº† systemã€userã€assistant ä¸‰ç§å­—æ®µã€‚å…¶ä¸­ï¼š</p>
<ul>
<li><p>system: è¡¨ç¤ºç»™æ¨¡å‹å‰ç½®çš„äººè®¾è¾“å…¥ï¼Œå…¶ä¸­æœ‰å‘Šè¯‰æ¨¡å‹å¦‚ä½•è°ƒç”¨æ’ä»¶ä»¥åŠç”Ÿæˆè¯·æ±‚</p>
</li>
<li><p>user: è¡¨ç¤ºç”¨æˆ·çš„è¾“å…¥ promptï¼Œåˆ†ä¸ºä¸¤ç§ï¼Œé€šç”¨ç”Ÿæˆçš„promptå’Œè°ƒç”¨æ’ä»¶éœ€æ±‚çš„ prompt</p>
</li>
<li><p>assistant: ä¸ºæ¨¡å‹çš„å›å¤ã€‚å…¶ä¸­ä¼šåŒ…æ‹¬æ’ä»¶è°ƒç”¨ä»£ç å’Œæ‰§è¡Œä»£ç ï¼Œè°ƒç”¨ä»£ç æ˜¯è¦ LLM ç”Ÿæˆçš„ï¼Œè€Œæ‰§è¡Œä»£ç æ˜¯è°ƒç”¨æœåŠ¡æ¥ç”Ÿæˆç»“æœçš„</p>
</li>
</ul>
<p>ä¸€æ¡è°ƒç”¨ç½‘é¡µæœç´¢æ’ä»¶æŸ¥è¯¢â€œä¸Šæµ·æ˜å¤©å¤©æ°”â€çš„æ•°æ®æ ·æœ¬ç¤ºä¾‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img  src="imgs/msagent_data.png"  ><span class="image-caption">BlgfEqpiRFO5G6L.png</span></p>
<h3 id="4-2-å¾®è°ƒæ­¥éª¤"><a href="#4-2-å¾®è°ƒæ­¥éª¤" class="headerlink" title="4.2 å¾®è°ƒæ­¥éª¤"></a>4.2 å¾®è°ƒæ­¥éª¤</h3><h4 id="4-2-1-å‡†å¤‡å·¥ä½œ"><a href="#4-2-1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="4.2.1 å‡†å¤‡å·¥ä½œ"></a>4.2.1 å‡†å¤‡å·¥ä½œ</h4><blockquote>
<p>xtuner æ˜¯ä»å›½å†…çš„ ModelScope å¹³å°ä¸‹è½½ MS-Agent æ•°æ®é›†ï¼Œå› æ­¤ä¸ç”¨æå‰æ‰‹åŠ¨ä¸‹è½½æ•°æ®é›†æ–‡ä»¶ã€‚</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å‡†å¤‡å·¥ä½œ</span><br><span class="hljs-built_in">mkdir</span> ~/ft-msagent &amp;&amp; <span class="hljs-built_in">cd</span> ~/ft-msagent<br><span class="hljs-built_in">cp</span> -r ~/ft-oasst1/internlm-chat-7b .<br><br><span class="hljs-comment"># æŸ¥çœ‹é…ç½®æ–‡ä»¶</span><br>xtuner list-cfg | grep msagent<br><br><span class="hljs-comment"># å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å½“å‰ç›®å½•</span><br>xtuner copy-cfg internlm_7b_qlora_msagent_react_e3_gpu8 .<br><br><span class="hljs-comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡å‹ä¸ºæœ¬åœ°è·¯å¾„</span><br>vim ./internlm_7b_qlora_msagent_react_e3_gpu8_copy.py <br></code></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">- pretrained_model_name_or_path = &#x27;internlm/internlm-chat-7b&#x27;</span><br><span class="hljs-addition">+ pretrained_model_name_or_path = &#x27;./internlm-chat-7b&#x27;</span><br></code></pre></td></tr></table></figure>
<h4 id="4-2-2-å¼€å§‹å¾®è°ƒ"><a href="#4-2-2-å¼€å§‹å¾®è°ƒ" class="headerlink" title="4.2.2 å¼€å§‹å¾®è°ƒ"></a>4.2.2 å¼€å§‹å¾®è°ƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash">xtuner train ./internlm_7b_qlora_msagent_react_e3_gpu8_copy.py --deepspeed deepspeed_zero2<br></code></pre></td></tr></table></figure>
<h3 id="4-3-ç›´æ¥ä½¿ç”¨"><a href="#4-3-ç›´æ¥ä½¿ç”¨" class="headerlink" title="4.3 ç›´æ¥ä½¿ç”¨"></a>4.3 ç›´æ¥ä½¿ç”¨</h3><blockquote>
<p>ç”±äº msagent çš„è®­ç»ƒéå¸¸è´¹æ—¶ï¼Œå¤§å®¶å¦‚æœæƒ³å°½å¿«æŠŠè¿™ä¸ªæ•™ç¨‹è·Ÿå®Œï¼Œå¯ä»¥ç›´æ¥ä» modelScope æ‹‰å–å’±ä»¬å·²ç»å¾®è°ƒå¥½äº†çš„ Adapterã€‚å¦‚ä¸‹æ¼”ç¤ºã€‚</p>
</blockquote>
<h4 id="4-3-1-ä¸‹è½½-Adapter"><a href="#4-3-1-ä¸‹è½½-Adapter" class="headerlink" title="4.3.1 ä¸‹è½½ Adapter"></a>4.3.1 ä¸‹è½½ Adapter</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs Bash"><span class="hljs-built_in">cd</span> ~/ft-msagent<br>apt install git git-lfs<br>git lfs install<br>git lfs <span class="hljs-built_in">clone</span> https://www.modelscope.cn/xtuner/internlm-7b-qlora-msagent-react.git<br></code></pre></td></tr></table></figure>
<p>OKï¼Œç°åœ¨ç›®å½•åº”è¯¥é•¿è¿™æ ·ï¼š</p>
<ul>
<li>internlm_7b_qlora_msagent_react_e3_gpu8_copy.py</li>
<li>internlm-7b-qlora-msagent-react</li>
<li>internlm-chat-7b</li>
<li>work_dirï¼ˆå¯æœ‰å¯æ— ï¼‰</li>
</ul>
<p>æœ‰äº†è¿™ä¸ªåœ¨ msagent ä¸Šè®­ç»ƒå¾—åˆ°çš„Adapterï¼Œæ¨¡å‹ç°åœ¨å·²ç»æœ‰ agent èƒ½åŠ›äº†ï¼å°±å¯ä»¥åŠ  â€”lagent ä»¥è°ƒç”¨æ¥è‡ª lagent çš„ä»£ç†åŠŸèƒ½äº†ï¼</p>
<h4 id="4-3-2-æ·»åŠ -serper-ç¯å¢ƒå˜é‡"><a href="#4-3-2-æ·»åŠ -serper-ç¯å¢ƒå˜é‡" class="headerlink" title="4.3.2 æ·»åŠ  serper ç¯å¢ƒå˜é‡"></a>4.3.2 æ·»åŠ  serper ç¯å¢ƒå˜é‡</h4><blockquote>
<p><strong>å¼€å§‹ chat ä¹‹å‰ï¼Œè¿˜è¦åŠ ä¸ª serper çš„ç¯å¢ƒå˜é‡ï¼š</strong></p>
<p>å» serper.dev å…è´¹æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œç”Ÿæˆè‡ªå·±çš„ api keyã€‚è¿™ä¸ªä¸œè¥¿æ˜¯ç”¨æ¥ç»™ lagent å»è·å– google æœç´¢çš„ç»“æœçš„ã€‚ç­‰äºæ˜¯ serper.dev å¸®ä½ å»è®¿é—® googleï¼Œè€Œä¸æ˜¯ä»ä½ è‡ªå·±æœ¬åœ°å»è®¿é—® google äº†ã€‚</p>
</blockquote>
<p><img  src="imgs/serper.png"  ><span class="image-caption">kDSdpQrhHfTWYsc.png</span></p>
<p>æ·»åŠ  serper api key åˆ°ç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> SERPER_API_KEY=abcdefg<br></code></pre></td></tr></table></figure>
<h4 id="4-3-3-xtuner-agentï¼Œå¯åŠ¨ï¼"><a href="#4-3-3-xtuner-agentï¼Œå¯åŠ¨ï¼" class="headerlink" title="4.3.3 xtuner + agentï¼Œå¯åŠ¨ï¼"></a>4.3.3 xtuner + agentï¼Œå¯åŠ¨ï¼</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">xtuner chat ./internlm-chat-7b --adapter internlm-7b-qlora-msagent-react --lagent<br></code></pre></td></tr></table></figure>
<h2 id="5-æ³¨æ„äº‹é¡¹"><a href="#5-æ³¨æ„äº‹é¡¹" class="headerlink" title="5 æ³¨æ„äº‹é¡¹"></a>5 æ³¨æ„äº‹é¡¹</h2><p>æœ¬æ•™ç¨‹ä½¿ç”¨ xtuner 0.1.9 ç‰ˆæœ¬<br>è‹¥éœ€è¦è·Ÿç€æœ¬æ•™ç¨‹ä¸€æ­¥ä¸€æ­¥å®Œæˆï¼Œå»ºè®®ä¸¥æ ¼éµå¾ªæœ¬æ•™ç¨‹çš„æ­¥éª¤ï¼</p>
<p>è‹¥å‡ºç°è«åå…¶å¦™æŠ¥é”™ï¼Œè¯·å°è¯•æ›´æ¢ä¸ºä»¥ä¸‹åŒ…çš„ç‰ˆæœ¬ï¼šï¼ˆå¦‚æœæœ‰æŠ¥é”™å†æ£€æŸ¥ï¼Œæ²¡æŠ¥é”™ä¸ç”¨çœ‹ï¼‰<br><figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">torch</span>                         <span class="hljs-number">2</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">transformers</span>                  <span class="hljs-number">4</span>.<span class="hljs-number">34</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">transformers</span>-stream-generator <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><br><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip install torch==2.1.1<br>pip install transformers==4.34.0<br>pip install transformers-stream-generator=0.0.4<br></code></pre></td></tr></table></figure><br>CUDA ç›¸å…³ï¼šï¼ˆå¦‚æœæœ‰æŠ¥é”™å†æ£€æŸ¥ï¼Œæ²¡æŠ¥é”™ä¸ç”¨çœ‹ï¼‰<br><figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">NVIDIA</span>-SMI <span class="hljs-number">535</span>.<span class="hljs-number">54</span>.<span class="hljs-number">03</span>              <br><span class="hljs-attribute">Driver</span> Version: <span class="hljs-number">535</span>.<span class="hljs-number">54</span>.<span class="hljs-number">03</span>    <br><span class="hljs-attribute">CUDA</span> Version: <span class="hljs-number">12</span>.<span class="hljs-number">2</span><br><br><span class="hljs-attribute">nvidia</span>-cuda-cupti-cu12        <span class="hljs-number">12</span>.<span class="hljs-number">1</span>.<span class="hljs-number">105</span><br><span class="hljs-attribute">nvidia</span>-cuda-nvrtc-cu12        <span class="hljs-number">12</span>.<span class="hljs-number">1</span>.<span class="hljs-number">105</span><br><span class="hljs-attribute">nvidia</span>-cuda-runtime-cu12      <span class="hljs-number">12</span>.<span class="hljs-number">1</span>.<span class="hljs-number">105</span><br></code></pre></td></tr></table></figure></p>
<h2 id="6-ä½œä¸š"><a href="#6-ä½œä¸š" class="headerlink" title="6 ä½œä¸š"></a>6 ä½œä¸š</h2><h3 id="1-æ¦‚è¿°-1"><a href="#1-æ¦‚è¿°-1" class="headerlink" title="1 æ¦‚è¿°"></a>1 æ¦‚è¿°</h3><p>ç›®æ ‡ï¼šé€šè¿‡å¾®è°ƒï¼Œè®©æ¨¡å‹æˆä¸ºæˆ‘ä»¬çš„å°åŠ©æ‰‹</p>
<p>æ–¹å¼ï¼šä½¿ç”¨ XTuner è¿›è¡Œå¾®è°ƒ</p>
<p><strong>å¾®è°ƒå‰</strong><br><img  src="å®˜æ–¹å›ç­”.png"  ><span class="image-caption">å®˜æ–¹å›ç­”</span></p>
<p><strong>å¾®è°ƒå</strong><br><img  src="å¾®è°ƒå.png"  ><span class="image-caption">å¾®è°ƒå.png</span></p>
<h3 id="2-å®æ“"><a href="#2-å®æ“" class="headerlink" title="2 å®æ“"></a>2 å®æ“</h3><h4 id="å¾®è°ƒç¯å¢ƒå‡†å¤‡"><a href="#å¾®è°ƒç¯å¢ƒå‡†å¤‡" class="headerlink" title="å¾®è°ƒç¯å¢ƒå‡†å¤‡"></a>å¾®è°ƒç¯å¢ƒå‡†å¤‡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># InternStudio å¹³å°ä¸­ï¼Œä»æœ¬åœ° clone ä¸€ä¸ªå·²æœ‰ pytorch 2.0.1 çš„ç¯å¢ƒï¼ˆåç»­å‡åœ¨è¯¥ç¯å¢ƒæ‰§è¡Œï¼Œè‹¥ä¸ºå…¶ä»–ç¯å¢ƒå¯ä½œä¸ºå‚è€ƒï¼‰</span><br><span class="hljs-comment"># è¿›å…¥ç¯å¢ƒåé¦–å…ˆ bash</span><br><span class="hljs-comment"># è¿›å…¥ç¯å¢ƒåé¦–å…ˆ bash</span><br><span class="hljs-comment"># è¿›å…¥ç¯å¢ƒåé¦–å…ˆ bash</span><br>bash<br>conda create --name personal_assistant --<span class="hljs-built_in">clone</span>=/root/share/conda_envs/internlm-base<br><span class="hljs-comment"># å¦‚æœåœ¨å…¶ä»–å¹³å°ï¼š</span><br><span class="hljs-comment"># conda create --name personal_assistant python=3.10 -y</span><br><br><span class="hljs-comment"># æ¿€æ´»ç¯å¢ƒ</span><br>conda activate personal_assistant<br><span class="hljs-comment"># è¿›å…¥å®¶ç›®å½• ï¼ˆ~çš„æ„æ€æ˜¯ â€œå½“å‰ç”¨æˆ·çš„homeè·¯å¾„â€ï¼‰</span><br><span class="hljs-built_in">cd</span> ~<br><span class="hljs-comment"># åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶å¤¹å¹¶è¿›å…¥ï¼Œä»¥è·Ÿéšæœ¬æ•™ç¨‹</span><br><span class="hljs-comment"># personal_assistantç”¨äºå­˜æ”¾æœ¬æ•™ç¨‹æ‰€ä½¿ç”¨çš„ä¸œè¥¿</span><br><span class="hljs-built_in">mkdir</span> /root/personal_assistant &amp;&amp; <span class="hljs-built_in">cd</span> /root/personal_assistant<br><span class="hljs-built_in">mkdir</span> /root/personal_assistant/xtuner019 &amp;&amp; <span class="hljs-built_in">cd</span> /root/personal_assistant/xtuner019<br><br><span class="hljs-comment"># æ‹‰å– 0.1.9 çš„ç‰ˆæœ¬æºç </span><br>git <span class="hljs-built_in">clone</span> -b v0.1.9  https://github.com/InternLM/xtuner<br><span class="hljs-comment"># æ— æ³•è®¿é—®githubçš„ç”¨æˆ·è¯·ä» gitee æ‹‰å–:</span><br><span class="hljs-comment"># git clone -b v0.1.9 https://gitee.com/Internlm/xtuner</span><br><br><span class="hljs-comment"># è¿›å…¥æºç ç›®å½•</span><br><span class="hljs-built_in">cd</span> xtuner<br><br><span class="hljs-comment"># ä»æºç å®‰è£… XTuner</span><br>pip install -e <span class="hljs-string">&#x27;.[all]&#x27;</span><br></code></pre></td></tr></table></figure>
<h4 id="æ•°æ®å‡†å¤‡"><a href="#æ•°æ®å‡†å¤‡" class="headerlink" title="æ•°æ®å‡†å¤‡"></a>æ•°æ®å‡†å¤‡</h4><p>åˆ›å»º<code>data</code>æ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾ç”¨äºè®­ç»ƒçš„æ•°æ®é›†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /root/personal_assistant/data &amp;&amp; <span class="hljs-built_in">cd</span> /root/personal_assistant/data<br></code></pre></td></tr></table></figure>
<p>åœ¨<code>data</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªjsonæ–‡ä»¶<code>personal_assistant.json</code>ä½œä¸ºæœ¬æ¬¡å¾®è°ƒæ‰€ä½¿ç”¨çš„æ•°æ®é›†ã€‚jsonä¸­å†…å®¹å¯å‚è€ƒä¸‹æ–¹(å¤åˆ¶ç²˜è´´næ¬¡åšæ•°æ®å¢å¹¿ï¼Œæ•°æ®é‡å°æ— æ³•æœ‰æ•ˆå¾®è°ƒï¼Œä¸‹é¢ä»…ç”¨äºå±•ç¤ºæ ¼å¼ï¼Œä¸‹é¢ä¹Ÿæœ‰ç”Ÿæˆè„šæœ¬)</p>
<p>å…¶ä¸­<code>conversation</code>è¡¨ç¤ºä¸€æ¬¡å¯¹è¯çš„å†…å®¹ï¼Œ<code>input</code>ä¸ºè¾“å…¥ï¼Œå³ç”¨æˆ·ä¼šé—®çš„é—®é¢˜ï¼Œ<code>output</code>ä¸ºè¾“å‡ºï¼Œå³æƒ³è¦æ¨¡å‹å›ç­”çš„ç­”æ¡ˆã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;conversation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;input&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;è¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;output&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æˆ‘æ˜¯ä¸è¦è‘±å§œè’œå¤§ä½¬çš„å°åŠ©æ‰‹ï¼Œå†…åœ¨æ˜¯ä¸Šæµ·AIå®éªŒå®¤ä¹¦ç”ŸÂ·æµ¦è¯­çš„7Bå¤§æ¨¡å‹å“¦&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;conversation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;input&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;è¯·åšä¸€ä¸‹è‡ªæˆ‘ä»‹ç»&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;output&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æˆ‘æ˜¯ä¸è¦è‘±å§œè’œå¤§ä½¬çš„å°åŠ©æ‰‹ï¼Œå†…åœ¨æ˜¯ä¸Šæµ·AIå®éªŒå®¤ä¹¦ç”ŸÂ·æµ¦è¯­çš„7Bå¤§æ¨¡å‹å“¦&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªpythonè„šæœ¬ï¼Œç”¨äºç”Ÿæˆæ•°æ®é›†ã€‚åœ¨<code>data</code>ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªgenerate_data.pyæ–‡ä»¶ï¼Œå°†ä»¥ä¸‹ä»£ç å¤åˆ¶è¿›å»ï¼Œç„¶åè¿è¡Œè¯¥è„šæœ¬å³å¯ç”Ÿæˆæ•°æ®é›†ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><br><span class="hljs-comment"># è¾“å…¥ä½ çš„åå­—</span><br>name = <span class="hljs-string">&#x27;Shengshenlan&#x27;</span><br><span class="hljs-comment"># é‡å¤æ¬¡æ•°</span><br>n = <span class="hljs-number">10000</span><br><br>data = [<br>    &#123;<br>        <span class="hljs-string">&quot;conversation&quot;</span>: [<br>            &#123;<br>                <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;è¯·åšä¸€ä¸‹è‡ªæˆ‘ä»‹ç»&quot;</span>,<br>                <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-string">&quot;æˆ‘æ˜¯&#123;&#125;çš„å°åŠ©æ‰‹ï¼Œå†…åœ¨æ˜¯ä¸Šæµ·AIå®éªŒå®¤ä¹¦ç”ŸÂ·æµ¦è¯­çš„7Bå¤§æ¨¡å‹å“¦&quot;</span>.<span class="hljs-built_in">format</span>(name)<br>            &#125;<br>        ]<br>    &#125;<br>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>    data.append(data[<span class="hljs-number">0</span>])<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;personal_assistant.json&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    json.dump(data, f, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">4</span>)<br><br></code></pre></td></tr></table></figure>
<h4 id="é…ç½®å‡†å¤‡"><a href="#é…ç½®å‡†å¤‡" class="headerlink" title="é…ç½®å‡†å¤‡"></a>é…ç½®å‡†å¤‡</h4><p>ä¸‹è½½æ¨¡å‹<code>InternLM-chat-7B</code></p>
<p><a href="https://studio.intern-ai.org.cn/">InternStudio</a> å¹³å°çš„ <code>share</code> ç›®å½•ä¸‹å·²ç»ä¸ºæˆ‘ä»¬å‡†å¤‡äº†å…¨ç³»åˆ—çš„ <code>InternLM</code> æ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¤åˆ¶<code>internlm-chat-7b</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /root/personal_assistant/model/Shanghai_AI_Laboratory<br><span class="hljs-built_in">cp</span> -r /root/share/temp/model_repos/internlm-chat-7b /root/personal_assistant/model/Shanghai_AI_Laboratory<br></code></pre></td></tr></table></figure>
<p>XTuner æä¾›å¤šä¸ªå¼€ç®±å³ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ—å‡ºæ‰€æœ‰å†…ç½®é…ç½®</span><br>xtuner list-cfg<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#åˆ›å»ºç”¨äºå­˜æ”¾é…ç½®çš„æ–‡ä»¶å¤¹configå¹¶è¿›å…¥</span><br><span class="hljs-built_in">mkdir</span> /root/personal_assistant/config &amp;&amp; <span class="hljs-built_in">cd</span> /root/personal_assistant/config<br></code></pre></td></tr></table></figure>
<p>æ‹·è´ä¸€ä¸ªé…ç½®æ–‡ä»¶åˆ°å½“å‰ç›®å½•ï¼š<code>xtuner copy-cfg $&#123;CONFIG_NAME&#125; $&#123;SAVE_PATH&#125;</code><br>åœ¨æœ¬ä¾‹ä¸­ï¼šï¼ˆæ³¨æ„æœ€åæœ‰ä¸ªè‹±æ–‡å¥å·ï¼Œä»£è¡¨å¤åˆ¶åˆ°å½“å‰è·¯å¾„ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">xtuner copy-cfg internlm_chat_7b_qlora_oasst1_e3 .<br></code></pre></td></tr></table></figure>
<p>ä¿®æ”¹æ‹·è´åçš„æ–‡ä»¶internlm_chat_7b_qlora_oasst1_e3_copy.pyï¼Œä¿®æ”¹ä¸‹è¿°ä½ç½®ï¼š<br>(è¿™æ˜¯ä¸€ä»½ä¿®æ”¹å¥½çš„æ–‡ä»¶<a href="./internlm_chat_7b_qlora_oasst1_e3_copy.py">internlm_chat_7b_qlora_oasst1_e3_copy.py</a>)<br><img  src="ä¿®æ”¹é…ç½®.png"  ><span class="image-caption">ä¿®æ”¹é…ç½®</span></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># PART 1 ä¸­</span><br><span class="hljs-comment"># é¢„è®­ç»ƒæ¨¡å‹å­˜æ”¾çš„ä½ç½®</span><br>pretrained_model_name_or_path = <span class="hljs-string">&#x27;/root/personal_assistant/model/Shanghai_AI_Laboratory/internlm-chat-7b&#x27;</span><br><br><span class="hljs-comment"># å¾®è°ƒæ•°æ®å­˜æ”¾çš„ä½ç½®</span><br>data_path = <span class="hljs-string">&#x27;/root/personal_assistant/data/personal_assistant.json&#x27;</span><br><br><span class="hljs-comment"># è®­ç»ƒä¸­æœ€å¤§çš„æ–‡æœ¬é•¿åº¦</span><br>max_length = 512<br><br><span class="hljs-comment"># æ¯ä¸€æ‰¹è®­ç»ƒæ ·æœ¬çš„å¤§å°</span><br>batch_size = 2<br><br><span class="hljs-comment"># æœ€å¤§è®­ç»ƒè½®æ•°</span><br>max_epochs = 3<br><br><span class="hljs-comment"># éªŒè¯çš„é¢‘ç‡</span><br>evaluation_freq = 90<br><br><span class="hljs-comment"># ç”¨äºè¯„ä¼°è¾“å‡ºå†…å®¹çš„é—®é¢˜ï¼ˆç”¨äºè¯„ä¼°çš„é—®é¢˜å°½é‡ä¸æ•°æ®é›†çš„questionä¿æŒä¸€è‡´ï¼‰</span><br>evaluation_inputs = [ <span class="hljs-string">&#x27;è¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±&#x27;</span>, <span class="hljs-string">&#x27;è¯·åšä¸€ä¸‹è‡ªæˆ‘ä»‹ç»&#x27;</span> ]<br><br><br><span class="hljs-comment"># PART 3 ä¸­</span><br>dataset=dict(<span class="hljs-built_in">type</span>=load_dataset, path=<span class="hljs-string">&#x27;json&#x27;</span>, data_files=dict(train=data_path))<br>dataset_map_fn=None<br></code></pre></td></tr></table></figure>
<h4 id="å¾®è°ƒå¯åŠ¨"><a href="#å¾®è°ƒå¯åŠ¨" class="headerlink" title="å¾®è°ƒå¯åŠ¨"></a>å¾®è°ƒå¯åŠ¨</h4><p>ç”¨<code>xtuner train</code>å‘½ä»¤å¯åŠ¨è®­ç»ƒã€</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">xtuner train /root/personal_assistant/config/internlm_chat_7b_qlora_oasst1_e3_copy.py<br></code></pre></td></tr></table></figure>
<p><img  src="è®­ç»ƒè¿‡ç¨‹.png"  ><span class="image-caption">è®­ç»ƒæ•°æ®æ ·ä¾‹</span></p>
<blockquote>
<p>ä¼šåœ¨è®­ç»ƒå®Œæˆåï¼Œè¾“å‡ºç”¨äºéªŒè¯çš„Sample output</p>
<h4 id="å¾®è°ƒåå‚æ•°è½¬æ¢-åˆå¹¶"><a href="#å¾®è°ƒåå‚æ•°è½¬æ¢-åˆå¹¶" class="headerlink" title="å¾®è°ƒåå‚æ•°è½¬æ¢/åˆå¹¶"></a>å¾®è°ƒåå‚æ•°è½¬æ¢/åˆå¹¶</h4></blockquote>
<p>è®­ç»ƒåçš„pthæ ¼å¼å‚æ•°è½¬Hugging Faceæ ¼å¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºç”¨äºå­˜æ”¾Hugging Faceæ ¼å¼å‚æ•°çš„hfæ–‡ä»¶å¤¹</span><br><span class="hljs-built_in">mkdir</span> /root/personal_assistant/config/work_dirs/hf<br><br><span class="hljs-built_in">export</span> MKL_SERVICE_FORCE_INTEL=1<br><br><span class="hljs-comment"># é…ç½®æ–‡ä»¶å­˜æ”¾çš„ä½ç½®</span><br><span class="hljs-built_in">export</span> CONFIG_NAME_OR_PATH=/root/personal_assistant/config/internlm_chat_7b_qlora_oasst1_e3_copy.py<br><br><span class="hljs-comment"># æ¨¡å‹è®­ç»ƒåå¾—åˆ°çš„pthæ ¼å¼å‚æ•°å­˜æ”¾çš„ä½ç½®</span><br><span class="hljs-built_in">export</span> PTH=/root/personal_assistant/config/work_dirs/internlm_chat_7b_qlora_oasst1_e3_copy/epoch_3.pth<br><br><span class="hljs-comment"># pthæ–‡ä»¶è½¬æ¢ä¸ºHugging Faceæ ¼å¼åå‚æ•°å­˜æ”¾çš„ä½ç½®</span><br><span class="hljs-built_in">export</span> SAVE_PATH=/root/personal_assistant/config/work_dirs/hf<br><br><span class="hljs-comment"># æ‰§è¡Œå‚æ•°è½¬æ¢</span><br>xtuner convert pth_to_hf <span class="hljs-variable">$CONFIG_NAME_OR_PATH</span> <span class="hljs-variable">$PTH</span> <span class="hljs-variable">$SAVE_PATH</span><br></code></pre></td></tr></table></figure>
<p>Mergeæ¨¡å‹å‚æ•°<br><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> MKL_SERVICE_FORCE_INTEL=1<br><span class="hljs-built_in">export</span> MKL_THREADING_LAYER=<span class="hljs-string">&#x27;GNU&#x27;</span><br><br><span class="hljs-comment"># åŸå§‹æ¨¡å‹å‚æ•°å­˜æ”¾çš„ä½ç½®</span><br><span class="hljs-built_in">export</span> NAME_OR_PATH_TO_LLM=/root/personal_assistant/model/Shanghai_AI_Laboratory/internlm-chat-7b<br><br><span class="hljs-comment"># Hugging Faceæ ¼å¼å‚æ•°å­˜æ”¾çš„ä½ç½®</span><br><span class="hljs-built_in">export</span> NAME_OR_PATH_TO_ADAPTER=/root/personal_assistant/config/work_dirs/hf<br><br><span class="hljs-comment"># æœ€ç»ˆMergeåçš„å‚æ•°å­˜æ”¾çš„ä½ç½®</span><br><span class="hljs-built_in">mkdir</span> /root/personal_assistant/config/work_dirs/hf_merge<br><span class="hljs-built_in">export</span> SAVE_PATH=/root/personal_assistant/config/work_dirs/hf_merge<br><br><span class="hljs-comment"># æ‰§è¡Œå‚æ•°Merge</span><br>xtuner convert merge \<br>    <span class="hljs-variable">$NAME_OR_PATH_TO_LLM</span> \<br>    <span class="hljs-variable">$NAME_OR_PATH_TO_ADAPTER</span> \<br>    <span class="hljs-variable">$SAVE_PATH</span> \<br>    --max-shard-size 2GB<br></code></pre></td></tr></table></figure></p>
<h4 id="ç½‘é¡µDEMO"><a href="#ç½‘é¡µDEMO" class="headerlink" title="ç½‘é¡µDEMO"></a>ç½‘é¡µDEMO</h4><p>å®‰è£…ç½‘é¡µDemoæ‰€éœ€ä¾èµ–</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip install streamlit==1.24.0<br></code></pre></td></tr></table></figure>
<p>ä¸‹è½½ InternLM é¡¹ç›®ä»£ç </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºcodeæ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾InternLMé¡¹ç›®ä»£ç </span><br><span class="hljs-built_in">mkdir</span> /root/personal_assistant/code &amp;&amp; <span class="hljs-built_in">cd</span> /root/personal_assistant/code<br>git <span class="hljs-built_in">clone</span> https://github.com/InternLM/InternLM.git<br></code></pre></td></tr></table></figure>
<p>å°† <code>/root/code/InternLM/web_demo.py</code> ä¸­ 29 è¡Œå’Œ 33 è¡Œçš„æ¨¡å‹è·¯å¾„æ›´æ¢ä¸ºMergeåå­˜æ”¾å‚æ•°çš„è·¯å¾„ <code>/root/personal_assistant/config/work_dirs/hf_merge</code><br>è¿è¡Œ <code>/root/personal_assistant/code/InternLM</code> ç›®å½•ä¸‹çš„ <code>web_demo.py</code> æ–‡ä»¶ï¼Œä¹‹åå°†ç«¯å£æ˜ å°„åˆ°æœ¬åœ°ã€‚åœ¨æœ¬åœ°æµè§ˆå™¨è¾“å…¥ <code>http://127.0.0.1:6006</code> å³å¯ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">streamlit run /root/personal_assistant/code/InternLM/web_demo<span class="hljs-selector-class">.py</span> <span class="hljs-attr">--server</span><span class="hljs-selector-class">.address</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-attr">--server</span><span class="hljs-selector-class">.port</span> <span class="hljs-number">6006</span><br></code></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šè¦åœ¨æµè§ˆå™¨æ‰“å¼€ <code>http://127.0.0.1:6006</code> é¡µé¢åï¼Œæ¨¡å‹æ‰ä¼šåŠ è½½ã€‚<br>åœ¨åŠ è½½å®Œæ¨¡å‹ä¹‹åï¼Œå°±å¯ä»¥ä¸å¾®è°ƒåçš„ InternLM-Chat-7B è¿›è¡Œå¯¹è¯äº†</p>
<h3 id="3-æ•ˆæœ"><a href="#3-æ•ˆæœ" class="headerlink" title="3 æ•ˆæœ"></a>3 æ•ˆæœ</h3><p>å¾®è°ƒå‰<br><img  src="å®˜æ–¹å›ç­”.png"  ><span class="image-caption">å®˜æ–¹å›ç­”</span></p>
<p>å¾®è°ƒå<br><img  src="å¾®è°ƒå.png"  ><span class="image-caption">å¾®è°ƒå.png</span></p>
<h2 id="7-è¿›é˜¶ä½œä¸š"><a href="#7-è¿›é˜¶ä½œä¸š" class="headerlink" title="7 è¿›é˜¶ä½œä¸š"></a>7 è¿›é˜¶ä½œä¸š</h2><h3 id="1-æ¨¡å‹ä¸Šä¼ "><a href="#1-æ¨¡å‹ä¸Šä¼ " class="headerlink" title="1 æ¨¡å‹ä¸Šä¼ "></a>1 æ¨¡å‹ä¸Šä¼ </h3><p><img  src="model-upload.png"  ><span class="image-caption">model-upload.png</span></p>
<h3 id="2-ä¿®æ”¹å¯åŠ¨æ–‡ä»¶"><a href="#2-ä¿®æ”¹å¯åŠ¨æ–‡ä»¶" class="headerlink" title="2 ä¿®æ”¹å¯åŠ¨æ–‡ä»¶"></a>2 ä¿®æ”¹å¯åŠ¨æ–‡ä»¶</h3><p>æ¥ä¸‹æ¥éœ€è¦ä¿®æ”¹å¯åŠ¨æ–‡ä»¶ä»¥ä¸‹è½½æ¨¡å‹ä»¥åŠåˆå¹¶ lora å±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> openxlab.model <span class="hljs-keyword">import</span> download<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Download</span>():<br>    download(model_repo=<span class="hljs-string">&#x27;OpenLMLab/InternLM-chat-7b&#x27;</span>,output=<span class="hljs-string">&#x27;/home/xlab-app-center/InternLM-chat-7b&#x27;</span>)<br>    download(model_repo=<span class="hljs-string">&#x27;EnableAsync/openxlab-assistant&#x27;</span>,output=<span class="hljs-string">&quot;/home/xlab-app-center/hf&quot;</span>)<br><br>Download()<br>os.system(<span class="hljs-string">&#x27;echo $PWD&#x27;</span>)<br>os.system(<span class="hljs-string">&#x27;ls&#x27;</span>)<br><br>os.system(<span class="hljs-string">&#x27;xtuner convert merge /home/xlab-app-center/InternLM-chat-7b /home/xlab-app-center/hf /home/xlab-app-center/hf-merge --max-shard-size 2GB&#x27;</span>)<br>os.system(<span class="hljs-string">&#x27;streamlit run /home/xlab-app-center/InternLM/web_demo.py --server.address=0.0.0.0 --server.port 7860&#x27;</span>)<br></code></pre></td></tr></table></figure>
<h3 id="3-æ„å»ºå¹¶è¿è¡Œ"><a href="#3-æ„å»ºå¹¶è¿è¡Œ" class="headerlink" title="3 æ„å»ºå¹¶è¿è¡Œ"></a>3 æ„å»ºå¹¶è¿è¡Œ</h3><p><img  src="./build.png"  ><span class="image-caption">æ„å»ºåŠè¿è¡Œ</span></p>
<p>Github åœ°å€å¦‚ä¸‹ï¼š</p>
<p><a href="https://github.com/EnableAsync/openxlab-assistant">EnableAsync/openxlab-assistant (github.com)</a></p>
<p>è¿è¡Œåœ°å€å¦‚ä¸‹ï¼š</p>
<p><a href="https://openxlab.org.cn/apps/detail/EnableAsync/openxlab-assistant">åº”ç”¨ä¸­å¿ƒ-OpenXLab-å°å¡çš„åŠ©æ‰‹</a></p>
]]></content>
      <categories>
        <category>internlm</category>
      </categories>
  </entry>
  <entry>
    <title>Internlm-06-ä½¿ç”¨ OpenCompass å¯¹å¤§æ¨¡å‹è¿›è¡Œè¯„æµ‹</title>
    <url>/internlm/internlm-06/</url>
    <content><![CDATA[<h1 id="ä½¿ç”¨-OpenCompass-å¯¹å¤§æ¨¡å‹è¿›è¡Œè¯„æµ‹"><a href="#ä½¿ç”¨-OpenCompass-å¯¹å¤§æ¨¡å‹è¿›è¡Œè¯„æµ‹" class="headerlink" title="ä½¿ç”¨ OpenCompass å¯¹å¤§æ¨¡å‹è¿›è¡Œè¯„æµ‹"></a>ä½¿ç”¨ OpenCompass å¯¹å¤§æ¨¡å‹è¿›è¡Œè¯„æµ‹</h1><h2 id="å¤§æ¨¡å‹è¯„æµ‹æ¦‚è¦"><a href="#å¤§æ¨¡å‹è¯„æµ‹æ¦‚è¦" class="headerlink" title="å¤§æ¨¡å‹è¯„æµ‹æ¦‚è¦"></a>å¤§æ¨¡å‹è¯„æµ‹æ¦‚è¦</h2><h3 id="äººå·¥æ™ºèƒ½æŠ€æœ¯çš„å‘å±•å’Œä¸»è¦æ¨¡å‹çš„æ¼”å˜"><a href="#äººå·¥æ™ºèƒ½æŠ€æœ¯çš„å‘å±•å’Œä¸»è¦æ¨¡å‹çš„æ¼”å˜" class="headerlink" title="äººå·¥æ™ºèƒ½æŠ€æœ¯çš„å‘å±•å’Œä¸»è¦æ¨¡å‹çš„æ¼”å˜"></a>äººå·¥æ™ºèƒ½æŠ€æœ¯çš„å‘å±•å’Œä¸»è¦æ¨¡å‹çš„æ¼”å˜</h3><ul>
<li><strong>OpenAI GPTç³»åˆ—ï¼š</strong><ul>
<li>2018å¹´ï¼šå‘å¸ƒç¬¬ä¸€ä»£GPTæ¨¡å‹ï¼Œå¼€å¯è‡ªç„¶è¯­è¨€æ¨¡å‹ç”Ÿæˆå¼é¢„è®­ç»ƒã€‚</li>
<li>éšåï¼šå‘å¸ƒGPT-2å’ŒGPT-3æ¨¡å‹ã€‚</li>
</ul>
</li>
<li><strong>è°·æ­Œçš„é¢„è®­ç»ƒæ¨¡å‹ï¼š</strong><ul>
<li>æ¢ç´¢ä¸åŒçš„å¤§è§„æ¨¡é¢„è®­ç»ƒæ¨¡å‹ï¼Œå¦‚T5, Flanç­‰ã€‚</li>
</ul>
</li>
<li><strong>OpenAIçš„ChatGPTå’ŒGPT-4ï¼š</strong><ul>
<li>2022å¹´11æœˆï¼šå‘å¸ƒChatGPTï¼Œå±•ç¤ºé—®ç­”ã€é€»è¾‘æ¨ç†å’Œå†…å®¹åˆ›ä½œèƒ½åŠ›ã€‚</li>
<li>2023å¹´4æœˆï¼šå‘å¸ƒGPT-4ï¼Œå¼•å…¥å¤šæ¨¡æ€èƒ½åŠ›ï¼Œæ‹“å±•è¯­è¨€æ¨¡å‹èƒ½åŠ›ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å¤§æ¨¡å‹çš„å›½é™…ç«äº‰å’Œåº”ç”¨"><a href="#å¤§æ¨¡å‹çš„å›½é™…ç«äº‰å’Œåº”ç”¨" class="headerlink" title="å¤§æ¨¡å‹çš„å›½é™…ç«äº‰å’Œåº”ç”¨"></a>å¤§æ¨¡å‹çš„å›½é™…ç«äº‰å’Œåº”ç”¨</h3><ul>
<li><strong>OpenAIå’Œå¾®è½¯çš„é›†æˆï¼š</strong><ul>
<li>å°†ChatGPTå’ŒGPT-4é›†æˆè¿›æœç´¢å¼•æ“å’ŒOfficeåŠå…¬å¥—ä»¶ï¼Œæ¨å‡ºNew Bingå’ŒOffice Copilotã€‚</li>
</ul>
</li>
<li><strong>è°·æ­Œçš„Bardï¼š</strong><ul>
<li>åŸºäºPaLMå’ŒPaLM-2æ¨¡å‹ï¼Œä¸OpenAIå’Œå¾®è½¯ç«äº‰ã€‚</li>
</ul>
</li>
<li><strong>ä¸­å›½ä¼ä¸šå’Œé«˜æ ¡çš„å‘å±•ï¼š</strong><ul>
<li>ç™¾åº¦ã€é˜¿é‡Œã€åä¸ºã€å•†æ±¤ã€è®¯é£ç­‰å‘å¸ƒå›½äº§å¤§æ¨¡å‹ã€‚</li>
<li>æ¸…åã€å¤æ—¦ç­‰é«˜æ ¡å‘å¸ƒGLM, MOSSç­‰æ¨¡å‹ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å¤§æ¨¡å‹è¯„æµ‹çš„å›½é™…å’Œå›½å†…è¿›å±•"><a href="#å¤§æ¨¡å‹è¯„æµ‹çš„å›½é™…å’Œå›½å†…è¿›å±•" class="headerlink" title="å¤§æ¨¡å‹è¯„æµ‹çš„å›½é™…å’Œå›½å†…è¿›å±•"></a>å¤§æ¨¡å‹è¯„æµ‹çš„å›½é™…å’Œå›½å†…è¿›å±•</h3><ul>
<li><strong>å›½é™…è¯„æµ‹æ¡†æ¶å’Œæ•°æ®é›†ï¼š</strong><ul>
<li>æ–¯å¦ç¦å¤§å­¦çš„HELMè¯„æµ‹æ¡†æ¶ã€‚</li>
<li>çº½çº¦å¤§å­¦ä¸è°·æ­Œã€Metaçš„SuperGLUEè¯„æµ‹é›†ã€‚</li>
<li>åŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„MMLUæµ‹è¯•é›†ã€‚</li>
<li>è°·æ­Œçš„Big-Benchè¯„æµ‹é›†ã€‚</li>
</ul>
</li>
<li><strong>ä¸­å›½çš„è¯„æµ‹æ•°æ®é›†ï¼š</strong><ul>
<li>å¦‚CLUE, CUGEç­‰ï¼Œè¯„æµ‹ä¸­æ–‡è¯­è¨€æ¨¡å‹èƒ½åŠ›ã€‚</li>
</ul>
</li>
</ul>
<h3 id="é¢ä¸´çš„æŒ‘æˆ˜å’ŒOpenCompassçš„æè®®"><a href="#é¢ä¸´çš„æŒ‘æˆ˜å’ŒOpenCompassçš„æè®®" class="headerlink" title="é¢ä¸´çš„æŒ‘æˆ˜å’ŒOpenCompassçš„æè®®"></a>é¢ä¸´çš„æŒ‘æˆ˜å’ŒOpenCompassçš„æè®®</h3><ul>
<li><strong>å½“å‰æŒ‘æˆ˜ï¼š</strong><ul>
<li>å¤§æ¨¡å‹åº”ç”¨åœºæ™¯å¹¿æ³›ï¼Œä½†è¯„æµ‹æ–¹æ¡ˆå¾€å¾€ç¼ºä¹ç³»ç»ŸåŒ–ã€‚</li>
</ul>
</li>
<li><strong>OpenCompassçš„æè®®ï¼š</strong><ul>
<li>è®¾è®¡å…¨é¢ã€é«˜æ•ˆã€å¯æ‹“å±•çš„è¯„æµ‹æ–¹æ¡ˆã€‚</li>
<li>æä¾›åˆ†å¸ƒå¼è‡ªåŠ¨åŒ–è¯„æµ‹ç³»ç»Ÿï¼Œæ”¯æŒå…¨é¢ç³»ç»Ÿçš„èƒ½åŠ›è¯„ä¼°ã€‚</li>
</ul>
</li>
</ul>
<h1 id="OpenCompassä»‹ç»"><a href="#OpenCompassä»‹ç»" class="headerlink" title="OpenCompassä»‹ç»"></a>OpenCompassä»‹ç»</h1><h2 id="è¯„æµ‹å¯¹è±¡"><a href="#è¯„æµ‹å¯¹è±¡" class="headerlink" title="è¯„æµ‹å¯¹è±¡"></a>è¯„æµ‹å¯¹è±¡</h2><p>æœ¬ç®—æ³•åº“çš„ä¸»è¦è¯„æµ‹å¯¹è±¡ä¸ºè¯­è¨€å¤§æ¨¡å‹ä¸å¤šæ¨¡æ€å¤§æ¨¡å‹ã€‚æˆ‘ä»¬ä»¥è¯­è¨€å¤§æ¨¡å‹ä¸ºä¾‹ä»‹ç»è¯„æµ‹çš„å…·ä½“æ¨¡å‹ç±»å‹ã€‚</p>
<ul>
<li><p><strong>åŸºåº§æ¨¡å‹</strong>ï¼šä¸€èˆ¬æ˜¯ç»è¿‡æµ·é‡çš„æ–‡æœ¬æ•°æ®ä»¥è‡ªç›‘ç£å­¦ä¹ çš„æ–¹å¼è¿›è¡Œè®­ç»ƒè·å¾—çš„æ¨¡å‹ï¼ˆå¦‚OpenAIçš„GPT-3ï¼ŒMetaçš„LLaMAï¼‰ï¼Œå¾€å¾€å…·æœ‰å¼ºå¤§çš„æ–‡å­—ç»­å†™èƒ½åŠ›ã€‚</p>
</li>
<li><p><strong>å¯¹è¯æ¨¡å‹</strong>ï¼šä¸€èˆ¬æ˜¯åœ¨çš„åŸºåº§æ¨¡å‹çš„åŸºç¡€ä¸Šï¼Œç»è¿‡æŒ‡ä»¤å¾®è°ƒæˆ–äººç±»åå¥½å¯¹é½è·å¾—çš„æ¨¡å‹ï¼ˆå¦‚OpenAIçš„ChatGPTã€ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤çš„ä¹¦ç”ŸÂ·æµ¦è¯­ï¼‰ï¼Œèƒ½ç†è§£äººç±»æŒ‡ä»¤ï¼Œå…·æœ‰è¾ƒå¼ºçš„å¯¹è¯èƒ½åŠ›ã€‚</p>
</li>
</ul>
<h2 id="å·¥å…·æ¶æ„"><a href="#å·¥å…·æ¶æ„" class="headerlink" title="å·¥å…·æ¶æ„"></a>å·¥å…·æ¶æ„</h2><p><img  src="å·¥å…·æ¶æ„.png"  ><span class="image-caption">å·¥å…·æ¶æ„</span></p>
<h3 id="å¤§æ¨¡å‹è¯„æµ‹çš„å±‚çº§ç»“æ„"><a href="#å¤§æ¨¡å‹è¯„æµ‹çš„å±‚çº§ç»“æ„" class="headerlink" title="å¤§æ¨¡å‹è¯„æµ‹çš„å±‚çº§ç»“æ„"></a>å¤§æ¨¡å‹è¯„æµ‹çš„å±‚çº§ç»“æ„</h3><ul>
<li><p>æ¨¡å‹å±‚</p>
<ul>
<li>é‡ç‚¹è¯„æµ‹å¯¹è±¡ï¼š<ul>
<li>åŸºåº§æ¨¡å‹</li>
<li>å¯¹è¯æ¨¡å‹</li>
</ul>
</li>
</ul>
</li>
<li><p>èƒ½åŠ›å±‚</p>
<ul>
<li><p>é€šç”¨èƒ½åŠ›ï¼š</p>
<ul>
<li>è¯­è¨€</li>
<li>çŸ¥è¯†</li>
<li>ç†è§£</li>
<li>æ¨ç†</li>
<li>å®‰å…¨</li>
</ul>
</li>
<li><p>ç‰¹è‰²èƒ½åŠ›ï¼š</p>
<ul>
<li>é•¿æ–‡æœ¬å¤„ç†</li>
<li>ç¼–ç èƒ½åŠ›</li>
<li>å·¥å…·ä½¿ç”¨</li>
<li>çŸ¥è¯†å¢å¼º</li>
</ul>
</li>
</ul>
</li>
<li><p>æ–¹æ³•å±‚</p>
<ul>
<li><p>å®¢è§‚è¯„æµ‹ï¼š</p>
<ul>
<li>è¯„ä¼°æ¨¡å‹åœ¨ç¡®å®šç­”æ¡ˆä»»åŠ¡ï¼ˆå¦‚é€‰æ‹©é¢˜ã€å¡«ç©ºã€å°é—­å¼é—®ç­”ï¼‰ä¸Šçš„èƒ½åŠ›ã€‚</li>
</ul>
</li>
<li><p>ä¸»è§‚è¯„æµ‹ï¼š</p>
<ul>
<li>è¯„ä¼°ç”¨æˆ·å¯¹æ¨¡å‹å›å¤çš„çœŸå®æ»¡æ„åº¦ã€‚</li>
<li>æ–¹æ³•åŒ…æ‹¬ï¼š<ul>
<li>åŸºäºæ¨¡å‹è¾…åŠ©çš„ä¸»è§‚è¯„æµ‹</li>
<li>åŸºäºäººç±»åé¦ˆçš„ä¸»è§‚è¯„æµ‹</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>å·¥å…·å±‚</p>
<ul>
<li>è‡ªåŠ¨åŒ–è¯„æµ‹æ”¯æŒï¼š<ul>
<li>åˆ†å¸ƒå¼è¯„æµ‹æŠ€æœ¯</li>
<li>æç¤ºè¯å·¥ç¨‹</li>
<li>å¯¹æ¥è¯„æµ‹æ•°æ®åº“</li>
<li>è¯„æµ‹æ¦œå•å‘å¸ƒ</li>
<li>è¯„æµ‹æŠ¥å‘Šç”Ÿæˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="è¯„æµ‹æ–¹æ³•"><a href="#è¯„æµ‹æ–¹æ³•" class="headerlink" title="è¯„æµ‹æ–¹æ³•"></a>è¯„æµ‹æ–¹æ³•</h2><h3 id="å®¢è§‚è¯„æµ‹"><a href="#å®¢è§‚è¯„æµ‹" class="headerlink" title="å®¢è§‚è¯„æµ‹"></a>å®¢è§‚è¯„æµ‹</h3><h4 id="è¯„æµ‹å®¢è§‚é—®é¢˜çš„æ–¹æ³•"><a href="#è¯„æµ‹å®¢è§‚é—®é¢˜çš„æ–¹æ³•" class="headerlink" title="è¯„æµ‹å®¢è§‚é—®é¢˜çš„æ–¹æ³•"></a>è¯„æµ‹å®¢è§‚é—®é¢˜çš„æ–¹æ³•</h4><ul>
<li><strong>å®šé‡æ¯”è¾ƒï¼š</strong><ul>
<li>ä½¿ç”¨å®šé‡æŒ‡æ ‡æ¯”è¾ƒæ¨¡å‹è¾“å‡ºä¸æ ‡å‡†ç­”æ¡ˆçš„å·®å¼‚ã€‚</li>
<li>æ ¹æ®å·®å¼‚ç»“æœè¡¡é‡æ¨¡å‹æ€§èƒ½ã€‚</li>
</ul>
</li>
<li><p><strong>è¾“å…¥è¾“å‡ºè§„èŒƒï¼š</strong></p>
<ul>
<li>åœ¨è¯„æµ‹é˜¶æ®µè§„èŒƒæ¨¡å‹çš„è¾“å…¥å’Œè¾“å‡ºã€‚</li>
<li>å°½é‡å‡å°‘å™ªå£°è¾“å‡ºï¼Œä»¥ä¾¿æ›´å®¢è§‚åœ°è¯„ä»·æ¨¡å‹èƒ½åŠ›ã€‚</li>
</ul>
<h4 id="æ¨¡å‹èƒ½åŠ›çš„æ¿€å‘ä¸å¼•å¯¼"><a href="#æ¨¡å‹èƒ½åŠ›çš„æ¿€å‘ä¸å¼•å¯¼" class="headerlink" title="æ¨¡å‹èƒ½åŠ›çš„æ¿€å‘ä¸å¼•å¯¼"></a>æ¨¡å‹èƒ½åŠ›çš„æ¿€å‘ä¸å¼•å¯¼</h4></li>
<li><p>æç¤ºè¯å·¥ç¨‹ï¼ˆPrompt Engineeringï¼‰ï¼š</p>
<ul>
<li>ä½¿ç”¨ç‰¹å®šæç¤ºè¯å¼•å¯¼æ¨¡å‹è¾“å‡ºã€‚</li>
</ul>
</li>
<li><p>è¯­å¢ƒå­¦ä¹ ï¼ˆIn-Context Learningï¼‰ï¼š</p>
<ul>
<li>åˆ©ç”¨ä¸Šä¸‹æ–‡ç¯å¢ƒæå‡æ¨¡å‹çš„è¾“å‡ºè´¨é‡ã€‚</li>
</ul>
<h4 id="å®¢è§‚è¯„æµ‹çš„å…·ä½“å®è·µ"><a href="#å®¢è§‚è¯„æµ‹çš„å…·ä½“å®è·µ" class="headerlink" title="å®¢è§‚è¯„æµ‹çš„å…·ä½“å®è·µ"></a>å®¢è§‚è¯„æµ‹çš„å…·ä½“å®è·µ</h4></li>
<li><p><strong>åˆ¤åˆ«å¼è¯„æµ‹ï¼š</strong></p>
<ul>
<li>ç»“åˆé—®é¢˜å’Œå€™é€‰ç­”æ¡ˆã€‚</li>
<li>è®¡ç®—å›°æƒ‘åº¦ï¼ˆperplexityï¼‰ï¼Œé€‰æ‹©å›°æƒ‘åº¦æœ€å°çš„ç­”æ¡ˆã€‚</li>
</ul>
</li>
<li><strong>ç”Ÿæˆå¼è¯„æµ‹ï¼š</strong><ul>
<li>ç”¨äºç”Ÿæˆç±»ä»»åŠ¡ï¼ˆå¦‚è¯­è¨€ç¿»è¯‘ã€ç¨‹åºç”Ÿæˆã€é€»è¾‘åˆ†æï¼‰ã€‚</li>
<li>ä½¿ç”¨é—®é¢˜ä½œä¸ºè¾“å…¥ï¼Œç•™ç™½ç­”æ¡ˆåŒºåŸŸç”±æ¨¡å‹è¡¥å…¨ã€‚</li>
<li>å¯¹æ¨¡å‹è¾“å‡ºè¿›è¡Œåå¤„ç†ï¼Œç¡®ä¿æ»¡è¶³æ•°æ®é›†è¦æ±‚ã€‚</li>
</ul>
</li>
</ul>
<h3 id="ä¸»è§‚è¯„æµ‹"><a href="#ä¸»è§‚è¯„æµ‹" class="headerlink" title="ä¸»è§‚è¯„æµ‹"></a>ä¸»è§‚è¯„æµ‹</h3><h4 id="ä¸»è§‚è¯„æµ‹çš„é‡è¦æ€§"><a href="#ä¸»è§‚è¯„æµ‹çš„é‡è¦æ€§" class="headerlink" title="ä¸»è§‚è¯„æµ‹çš„é‡è¦æ€§"></a>ä¸»è§‚è¯„æµ‹çš„é‡è¦æ€§</h4><ul>
<li>åœºæ™¯å’Œèƒ½åŠ›å¤šæ ·æ€§ï¼š<ul>
<li>è¯­è¨€è¡¨è¾¾ä¸°å¯Œå¤šå˜ï¼Œå¾ˆå¤šåœºæ™¯å’Œèƒ½åŠ›éš¾ä»¥é€šè¿‡å®¢è§‚æŒ‡æ ‡è¯„æµ‹ã€‚</li>
</ul>
</li>
<li>æ¨¡å‹å®‰å…¨å’Œè¯­è¨€èƒ½åŠ›ï¼š<ul>
<li>éœ€è¦ä¾èµ–äººçš„ä¸»è§‚æ„Ÿå—è¿›è¡Œè¯„æµ‹ï¼Œä»¥æ›´çœŸå®åœ°åæ˜ æ¨¡å‹èƒ½åŠ›ã€‚</li>
</ul>
</li>
</ul>
<h4 id="OpenCompassçš„ä¸»è§‚è¯„æµ‹æ–¹æ¡ˆ"><a href="#OpenCompassçš„ä¸»è§‚è¯„æµ‹æ–¹æ¡ˆ" class="headerlink" title="OpenCompassçš„ä¸»è§‚è¯„æµ‹æ–¹æ¡ˆ"></a>OpenCompassçš„ä¸»è§‚è¯„æµ‹æ–¹æ¡ˆ</h4><ul>
<li>è¯„æµ‹å®æ–½ï¼š<ul>
<li>ä½¿ç”¨å—è¯•è€…çš„ä¸»è§‚åˆ¤æ–­å¯¹å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œè¯„æµ‹ã€‚</li>
<li>æ„å»ºä¸»è§‚æµ‹è¯•é—®é¢˜é›†ï¼Œå¯¹æ¯”ä¸åŒæ¨¡å‹çš„å›å¤ã€‚</li>
</ul>
</li>
<li>æˆæœ¬ä¸æ•ˆç‡ï¼š<ul>
<li>é«˜æˆæœ¬çš„äººç±»ä¸»è§‚è¯„æµ‹ã€‚</li>
<li>ç»“åˆä½¿ç”¨æ€§èƒ½ä¼˜å¼‚çš„å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œä¸»è§‚æ‰“åˆ†ã€‚</li>
</ul>
</li>
</ul>
<h4 id="ä¸»è§‚è¯„æµ‹çš„å…·ä½“å®è·µ"><a href="#ä¸»è§‚è¯„æµ‹çš„å…·ä½“å®è·µ" class="headerlink" title="ä¸»è§‚è¯„æµ‹çš„å…·ä½“å®è·µ"></a>ä¸»è§‚è¯„æµ‹çš„å…·ä½“å®è·µ</h4><ul>
<li>å•æ¨¡å‹å›å¤æ»¡æ„åº¦ç»Ÿè®¡ï¼š<ul>
<li>å¯¹å•ä¸€æ¨¡å‹çš„å›å¤è¿›è¡Œæ»¡æ„åº¦è¯„åˆ†ã€‚</li>
</ul>
</li>
<li>å¤šæ¨¡å‹æ»¡æ„åº¦æ¯”è¾ƒï¼š<ul>
<li>æ¯”è¾ƒä¸åŒæ¨¡å‹å›å¤çš„æ»¡æ„åº¦ã€‚</li>
</ul>
</li>
</ul>
<h1 id="å¿«é€Ÿå¼€å§‹"><a href="#å¿«é€Ÿå¼€å§‹" class="headerlink" title="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹</h1><p><img  src="opencompassæµç¨‹.png"  ><span class="image-caption">opencompass è¯„åˆ¤æµç¨‹</span></p>
<h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p>åœ¨ OpenCompass ä¸­è¯„ä¼°ä¸€ä¸ªæ¨¡å‹é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š<strong>é…ç½®</strong> -&gt; <strong>æ¨ç†</strong> -&gt; <strong>è¯„ä¼°</strong> -&gt; <strong>å¯è§†åŒ–</strong>ã€‚</p>
<p><strong>é…ç½®</strong>ï¼šè¿™æ˜¯æ•´ä¸ªå·¥ä½œæµçš„èµ·ç‚¹ã€‚æ‚¨éœ€è¦é…ç½®æ•´ä¸ªè¯„ä¼°è¿‡ç¨‹ï¼Œé€‰æ‹©è¦è¯„ä¼°çš„æ¨¡å‹å’Œæ•°æ®é›†ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€‰æ‹©è¯„ä¼°ç­–ç•¥ã€è®¡ç®—åç«¯ç­‰ï¼Œå¹¶å®šä¹‰æ˜¾ç¤ºç»“æœçš„æ–¹å¼ã€‚</p>
<p><strong>æ¨ç†ä¸è¯„ä¼°</strong>ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼ŒOpenCompass å°†ä¼šå¼€å§‹å¯¹æ¨¡å‹å’Œæ•°æ®é›†è¿›è¡Œå¹¶è¡Œæ¨ç†å’Œè¯„ä¼°ã€‚<strong>æ¨ç†</strong>é˜¶æ®µä¸»è¦æ˜¯è®©æ¨¡å‹ä»æ•°æ®é›†äº§ç”Ÿè¾“å‡ºï¼Œè€Œ<strong>è¯„ä¼°</strong>é˜¶æ®µåˆ™æ˜¯è¡¡é‡è¿™äº›è¾“å‡ºä¸æ ‡å‡†ç­”æ¡ˆçš„åŒ¹é…ç¨‹åº¦ã€‚è¿™ä¸¤ä¸ªè¿‡ç¨‹ä¼šè¢«æ‹†åˆ†ä¸ºå¤šä¸ªåŒæ—¶è¿è¡Œçš„â€œä»»åŠ¡â€ä»¥æé«˜æ•ˆç‡ï¼Œä½†è¯·æ³¨æ„ï¼Œå¦‚æœè®¡ç®—èµ„æºæœ‰é™ï¼Œè¿™ç§ç­–ç•¥å¯èƒ½ä¼šä½¿è¯„æµ‹å˜å¾—æ›´æ…¢ã€‚</p>
<p><strong>å¯è§†åŒ–</strong>ï¼šè¯„ä¼°å®Œæˆåï¼ŒOpenCompass å°†ç»“æœæ•´ç†æˆæ˜“è¯»çš„è¡¨æ ¼ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸º CSV å’Œ TXT æ–‡ä»¶ã€‚ä½ ä¹Ÿå¯ä»¥æ¿€æ´»é£ä¹¦çŠ¶æ€ä¸ŠæŠ¥åŠŸèƒ½ï¼Œæ­¤åå¯ä»¥åœ¨é£ä¹¦å®¢æˆ·ç«¯ä¸­åŠæ—¶è·å¾—è¯„æµ‹çŠ¶æ€æŠ¥å‘Šã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å±•ç¤º OpenCompass çš„åŸºç¡€ç”¨æ³•ï¼Œå±•ç¤ºä¹¦ç”Ÿæµ¦è¯­åœ¨ <a href="https://cevalbenchmark.com/index.html#home">C-Eval</a> åŸºå‡†ä»»åŠ¡ä¸Šçš„è¯„ä¼°ã€‚å®ƒä»¬çš„é…ç½®æ–‡ä»¶å¯ä»¥åœ¨ <a href="https://github.com/open-compass/opencompass/blob/main/configs/eval_demo.py">configs/eval_demo.py</a> ä¸­æ‰¾åˆ°ã€‚</p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="é¢å‘GPUçš„ç¯å¢ƒå®‰è£…"><a href="#é¢å‘GPUçš„ç¯å¢ƒå®‰è£…" class="headerlink" title="é¢å‘GPUçš„ç¯å¢ƒå®‰è£…"></a>é¢å‘GPUçš„ç¯å¢ƒå®‰è£…</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">conda create --name opencompass --<span class="hljs-built_in">clone</span>=/root/share/conda_envs/internlm-base<br>conda activate opencompass<br>git <span class="hljs-built_in">clone</span> https://github.com/open-compass/opencompass<br><span class="hljs-built_in">cd</span> opencompass<br>pip install -e .<br></code></pre></td></tr></table></figure>
<p>æœ‰éƒ¨åˆ†ç¬¬ä¸‰æ–¹åŠŸèƒ½,å¦‚ä»£ç èƒ½åŠ›åŸºå‡†æµ‹è¯• Humaneval ä»¥åŠ Llamaæ ¼å¼çš„æ¨¡å‹è¯„æµ‹,å¯èƒ½éœ€è¦é¢å¤–æ­¥éª¤æ‰èƒ½æ­£å¸¸è¿è¡Œï¼Œå¦‚éœ€è¯„æµ‹ï¼Œè¯¦ç»†æ­¥éª¤è¯·å‚è€ƒ<a href="https://opencompass.readthedocs.io/zh_CN/latest/get_started/installation.html">å®‰è£…æŒ‡å—</a>ã€‚</p>
<h3 id="æ•°æ®å‡†å¤‡"><a href="#æ•°æ®å‡†å¤‡" class="headerlink" title="æ•°æ®å‡†å¤‡"></a>æ•°æ®å‡†å¤‡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è§£å‹è¯„æµ‹æ•°æ®é›†åˆ° data/ å¤„</span><br><span class="hljs-built_in">cp</span> /share/temp/datasets/OpenCompassData-core-20231110.zip /root/opencompass/<br>unzip OpenCompassData-core-20231110.zip<br><br><span class="hljs-comment"># å°†ä¼šåœ¨opencompassä¸‹çœ‹åˆ°dataæ–‡ä»¶å¤¹</span><br></code></pre></td></tr></table></figure>
<h3 id="æŸ¥çœ‹æ”¯æŒçš„æ•°æ®é›†å’Œæ¨¡å‹"><a href="#æŸ¥çœ‹æ”¯æŒçš„æ•°æ®é›†å’Œæ¨¡å‹" class="headerlink" title="æŸ¥çœ‹æ”¯æŒçš„æ•°æ®é›†å’Œæ¨¡å‹"></a>æŸ¥çœ‹æ”¯æŒçš„æ•°æ®é›†å’Œæ¨¡å‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ—å‡ºæ‰€æœ‰è·Ÿ internlm åŠ ceval ç›¸å…³çš„é…ç½®</span><br>python tools/list_configs.py internlm ceval<br></code></pre></td></tr></table></figure>
<p>å°†ä¼šçœ‹åˆ°</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">+--------------------------+--------------------------------------------------------+<br>| Model                    | Config Path                                            |<br>|--------------------------+--------------------------------------------------------|<br>| hf_internlm_20b          | configs/models/hf_internlm/hf_internlm_20b.py          |<br>| hf_internlm_7b           | configs/models/hf_internlm/hf_internlm_7b.py           |<br>| hf_internlm_chat_20b     | configs/models/hf_internlm/hf_internlm_chat_20b.py     |<br>| hf_internlm_chat_7b      | configs/models/hf_internlm/hf_internlm_chat_7b.py      |<br>| hf_internlm_chat_7b_8k   | configs/models/hf_internlm/hf_internlm_chat_7b_8k.py   |<br>| hf_internlm_chat_7b_v1_1 | configs/models/hf_internlm/hf_internlm_chat_7b_v1_1.py |<br>| internlm_7b              | configs/models/internlm/internlm_7b.py                 |<br>| ms_internlm_chat_7b_8k   | configs/models/ms_internlm/ms_internlm_chat_7b_8k.py   |<br>+--------------------------+--------------------------------------------------------+<br>+----------------------------+------------------------------------------------------+<br>| Dataset                    | Config Path                                          |<br>|----------------------------+------------------------------------------------------|<br>| ceval_clean_ppl            | configs/datasets/ceval/ceval_clean_ppl.py            |<br>| ceval_gen                  | configs/datasets/ceval/ceval_gen.py                  |<br>| ceval_gen_2daf24           | configs/datasets/ceval/ceval_gen_2daf24.py           |<br>| ceval_gen_5f30c7           | configs/datasets/ceval/ceval_gen_5f30c7.py           |<br>| ceval_ppl                  | configs/datasets/ceval/ceval_ppl.py                  |<br>| ceval_ppl_578f8d           | configs/datasets/ceval/ceval_ppl_578f8d.py           |<br>| ceval_ppl_93e5ce           | configs/datasets/ceval/ceval_ppl_93e5ce.py           |<br>| ceval_zero_shot_gen_bd40ef | configs/datasets/ceval/ceval_zero_shot_gen_bd40ef.py |<br>+----------------------------+------------------------------------------------------+<br></code></pre></td></tr></table></figure>
<h3 id="å¯åŠ¨è¯„æµ‹"><a href="#å¯åŠ¨è¯„æµ‹" class="headerlink" title="å¯åŠ¨è¯„æµ‹"></a>å¯åŠ¨è¯„æµ‹</h3><p>ç¡®ä¿æŒ‰ç…§ä¸Šè¿°æ­¥éª¤æ­£ç¡®å®‰è£… OpenCompass å¹¶å‡†å¤‡å¥½æ•°æ®é›†åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¯„æµ‹ InternLM-Chat-7B æ¨¡å‹åœ¨ C-Eval æ•°æ®é›†ä¸Šçš„æ€§èƒ½ã€‚ç”±äº OpenCompass é»˜è®¤å¹¶è¡Œå¯åŠ¨è¯„ä¼°è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ä»¥ <code>--debug</code> æ¨¡å¼å¯åŠ¨è¯„ä¼°ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨é—®é¢˜ã€‚åœ¨ <code>--debug</code> æ¨¡å¼ä¸‹ï¼Œä»»åŠ¡å°†æŒ‰é¡ºåºæ‰§è¡Œï¼Œå¹¶å®æ—¶æ‰“å°è¾“å‡ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python run.py --datasets ceval_gen --hf-path /share/temp/model_repos/internlm-chat-7b/ --tokenizer-path /share/temp/model_repos/internlm-chat-7b/ --tokenizer-kwargs padding_side=<span class="hljs-string">&#x27;left&#x27;</span> truncation=<span class="hljs-string">&#x27;left&#x27;</span> trust_remote_code=True --model-kwargs trust_remote_code=True device_map=<span class="hljs-string">&#x27;auto&#x27;</span> --max-seq-len 2048 --max-out-len 16 --batch-size 4 --num-gpus 1 --debug<br></code></pre></td></tr></table></figure>
<p>å‘½ä»¤è§£æ<br><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">--datasets ceval_gen \<br>--hf-path /share/temp/model_repos/internlm-chat-7b/ \  <span class="hljs-comment"># HuggingFace æ¨¡å‹è·¯å¾„</span><br>--tokenizer-path /share/temp/model_repos/internlm-chat-7b/ \  <span class="hljs-comment"># HuggingFace tokenizer è·¯å¾„ï¼ˆå¦‚æœä¸æ¨¡å‹è·¯å¾„ç›¸åŒï¼Œå¯ä»¥çœç•¥ï¼‰</span><br>--tokenizer-kwargs padding_side=<span class="hljs-string">&#x27;left&#x27;</span> truncation=<span class="hljs-string">&#x27;left&#x27;</span> trust_remote_code=True \  <span class="hljs-comment"># æ„å»º tokenizer çš„å‚æ•°</span><br>--model-kwargs device_map=<span class="hljs-string">&#x27;auto&#x27;</span> trust_remote_code=True \  <span class="hljs-comment"># æ„å»ºæ¨¡å‹çš„å‚æ•°</span><br>--max-seq-len 2048 \  <span class="hljs-comment"># æ¨¡å‹å¯ä»¥æ¥å—çš„æœ€å¤§åºåˆ—é•¿åº¦</span><br>--max-out-len 16 \  <span class="hljs-comment"># ç”Ÿæˆçš„æœ€å¤§ token æ•°</span><br>--batch-size 2  \  <span class="hljs-comment"># æ‰¹é‡å¤§å°</span><br>--num-gpus 1  <span class="hljs-comment"># è¿è¡Œæ¨¡å‹æ‰€éœ€çš„ GPU æ•°é‡</span><br>--debug<br></code></pre></td></tr></table></figure></p>
<p>å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°å±å¹•ä¸Šæ˜¾ç¤º â€œStarting inference processâ€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[2024-01-12 18:23:55,076] [opencompass.openicl.icl_inferencer.icl_gen_inferencer] [INFO] Starting inference process...<br></code></pre></td></tr></table></figure>
<p>è¯„æµ‹å®Œæˆåï¼Œå°†ä¼šçœ‹åˆ°ï¼š<br><figure class="highlight maxima"><table><tr><td class="code"><pre><code class="hljs maxima"><br>dataset                                         version    metric         mode      opencompass.models.huggingface.HuggingFace_model_repos_internlm-chat-7b<br>----------------------------------------------  ---------  -------------  ------  -------------------------------------------------------------------------<br>ceval-computer_network                          db9ce2     accuracy       gen                                                                         <span class="hljs-number">31.58</span><br>ceval-operating_system                          1c2571     accuracy       gen                                                                         <span class="hljs-number">36.84</span><br>ceval-computer_architecture                     a74dad     accuracy       gen                                                                         <span class="hljs-number">28.57</span><br>ceval-college_programming                       4ca32a     accuracy       gen                                                                         <span class="hljs-number">32.43</span><br>ceval-college_physics                           963fa8     accuracy       gen                                                                         <span class="hljs-number">26.32</span><br>ceval-college_chemistry                         e78857     accuracy       gen                                                                         <span class="hljs-number">16.67</span><br>ceval-advanced_mathematics                      ce03e2     accuracy       gen                                                                         <span class="hljs-number">21.05</span><br>ceval-probability_and_statistics                <span class="hljs-number">65e812</span>     accuracy       gen                                                                         <span class="hljs-number">38.89</span><br>ceval-discrete_mathematics                      e894ae     accuracy       gen                                                                         <span class="hljs-number">18.75</span><br>ceval-electrical_engineer                       ae42b9     accuracy       gen                                                                         <span class="hljs-number">35.14</span><br>ceval-metrology_engineer                        ee34ea     accuracy       gen                                                                         <span class="hljs-number">50</span><br>ceval-high_school_mathematics                   1dc5bf     accuracy       gen                                                                         <span class="hljs-number">22.22</span><br>ceval-high_school_physics                       adf25f     accuracy       gen                                                                         <span class="hljs-number">31.58</span><br>ceval-high_school_chemistry                     2ed27f     accuracy       gen                                                                         <span class="hljs-number">15.79</span><br>ceval-high_school_biology                       8e2b9a     accuracy       gen                                                                         <span class="hljs-number">36.84</span><br>ceval-middle_school_mathematics                 bee8d5     accuracy       gen                                                                         <span class="hljs-number">26.32</span><br>ceval-middle_school_biology                     86817c     accuracy       gen                                                                         <span class="hljs-number">61.9</span><br>ceval-middle_school_physics                     8accf6     accuracy       gen                                                                         <span class="hljs-number">63.16</span><br>ceval-middle_school_chemistry                   167a15     accuracy       gen                                                                         <span class="hljs-number">60</span><br>ceval-veterinary_medicine                       b4e08d     accuracy       gen                                                                         <span class="hljs-number">47.83</span><br>ceval-college_economics                         f3f4e6     accuracy       gen                                                                         <span class="hljs-number">41.82</span><br>ceval-business_administration                   c1614e     accuracy       gen                                                                         <span class="hljs-number">33.33</span><br>ceval-marxism                                   cf874c     accuracy       gen                                                                         <span class="hljs-number">68.42</span><br>ceval-mao_zedong_thought                        51c7a4     accuracy       gen                                                                         <span class="hljs-number">70.83</span><br>ceval-education_science                         591fee     accuracy       gen                                                                         <span class="hljs-number">58.62</span><br>ceval-teacher_qualification                     4e4ced     accuracy       gen                                                                         <span class="hljs-number">70.45</span><br>ceval-high_school_politics                      5c0de2     accuracy       gen                                                                         <span class="hljs-number">26.32</span><br>ceval-high_school_geography                     <span class="hljs-number">865461</span>     accuracy       gen                                                                         <span class="hljs-number">47.37</span><br>ceval-middle_school_politics                    5be3e7     accuracy       gen                                                                         <span class="hljs-number">52.38</span><br>ceval-middle_school_geography                   8a63be     accuracy       gen                                                                         <span class="hljs-number">58.33</span><br>ceval-modern_chinese_history                    fc01af     accuracy       gen                                                                         <span class="hljs-number">73.91</span><br>ceval-ideological_and_moral_cultivation         a2aa4a     accuracy       gen                                                                         <span class="hljs-number">63.16</span><br>ceval-logic                                     f5b022     accuracy       gen                                                                         <span class="hljs-number">31.82</span><br>ceval-law                                       a110a1     accuracy       gen                                                                         <span class="hljs-number">25</span><br>ceval-chinese_language_and_literature           <span class="hljs-number">0f8b68</span>     accuracy       gen                                                                         <span class="hljs-number">30.43</span><br>ceval-art_studies                               2a1300     accuracy       gen                                                                         <span class="hljs-number">60.61</span><br>ceval-professional_tour_guide                   4e673e     accuracy       gen                                                                         <span class="hljs-number">62.07</span><br>ceval-legal_professional                        ce8787     accuracy       gen                                                                         <span class="hljs-number">39.13</span><br>ceval-high_school_chinese                       <span class="hljs-number">315705</span>     accuracy       gen                                                                         <span class="hljs-number">63.16</span><br>ceval-high_school_history                       7eb30a     accuracy       gen                                                                         <span class="hljs-number">70</span><br>ceval-middle_school_history                     48ab4a     accuracy       gen                                                                         <span class="hljs-number">59.09</span><br>ceval-civil_servant                             87d061     accuracy       gen                                                                         <span class="hljs-number">53.19</span><br>ceval-sports_science                            70f27b     accuracy       gen                                                                         <span class="hljs-number">52.63</span><br>ceval-plant_protection                          8941f9     accuracy       gen                                                                         <span class="hljs-number">59.09</span><br>ceval-basic_medicine                            c409d6     accuracy       gen                                                                         <span class="hljs-number">47.37</span><br>ceval-clinical_medicine                         49e82d     accuracy       gen                                                                         <span class="hljs-number">40.91</span><br>ceval-urban_and_rural_planner                   <span class="hljs-number">95b885</span>     accuracy       gen                                                                         <span class="hljs-number">45.65</span><br>ceval-accountant                                <span class="hljs-number">002837</span>     accuracy       gen                                                                         <span class="hljs-number">26.53</span><br>ceval-fire_engineer                             bc23f5     accuracy       gen                                                                         <span class="hljs-number">22.58</span><br>ceval-environmental_impact_assessment_engineer  c64e2d     accuracy       gen                                                                         <span class="hljs-number">64.52</span><br>ceval-tax_accountant                            3a5e3c     accuracy       gen                                                                         <span class="hljs-number">34.69</span><br>ceval-physician                                 6e277d     accuracy       gen                                                                         <span class="hljs-number">40.82</span><br>ceval-stem                                      -          naive_average  gen                                                                         <span class="hljs-number">35.09</span><br>ceval-social-science                            -          naive_average  gen                                                                         <span class="hljs-number">52.79</span><br>ceval-humanities                                -          naive_average  gen                                                                         <span class="hljs-number">52.58</span><br>ceval-other                                     -          naive_average  gen                                                                         <span class="hljs-number">44.36</span><br>ceval-hard                                      -          naive_average  gen                                                                         <span class="hljs-number">23.91</span><br>ceval                                           -          naive_average  gen                                                                         <span class="hljs-number">44.16</span><br></code></pre></td></tr></table></figure></p>
<p>æœ‰å…³ <code>run.py</code> æ”¯æŒçš„æ‰€æœ‰ä¸ HuggingFace ç›¸å…³çš„å‚æ•°ï¼Œè¯·é˜…è¯» <a href="https://opencompass.readthedocs.io/zh-cn/latest/user_guides/experimentation.html#id2">è¯„æµ‹ä»»åŠ¡å‘èµ·</a></p>
<p>é™¤äº†é€šè¿‡å‘½ä»¤è¡Œé…ç½®å®éªŒå¤–ï¼ŒOpenCompass è¿˜å…è®¸ç”¨æˆ·åœ¨é…ç½®æ–‡ä»¶ä¸­ç¼–å†™å®éªŒçš„å®Œæ•´é…ç½®ï¼Œå¹¶é€šè¿‡ <code>run.py</code> ç›´æ¥è¿è¡Œå®ƒã€‚é…ç½®æ–‡ä»¶æ˜¯ä»¥ Python æ ¼å¼ç»„ç»‡çš„ï¼Œå¹¶ä¸”å¿…é¡»åŒ…æ‹¬ <code>datasets</code> å’Œ <code>models</code> å­—æ®µã€‚</p>
<p>ç¤ºä¾‹æµ‹è¯•é…ç½®åœ¨ <a href="https://github.com/open-compass/opencompass/blob/main/configs/eval_demo.py">configs/eval_demo.py</a> ä¸­ã€‚æ­¤é…ç½®é€šè¿‡ <a href="../user_guides/config.md#ç»§æ‰¿æœºåˆ¶">ç»§æ‰¿æœºåˆ¶</a> å¼•å…¥æ‰€éœ€çš„æ•°æ®é›†å’Œæ¨¡å‹é…ç½®ï¼Œå¹¶ä»¥æ‰€éœ€æ ¼å¼ç»„åˆ <code>datasets</code> å’Œ <code>models</code> å­—æ®µã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> mmengine.config <span class="hljs-keyword">import</span> read_base<br><br><span class="hljs-keyword">with</span> read_base():<br>    <span class="hljs-keyword">from</span> .datasets.siqa.siqa_gen <span class="hljs-keyword">import</span> siqa_datasets<br>    <span class="hljs-keyword">from</span> .datasets.winograd.winograd_ppl <span class="hljs-keyword">import</span> winograd_datasets<br>    <span class="hljs-keyword">from</span> .models.opt.hf_opt_125m <span class="hljs-keyword">import</span> opt125m<br>    <span class="hljs-keyword">from</span> .models.opt.hf_opt_350m <span class="hljs-keyword">import</span> opt350m<br><br>datasets = [*siqa_datasets, *winograd_datasets]<br>models = [opt125m, opt350m]<br></code></pre></td></tr></table></figure>
<p>è¿è¡Œä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬åªéœ€å°†é…ç½®æ–‡ä»¶çš„è·¯å¾„ä¼ é€’ç»™ <code>run.py</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python run.py configs/eval_demo.py<br></code></pre></td></tr></table></figure>
<p>OpenCompass æä¾›äº†ä¸€ç³»åˆ—é¢„å®šä¹‰çš„æ¨¡å‹é…ç½®ï¼Œä½äº <code>configs/models</code> ä¸‹ã€‚ä»¥ä¸‹æ˜¯ä¸ <a href="https://github.com/open-compass/opencompass/blob/main/configs/models/opt/hf_opt_350m.py">opt-350m</a>ï¼ˆ<code>configs/models/opt/hf_opt_350m.py</code>ï¼‰ç›¸å…³çš„é…ç½®ç‰‡æ®µï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ä½¿ç”¨ `HuggingFaceCausalLM` è¯„ä¼°ç”± HuggingFace çš„ `AutoModelForCausalLM` æ”¯æŒçš„æ¨¡å‹</span><br><span class="hljs-keyword">from</span> opencompass.models <span class="hljs-keyword">import</span> HuggingFaceCausalLM<br><br><span class="hljs-comment"># OPT-350M</span><br>opt350m = <span class="hljs-built_in">dict</span>(<br>       <span class="hljs-built_in">type</span>=HuggingFaceCausalLM,<br>       <span class="hljs-comment"># `HuggingFaceCausalLM` çš„åˆå§‹åŒ–å‚æ•°</span><br>       path=<span class="hljs-string">&#x27;facebook/opt-350m&#x27;</span>,<br>       tokenizer_path=<span class="hljs-string">&#x27;facebook/opt-350m&#x27;</span>,<br>       tokenizer_kwargs=<span class="hljs-built_in">dict</span>(<br>           padding_side=<span class="hljs-string">&#x27;left&#x27;</span>,<br>           truncation_side=<span class="hljs-string">&#x27;left&#x27;</span>,<br>           proxies=<span class="hljs-literal">None</span>,<br>           trust_remote_code=<span class="hljs-literal">True</span>),<br>       model_kwargs=<span class="hljs-built_in">dict</span>(device_map=<span class="hljs-string">&#x27;auto&#x27;</span>),<br>       <span class="hljs-comment"># ä¸‹é¢æ˜¯æ‰€æœ‰æ¨¡å‹çš„å…±åŒå‚æ•°ï¼Œä¸ç‰¹å®šäº HuggingFaceCausalLM</span><br>       abbr=<span class="hljs-string">&#x27;opt350m&#x27;</span>,               <span class="hljs-comment"># ç»“æœæ˜¾ç¤ºçš„æ¨¡å‹ç¼©å†™</span><br>       max_seq_len=<span class="hljs-number">2048</span>,             <span class="hljs-comment"># æ•´ä¸ªåºåˆ—çš„æœ€å¤§é•¿åº¦</span><br>       max_out_len=<span class="hljs-number">100</span>,              <span class="hljs-comment"># ç”Ÿæˆçš„æœ€å¤§ token æ•°</span><br>       batch_size=<span class="hljs-number">64</span>,                <span class="hljs-comment"># æ‰¹é‡å¤§å°</span><br>       run_cfg=<span class="hljs-built_in">dict</span>(num_gpus=<span class="hljs-number">1</span>),     <span class="hljs-comment"># è¯¥æ¨¡å‹æ‰€éœ€çš„ GPU æ•°é‡</span><br>    )<br></code></pre></td></tr></table></figure>
<p>ä½¿ç”¨é…ç½®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•° <code>--models</code> æŒ‡å®šç›¸å…³æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨ç»§æ‰¿æœºåˆ¶å°†æ¨¡å‹é…ç½®å¯¼å…¥åˆ°é…ç½®æ–‡ä»¶ä¸­çš„ <code>models</code> åˆ—è¡¨ä¸­ã€‚</p>
<p>ä¸æ¨¡å‹ç±»ä¼¼ï¼Œæ•°æ®é›†çš„é…ç½®æ–‡ä»¶ä¹Ÿæä¾›åœ¨ <code>configs/datasets</code> ä¸‹ã€‚ç”¨æˆ·å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ <code>--datasets</code>ï¼Œæˆ–é€šè¿‡ç»§æ‰¿åœ¨é…ç½®æ–‡ä»¶ä¸­å¯¼å…¥ç›¸å…³é…ç½®</p>
<p>ä¸‹é¢æ˜¯æ¥è‡ª <code>configs/eval_demo.py</code> çš„ä¸æ•°æ®é›†ç›¸å…³çš„é…ç½®ç‰‡æ®µï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> mmengine.config <span class="hljs-keyword">import</span> read_base  <span class="hljs-comment"># ä½¿ç”¨ mmengine.read_base() è¯»å–åŸºæœ¬é…ç½®</span><br><br><span class="hljs-keyword">with</span> read_base():<br>    <span class="hljs-comment"># ç›´æ¥ä»é¢„è®¾çš„æ•°æ®é›†é…ç½®ä¸­è¯»å–æ‰€éœ€çš„æ•°æ®é›†é…ç½®</span><br>    <span class="hljs-keyword">from</span> .datasets.winograd.winograd_ppl <span class="hljs-keyword">import</span> winograd_datasets  <span class="hljs-comment"># è¯»å– Winograd é…ç½®ï¼ŒåŸºäº PPLï¼ˆå›°æƒ‘åº¦ï¼‰è¿›è¡Œè¯„ä¼°</span><br>    <span class="hljs-keyword">from</span> .datasets.siqa.siqa_gen <span class="hljs-keyword">import</span> siqa_datasets  <span class="hljs-comment"># è¯»å– SIQA é…ç½®ï¼ŒåŸºäºç”Ÿæˆè¿›è¡Œè¯„ä¼°</span><br><br>datasets = [*siqa_datasets, *winograd_datasets]       <span class="hljs-comment"># æœ€ç»ˆçš„é…ç½®éœ€è¦åŒ…å«æ‰€éœ€çš„è¯„ä¼°æ•°æ®é›†åˆ—è¡¨ &#x27;datasets&#x27;</span><br></code></pre></td></tr></table></figure>
<p>æ•°æ®é›†é…ç½®é€šå¸¸æœ‰ä¸¤ç§ç±»å‹ï¼šâ€™pplâ€™ å’Œ â€˜genâ€™ï¼Œåˆ†åˆ«æŒ‡ç¤ºä½¿ç”¨çš„è¯„ä¼°æ–¹æ³•ã€‚å…¶ä¸­ <code>ppl</code> è¡¨ç¤ºè¾¨åˆ«æ€§è¯„ä¼°ï¼Œ<code>gen</code> è¡¨ç¤ºç”Ÿæˆæ€§è¯„ä¼°ã€‚</p>
<p>æ­¤å¤–ï¼Œ<a href="https://github.com/open-compass/opencompass/blob/main/configs/datasets/collections">configs/datasets/collections</a> æ”¶å½•äº†å„ç§æ•°æ®é›†é›†åˆï¼Œæ–¹ä¾¿è¿›è¡Œç»¼åˆè¯„ä¼°ã€‚OpenCompass é€šå¸¸ä½¿ç”¨ <a href="https://github.com/open-compass/opencompass/blob/main/configs/datasets/collections/base_medium.py"><code>base_medium.py</code></a> è¿›è¡Œå…¨é¢çš„æ¨¡å‹æµ‹è¯•ã€‚è¦å¤åˆ¶ç»“æœï¼Œåªéœ€å¯¼å…¥è¯¥æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python run.py --models hf_llama_7b --datasets base_medium<br></code></pre></td></tr></table></figure>
<p>OpenCompass é€šå¸¸å‡å®šè¿è¡Œç¯å¢ƒç½‘ç»œæ˜¯å¯ç”¨çš„ã€‚å¦‚æœæ‚¨é‡åˆ°ç½‘ç»œé—®é¢˜æˆ–å¸Œæœ›åœ¨ç¦»çº¿ç¯å¢ƒä¸­è¿è¡Œ OpenCompassï¼Œè¯·å‚é˜… <a href="https://opencompass.readthedocs.io/zh-cn/latest/get_started/faq.html">FAQ - ç½‘ç»œ - Q1</a> å¯»æ±‚è§£å†³æ–¹æ¡ˆã€‚</p>
<h2 id="å¯è§†åŒ–è¯„ä¼°ç»“æœ"><a href="#å¯è§†åŒ–è¯„ä¼°ç»“æœ" class="headerlink" title="å¯è§†åŒ–è¯„ä¼°ç»“æœ"></a>å¯è§†åŒ–è¯„ä¼°ç»“æœ</h2><p>è¯„ä¼°å®Œæˆåï¼Œè¯„ä¼°ç»“æœè¡¨æ ¼å°†æ‰“å°å¦‚ä¸‹ï¼š</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">dataset    version    metric    mode      opt350m    opt125m<br>---------  ---------  --------  ------  ---------  ---------<br>siqa       e78df3     accuracy  gen         21.55      12.44<br>winograd   b6c7ed     accuracy  ppl         51.23      49.82<br></code></pre></td></tr></table></figure>
<p>æ‰€æœ‰è¿è¡Œè¾“å‡ºå°†å®šå‘åˆ° <code>outputs/demo/</code> ç›®å½•ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">outputs/default/<br>â”œâ”€â”€ 20200220_120000<br>â”œâ”€â”€ 20230220_183030     # æ¯ä¸ªå®éªŒä¸€ä¸ªæ–‡ä»¶å¤¹<br>â”‚   â”œâ”€â”€ configs         # ç”¨äºè®°å½•çš„å·²è½¬å‚¨çš„é…ç½®æ–‡ä»¶ã€‚å¦‚æœåœ¨åŒä¸€ä¸ªå®éªŒæ–‡ä»¶å¤¹ä¸­é‡æ–°è¿è¡Œäº†ä¸åŒçš„å®éªŒï¼Œå¯èƒ½ä¼šä¿ç•™å¤šä¸ªé…ç½®<br>â”‚   â”œâ”€â”€ logs            # æ¨ç†å’Œè¯„ä¼°é˜¶æ®µçš„æ—¥å¿—æ–‡ä»¶<br>â”‚   â”‚   â”œâ”€â”€ eval<br>â”‚   â”‚   â””â”€â”€ infer<br>â”‚   â”œâ”€â”€ predictions   # æ¯ä¸ªä»»åŠ¡çš„æ¨ç†ç»“æœ<br>â”‚   â”œâ”€â”€ results       # æ¯ä¸ªä»»åŠ¡çš„è¯„ä¼°ç»“æœ<br>â”‚   â””â”€â”€ summary       # å•ä¸ªå®éªŒçš„æ±‡æ€»è¯„ä¼°ç»“æœ<br>â”œâ”€â”€ ...<br></code></pre></td></tr></table></figure>
<p>æ‰“å°è¯„æµ‹ç»“æœçš„è¿‡ç¨‹å¯è¢«è¿›ä¸€æ­¥å®šåˆ¶åŒ–ï¼Œç”¨äºè¾“å‡ºä¸€äº›æ•°æ®é›†çš„å¹³å‡åˆ† (ä¾‹å¦‚ MMLU, C-Eval ç­‰)ã€‚</p>
<p>å…³äºè¯„æµ‹ç»“æœè¾“å‡ºçš„æ›´å¤šä»‹ç»å¯é˜…è¯» <a href="../user_guides/summarizer.md">ç»“æœå±•ç¤º</a>ã€‚</p>
<h2 id="æ›´å¤šæ•™ç¨‹"><a href="#æ›´å¤šæ•™ç¨‹" class="headerlink" title="æ›´å¤šæ•™ç¨‹"></a>æ›´å¤šæ•™ç¨‹</h2><p>æƒ³è¦æ›´å¤šäº†è§£ OpenCompass, å¯ä»¥ç‚¹å‡»ä¸‹åˆ—é“¾æ¥å­¦ä¹ ã€‚</p>
<ul>
<li><a href="https://opencompass.readthedocs.io/zh-cn/latest/">https://opencompass.readthedocs.io/zh-cn/latest/</a></li>
</ul>
<h2 id="ä½œä¸š"><a href="#ä½œä¸š" class="headerlink" title="ä½œä¸š"></a>ä½œä¸š</h2><h3 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºç¯å¢ƒ</span><br>conda create --name opencompass --<span class="hljs-built_in">clone</span>=/root/share/conda_envs/internlm-base<br>conda activate opencompass<br><span class="hljs-comment"># ä½¿ç”¨é•œåƒ clone</span><br>git <span class="hljs-built_in">clone</span> https://mirror.ghproxy.com/https://github.com/open-compass/opencompass<br><span class="hljs-built_in">cd</span> opencompass<br>pip install -e .<br></code></pre></td></tr></table></figure>
<h3 id="å‡†å¤‡æ•°æ®"><a href="#å‡†å¤‡æ•°æ®" class="headerlink" title="å‡†å¤‡æ•°æ®"></a>å‡†å¤‡æ•°æ®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> /share/temp/datasets/OpenCompassData-core-20231110.zip /root/opencompass/<br><span class="hljs-built_in">cd</span> /root/opencompass/<br>unzip OpenCompassData-core-20231110.zip<br></code></pre></td></tr></table></figure>
<p><img  src="unzip.png"  ><span class="image-caption">è§£å‹æ•°æ®</span></p>
<h3 id="æŸ¥çœ‹æ”¯æŒçš„æ•°æ®é›†å’Œæ¨¡å‹-1"><a href="#æŸ¥çœ‹æ”¯æŒçš„æ•°æ®é›†å’Œæ¨¡å‹-1" class="headerlink" title="æŸ¥çœ‹æ”¯æŒçš„æ•°æ®é›†å’Œæ¨¡å‹"></a>æŸ¥çœ‹æ”¯æŒçš„æ•°æ®é›†å’Œæ¨¡å‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python tools/list_configs.py internlm ceval<br></code></pre></td></tr></table></figure>
<p><img  src="list.png"  ><span class="image-caption">åˆ—å‡ºæ‰€æœ‰è·Ÿ internlm åŠ ceval ç›¸å…³çš„é…ç½®</span></p>
<h3 id="å¯åŠ¨è¯„æµ‹-1"><a href="#å¯åŠ¨è¯„æµ‹-1" class="headerlink" title="å¯åŠ¨è¯„æµ‹"></a>å¯åŠ¨è¯„æµ‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python run.py \<br>--datasets ceval_gen \<br>--hf-path /share/model_repos/internlm2-chat-7b/ \  <span class="hljs-comment"># HuggingFace æ¨¡å‹è·¯å¾„</span><br>--tokenizer-path /share/model_repos/internlm2-chat-7b/ \  <span class="hljs-comment"># æ³¨æ„è¿™é‡Œæ˜¯ internlm2</span><br>--tokenizer-kwargs padding_side=<span class="hljs-string">&#x27;left&#x27;</span> truncation=<span class="hljs-string">&#x27;left&#x27;</span> trust_remote_code=True \  <span class="hljs-comment"># æ„å»º tokenizer çš„å‚æ•°</span><br>--model-kwargs device_map=<span class="hljs-string">&#x27;auto&#x27;</span> trust_remote_code=True \  <span class="hljs-comment"># æ„å»ºæ¨¡å‹çš„å‚æ•°</span><br>--max-seq-len 2048 \  <span class="hljs-comment"># æ¨¡å‹å¯ä»¥æ¥å—çš„æœ€å¤§åºåˆ—é•¿åº¦</span><br>--max-out-len 16 \  <span class="hljs-comment"># ç”Ÿæˆçš„æœ€å¤§ token æ•°</span><br>--batch-size 2  \  <span class="hljs-comment"># æ‰¹é‡å¤§å°</span><br>--num-gpus 1 \ <span class="hljs-comment"># è¿è¡Œæ¨¡å‹æ‰€éœ€çš„ GPU æ•°é‡</span><br>--debug<br></code></pre></td></tr></table></figure>
<p>ä¾¿äºå¤åˆ¶ç‰ˆï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python run.py \<br>--datasets ceval_gen \<br>--hf-path /share/model_repos/internlm2-chat-7b/ \<br>--tokenizer-path /share/model_repos/internlm2-chat-7b/ \<br>--tokenizer-kwargs padding_side=<span class="hljs-string">&#x27;left&#x27;</span> truncation=<span class="hljs-string">&#x27;left&#x27;</span> trust_remote_code=True \<br>--model-kwargs device_map=<span class="hljs-string">&#x27;auto&#x27;</span> trust_remote_code=True \<br>--max-seq-len 2048 \<br>--max-out-len 16 \<br>--batch-size 2  \<br>--num-gpus 1 \<br>--debug<br></code></pre></td></tr></table></figure>
<p>å‘ç°æ˜¾å­˜ä¸å¤Ÿç”¨ï¼Œå°è¯•æ”¹å° batch size ä¸º 1ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python run.py \<br>--datasets ceval_gen \<br>--hf-path /share/model_repos/internlm2-chat-7b/ \<br>--tokenizer-path /share/model_repos/internlm2-chat-7b/ \<br>--tokenizer-kwargs padding_side=<span class="hljs-string">&#x27;left&#x27;</span> truncation=<span class="hljs-string">&#x27;left&#x27;</span> trust_remote_code=True \<br>--model-kwargs device_map=<span class="hljs-string">&#x27;auto&#x27;</span> trust_remote_code=True \<br>--max-seq-len 2048 \<br>--max-out-len 16 \<br>--batch-size 1  \<br>--num-gpus 1 \<br>--debug<br></code></pre></td></tr></table></figure>
<p><img  src="run.png"  ><span class="image-caption">è¿è¡Œæˆªå›¾</span></p>
<p><img  src="result.png"  ><span class="image-caption">è¯„æµ‹ç»“æœ</span></p>
<h2 id="è¿›é˜¶ä½œä¸š"><a href="#è¿›é˜¶ä½œä¸š" class="headerlink" title="è¿›é˜¶ä½œä¸š"></a>è¿›é˜¶ä½œä¸š</h2><p>å®‰è£… lmdeployï¼Œè¿™ä¸€æ­¥æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™æ— æ³•åŠ è½½ TurboMind æ¨¡å‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip install lmdeploy==0.2.0<br></code></pre></td></tr></table></figure>
<p>ç¼–å†™ config æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> mmengine.config <span class="hljs-keyword">import</span> read_base<br><span class="hljs-keyword">from</span> opencompass.models.turbomind <span class="hljs-keyword">import</span> TurboMindModel<br><br><span class="hljs-keyword">with</span> read_base():<br>    <span class="hljs-comment"># choose a list of datasets</span><br>    <span class="hljs-keyword">from</span> .datasets.ceval.ceval_gen_5f30c7 <span class="hljs-keyword">import</span> ceval_datasets<br><br><br>datasets = [*ceval_datasets]<br><br>internlm_meta_template = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">round</span>=[<br>    <span class="hljs-built_in">dict</span>(role=<span class="hljs-string">&#x27;HUMAN&#x27;</span>, begin=<span class="hljs-string">&#x27;&lt;|User|&gt;:&#x27;</span>, end=<span class="hljs-string">&#x27;\n&#x27;</span>),<br>    <span class="hljs-built_in">dict</span>(role=<span class="hljs-string">&#x27;BOT&#x27;</span>, begin=<span class="hljs-string">&#x27;&lt;|Bot|&gt;:&#x27;</span>, end=<span class="hljs-string">&#x27;&lt;eoa&gt;\n&#x27;</span>, generate=<span class="hljs-literal">True</span>),<br>],<br>                              eos_token_id=<span class="hljs-number">103028</span>)<br><br><span class="hljs-comment"># config for internlm-chat-7b</span><br>internlm_chat_7b = <span class="hljs-built_in">dict</span>(<br>    <span class="hljs-built_in">type</span>=TurboMindModel,<br>    abbr=<span class="hljs-string">&#x27;internlm-chat-7b&#x27;</span>,<br>    path=<span class="hljs-string">&#x27;/root/workspace_quant_awq4&#x27;</span>, <span class="hljs-comment"># è¿™é‡Œçš„ path æ˜¯ä¸Šä¸€èŠ‚è¯¾ä¸­çš„ awq æ¨¡å‹</span><br>    engine_config=<span class="hljs-built_in">dict</span>(session_len=<span class="hljs-number">2048</span>,<br>                       max_batch_size=<span class="hljs-number">32</span>,<br>                       rope_scaling_factor=<span class="hljs-number">1.0</span>),<br>    gen_config=<span class="hljs-built_in">dict</span>(top_k=<span class="hljs-number">1</span>,<br>                    top_p=<span class="hljs-number">0.8</span>,<br>                    temperature=<span class="hljs-number">1.0</span>,<br>                    max_new_tokens=<span class="hljs-number">100</span>),<br>    max_out_len=<span class="hljs-number">100</span>,<br>    max_seq_len=<span class="hljs-number">1024</span>,<br>    batch_size=<span class="hljs-number">2</span>,<br>    concurrency=<span class="hljs-number">32</span>,<br>    meta_template=internlm_meta_template,<br>    run_cfg=<span class="hljs-built_in">dict</span>(num_gpus=<span class="hljs-number">1</span>, num_procs=<span class="hljs-number">1</span>),<br>)<br><br>models = [internlm_chat_7b]<br></code></pre></td></tr></table></figure>
<p>è¿è¡Œè¯„æµ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python run.py configs/eval_internlm_my_deploy.py --debug<br></code></pre></td></tr></table></figure>
<p><img  src="awq.png"  ><span class="image-caption">åŠ è½½é‡åŒ–åçš„æ¨¡å‹</span></p>
<p><img  src="result-internlm-awq.png"  ><span class="image-caption">è¯„åˆ¤ internlm-awq</span></p>
<p>å¯è§ internlm-AWQ åœ¨ ceval ä¸Šçš„å¾—åˆ†å¹¶ä¸å¦‚ internlm2ã€‚</p>
<h3 id="ä½¿ç”¨-lmdeploy-0-2-0-è½¬æ¢-internlm2-ä¸º-awq-æ¨¡å‹å¹¶è¿›è¡Œè¯„æµ‹"><a href="#ä½¿ç”¨-lmdeploy-0-2-0-è½¬æ¢-internlm2-ä¸º-awq-æ¨¡å‹å¹¶è¿›è¡Œè¯„æµ‹" class="headerlink" title="ä½¿ç”¨ lmdeploy 0.2.0 è½¬æ¢ internlm2 ä¸º awq æ¨¡å‹å¹¶è¿›è¡Œè¯„æµ‹"></a>ä½¿ç”¨ lmdeploy 0.2.0 è½¬æ¢ internlm2 ä¸º awq æ¨¡å‹å¹¶è¿›è¡Œè¯„æµ‹</h3><p>ä½¿ç”¨ lmdeploy 0.2 çš„æ—¶å€™ä¸ 0.1 ç‰ˆæœ¬è¿›è¡Œ AWQ é‡åŒ–çš„æ–¹å¼ç•¥æœ‰ä¸åŒï¼ŒåŒæ—¶è¦ä» huggingface ä¸Šä¸‹è½½æµ‹è¯•æ•°æ®é›†ï¼Œæ‰€ä»¥å›½å†…å¯ä»¥ä½¿ç”¨é•œåƒï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> HF_ENDPOINT=https://hf-mirror.com<br>lmdeploy lite auto_awq /root/share/model_repos/internlm2-chat-7b  --work-dir internlm2-chat-7b-4bit<br></code></pre></td></tr></table></figure>
<p>ä¹‹åå¯¹æ¨¡å‹è¿›è¡Œè½¬åŒ–ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lmdeploy convert  internlm2-chat-7b ./internlm2-chat-7b-4bit/ --model-format awq --group-size 128  --dst-path  ./workspace_awq_internlm2<br></code></pre></td></tr></table></figure>
<p><img  src="convert.png"  ><span class="image-caption">è½¬æ¢æ¨¡å‹</span></p>
<p>ä¹‹åç¼–å†™æ–°çš„ config.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> mmengine.config <span class="hljs-keyword">import</span> read_base<br><span class="hljs-keyword">from</span> opencompass.models.turbomind <span class="hljs-keyword">import</span> TurboMindModel<br><br><span class="hljs-keyword">with</span> read_base():<br>    <span class="hljs-comment"># choose a list of datasets</span><br>    <span class="hljs-keyword">from</span> .datasets.ceval.ceval_gen_5f30c7 <span class="hljs-keyword">import</span> ceval_datasets<br><br><br>datasets = [*ceval_datasets]<br><br>internlm_meta_template = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">round</span>=[<br>    <span class="hljs-built_in">dict</span>(role=<span class="hljs-string">&#x27;HUMAN&#x27;</span>, begin=<span class="hljs-string">&#x27;&lt;|User|&gt;:&#x27;</span>, end=<span class="hljs-string">&#x27;\n&#x27;</span>),<br>    <span class="hljs-built_in">dict</span>(role=<span class="hljs-string">&#x27;BOT&#x27;</span>, begin=<span class="hljs-string">&#x27;&lt;|Bot|&gt;:&#x27;</span>, end=<span class="hljs-string">&#x27;&lt;eoa&gt;\n&#x27;</span>, generate=<span class="hljs-literal">True</span>),<br>],<br>                              eos_token_id=<span class="hljs-number">103028</span>)<br><br><span class="hljs-comment"># config for internlm2-chat-7b-awq</span><br>internlm2_chat_7b = <span class="hljs-built_in">dict</span>(<br>    <span class="hljs-built_in">type</span>=TurboMindModel,<br>    abbr=<span class="hljs-string">&#x27;internlm-chat-7b&#x27;</span>,<br>    path=<span class="hljs-string">&#x27;/root/workspace_awq_internlm2&#x27;</span>,<br>    engine_config=<span class="hljs-built_in">dict</span>(session_len=<span class="hljs-number">2048</span>,<br>                       max_batch_size=<span class="hljs-number">32</span>,<br>                       rope_scaling_factor=<span class="hljs-number">1.0</span>),<br>    gen_config=<span class="hljs-built_in">dict</span>(top_k=<span class="hljs-number">1</span>,<br>                    top_p=<span class="hljs-number">0.8</span>,<br>                    temperature=<span class="hljs-number">1.0</span>,<br>                    max_new_tokens=<span class="hljs-number">100</span>),<br>    max_out_len=<span class="hljs-number">100</span>,<br>    max_seq_len=<span class="hljs-number">1024</span>,<br>    batch_size=<span class="hljs-number">2</span>,<br>    concurrency=<span class="hljs-number">32</span>,<br>    meta_template=internlm_meta_template,<br>    run_cfg=<span class="hljs-built_in">dict</span>(num_gpus=<span class="hljs-number">1</span>, num_procs=<span class="hljs-number">1</span>),<br>)<br><br>models = [internlm2_chat_7b]<br></code></pre></td></tr></table></figure>
<p>è¿›è¡Œè¯„æµ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">python run.py configs/eval_internlm2_my_deploy.py --debug<br></code></pre></td></tr></table></figure>
<p><img  src="awq-result.png"  ><span class="image-caption">AWQ é‡åŒ–è¯„æµ‹</span></p>
<p>èƒ½å¤Ÿå‘ç° AWQ é‡åŒ–åçš„æ¨¡å‹åœ¨ ceval æ•°æ®é›†ä¸Šçš„å¾—åˆ†æ¯”åŸæ¨¡å‹è¦å¥½ã€‚ç²¾åº¦ä¸ä»…æ²¡æœ‰æ˜æ˜¾ä¸‹é™ï¼Œç›¸ååœ¨ä¸å°‘ä»»åŠ¡ä¸Šè¿˜æœ‰ä¸€å®šçš„æå‡ã€‚å¯èƒ½å¾—åŸå› æ˜¯ï¼Œé‡åŒ–ä¼šå¯¼è‡´ä¸€å®šçš„è¯¯å·®ï¼Œæœ‰æ—¶å€™è¿™ç§è¯¯å·®å¯èƒ½ä¼šå‡å°‘æ¨¡å‹å¯¹è®­ç»ƒæ•°æ®çš„æ‹Ÿåˆï¼Œä»è€Œæé«˜æ³›åŒ–æ€§èƒ½ã€‚é‡åŒ–å¯ä»¥è¢«è§†ä¸ºå¼•å…¥è½»å¾®å™ªå£°çš„æ­£åˆ™åŒ–æ–¹æ³•ã€‚æˆ–è€…ï¼Œä¹Ÿæœ‰å¯èƒ½é‡åŒ–åçš„æ¨¡å‹æ­£å¥½å¯¹æŸäº›æ•°æ®é›†å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</p>
]]></content>
      <categories>
        <category>internlm</category>
      </categories>
  </entry>
  <entry>
    <title>ç®—æ³•æ•´ç†</title>
    <url>/uncategorized/leetcode/</url>
    <content><![CDATA[<h1 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h1><h2 id="rust-ä¸­-dbg-è¶…æ—¶"><a href="#rust-ä¸­-dbg-è¶…æ—¶" class="headerlink" title="rust ä¸­ dbg! è¶…æ—¶"></a><code>rust</code> ä¸­ <code>dbg!</code> è¶…æ—¶</h2><p>åœ¨ <code>rust</code> ä¸­ä½¿ç”¨ <code>dbg!</code> çš„æ—¶å€™ï¼Œåœ¨é¢˜ç›®åˆ¤å®šæ—¶ï¼Œå¯èƒ½ä¼šå› ä¸º <code>dbg!</code> è¶…æ—¶ï¼Œæäº¤ä»£ç çš„æ—¶å€™è¦å»æ‰ <code>dbg!</code></p>
<h1 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h1><h2 id="åŒæŒ‡é’ˆ"><a href="#åŒæŒ‡é’ˆ" class="headerlink" title="åŒæŒ‡é’ˆ"></a>åŒæŒ‡é’ˆ</h2><p>ç¬¬ 27ã€977 é¢˜å°±æ˜¯ç»å…¸çš„åŒæŒ‡é’ˆé¢˜ç›®ã€‚</p>
<h2 id="æ»‘åŠ¨çª—å£"><a href="#æ»‘åŠ¨çª—å£" class="headerlink" title="æ»‘åŠ¨çª—å£"></a>æ»‘åŠ¨çª—å£</h2><p>æ³¨æ„ï¼Œä½¿ç”¨æ»‘åŠ¨çª—å£çš„æ—¶å€™ï¼Œfor å¾ªç¯ä»£è¡¨æ»‘åŠ¨çª—å£çš„ç»“å°¾ï¼Œå¦åˆ™åˆä¼šé™·å…¥ä¸¤ä¸ª for çš„å›°å¢ƒã€‚</p>
<h1 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h1><p>é“¾è¡¨å¯¹äºæœ‰æ’å…¥ã€äº¤æ¢æˆ–è€…åˆ é™¤çš„æ“ä½œçš„æ—¶å€™ï¼Œä¸€èˆ¬åŠ ä¸€ä¸ªè™šæ‹Ÿå¤´èŠ‚ç‚¹æ›´å¥½å¤„ç†ã€‚</p>
<h2 id="åŒæŒ‡é’ˆ-1"><a href="#åŒæŒ‡é’ˆ-1" class="headerlink" title="åŒæŒ‡é’ˆ"></a>åŒæŒ‡é’ˆ</h2><p>ç»å…¸çš„ä¸€ä¸ª pre æŒ‡é’ˆï¼Œä¸€ä¸ª cur æŒ‡é’ˆï¼šå¯ä»¥è§£å†³åè½¬é“¾è¡¨ã€äº¤æ¢èŠ‚ç‚¹ç­‰é—®é¢˜ã€‚<br>è¿˜æœ‰ä¸€ä¸ª fast æŒ‡é’ˆï¼Œä¸€ä¸ª slow æŒ‡é’ˆï¼šå¯ä»¥è§£å†³åˆ é™¤ç¬¬ n ä¸ªå…ƒç´ çš„é—®é¢˜ã€‚</p>
<h1 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h1><h2 id="æœ€é•¿å…¬å…±å­ä¸²"><a href="#æœ€é•¿å…¬å…±å­ä¸²" class="headerlink" title="æœ€é•¿å…¬å…±å­ä¸²"></a>æœ€é•¿å…¬å…±å­ä¸²</h2><p>çŠ¶æ€è½¬ç§»æ–¹ç¨‹å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
d p[i][j]=\left\{\begin{array}{l}
d p[i-1][j-1]+1, \text { å½“ä¸”ä»…å½“ } x[i]=y[j] \\
0, \text { å½“ } x[i] \ne y[j]
\end{array}\right.</script><p>æŒ‰ç…§ä¸Šé¢æ–¹ç¨‹å®ç°çš„ç®—æ³•æ—¶é—´å¤æ‚åº¦ä¸º $O(n^2)$ï¼Œç©ºé—´å¤æ‚åº¦ä¸º $O(n^2)$ã€‚</p>
<p><img  src="../leetcode/d6f0b0e17ed6e13f5c042d172b1ddca782cb6aba589f5fcfea8944831614502f-image.png"  ><span class="image-caption">image.png</span></p>
<p>æ³¨æ„åˆ°ï¼Œæ›´æ–° $dp[i][j]$ åªéœ€è¦ä¸Šä¸€åˆ—ï¼Œå³ $dp[i-1]$ åˆ—ï¼Œæ‰€ä»¥å¯ä»¥å°†ç©ºé—´å¤æ‚åº¦é™ä½ä¸º $O(n)$ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„å› ä¸ºä½¿ç”¨çš„æ˜¯ç›¸åŒçš„æ•°ç»„åˆ—ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²ä¸ç›¸ç­‰æ—¶éœ€è¦è®¾ç½® $dp[j] = 0$ï¼ŒåŒæ—¶è¦æ³¨æ„ä»åå‘å‰æ›´æ–°æ•°ç»„ï¼Œå› ä¸ºå¦‚æœä»å‰å‘åæ›´æ–°ï¼Œé‚£ä¹ˆå½“å‰çš„ $dp[j]$ ä½¿ç”¨çš„æ˜¯å½“å‰åˆ—åˆšåˆšæ›´æ–°è¿‡çš„æ•°æ®ï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸Šä¸€åˆ—çš„æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥ä»åå‘å‰æ›´æ–°æ•°æ®é¿å…è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>rust ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">dp</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; s2.<span class="hljs-title function_ invoke__">len</span>()];<br><span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..s1.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>    <span class="hljs-comment">// é€†åºè¿­ä»£æ˜¯å› ä¸ºæ›´æ–°a[i][j]éœ€è¦a[i-1][j-1]</span><br>    <span class="hljs-comment">// ç°åœ¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥ a[j] æ˜¯åŸæ¥çš„ a[i][j]ï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ a[i-1][j]</span><br>    <span class="hljs-comment">// æ‰€ä»¥ä»åå‘å‰è¿­ä»£ï¼Œa[j] æ˜¯åŸæ¥çš„ a[i-1][j]</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">j</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span>..s2.<span class="hljs-title function_ invoke__">len</span>()).<span class="hljs-title function_ invoke__">s2</span>() &#123;<br>        <span class="hljs-keyword">if</span> s[i] == s2[j] &#123;<br>            <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> || j == <span class="hljs-number">0</span> &#123;<br>                dp[j] = <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dp[j] = dp[j - <span class="hljs-number">1</span>] + <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> dp[j] &gt; max_len &#123;<br>                <span class="hljs-keyword">let</span> <span class="hljs-variable">before_s2</span> = s2.<span class="hljs-title function_ invoke__">len</span>() - <span class="hljs-number">1</span> - j;<br>                <span class="hljs-keyword">if</span> before_s2 + dp[j] - <span class="hljs-number">1</span> == i &#123;<br>                    max_len = dp[j];<br>                    max_end = i;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// ä¸ä¹‹å‰ä¸åŒï¼Œä¹‹å‰ä½¿ç”¨çš„æ˜¯ä¸åŒçš„åˆ—ï¼Œæ‰€ä»¥ä¸éœ€è¦ç½®0</span><br>            dp[j] = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="æœ€é•¿å›æ–‡å­ä¸²"><a href="#æœ€é•¿å›æ–‡å­ä¸²" class="headerlink" title="æœ€é•¿å›æ–‡å­ä¸²"></a>æœ€é•¿å›æ–‡å­ä¸²</h2><h3 id="åŠ¨æ€è§„åˆ’"><a href="#åŠ¨æ€è§„åˆ’" class="headerlink" title="åŠ¨æ€è§„åˆ’"></a>åŠ¨æ€è§„åˆ’</h3><p>å°†å­—ç¬¦ä¸²å€’ç½®ä¹‹åæ±‚æœ€é•¿å…¬å…±å­ä¸²ï¼ˆçŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸æœ€é•¿å…¬å…±å­ä¸²ç›¸åŒï¼‰ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦ä¸ºå›æ–‡å­ä¸²ï¼Œè¿™é‡Œå›æ–‡å­ä¸²ã€Œç”±å€’ç½®å­—ç¬¦ä¸²æ¨å‡ºçš„åŸå­—ç¬¦ä¸²æœ«å°¾ä¸‹æ ‡ã€ä¸ã€Œiã€åº”è¯¥ç›¸ç­‰ã€‚</p>
<p>ä»£ç ä¸­ <code>longest_palindrome1</code> çš„æ±‚æœ€é•¿å…¬å…±å­ä¸²ç©ºé—´å¤æ‚åº¦ä¸º $O(n^2)$ï¼Œ<code>longest_palindrome2</code> çš„æ±‚æœ€é•¿å…¬å…±å­ä¸²ç©ºé—´å¤æ‚åº¦ä¸º $O(n)$ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Solution</span>;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">longest_palindrome1</span>(s: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;<br>        <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">len</span>() &lt;= <span class="hljs-number">1</span> &#123;<br>            <span class="hljs-keyword">return</span> s;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">rev</span>: <span class="hljs-type">String</span> = s.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">rev</span>().<span class="hljs-title function_ invoke__">collect</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">rev</span> = rev.<span class="hljs-title function_ invoke__">as_bytes</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = s.<span class="hljs-title function_ invoke__">as_bytes</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">dp</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; rev.<span class="hljs-title function_ invoke__">len</span>()]; s.<span class="hljs-title function_ invoke__">len</span>()];<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">max_len</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">max_end</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..s.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>            <span class="hljs-keyword">for</span> <span class="hljs-variable">j</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..rev.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>                <span class="hljs-keyword">if</span> s[i] == rev[j] &#123;<br>                    <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> || j == <span class="hljs-number">0</span> &#123;<br>                        dp[i][j] = <span class="hljs-number">1</span>;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j - <span class="hljs-number">1</span>] + <span class="hljs-number">1</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> dp[i][j] &gt; max_len &#123;<br>                    <span class="hljs-comment">// å¦‚æœæ˜¯å›æ–‡ä¸²ï¼Œé‚£ä¹ˆã€Œç”±å€’ç½®å­—ç¬¦ä¸²æ¨å‡ºçš„åŸå­—ç¬¦ä¸²æœ«å°¾ä¸‹æ ‡ã€ä¸ã€Œiã€åº”è¯¥ç›¸ç­‰</span><br>                    <span class="hljs-comment">// å…¶ä¸­ï¼Œå€’ç½®å­—ç¬¦ä¸²çš„ rev.len() - 1 - jï¼Œä¹Ÿå°±æ˜¯å€’ç½®ä¹‹å‰çš„å¼€å§‹ä¸‹æ ‡ï¼Œå‡ä¸€æ˜¯å› ä¸ºé•¿åº¦æ¯”ä¸‹æ ‡å¤šä¸€</span><br>                    <span class="hljs-comment">// å†åŠ ä¸Š dp[i][j] - 1ï¼Œå°±æ˜¯åŸå­—ç¬¦ä¸²çš„æœ«å°¾ä¸‹æ ‡ã€‚abcï¼Œaçš„ä¸‹æ ‡ä¸º0ï¼Œé•¿åº¦ä¸º3ï¼Œ0+3ä¸º3ï¼Œä½†æ˜¯æœ€å¤§ä¸‹æ ‡ä¸º2ï¼Œæ‰€ä»¥éœ€è¦å‡ä¸€</span><br>                    <span class="hljs-keyword">let</span> <span class="hljs-variable">before_rev</span> = rev.<span class="hljs-title function_ invoke__">len</span>() - <span class="hljs-number">1</span> - j;<br>                    <span class="hljs-keyword">if</span> before_rev + dp[i][j] - <span class="hljs-number">1</span> == i &#123;<br>                        max_len = dp[i][j];<br>                        max_end = i;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(&amp;s[max_end + <span class="hljs-number">1</span> - max_len..max_end + <span class="hljs-number">1</span>])<br>            .<span class="hljs-title function_ invoke__">unwrap</span>()<br>            .<span class="hljs-title function_ invoke__">to_string</span>()<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">longest_palindrome2</span>(s: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;<br>        <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">len</span>() &lt; <span class="hljs-number">1</span> &#123;<br>            <span class="hljs-keyword">return</span> s;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">rev</span>: <span class="hljs-type">String</span> = s.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">rev</span>().<span class="hljs-title function_ invoke__">collect</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = s.<span class="hljs-title function_ invoke__">as_bytes</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">rev</span> = rev.<span class="hljs-title function_ invoke__">as_bytes</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">max_len</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">max_end</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">dp</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; rev.<span class="hljs-title function_ invoke__">len</span>()];<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..s.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>            <span class="hljs-comment">// é€†åºè¿­ä»£æ˜¯å› ä¸ºæ›´æ–°a[i][j]éœ€è¦a[i-1][j-1]</span><br>            <span class="hljs-comment">// ç°åœ¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥ a[j] æ˜¯åŸæ¥çš„ a[i][j]ï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ a[i-1][j]</span><br>            <span class="hljs-comment">// æ‰€ä»¥ä»åå‘å‰è¿­ä»£ï¼Œa[j] æ˜¯åŸæ¥çš„ a[i-1][j]</span><br>            <span class="hljs-keyword">for</span> <span class="hljs-variable">j</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span>..rev.<span class="hljs-title function_ invoke__">len</span>()).<span class="hljs-title function_ invoke__">rev</span>() &#123;<br>                <span class="hljs-keyword">if</span> s[i] == rev[j] &#123;<br>                    <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> || j == <span class="hljs-number">0</span> &#123;<br>                        dp[j] = <span class="hljs-number">1</span>;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        dp[j] = dp[j - <span class="hljs-number">1</span>] + <span class="hljs-number">1</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> dp[j] &gt; max_len &#123;<br>                        <span class="hljs-keyword">let</span> <span class="hljs-variable">before_rev</span> = rev.<span class="hljs-title function_ invoke__">len</span>() - <span class="hljs-number">1</span> - j;<br>                        <span class="hljs-keyword">if</span> before_rev + dp[j] - <span class="hljs-number">1</span> == i &#123;<br>                            max_len = dp[j];<br>                            max_end = i;<br>                        &#125;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// ä¸ä¹‹å‰ä¸åŒï¼Œä¹‹å‰ä½¿ç”¨çš„æ˜¯ä¸åŒçš„åˆ—ï¼Œæ‰€ä»¥ä¸éœ€è¦ç½®0</span><br>                    dp[j] = <span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(&amp;s[max_end + <span class="hljs-number">1</span> - max_len..max_end + <span class="hljs-number">1</span>])<br>            .<span class="hljs-title function_ invoke__">unwrap</span>()<br>            .<span class="hljs-title function_ invoke__">to_string</span>()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="ä¸­å¿ƒæ‹“å±•ç®—æ³•"><a href="#ä¸­å¿ƒæ‹“å±•ç®—æ³•" class="headerlink" title="ä¸­å¿ƒæ‹“å±•ç®—æ³•"></a>ä¸­å¿ƒæ‹“å±•ç®—æ³•</h3><p>ä¸ºäº†é¿å…åœ¨ä¹‹åçš„å™è¿°ä¸­å‡ºç°æ­§ä¹‰ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡å‡ºä»€ä¹ˆæ˜¯â€œæœ´ç´ ç®—æ³•â€ã€‚</p>
<p>è¯¥ç®—æ³•é€šè¿‡ä¸‹è¿°æ–¹å¼å·¥ä½œï¼šå¯¹æ¯ä¸ªä¸­å¿ƒä½ç½® $i$ åœ¨æ¯”è¾ƒä¸€å¯¹å¯¹åº”å­—ç¬¦åï¼Œåªè¦å¯èƒ½ï¼Œè¯¥ç®—æ³•ä¾¿å°è¯•å°†ç­”æ¡ˆåŠ  $1$ã€‚</p>
<p>è¯¥ç®—æ³•æ˜¯æ¯”è¾ƒæ…¢çš„ï¼šå®ƒåªèƒ½åœ¨ $O(n^2)$ çš„æ—¶é—´å†…è®¡ç®—ç­”æ¡ˆã€‚</p>
<p>è¯¥ç®—æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// C++ Version</span><br><span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">d1</span><span class="hljs-params">(n)</span>, <span class="hljs-title">d2</span><span class="hljs-params">(n)</span></span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>  d1[i] = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span> &lt;= i - d1[i] &amp;&amp; i + d1[i] &lt; n &amp;&amp; s[i - d1[i]] == s[i + d1[i]]) &#123;<br>    d1[i]++;<br>  &#125;<br><br>  d2[i] = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span> &lt;= i - d2[i] - <span class="hljs-number">1</span> &amp;&amp; i + d2[i] &lt; n &amp;&amp;<br>         s[i - d2[i] - <span class="hljs-number">1</span>] == s[i + d2[i]]) &#123;<br>    d2[i]++;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Python Version</span><br>d1 = [<span class="hljs-number">0</span>] * n<br>d2 = [<span class="hljs-number">0</span>] * n<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, n):<br>    d1[i] = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-number">0</span> &lt;= i - d1[i] <span class="hljs-keyword">and</span> i + d1[i] &lt; n <span class="hljs-keyword">and</span> s[i - d1[i]] == s[i + d1[i]]:<br>        d1[i] += <span class="hljs-number">1</span><br><br>    d2[i] = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-number">0</span> &lt;= i - d2[i] - <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> i + d2[i] &lt; n <span class="hljs-keyword">and</span> s[i - d2[i] - <span class="hljs-number">1</span>] == s[i + d2[i]]:<br>        d2[i] += <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
<h3 id="Manacher-ç®—æ³•12"><a href="#Manacher-ç®—æ³•12" class="headerlink" title="Manacher ç®—æ³•12"></a>Manacher ç®—æ³•<sup><a href="#fn_1" id="reffn_1">1</a></sup><sup><a href="#fn_2" id="reffn_2">2</a></sup></h3><p>Manacher ç®—æ³•æ˜¯å¯¹ä¸­å¿ƒæ‹“å±•ç®—æ³•çš„ä¼˜åŒ–ï¼Œä¸ºäº†å¿«é€Ÿè®¡ç®—ï¼Œæˆ‘ä»¬ç»´æŠ¤å·²æ‰¾åˆ°çš„æœ€é å³çš„å­å›æ–‡ä¸²çš„ <strong>è¾¹ç•Œ $(l, r)$</strong>ï¼ˆå³å…·æœ‰æœ€å¤§ $r$ å€¼çš„å›æ–‡ä¸²ï¼Œå…¶ä¸­ $l$ å’Œ $r$ åˆ†åˆ«ä¸ºè¯¥å›æ–‡ä¸²å·¦å³è¾¹ç•Œçš„ä½ç½®ï¼‰ã€‚åˆå§‹æ—¶ï¼Œæˆ‘ä»¬ç½® $l = 0$ å’Œ $r = -1$ï¼ˆ<em>-1</em>éœ€åŒºåˆ«äºå€’åºç´¢å¼•ä½ç½®ï¼Œè¿™é‡Œå¯ä¸ºä»»æ„è´Ÿæ•°ï¼Œä»…ä¸ºäº†å¾ªç¯åˆå§‹æ—¶æ–¹ä¾¿ï¼‰ã€‚</p>
<p>ç°åœ¨å‡è®¾æˆ‘ä»¬è¦å¯¹ä¸‹ä¸€ä¸ª $i$ è®¡ç®— $P[i]$ï¼Œè€Œä¹‹å‰æ‰€æœ‰ $P[]$ ä¸­çš„å€¼å·²è®¡ç®—å®Œæ¯•ã€‚æˆ‘ä»¬å°†é€šè¿‡ä¸‹åˆ—æ–¹å¼è®¡ç®—ï¼š</p>
<ul>
<li><p>å¦‚æœ $i$ ä½äºå½“å‰å­å›æ–‡ä¸²ä¹‹å¤–ï¼Œå³ $i &gt; r$ï¼Œé‚£ä¹ˆæˆ‘ä»¬è°ƒç”¨æœ´ç´ ç®—æ³•ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å°†è¿ç»­åœ°å¢åŠ  $d_1[i]$ï¼ŒåŒæ—¶åœ¨æ¯ä¸€æ­¥ä¸­æ£€æŸ¥å½“å‰çš„å­ä¸² $[i - P[i] \dots i +  P[i]]$ï¼ˆ$P[i]$ è¡¨ç¤ºåŠå¾„é•¿åº¦ï¼Œä¸‹åŒï¼‰æ˜¯å¦ä¸ºä¸€ä¸ªå›æ–‡ä¸²ã€‚å¦‚æœæˆ‘ä»¬æ‰¾åˆ°äº†ç¬¬ä¸€å¤„å¯¹åº”å­—ç¬¦ä¸åŒï¼Œåˆæˆ–è€…ç¢°åˆ°äº† $s$  çš„è¾¹ç•Œï¼Œåˆ™ç®—æ³•åœæ­¢ã€‚åœ¨ä¸¤ç§æƒ…å†µä¸‹æˆ‘ä»¬å‡å·²è®¡ç®—å®Œ $P[i]$ã€‚æ­¤åï¼Œä»éœ€è®°å¾—æ›´æ–° $(l, r)$ã€‚</p>
</li>
<li><p>ç°åœ¨è€ƒè™‘ $i \le r$ çš„æƒ…å†µã€‚æˆ‘ä»¬å°†å°è¯•ä»å·²è®¡ç®—è¿‡çš„ $P[]$ çš„å€¼ä¸­è·å–ä¸€äº›ä¿¡æ¯ã€‚é¦–å…ˆåœ¨å­å›æ–‡ä¸²  $(l, r)$ ä¸­åè½¬ä½ç½® $i$ï¼Œå³æˆ‘ä»¬å¾—åˆ° $j = l + (r - i)$ã€‚ç°åœ¨æ¥è€ƒå¯Ÿå€¼ $P[j]$ã€‚å› ä¸ºä½ç½® $j$ åŒä½ç½®  $i$ å¯¹ç§°ï¼Œæˆ‘ä»¬ <strong>å‡ ä¹æ€»æ˜¯</strong> å¯ä»¥ç½® $P[i] = P[j]$ã€‚</p>
<p>å­˜åœ¨ <strong>æ£˜æ‰‹çš„æƒ…å†µ</strong>ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ï¼š</p>
<ul>
<li><p>è¶…å‡ºäº† $r$</p>
<p><img  src="../leetcode/b0d52a5f30747e55ef09b3c7b7cfc23026e37040edc41f387263e8f8a0ba8f49-image.png"  ><span class="image-caption">å›¾è½¬è‡ª LeetCode</span></p>
<p>å½“æˆ‘ä»¬è¦æ±‚ $P [ i ]$ çš„æ—¶å€™ï¼Œ$P [mirror] = 7$ï¼Œè€Œæ­¤æ—¶ $P [ i ]$ å¹¶ä¸ç­‰äº $7$ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸ºæˆ‘ä»¬ä» $i$ å¼€å§‹å¾€åæ•° $7$ ä¸ªï¼Œç­‰äº $22$ï¼Œå·²ç»è¶…è¿‡äº†æœ€å³çš„ $r$ï¼Œæ­¤æ—¶ä¸èƒ½åˆ©ç”¨å¯¹ç§°æ€§äº†ï¼Œä½†æˆ‘ä»¬ä¸€å®šå¯ä»¥æ‰©å±•åˆ° $r$ çš„ï¼Œæ‰€ä»¥ $P [ i ]$ è‡³å°‘ç­‰äº $r - i = 20 - 15 = 5$ï¼Œä¼šä¸ä¼šæ›´å¤§å‘¢ï¼Œæˆ‘ä»¬åªéœ€è¦æ¯”è¾ƒ $T [ r+1 ]$ å’Œ $T [ r+1 ]$ å…³äº $i$ çš„å¯¹ç§°ç‚¹å°±è¡Œäº†ï¼Œå°±åƒä¸­å¿ƒæ‰©å±•æ³•ä¸€æ ·ä¸€ä¸ªä¸ªæ‰©å±•ã€‚</p>
</li>
<li><p>$P[i]$ é‡åˆ°äº†åŸå­—ç¬¦ä¸²çš„å·¦è¾¹ç•Œ</p>
<p><img  src="../leetcode/714e6f768e67304fb7162ecac3ae85fcf23ad82a21456e8ca55ac2c8cfd2609e-image.png"  ><span class="image-caption">image.png</span></p>
<p>æ­¤æ—¶$P [ i_{mirror} ] = 1$ï¼Œä½†æ˜¯ $P [ i ]$ èµ‹å€¼æˆ 1 æ˜¯ä¸æ­£ç¡®çš„ï¼Œå‡ºç°è¿™ç§æƒ…å†µçš„åŸå› æ˜¯ $P [ i_{mirror} ]$ åœ¨æ‰©å±•çš„æ—¶å€™é¦–å…ˆæ˜¯ â€œ#â€ == â€œ#â€ï¼Œä¹‹åé‡åˆ°äº† â€œ^â€ å’Œå¦ä¸€ä¸ªå­—ç¬¦æ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯åˆ°äº†è¾¹ç•Œï¼Œæ‰ç»ˆæ­¢å¾ªç¯çš„ã€‚è€Œ $P [ i ]$ å¹¶æ²¡æœ‰é‡åˆ°è¾¹ç•Œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»§ç»­é€šè¿‡ä¸­å¿ƒæ‰©å±•æ³•ä¸€æ­¥ä¸€æ­¥å‘ä¸¤è¾¹æ‰©å±•å°±è¡Œäº†ã€‚</p>
</li>
<li><p>$i = r$</p>
<p>æ­¤æ—¶æˆ‘ä»¬å…ˆæŠŠ P [ i ] èµ‹å€¼ä¸º 0ï¼Œç„¶åé€šè¿‡ä¸­å¿ƒæ‰©å±•æ³•ä¸€æ­¥ä¸€æ­¥æ‰©å±•å°±è¡Œäº†ã€‚</p>
</li>
</ul>
<p>è€ƒè™‘ $r$ çš„æ›´æ–°</p>
<p>å°±è¿™æ ·ä¸€æ­¥ä¸€æ­¥çš„æ±‚å‡ºæ¯ä¸ª $P [ i ]$ï¼Œå½“æ±‚å‡ºçš„ $P [ i ]$ çš„å³è¾¹ç•Œå¤§äºå½“å‰çš„ $r$ æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦æ›´æ–° $r$ ä¸ºå½“å‰çš„å›æ–‡ä¸²äº†ã€‚</p>
</li>
</ul>
<h2 id="æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰"><a href="#æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰" class="headerlink" title="æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰"></a>æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰</h2><h3 id="åŠ¨æ€è§„åˆ’-1"><a href="#åŠ¨æ€è§„åˆ’-1" class="headerlink" title="åŠ¨æ€è§„åˆ’"></a>åŠ¨æ€è§„åˆ’</h3><p>çŠ¶æ€è½¬ç§»æ–¹ç¨‹å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
d p[i][j]=\left\{\begin{array}{ll}
d p[i-1][j-1]+1, & t e x t_{1}[i-1]=t e x t_{2}[j-1] \\
\max (d p[i-1][j], d p[i][j-1]), & t e x t_{1}[i-1] \neq t e x t_{2}[j-1]
\end{array}\right.</script><p>LCS å¯¹åº”çš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸æœ€é•¿å…¬å…±å­ä¸²ä¸åŒä¹‹å¤„åœ¨äºï¼š</p>
<ul>
<li>æœ€é•¿å…¬å…±å­ä¸²è¦æ±‚å­—ç¬¦ä¸²è¿ç»­ï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ªçŠ¶æ€åªèƒ½ç”±ä¸Šä¸€ä¸ªå¯¹åº”çš„å­—ç¬¦ä¸²å¾—åˆ°ã€‚</li>
<li>LCS ä¸è¦æ±‚å­—ç¬¦ä¸²è¿ç»­ï¼Œæ‰€ä»¥å¯ä»¥å‰åç§»åŠ¨ï¼Œå°±æœ‰äº†ç¬¬äºŒä¸ªå¼å­ã€‚</li>
</ul>
<p>çŸ¥é“çŠ¶æ€å®šä¹‰ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹å†™çŠ¶æ€è½¬ç§»æ–¹ç¨‹ã€‚</p>
<ul>
<li><p>å½“ $text_1[i - 1] = text_2[j - 1]$ æ—¶ï¼Œè¯´æ˜ä¸¤ä¸ªå­å­—ç¬¦ä¸²çš„æœ€åä¸€ä½ç›¸ç­‰ï¼Œæ‰€ä»¥æœ€é•¿å…¬å…±å­åºåˆ—åˆå¢åŠ äº† 1ï¼Œæ‰€ä»¥ $dp[i][j] = dp[i - 1][j - 1] + 1$ï¼›ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚å¯¹äº <code>ac</code> å’Œ <code>bc</code> è€Œè¨€ï¼Œä»–ä»¬çš„æœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦ç­‰äº <code>a</code> å’Œ <code>b</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦ $0 + 1 = 1$ã€‚</p>
</li>
<li><p>å½“ $text_1[i - 1] \ne text_2[j - 1]$ æ—¶ï¼Œè¯´æ˜ä¸¤ä¸ªå­å­—ç¬¦ä¸²çš„æœ€åä¸€ä½ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„çŠ¶æ€ $dp[i][j]$ åº”è¯¥æ˜¯ $dp[i - 1][j]$ å’Œ $dp[i][j - 1]$ çš„æœ€å¤§å€¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚å¯¹äº <code>ace</code> å’Œ <code>bc</code> è€Œè¨€ï¼Œä»–ä»¬çš„æœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦ç­‰äº</p>
<p> â‘  <code>ace</code> å’Œ <code>b</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦ <code>0</code> ä¸</p>
<p>â‘¡ <code>ac</code> å’Œ <code>bc</code> çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦ <code>1</code> çš„æœ€å¤§å€¼ï¼Œå³ <code>1</code>ã€‚</p>
</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Solution</span>;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">longest_common_subsequence</span>(text1: <span class="hljs-type">String</span>, text2: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">text1</span> = text1.<span class="hljs-title function_ invoke__">as_bytes</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">text2</span> = text2.<span class="hljs-title function_ invoke__">as_bytes</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">m</span> = text1.<span class="hljs-title function_ invoke__">len</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">n</span> = text2.<span class="hljs-title function_ invoke__">len</span>();<br>        <span class="hljs-comment">// dp[i][j] ä»£è¡¨ text1[0..i] ä¸ text2[0..j] çš„æœ€å¤§å­åºåˆ—ï¼Œæ³¨æ„ä¸åŒ…æ‹¬ç¬¬ i å’Œç¬¬ j ä¸ªå­—ç¬¦</span><br>        <span class="hljs-comment">// åŒç†ï¼Œdp æ•°ç»„è¦å¾ªç¯åˆ° m ä¸ n æ‰ç»“æŸ</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">dp</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; n + <span class="hljs-number">1</span>]; m + <span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>..=m &#123;<br>            <span class="hljs-keyword">for</span> <span class="hljs-variable">j</span> <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>..=n &#123;<br>                <span class="hljs-comment">// è¿™é‡Œè¦æ³¨æ„ï¼Œæ¯”è¾ƒçš„æ˜¯ç¬¬ i-1 ä¸ç¬¬ j-1 ä¸ªå­—ç¬¦</span><br>                <span class="hljs-keyword">if</span> text1[i - <span class="hljs-number">1</span>] == text2[j - <span class="hljs-number">1</span>] &#123;<br>                    dp[i][j] = dp[i - <span class="hljs-number">1</span>][j - <span class="hljs-number">1</span>] + <span class="hljs-number">1</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    dp[i][j] = std::cmp::<span class="hljs-title function_ invoke__">max</span>(dp[i][j - <span class="hljs-number">1</span>], dp[i - <span class="hljs-number">1</span>][j]);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> dp[m][n];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="æ•°å­¦"><a href="#æ•°å­¦" class="headerlink" title="æ•°å­¦"></a>æ•°å­¦</h1><h2 id="å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°3"><a href="#å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°3" class="headerlink" title="å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°3"></a>å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°<sup><a href="#fn_3" id="reffn_3">3</a></sup></h2><p>ä¸­ä½æ•°å®šä¹‰ï¼šå°†ä¸€ä¸ªé›†åˆåˆ’åˆ†ä¸ºä¸¤ä¸ªé•¿åº¦ç›¸ç­‰çš„å­é›†ï¼Œå…¶ä¸­ä¸€ä¸ªå­é›†ä¸­çš„å…ƒç´ æ€»æ˜¯å¤§äºå¦ä¸€ä¸ªå­é›†ä¸­çš„å…ƒç´ ã€‚</p>
<pre><code>      left_part          |         right_part
A[0], A[1], ..., A[i-1]  |  A[i], A[i+1], ..., A[m-1]
B[0], B[1], ..., B[j-1]  |  B[j], B[j+1], ..., B[n-1]
</code></pre><p>æ ¹æ®ä¸­ä½æ•°çš„å®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä»¥ä¸Šçš„åˆ’åˆ†ï¼ˆè®¾ä¸¤ä¸ªæ•°ç»„æ€»é•¿åº¦ä¸ºå¶æ•°ï¼‰ä½¿å¾—</p>
<ul>
<li>$\text{len}(left_part) = \text{len}(right_part)$</li>
<li>$\max(left_part)=\max(right_part)$</li>
</ul>
<p>æ­¤æ—¶çš„ä¸­ä½æ•°ä¸ºï¼š</p>
<script type="math/tex; mode=display">\text{median} = \frac{\max(left\_part)+\min(right\_part)}{2}</script><p>æ‰€ä»¥ç°åœ¨çš„é—®é¢˜å…³é”®åœ¨äºå¯»æ‰¾è¿™æ ·ä¸€ä¸ªåˆ’åˆ†ã€‚è¦å¯»æ‰¾è¿™æ ·ä¸€ä¸ªåˆ’åˆ†éœ€è¦æ ¹æ®è¿™ä¸ªåˆ’åˆ†æ»¡è¶³çš„ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>å·¦è¾¹å…ƒç´ å…±æœ‰ $i + j$ ä¸ªï¼Œå³è¾¹å…ƒç´ å…±æœ‰ $(m-i)+(n-j)$ ä¸ªï¼Œæ‰€ä»¥ç”±ç¬¬ä¸€ä¸ªå¼å­å¯ä»¥å¾—åˆ° $i+j=(m-i)+(n-j)$ã€‚å˜å½¢å¾—åˆ° $i+j=\frac{m+n}{2}$ã€‚å‡è®¾ $m &lt; n$ï¼Œå³ B æ•°ç»„é•¿äº A æ•°ç»„ï¼Œåˆ™ $i\in[0,m]$ï¼Œæœ‰ $j = \frac{m+n}{2}-i$ ä¸” $j \in [0,n]$ï¼Œæ‰€ä»¥åªè¦çŸ¥é“ $i$ çš„å€¼ï¼Œé‚£ä¹ˆ $j$ çš„å€¼ä¹Ÿæ˜¯ç¡®å®šçš„ã€‚</li>
<li>åœ¨ $(0, m)$ ä¸­æ‰¾åˆ° $i$ï¼Œæ»¡è¶³ $A[i-1] \le B[j]$ ä¸” $A[i] \ge B[j-1]$ ã€‚</li>
</ul>
<p>æ³¨æ„åˆ°ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸­ï¼Œå½“ $i$ å¢å¤§çš„æ—¶å€™ï¼Œ$j$ ä¼šå‡å°ä»¥æ­¤æ¥ä¿è¯å·¦å³ä¸¤éƒ¨åˆ†çš„å…ƒç´ ä¸ªæ•°ç›¸åŒã€‚åŒæ—¶ Aã€B æ•°ç»„éƒ½æ˜¯å•è°ƒä¸é€’å‡çš„ï¼Œæ‰€ä»¥ä¸€å®šå­˜åœ¨ä¸€ä¸ªæœ€å¤§çš„ $i$ æ»¡è¶³ $A[i-1] \le B[j]$ã€‚ï¼ˆå½“ $i$ å– $i+1$ æ—¶ $A[i] &gt; B[j-1]$ï¼‰</p>
<p>æ‰€ä»¥é—®é¢˜è½¬åŒ–ä¸ºï¼šæ‰¾ä¸€ä¸ªæœ€å¤§çš„ $i$ ä½¿å¾— $A[i-1] \le B[j]$ã€‚</p>
<p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å®¹æ˜“æšä¸¾ $i$ï¼ŒåŒæ—¶ Aã€B éƒ½æ˜¯å•è°ƒé€’å¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜èƒ½çŸ¥é“æšä¸¾å‡ºçš„ $i$ æ˜¯ä¸æ˜¯æ»¡è¶³æ¡ä»¶ï¼ˆ$A[i-1] \le B[j]$ï¼‰ï¼Œå¹¶ä»ä¸­æ‰¾å‡ºæ»¡è¶³æ¡ä»¶çš„æœ€å¤§ $i$ å€¼å³å¯ã€‚</p>
<p>å¯¹äºä¸¤ä¸ªæ•°ç»„æ€»é•¿åº¦ä¸ºå¥‡æ•°çš„æƒ…å†µï¼Œå¯ä»¥ä½¿å¾— $j = \lfloor \frac{m+n+1}{2}-i \rfloor$ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[warn(dead_code)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Solution</span>;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_median_sorted_arrays</span>(nums1: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;, nums2: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f64</span> &#123;<br>        <span class="hljs-keyword">if</span> nums1.<span class="hljs-title function_ invoke__">len</span>() &gt; nums2.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>            <span class="hljs-keyword">return</span> Solution::<span class="hljs-title function_ invoke__">find_median_sorted_arrays</span>(nums2, nums1);<br>        &#125;<br>        <span class="hljs-comment">// m &lt; n</span><br>        <span class="hljs-keyword">let</span> (m, n) = (nums1.<span class="hljs-title function_ invoke__">len</span>(), nums2.<span class="hljs-title function_ invoke__">len</span>());<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">left</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">right</span> = m;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pos</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">median1</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">median2</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> left &lt;= right &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = (left + right) / <span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">j</span> = (m + n + <span class="hljs-number">1</span>) / <span class="hljs-number">2</span> - i;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nums_im1</span> = <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> &#123; -<span class="hljs-number">0x3f3f3f3f</span> &#125; <span class="hljs-keyword">else</span> &#123; nums1[i - <span class="hljs-number">1</span>] &#125;;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nums_i</span> = <span class="hljs-keyword">if</span> i == m &#123; <span class="hljs-number">0x3f3f3f3f</span> &#125; <span class="hljs-keyword">else</span> &#123; nums1[i] &#125;;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nums_jm1</span> = <span class="hljs-keyword">if</span> j == <span class="hljs-number">0</span> &#123; -<span class="hljs-number">0x3f3f3f3f</span> &#125; <span class="hljs-keyword">else</span> &#123; nums2[j - <span class="hljs-number">1</span>] &#125;;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">nums_j</span> = <span class="hljs-keyword">if</span> j == n &#123; <span class="hljs-number">0x3f3f3f3f</span> &#125; <span class="hljs-keyword">else</span> &#123; nums2[j] &#125;;<br>            <span class="hljs-keyword">if</span> nums_im1 &lt;= nums_j &#123;<br>                median1 = std::cmp::<span class="hljs-title function_ invoke__">max</span>(nums_im1, nums_jm1);<br>                median2 = std::cmp::<span class="hljs-title function_ invoke__">min</span>(nums_i, nums_j);<br>                left = i + <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                right = i - <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">if</span> (m + n) &amp; <span class="hljs-number">1</span> == <span class="hljs-number">0</span> &#123;<br>            (median1 + median2) <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span> / <span class="hljs-number">2.0</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            median1 <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="ä¸‰æ•°ä¹‹å’Œ"><a href="#ä¸‰æ•°ä¹‹å’Œ" class="headerlink" title="ä¸‰æ•°ä¹‹å’Œ"></a>ä¸‰æ•°ä¹‹å’Œ</h2><h3 id="æœ´ç´ ç®—æ³•"><a href="#æœ´ç´ ç®—æ³•" class="headerlink" title="æœ´ç´ ç®—æ³•"></a>æœ´ç´ ç®—æ³•</h3><p>æ’åºä¹‹åä¸‰é‡å¾ªç¯ï¼Œåˆ¤æ–­ä¸‰ä¸ªæ•°ä¹‹å’Œæ˜¯å¦ä¸º $0$ï¼Œæ—¶é—´å¤æ‚åº¦ $O(n^3)$ã€‚</p>
<p>æ’åºçš„ç›®çš„æ˜¯ä¸ºäº†å®¹æ˜“åœ°å»é™¤é‡å¤æ•°å­—ï¼Œå› ä¸ºæ’åºä¹‹ååªéœ€è¦åˆ¤æ–­å½“å‰å’Œå‰ä¸€ä¸ªå…ƒç´ æ˜¯å¦ç›¸ç­‰å°±å¯ä»¥çŸ¥é“æ˜¯å¦æ˜¯é‡å¤æ•°å­—ã€‚</p>
<h3 id="æ’åºååŒæŒ‡é’ˆ"><a href="#æ’åºååŒæŒ‡é’ˆ" class="headerlink" title="æ’åºååŒæŒ‡é’ˆ"></a>æ’åºååŒæŒ‡é’ˆ</h3><p>æ³¨æ„åˆ°æ’åºä¹‹åæ•´ä¸ªæ•°ç»„æ˜¯å•è°ƒéé€’å‡çš„ï¼Œæˆ‘ä»¬éœ€è¦ $a+b+c=0$ï¼Œå½“å›ºå®šäº† $a$ å’Œ $b$ çš„æ—¶å€™ï¼Œ$c$ ä»å¤§åˆ°å°åœ°åˆ¤æ–­æ˜¯å¦æœ‰ $a+b+c=0$ å³å¯ã€‚çœ‹ä¼¼æ˜¯æœ€å¤–å±‚å¯¹åº” $a$ çš„å¾ªç¯åµŒå¥—å¯¹åº” $b$ çš„å¾ªç¯ï¼Œå¹¶åœ¨å…¶ä¸­åŠ ä¸Šäº† $c$ é€’å‡çš„å¾ªç¯ï¼Œä½†æ˜¯å®é™…ä¸Šæ³¨æ„åˆ°å½“ $b$ ä¸ $c$ æ˜¯åŒä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå¦‚æœä»ç„¶ä¸æ»¡è¶³ $a+b+c=0$ï¼Œé‚£ä¹ˆ $c$ ç»§ç»­å‘å·¦å‡å°å°±ä¸ä¹‹å‰çš„æ•°å­—é‡å¤äº†ï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸€æ¬¡ $b$ ä¸­çš„å¾ªç¯ï¼Œæœ€å¤šè¿è¡Œ $n$ æ¬¡ï¼Œå¤–è¾¹å†åµŒå¥— $a$ çš„å¾ªç¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(n^2)$ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[warn(dead_code)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Solution</span>;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">three_sum</span>(<span class="hljs-keyword">mut</span> nums: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;&gt; &#123;<br>        nums.<span class="hljs-title function_ invoke__">sort</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span> = nums.<span class="hljs-title function_ invoke__">len</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ans</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..len &#123;<br>            <span class="hljs-comment">// é˜²æ­¢å–åˆ°ç›¸åŒçš„æ•°å­—</span><br>            <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span> &amp;&amp; nums[i - <span class="hljs-number">1</span>] == nums[i] &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">third</span> = len - <span class="hljs-number">1</span>;<br>            <span class="hljs-comment">// æ³¨æ„è¿™é‡Œå¼€å§‹ä½ç½®æ˜¯ i+1ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¸ä¸ a å–é‡</span><br>            <span class="hljs-keyword">for</span> <span class="hljs-variable">j</span> <span class="hljs-keyword">in</span> i + <span class="hljs-number">1</span>..len &#123;<br>                <span class="hljs-comment">// æ³¨æ„è¿™é‡Œåˆ¤å®šæ¡ä»¶æ˜¯ j &gt; i+1 å¦åˆ™ä¼šå–ä¸åˆ°ä¸ a ç›¸åŒçš„æ•°å­—</span><br>                <span class="hljs-keyword">if</span> j &gt; i + <span class="hljs-number">1</span> &amp;&amp; nums[j - <span class="hljs-number">1</span>] == nums[j] &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-keyword">while</span> j &lt; third &amp;&amp; nums[i] + nums[j] + nums[third] &gt; <span class="hljs-number">0</span> &#123;<br>                    third = third - <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> j == third &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> nums[i] + nums[j] + nums[third] == <span class="hljs-number">0</span> &#123;<br>                    ans.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-built_in">vec!</span>[nums[i], nums[j], nums[third]]);<br>                &#125;<br>            &#125;<br>        &#125;<br>        ans<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="ç››æœ€å¤šæ°´çš„å®¹å™¨4"><a href="#ç››æœ€å¤šæ°´çš„å®¹å™¨4" class="headerlink" title="ç››æœ€å¤šæ°´çš„å®¹å™¨4"></a>ç››æœ€å¤šæ°´çš„å®¹å™¨<sup><a href="#fn_4" id="reffn_4">4</a></sup></h2><script type="math/tex; mode=display">
area = (right - left) * \min (height[left], height[right])</script><p>ç”±ä¸Šé¢çš„å…¬å¼å¯ä»¥çŸ¥é“ï¼Œé¢ç§¯ç”±ä¸¤éƒ¨åˆ†å…±åŒå†³å®šï¼š</p>
<ul>
<li>å®½åº¦</li>
<li>é«˜åº¦</li>
</ul>
<p>æ‰€ä»¥è€ƒè™‘å°½å¯èƒ½åœ°å¢åŠ å®½åº¦å’Œé«˜åº¦ã€‚å‡è®¾å·¦æŒ‡é’ˆæŒ‡å‘çš„æ•°ä¸º $x$ï¼Œå³æŒ‡é’ˆæŒ‡å‘çš„æ•°ä¸º $y$ï¼Œå‡è®¾ $x &lt; y$ï¼Œè·ç¦»ä¸º $t$ï¼Œæ¥ä¸‹æ¥è¿›è¡Œå…·ä½“åˆ†æï¼š</p>
<ol>
<li>æ°´é‡ $ area = \min(x, y) <em> t = x </em> t $ï¼Œå½“å·¦æŒ‡é’ˆä¸å˜çš„æ—¶å€™ï¼Œå³æŒ‡é’ˆæ— è®ºåœ¨å“ªéƒ½ä¸ä¼šå½±å“å®¹å™¨çš„æ°´é‡äº†ï¼Œæ°´é‡æ˜¯å›ºå®šçš„ $x*t$ã€‚</li>
<li>æ‰€ä»¥è€ƒè™‘å·¦æŒ‡é’ˆå‘å³ç§»åŠ¨ï¼Œè¿™æ ·æ‰æœ‰å¯èƒ½å–åˆ°æ›´å¤§çš„æ°´é‡ã€‚</li>
<li>åŒç†å·¦æŒ‡é’ˆæŒ‡å‘çš„æ•°å¤§äºå³æŒ‡é’ˆæŒ‡å‘çš„æ•°çš„æ—¶å€™ï¼Œå·¦ç§»å³æŒ‡é’ˆæ‰æœ‰å¯èƒ½å–åˆ°æ›´å¤§çš„æ°´é‡ã€‚</li>
<li>é‡å¤ä»¥ä¸Šæ­¥éª¤å°±å¯ä»¥å¾—åˆ°æœ€å¤§æ°´é‡ã€‚</li>
</ol>
<p>æ€»æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ã€‚</p>
<p>æ³¨è§£ï¼š</p>
<ul>
<li>å¯¹äºåŒæŒ‡é’ˆé—®é¢˜ï¼Œä¸¤ä¸ªæŒ‡é’ˆçš„åˆå§‹ä½ç½®ä¸ä¸€å®šéƒ½åœ¨æœ€å·¦æˆ–è€…æœ€å³ï¼Œè¦çµæ´»åœ°è®¾ç½®æŒ‡é’ˆä½ç½®ã€‚</li>
</ul>
<h2 id="æœ€æ¥è¿‘ä¸‰æ•°ä¹‹å’Œ"><a href="#æœ€æ¥è¿‘ä¸‰æ•°ä¹‹å’Œ" class="headerlink" title="æœ€æ¥è¿‘ä¸‰æ•°ä¹‹å’Œ"></a>æœ€æ¥è¿‘ä¸‰æ•°ä¹‹å’Œ</h2><p>ä¸ã€Œç››æœ€å¤šæ°´çš„å®¹å™¨ã€å’Œã€Œä¸‰æ•°ä¹‹å’Œã€ç±»ä¼¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[warn(dead_code)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Solution</span>;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">three_sum_closest</span>(<span class="hljs-keyword">mut</span> nums: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;, target: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>        nums.<span class="hljs-title function_ invoke__">sort</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span> = nums.<span class="hljs-title function_ invoke__">len</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ans</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">diff</span> = <span class="hljs-number">0x3f3f3f3f</span>;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..len &#123;<br>            <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span> &amp;&amp; nums[i] == nums[i - <span class="hljs-number">1</span>] &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">j</span> = i + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">k</span> = len - <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span> j &lt; k &#123;<br>                <span class="hljs-comment">//dbg!((i, j , k));</span><br>                <span class="hljs-keyword">let</span> <span class="hljs-variable">sum</span> = nums[i] + nums[j] + nums[k];<br>                <span class="hljs-keyword">if</span> sum == target &#123;<br>                    <span class="hljs-keyword">return</span> sum;<br>                &#125;<br>                <span class="hljs-keyword">let</span> <span class="hljs-variable">tmp</span> = (sum - target).<span class="hljs-title function_ invoke__">abs</span>();<br>                <span class="hljs-keyword">if</span> tmp &lt; diff &#123;<br>                    diff = tmp;<br>                    ans = sum;<br>                &#125;<br>                <span class="hljs-keyword">if</span> sum &gt; target &#123;<br>                    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">k0</span> = k - <span class="hljs-number">1</span>;<br>                    <span class="hljs-keyword">while</span> j &lt; k0 &amp;&amp; nums[k0] == nums[k] &#123;<br>                        k0 = k0 - <span class="hljs-number">1</span>;<br>                    &#125;<br>                    k = k0;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">j0</span> = j + <span class="hljs-number">1</span>;<br>                    <span class="hljs-keyword">while</span> j0 &lt; k &amp;&amp; nums[j0] == nums[j] &#123;<br>                        j0 = j0 + <span class="hljs-number">1</span>;<br>                    &#125;<br>                    j = j0;<br>                &#125;<br>            &#125;<br>        &#125;<br>        ans<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h1><h2 id="åˆå¹¶Kä¸ªå‡åºé“¾è¡¨"><a href="#åˆå¹¶Kä¸ªå‡åºé“¾è¡¨" class="headerlink" title="åˆå¹¶Kä¸ªå‡åºé“¾è¡¨"></a>åˆå¹¶Kä¸ªå‡åºé“¾è¡¨</h2><p>ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—å³å¯ã€‚</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::&#123;cmp::Reverse, collections::BinaryHeap&#125;;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">merge_k_lists</span>(lists: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;<span class="hljs-type">Box</span>&lt;ListNode&gt;&gt;&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Box</span>&lt;ListNode&gt;&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">priority_queue</span> = BinaryHeap::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ret</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(ListNode::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>));<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ptr</span> = &amp;<span class="hljs-keyword">mut</span> ret;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">list</span> <span class="hljs-keyword">in</span> lists &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">plist</span> = &amp;list;<br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(node) = plist &#123;<br>                priority_queue.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-title function_ invoke__">Reverse</span>(node.val));<br>                plist = &amp;node.next;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(<span class="hljs-title function_ invoke__">Reverse</span>(node)) = priority_queue.<span class="hljs-title function_ invoke__">pop</span>() &#123;<br>            ptr.next = <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(ListNode::<span class="hljs-title function_ invoke__">new</span>(node)));<br>            ptr = ptr.next.<span class="hljs-title function_ invoke__">as_mut</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>        &#125;<br>        ret.next<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><blockquote id="fn_1">
<sup>1</sup>. <a href="https://leetcode-cn.com/problems/longest-palindromic-substring/solution/xiang-xi-tong-su-de-si-lu-fen-xi-duo-jie-fa-bao-gu">https://leetcode-cn.com/problems/longest-palindromic-substring/solution/xiang-xi-tong-su-de-si-lu-fen-xi-duo-jie-fa-bao-gu</a><a href="#reffn_1" title="Jump back to footnote [1] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_2">
<sup>2</sup>. <a href="https://oi-wiki.org/string/manacher/">https://oi-wiki.org/string/manacher/</a><a href="#reffn_2" title="Jump back to footnote [2] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_3">
<sup>3</sup>. <a href="https://leetcode-cn.com/problems/median-of-two-sorted-arrays/solution/xun-zhao-liang-ge-you-xu-shu-zu-de-zhong-wei-s-114/">https://leetcode-cn.com/problems/median-of-two-sorted-arrays/solution/xun-zhao-liang-ge-you-xu-shu-zu-de-zhong-wei-s-114/</a><a href="#reffn_3" title="Jump back to footnote [3] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_4">
<sup>4</sup>. <a href="https://leetcode-cn.com/problems/container-with-most-water/solution/sheng-zui-duo-shui-de-rong-qi-by-leetcode-solution/">https://leetcode-cn.com/problems/container-with-most-water/solution/sheng-zui-duo-shui-de-rong-qi-by-leetcode-solution/</a><a href="#reffn_4" title="Jump back to footnote [4] in the text."> &#8617;</a>
</blockquote>
]]></content>
      <tags>
        <tag>data structure, algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>Internlm-05-LMDeploy çš„é‡åŒ–å’Œéƒ¨ç½²</title>
    <url>/internlm/internlm-05/</url>
    <content><![CDATA[<h1 id="LMDeploy-çš„é‡åŒ–å’Œéƒ¨ç½²"><a href="#LMDeploy-çš„é‡åŒ–å’Œéƒ¨ç½²" class="headerlink" title="LMDeploy çš„é‡åŒ–å’Œéƒ¨ç½²"></a>LMDeploy çš„é‡åŒ–å’Œéƒ¨ç½²</h1><h2 id="1-ç¯å¢ƒé…ç½®"><a href="#1-ç¯å¢ƒé…ç½®" class="headerlink" title="1 ç¯å¢ƒé…ç½®"></a>1 ç¯å¢ƒé…ç½®</h2><p>è¿™é‡Œ <code>/share/conda_envs</code> ç›®å½•ä¸‹çš„ç¯å¢ƒæ˜¯å®˜æ–¹æœªå¤§å®¶å‡†å¤‡å¥½çš„åŸºç¡€ç¯å¢ƒï¼Œå› ä¸ºè¯¥ç›®å½•æ˜¯å…±äº«åªè¯»çš„ï¼Œè€Œæˆ‘ä»¬åé¢éœ€è¦åœ¨æ­¤åŸºç¡€ä¸Šå®‰è£…æ–°çš„è½¯ä»¶åŒ…ï¼Œæ‰€ä»¥éœ€è¦å¤åˆ¶åˆ°æˆ‘ä»¬è‡ªå·±çš„ conda ç¯å¢ƒï¼ˆè¯¥ç¯å¢ƒä¸‹æˆ‘ä»¬æ˜¯å¯å†™çš„ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">conda create -n lmdeploy --<span class="hljs-built_in">clone</span> /share/conda_envs/internlm-base<br></code></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœcloneæ“ä½œè¿‡æ…¢ï¼Œå¯é‡‡ç”¨å¦‚ä¸‹æ“ä½œ:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">/root/share/install_conda_env_internlm_base.sh lmdeploy<br></code></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å– <code>CONDA_ENV_NAME</code> ä¸º <code>lmdeploy</code>ï¼Œå¤åˆ¶å®Œæˆåï¼Œå¯ä»¥åœ¨æœ¬åœ°æŸ¥çœ‹ç¯å¢ƒã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">conda <span class="hljs-built_in">env</span> list<br></code></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># conda environments:</span><br><span class="hljs-comment">#</span><br>base                  *  /root/.conda<br>lmdeploy                 /root/.conda/envs/lmdeploy<br></code></pre></td></tr></table></figure>
<p>ç„¶åæ¿€æ´»ç¯å¢ƒã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">conda activate lmdeploy<br></code></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯åœ¨ InternStudio å¼€å‘ç¯å¢ƒï¼Œéœ€è¦å…ˆè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è§£å†³ ModuleNotFoundError: No module named &#x27;packaging&#x27; é—®é¢˜</span><br>pip install packaging<br><span class="hljs-comment"># ä½¿ç”¨ flash_attn çš„é¢„ç¼–è¯‘åŒ…è§£å†³å®‰è£…è¿‡æ…¢é—®é¢˜</span><br>pip install /root/share/wheels/flash_attn-2.4.2+cu118torch2.0cxx11abiTRUE-cp310-cp310-linux_x86_64.whl<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">pip install <span class="hljs-string">&#x27;lmdeploy[all]==v0.1.0&#x27;</span><br></code></pre></td></tr></table></figure>
<p>ç”±äºé»˜è®¤å®‰è£…çš„æ˜¯ runtime ä¾èµ–åŒ…ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œè¿˜éœ€è¦éƒ¨ç½²å’Œé‡åŒ–ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œé€‰æ‹© <code>[all]</code>ã€‚ç„¶åå¯ä»¥å†æ£€æŸ¥ä¸€ä¸‹ lmdeploy åŒ…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="env.png"  ><span class="image-caption">å®‰è£… lmdeploy æˆåŠŸ</span></p>
<p>åŸºç¡€ç¯å¢ƒåˆ°è¿™é‡Œå°±é…ç½®å¥½äº†ã€‚</p>
<h2 id="2-æœåŠ¡éƒ¨ç½²"><a href="#2-æœåŠ¡éƒ¨ç½²" class="headerlink" title="2 æœåŠ¡éƒ¨ç½²"></a>2 æœåŠ¡éƒ¨ç½²</h2><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ¶‰åŠæœ¬åœ°æ¨ç†å’Œéƒ¨ç½²ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€å¼ å›¾ã€‚</p>
<p><img  src="lmdeploy.drawio.png"  ><span class="image-caption">æœåŠ¡æ¶æ„å›¾</span></p>
<p>lmdeploy ä»æ¶æ„ä¸ŠæŠŠæ•´ä¸ªæœåŠ¡æµç¨‹åˆ†æˆä¸‹é¢å‡ ä¸ªæ¨¡å—ã€‚</p>
<ul>
<li>æ¨¡å‹æ¨ç†/æœåŠ¡ã€‚ä¸»è¦æä¾›æ¨¡å‹æœ¬èº«çš„æ¨ç†ï¼Œä¸€èˆ¬æ¥è¯´å¯ä»¥å’Œå…·ä½“ä¸šåŠ¡è§£è€¦ï¼Œä¸“æ³¨æ¨¡å‹æ¨ç†æœ¬èº«æ€§èƒ½çš„ä¼˜åŒ–ã€‚å¯ä»¥ä»¥æ¨¡å—ã€APIç­‰å¤šç§æ–¹å¼æä¾›ã€‚</li>
<li>Clientã€‚å¯ä»¥ç†è§£ä¸ºå‰ç«¯ï¼Œä¸ç”¨æˆ·äº¤äº’çš„åœ°æ–¹ã€‚</li>
<li>API Serverã€‚ä¸€èˆ¬ä½œä¸ºå‰ç«¯çš„åç«¯ï¼Œæä¾›ä¸äº§å“å’ŒæœåŠ¡ç›¸å…³çš„æ•°æ®å’ŒåŠŸèƒ½æ”¯æŒã€‚</li>
</ul>
<p>å€¼å¾—è¯´æ˜çš„æ˜¯ï¼Œä»¥ä¸Šçš„åˆ’åˆ†æ˜¯ä¸€ä¸ªç›¸å¯¹å®Œæ•´çš„æ¨¡å‹ï¼Œä½†åœ¨å®é™…ä¸­è¿™å¹¶ä¸æ˜¯ç»å¯¹çš„ã€‚æ¯”å¦‚å¯ä»¥æŠŠâ€œæ¨¡å‹æ¨ç†â€å’Œâ€œAPI Serverâ€åˆå¹¶ï¼Œæœ‰çš„ç”šè‡³æ˜¯ä¸‰ä¸ªæµç¨‹æ‰“åŒ…åœ¨ä¸€èµ·æä¾›æœåŠ¡ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ lmdeploy æä¾›çš„éƒ¨ç½²åŠŸèƒ½ã€‚</p>
<h3 id="2-1-æ¨¡å‹è½¬æ¢"><a href="#2-1-æ¨¡å‹è½¬æ¢" class="headerlink" title="2.1 æ¨¡å‹è½¬æ¢"></a>2.1 æ¨¡å‹è½¬æ¢</h3><p>ä½¿ç”¨ TurboMind æ¨ç†æ¨¡å‹éœ€è¦å…ˆå°†æ¨¡å‹è½¬åŒ–ä¸º TurboMind çš„æ ¼å¼ï¼Œç›®å‰æ”¯æŒåœ¨çº¿è½¬æ¢å’Œç¦»çº¿è½¬æ¢ä¸¤ç§å½¢å¼ã€‚åœ¨çº¿è½¬æ¢å¯ä»¥ç›´æ¥åŠ è½½ Huggingface æ¨¡å‹ï¼Œç¦»çº¿è½¬æ¢éœ€éœ€è¦å…ˆä¿å­˜æ¨¡å‹å†åŠ è½½ã€‚</p>
<p>TurboMind æ˜¯ä¸€æ¬¾å…³äº LLM æ¨ç†çš„é«˜æ•ˆæ¨ç†å¼•æ“ï¼ŒåŸºäºè‹±ä¼Ÿè¾¾çš„ <a href="https://github.com/NVIDIA/FasterTransformer">FasterTransformer</a> ç ”å‘è€Œæˆã€‚å®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼šLLaMa ç»“æ„æ¨¡å‹çš„æ”¯æŒï¼Œpersistent batch æ¨ç†æ¨¡å¼å’Œå¯æ‰©å±•çš„ KV ç¼“å­˜ç®¡ç†å™¨ã€‚</p>
<h4 id="2-1-1-åœ¨çº¿è½¬æ¢"><a href="#2-1-1-åœ¨çº¿è½¬æ¢" class="headerlink" title="2.1.1 åœ¨çº¿è½¬æ¢"></a>2.1.1 åœ¨çº¿è½¬æ¢</h4><p>lmdeploy æ”¯æŒç›´æ¥è¯»å– Huggingface æ¨¡å‹æƒé‡ï¼Œç›®å‰å…±æ”¯æŒä¸‰ç§ç±»å‹ï¼š</p>
<ul>
<li>åœ¨ huggingface.co ä¸Šé¢é€šè¿‡ lmdeploy é‡åŒ–çš„æ¨¡å‹ï¼Œå¦‚ <a href="https://huggingface.co/lmdeploy/llama2-chat-70b-4bit">llama2-70b-4bit</a>, <a href="https://huggingface.co/internlm/internlm-chat-20b-4bit">internlm-chat-20b-4bit</a></li>
<li>huggingface.co ä¸Šé¢å…¶ä»– LM æ¨¡å‹ï¼Œå¦‚ Qwen/Qwen-7B-Chat</li>
</ul>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># éœ€è¦èƒ½è®¿é—® Huggingface çš„ç½‘ç»œç¯å¢ƒ</span><br>lmdeploy chat turbomind internlm/internlm-chat-20b-4bit --model-name internlm-chat-20b<br>lmdeploy chat turbomind Qwen/Qwen-7B-Chat --model-name qwen-7b<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢ä¸¤è¡Œå‘½ä»¤åˆ†åˆ«å±•ç¤ºäº†å¦‚ä½•ç›´æ¥åŠ è½½ Huggingface çš„æ¨¡å‹ï¼Œç¬¬ä¸€æ¡å‘½ä»¤æ˜¯åŠ è½½ä½¿ç”¨ lmdeploy é‡åŒ–çš„ç‰ˆæœ¬ï¼Œç¬¬äºŒæ¡å‘½ä»¤æ˜¯åŠ è½½å…¶ä»– LLM æ¨¡å‹ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥å¯åŠ¨æœ¬åœ°çš„ Huggingface æ¨¡å‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lmdeploy chat turbomind /share/temp/model_repos/internlm-chat-7b/  --model-name internlm-chat-7b<br></code></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå‘½ä»¤éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªæœ¬åœ°å¯¹è¯ç•Œé¢ï¼Œé€šè¿‡ Bash å¯ä»¥ä¸ LLM è¿›è¡Œå¯¹è¯ã€‚</p>
<h4 id="2-1-2-ç¦»çº¿è½¬æ¢"><a href="#2-1-2-ç¦»çº¿è½¬æ¢" class="headerlink" title="2.1.2 ç¦»çº¿è½¬æ¢"></a>2.1.2 ç¦»çº¿è½¬æ¢</h4><p>ç¦»çº¿è½¬æ¢éœ€è¦åœ¨å¯åŠ¨æœåŠ¡ä¹‹å‰ï¼Œå°†æ¨¡å‹è½¬ä¸º lmdeploy TurboMind  çš„æ ¼å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è½¬æ¢æ¨¡å‹ï¼ˆFastTransformeræ ¼å¼ï¼‰ TurboMind</span><br>lmdeploy convert internlm-chat-7b /path/to/internlm-chat-7b<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å®˜æ–¹æä¾›çš„æ¨¡å‹æ–‡ä»¶ï¼Œå°±åœ¨ç”¨æˆ·æ ¹ç›®å½•æ‰§è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lmdeploy convert internlm-chat-7b  /root/share/temp/model_repos/internlm-chat-7b/<br></code></pre></td></tr></table></figure>
<p><img  src="convert.png"  ><span class="image-caption">è½¬æ¢æ¨¡å‹</span></p>
<p>æ‰§è¡Œå®Œæˆåå°†ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ª <code>workspace</code> çš„æ–‡ä»¶å¤¹ã€‚è¿™é‡Œé¢åŒ…å«çš„å°±æ˜¯ TurboMind å’Œ Triton â€œæ¨¡å‹æ¨ç†â€éœ€è¦åˆ°çš„æ–‡ä»¶ã€‚</p>
<p>ç›®å½•å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="tree1.png"  ><span class="image-caption">è½¬æ¢åçš„æ¨¡å‹</span></p>
<p><code>weights</code> å’Œ <code>tokenizer</code> ç›®å½•åˆ†åˆ«æ”¾çš„æ˜¯æ‹†åˆ†åçš„å‚æ•°å’Œ Tokenizerã€‚å¦‚æœæˆ‘ä»¬è¿›ä¸€æ­¥æŸ¥çœ‹ <code>weights</code> çš„ç›®å½•ï¼Œå°±ä¼šå‘ç°å‚æ•°æ˜¯æŒ‰å±‚å’Œæ¨¡å—æ‹†å¼€çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="tree2.png"  ><span class="image-caption">è½¬æ¢åçš„æƒé‡</span></p>
<p>æ¯ä¸€ä»½å‚æ•°ç¬¬ä¸€ä¸ª 0 è¡¨ç¤ºâ€œå±‚â€çš„ç´¢å¼•ï¼Œåé¢çš„é‚£ä¸ª0è¡¨ç¤º Tensor å¹¶è¡Œçš„ç´¢å¼•ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€å¼ å¡ï¼Œæ‰€ä»¥è¢«æ‹†åˆ†æˆ 1 ä»½ã€‚å¦‚æœæœ‰ä¸¤å¼ å¡å¯ä»¥ç”¨æ¥æ¨ç†ï¼Œåˆ™ä¼šç”Ÿæˆ0å’Œ1ä¸¤ä»½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šæŠŠåŒä¸€ä¸ªå‚æ•°æ‹†æˆä¸¤ä»½ã€‚æ¯”å¦‚ <code>layers.0.attention.w_qkv.0.weight</code> ä¼šå˜æˆ <code>layers.0.attention.w_qkv.0.weight</code> å’Œ <code>layers.0.attention.w_qkv.1.weight</code>ã€‚æ‰§è¡Œ <code>lmdeploy convert</code> å‘½ä»¤æ—¶ï¼Œå¯ä»¥é€šè¿‡ <code>--tp</code> æŒ‡å®šï¼ˆtp è¡¨ç¤º tensor parallelï¼‰ï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸º1ï¼ˆä¹Ÿå°±æ˜¯ä¸€å¼ å¡ï¼‰ã€‚</p>
<p><strong>å…³äºTensorå¹¶è¡Œ</strong></p>
<p>Tensorå¹¶è¡Œä¸€èˆ¬åˆ†ä¸ºè¡Œå¹¶è¡Œæˆ–åˆ—å¹¶è¡Œï¼ŒåŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="col.png"  ><span class="image-caption">åˆ—å¹¶è¡Œ</span></p>
<p><img  src="row.png"  ><span class="image-caption">è¡Œå¹¶è¡Œ</span></p>
<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªå¤§çš„å¼ é‡ï¼ˆå‚æ•°ï¼‰åˆ†åˆ°å¤šå¼ å¡ä¸Šï¼Œåˆ†åˆ«è®¡ç®—å„éƒ¨åˆ†çš„ç»“æœï¼Œç„¶åå†åŒæ­¥æ±‡æ€»ã€‚</p>
<h3 id="2-2-TurboMind-æ¨ç†-å‘½ä»¤è¡Œæœ¬åœ°å¯¹è¯"><a href="#2-2-TurboMind-æ¨ç†-å‘½ä»¤è¡Œæœ¬åœ°å¯¹è¯" class="headerlink" title="2.2  TurboMind æ¨ç†+å‘½ä»¤è¡Œæœ¬åœ°å¯¹è¯"></a>2.2  TurboMind æ¨ç†+å‘½ä»¤è¡Œæœ¬åœ°å¯¹è¯</h3><p>æ¨¡å‹è½¬æ¢å®Œæˆåï¼Œæˆ‘ä»¬å°±å…·å¤‡äº†ä½¿ç”¨æ¨¡å‹æ¨ç†çš„æ¡ä»¶ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡ŒçœŸæ­£çš„æ¨¡å‹æ¨ç†ç¯èŠ‚ã€‚</p>
<p>æˆ‘ä»¬å…ˆå°è¯•æœ¬åœ°å¯¹è¯ï¼ˆ<code>Bash Local Chat</code>ï¼‰ï¼Œä¸‹é¢ç”¨ï¼ˆLocal Chat è¡¨ç¤ºï¼‰åœ¨è¿™é‡Œå…¶å®æ˜¯è·³è¿‡ API Server ç›´æ¥è°ƒç”¨ TurboMindã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å‘½ä»¤è¡Œä»£ç ç›´æ¥æ‰§è¡Œ TurboMindã€‚æ‰€ä»¥è¯´ï¼Œå®é™…å’Œå‰é¢çš„æ¶æ„å›¾æ˜¯æœ‰åŒºåˆ«çš„ã€‚</p>
<p>è¿™é‡Œæ”¯æŒå¤šç§æ–¹å¼è¿è¡Œï¼Œæ¯”å¦‚Turbomindã€PyTorchã€DeepSpeedã€‚ä½† PyTorch å’Œ DeepSpeed è°ƒç”¨çš„å…¶å®éƒ½æ˜¯ Huggingface çš„ Transformers åŒ…ï¼ŒPyTorchè¡¨ç¤ºåŸç”Ÿçš„ Transformer åŒ…ï¼ŒDeepSpeed è¡¨ç¤ºä½¿ç”¨äº† DeepSpeed ä½œä¸ºæ¨ç†æ¡†æ¶ã€‚Pytorch/DeepSpeed ç›®å‰åŠŸèƒ½éƒ½æ¯”è¾ƒå¼±ï¼Œä¸å…·å¤‡ç”Ÿäº§èƒ½åŠ›ï¼Œä¸æ¨èä½¿ç”¨ã€‚</p>
<p>æ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Turbomind + Bash Local Chat</span><br>lmdeploy chat turbomind ./workspace<br></code></pre></td></tr></table></figure>
<p>å¯åŠ¨åå°±å¯ä»¥å’Œå®ƒè¿›è¡Œå¯¹è¯äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="chat.png"  ><span class="image-caption">ä¸æœ¬åœ°éƒ¨ç½²çš„æ¨¡å‹è¿›è¡Œå¯¹è¯</span></p>
<p>è¾“å…¥åä¸¤æ¬¡å›è½¦ï¼Œé€€å‡ºæ—¶è¾“å…¥<code>exit</code> å›è½¦ä¸¤æ¬¡å³å¯ã€‚æ­¤æ—¶ï¼ŒServer å°±æ˜¯æœ¬åœ°è·‘èµ·æ¥çš„æ¨¡å‹ï¼ˆTurboMindï¼‰ï¼Œå‘½ä»¤è¡Œå¯ä»¥çœ‹ä½œæ˜¯å‰ç«¯ã€‚</p>
<h3 id="2-3-TurboMindæ¨ç†-APIæœåŠ¡"><a href="#2-3-TurboMindæ¨ç†-APIæœåŠ¡" class="headerlink" title="2.3 TurboMindæ¨ç†+APIæœåŠ¡"></a>2.3 TurboMindæ¨ç†+APIæœåŠ¡</h3><p>åœ¨ä¸Šé¢çš„éƒ¨åˆ†æˆ‘ä»¬å°è¯•äº†ç›´æ¥ç”¨å‘½ä»¤è¡Œå¯åŠ¨ Clientï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•å¦‚ä½•è¿ç”¨ lmdepoy è¿›è¡ŒæœåŠ¡åŒ–ã€‚</p>
<p>â€æ¨¡å‹æ¨ç†/æœåŠ¡â€œç›®å‰æä¾›äº† Turbomind å’Œ TritonServer ä¸¤ç§æœåŠ¡åŒ–æ–¹å¼ã€‚æ­¤æ—¶ï¼ŒServer æ˜¯ TurboMind æˆ– TritonServerï¼ŒAPI Server å¯ä»¥æä¾›å¯¹å¤–çš„ API æœåŠ¡ã€‚æˆ‘ä»¬æ¨èä½¿ç”¨ TurboMindï¼ŒTritonServer ä½¿ç”¨æ–¹å¼è¯¦è§ã€Šé™„å½•1ã€‹ã€‚</p>
<p>é¦–å…ˆï¼Œé€šè¿‡ä¸‹é¢å‘½ä»¤å¯åŠ¨æœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ApiServer+Turbomind   api_server =&gt; AsyncEngine =&gt; TurboMind</span><br>lmdeploy serve api_server ./workspace \<br>	--server_name 0.0.0.0 \<br>	--server_port 23333 \<br>	--instance_num 64 \<br>	--tp 1<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å‚æ•°ä¸­ <code>server_name</code> å’Œ <code>server_port</code> åˆ†åˆ«è¡¨ç¤ºæœåŠ¡åœ°å€å’Œç«¯å£ï¼Œ<code>tp</code> å‚æ•°æˆ‘ä»¬ä¹‹å‰å·²ç»æåˆ°è¿‡äº†ï¼Œè¡¨ç¤º Tensor å¹¶è¡Œã€‚è¿˜å‰©ä¸‹ä¸€ä¸ª <code>instance_num</code> å‚æ•°ï¼Œè¡¨ç¤ºå®ä¾‹æ•°ï¼Œå¯ä»¥ç†è§£æˆ Batch çš„å¤§å°ã€‚æ‰§è¡Œåå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="api-deploy.png"  ><span class="image-caption">éƒ¨ç½² api server</span></p>
<p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ–°å¼€ä¸€ä¸ªçª—å£ï¼Œæ‰§è¡Œä¸‹é¢çš„ Client å‘½ä»¤ã€‚å¦‚æœä½¿ç”¨å®˜æ–¹æœºå™¨ï¼Œå¯ä»¥æ‰“å¼€ vscode çš„ Terminalï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ChatApiClient+ApiServerï¼ˆæ³¨æ„æ˜¯httpåè®®ï¼Œéœ€è¦åŠ httpï¼‰</span><br>lmdeploy serve api_client http://localhost:23333<br></code></pre></td></tr></table></figure>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="test-apiserver.png"  ><span class="image-caption">æµ‹è¯• api server</span></p>
<p>å½“ç„¶ï¼Œåˆšåˆšæˆ‘ä»¬å¯åŠ¨çš„æ˜¯ API Serverï¼Œè‡ªç„¶ä¹Ÿæœ‰ç›¸åº”çš„æ¥å£ã€‚å¯ä»¥ç›´æ¥æ‰“å¼€ <code>http://&#123;host&#125;:23333</code> æŸ¥çœ‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="fastapi.png"  ><span class="image-caption">fastapi æ¼”ç¤º</span></p>
<p>è¿™é‡Œä¸€å…±æä¾›äº† 4 ä¸ª HTTP çš„æ¥å£ï¼Œä»»ä½•è¯­è¨€éƒ½å¯ä»¥å¯¹å…¶è¿›è¡Œè°ƒç”¨ï¼Œæˆ‘ä»¬ä»¥ <code>v1/chat/completions</code> æ¥å£ä¸ºä¾‹ï¼Œç®€å•è¯•ä¸€ä¸‹ã€‚</p>
<p>æ¥å£è¯·æ±‚å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;model&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;internlm-chat-7b&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;messages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å†™ä¸€é¦–å†¬å¤©çš„è¯—&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;temperature&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;top_p&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;n&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;max_tokens&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">512</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;stop&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;stream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;presence_penalty&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;frequency_penalty&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;repetition_penalty&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;renew_session&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;ignore_eos&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>è¯·æ±‚ç»“æœå¦‚ä¸‹ã€‚</p>
<p><img  src="test-fastapi.png"  ><span class="image-caption">æµ‹è¯• api</span></p>
<h3 id="2-4-ç½‘é¡µ-Demo-æ¼”ç¤º"><a href="#2-4-ç½‘é¡µ-Demo-æ¼”ç¤º" class="headerlink" title="2.4 ç½‘é¡µ Demo æ¼”ç¤º"></a>2.4 ç½‘é¡µ Demo æ¼”ç¤º</h3><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯å°† Gradio ä½œä¸ºå‰ç«¯ Demo æ¼”ç¤ºã€‚åœ¨ä¸Šä¸€èŠ‚çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬ä¸æ‰§è¡Œåé¢çš„ <code>api_client</code> æˆ– <code>triton_client</code>ï¼Œè€Œæ˜¯æ‰§è¡Œ <code>gradio</code>ã€‚</p>
<h4 id="2-4-1-TurboMind-æœåŠ¡ä½œä¸ºåç«¯"><a href="#2-4-1-TurboMind-æœåŠ¡ä½œä¸ºåç«¯" class="headerlink" title="2.4.1 TurboMind æœåŠ¡ä½œä¸ºåç«¯"></a>2.4.1 TurboMind æœåŠ¡ä½œä¸ºåç«¯</h4><p>API Server çš„å¯åŠ¨å’Œä¸Šä¸€èŠ‚ä¸€æ ·ï¼Œè¿™é‡Œç›´æ¥å¯åŠ¨ä½œä¸ºå‰ç«¯çš„ Gradioã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Gradio+ApiServerã€‚å¿…é¡»å…ˆå¼€å¯ Serverï¼Œæ­¤æ—¶ Gradio ä¸º Client</span><br>lmdeploy serve gradio http://0.0.0.0:23333 \<br>	--server_name 0.0.0.0 \<br>	--server_port 6006 \<br>	--restful_api True<br></code></pre></td></tr></table></figure>
<h4 id="2-4-2-TurboMind-æ¨ç†ä½œä¸ºåç«¯"><a href="#2-4-2-TurboMind-æ¨ç†ä½œä¸ºåç«¯" class="headerlink" title="2.4.2 TurboMind æ¨ç†ä½œä¸ºåç«¯"></a>2.4.2 TurboMind æ¨ç†ä½œä¸ºåç«¯</h4><p>å½“ç„¶ï¼ŒGradio ä¹Ÿå¯ä»¥ç›´æ¥å’Œ TurboMind è¿æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Gradio+Turbomind(local)</span><br>lmdeploy serve gradio ./workspace<br></code></pre></td></tr></table></figure>
<p>å¯ä»¥ç›´æ¥å¯åŠ¨ Gradioï¼Œæ­¤æ—¶æ²¡æœ‰ API Serverï¼ŒTurboMind ç›´æ¥ä¸ Gradio é€šä¿¡ã€‚</p>
<h3 id="2-5-TurboMind-æ¨ç†-Python-ä»£ç é›†æˆ"><a href="#2-5-TurboMind-æ¨ç†-Python-ä»£ç é›†æˆ" class="headerlink" title="2.5 TurboMind æ¨ç† + Python ä»£ç é›†æˆ"></a>2.5 TurboMind æ¨ç† + Python ä»£ç é›†æˆ</h3><p>å‰é¢ä»‹ç»çš„éƒ½æ˜¯é€šè¿‡ API æˆ–æŸç§å‰ç«¯ä¸â€æ¨¡å‹æ¨ç†/æœåŠ¡â€œè¿›è¡Œäº¤äº’ï¼Œlmdeploy è¿˜æ”¯æŒ Python ç›´æ¥ä¸ TurboMind è¿›è¡Œäº¤äº’ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> lmdeploy <span class="hljs-keyword">import</span> turbomind <span class="hljs-keyword">as</span> tm<br><br><span class="hljs-comment"># load model</span><br>model_path = <span class="hljs-string">&quot;/root/share/temp/model_repos/internlm-chat-7b/&quot;</span><br>tm_model = tm.TurboMind.from_pretrained(model_path, model_name=<span class="hljs-string">&#x27;internlm-chat-20b&#x27;</span>)<br>generator = tm_model.create_instance()<br><br><span class="hljs-comment"># process query</span><br>query = <span class="hljs-string">&quot;ä½ å¥½å•Šå…„å˜š&quot;</span><br>prompt = tm_model.model.get_prompt(query)<br>input_ids = tm_model.tokenizer.encode(prompt)<br><br><span class="hljs-comment"># inference</span><br><span class="hljs-keyword">for</span> outputs <span class="hljs-keyword">in</span> generator.stream_infer(<br>        session_id=<span class="hljs-number">0</span>,<br>        input_ids=[input_ids]):<br>    res, tokens = outputs[<span class="hljs-number">0</span>]<br><br>response = tm_model.tokenizer.decode(res.tolist())<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåŠ è½½æ¨¡å‹ï¼Œç„¶åæ„é€ è¾“å…¥ï¼Œæœ€åæ‰§è¡Œæ¨ç†ã€‚</p>
<p>åŠ è½½æ¨¡å‹å¯ä»¥æ˜¾å¼æŒ‡å®šæ¨¡å‹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®š Huggingface çš„ repo_idï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä¸Šé¢ç”Ÿæˆè¿‡çš„ <code>workspace</code>ã€‚è¿™é‡Œçš„ <code>tm.TurboMind</code> å…¶å®æ˜¯å¯¹ C++ TurboMind çš„å°è£…ã€‚</p>
<p>æ„é€ è¾“å…¥è¿™é‡Œä¸»è¦æ˜¯æŠŠç”¨æˆ·çš„ query æ„é€ æˆ InternLLM æ”¯æŒçš„è¾“å…¥æ ¼å¼ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ <code>query</code> æ˜¯â€œä½ å¥½å•Šå…„å˜šâ€ï¼Œæ„é€ å¥½çš„ Prompt å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">&lt;|System|&gt;:You are an AI assistant whose name is InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­).</span><br><span class="hljs-string">- InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) is a conversational language model that is developed by Shanghai AI Laboratory (ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤). It is designed to be helpful, honest, and harmless.</span><br><span class="hljs-string">- InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) can understand and communicate fluently in the language chosen by the user such as English and ä¸­æ–‡.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;|User|&gt;:ä½ å¥½å•Šå…„å˜š</span><br><span class="hljs-string">&lt;|Bot|&gt;:</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>
<p>Prompt å…¶å®å°±æ˜¯å¢åŠ äº† <code>&lt;|System|&gt;</code> æ¶ˆæ¯å’Œ <code>&lt;|User|&gt;</code> æ¶ˆæ¯ï¼ˆå³ç”¨æˆ·çš„ <code>query</code>ï¼‰ï¼Œä»¥åŠä¸€ä¸ª <code>&lt;|Bot|&gt;</code> çš„æ ‡è®°ï¼Œè¡¨ç¤ºæ¥ä¸‹æ¥è¯¥æ¨¡å‹è¾“å‡ºå“åº”äº†ã€‚æœ€ç»ˆè¾“å‡ºçš„å“åº”å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;ä½ å¥½å•Šï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ&quot;</span><br></code></pre></td></tr></table></figure>
<h3 id="2-6-æœ€ä½³å®è·µ"><a href="#2-6-æœ€ä½³å®è·µ" class="headerlink" title="2.6 æœ€ä½³å®è·µ"></a>2.6 æœ€ä½³å®è·µ</h3><h4 id="2-6-1-æ–¹æ¡ˆå®è·µ"><a href="#2-6-1-æ–¹æ¡ˆå®è·µ" class="headerlink" title="2.6.1 æ–¹æ¡ˆå®è·µ"></a>2.6.1 æ–¹æ¡ˆå®è·µ</h4><p>é¦–å…ˆè¯´ â€œæ¨¡å‹æ¨ç†/æœåŠ¡â€ï¼Œæ¨èä½¿ç”¨ TurboMindï¼Œä½¿ç”¨ç®€å•ï¼Œæ€§èƒ½è‰¯å¥½ï¼Œç›¸å…³çš„ Benchmark å¯¹æ¯”å¦‚ä¸‹ã€‚</p>
<p><img  src="benchmark.png"  ><span class="image-caption">Benchmark æ•ˆæœ</span></p>
<p>ä¸Šé¢çš„æ€§èƒ½å¯¹æ¯”åŒ…æ‹¬ä¸¤ä¸ªåœºæ™¯ï¼š</p>
<ul>
<li>åœºæ™¯ä¸€ï¼ˆå‰4å¼ å›¾ï¼‰ï¼šå›ºå®šçš„è¾“å…¥ã€è¾“å‡º token æ•°ï¼ˆåˆ†åˆ«1å’Œ2048ï¼‰ï¼Œæµ‹è¯•Tokenè¾“å‡ºååé‡ï¼ˆoutput token throughputï¼‰ã€‚</li>
<li>åœºæ™¯äºŒï¼ˆç¬¬5å¼ å›¾ï¼‰ï¼šä½¿ç”¨çœŸå®æ•°æ®ï¼Œæµ‹è¯•ååé‡ï¼ˆrequest throughputï¼‰ã€‚</li>
</ul>
<p>åœºæ™¯ä¸€ä¸­ï¼ŒBatchSize=64æ—¶ï¼ŒTurboMind çš„ååé‡è¶…è¿‡ 2000 token/sï¼Œæ•´ä½“æ¯” DeepSpeed æå‡çº¦ 5% - 15%ï¼›BatchSize=32æ—¶ï¼Œæ¯” Huggingface çš„Transformers æå‡çº¦ 3 å€ï¼›å…¶ä»–BatchSizeæ—¶ TurboMind ä¹Ÿè¡¨ç°å‡ºä¼˜å¼‚çš„æ€§èƒ½ã€‚</p>
<p>åœºæ™¯äºŒä¸­ï¼Œå¯¹æ¯”äº† TurboMind å’Œ vLLM åœ¨çœŸå®æ•°æ®ä¸Šçš„ååé‡ï¼ˆrequest throughputï¼‰æŒ‡æ ‡ï¼ŒTurboMind çš„æ•ˆç‡æ¯” vLLM é«˜ 30%ã€‚</p>
<p>å¤§å®¶ä¸å¦¨äº²è‡ªä½¿ç”¨æœ¬åœ°å¯¹è¯ï¼ˆLocal Chatï¼‰æ„Ÿå—ä¸€ä¸‹æ€§èƒ½å·®åˆ«ï¼ˆ2.2 èŠ‚ï¼‰ï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œæˆ‘ä»¬æä¾›çš„ <code>infer_compare.py</code> è„šæœ¬ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ‰§è¡Œ Huggingface çš„ Transformer</span><br>python infer_compare.py hf<br><span class="hljs-comment"># æ‰§è¡ŒLMDeploy</span><br>python infer_compare.py lmdeploy<br></code></pre></td></tr></table></figure>
<p>LMDeployåº”è¯¥æ˜¯Transformersçš„3-5å€å·¦å³ã€‚</p>
<p>åé¢çš„ API æœåŠ¡å’Œ Client å°±å¾—åˆ†åœºæ™¯äº†ã€‚</p>
<ul>
<li>æˆ‘æƒ³å¯¹å¤–æä¾›ç±»ä¼¼ OpenAI é‚£æ ·çš„ HTTP æ¥å£æœåŠ¡ã€‚æ¨èä½¿ç”¨ TurboMindæ¨ç† + API æœåŠ¡ï¼ˆ2.3ï¼‰ã€‚</li>
<li>æˆ‘æƒ³åšä¸€ä¸ªæ¼”ç¤º Demoï¼ŒGradio æ— ç–‘æ˜¯æ¯” Local Chat æ›´å‹å¥½çš„ã€‚æ¨èä½¿ç”¨ TurboMind æ¨ç†ä½œä¸ºåç«¯çš„Gradioè¿›è¡Œæ¼”ç¤ºï¼ˆ2.4.2ï¼‰ã€‚</li>
<li>æˆ‘æƒ³ç›´æ¥åœ¨è‡ªå·±çš„ Python é¡¹ç›®ä¸­ä½¿ç”¨å¤§æ¨¡å‹åŠŸèƒ½ã€‚æ¨èä½¿ç”¨ TurboMindæ¨ç† + Pythonï¼ˆ2.5ï¼‰ã€‚</li>
<li>æˆ‘æƒ³åœ¨è‡ªå·±çš„å…¶ä»–é Python é¡¹ç›®ä¸­ä½¿ç”¨å¤§æ¨¡å‹åŠŸèƒ½ã€‚æ¨èç›´æ¥é€šè¿‡ HTTP æ¥å£è°ƒç”¨æœåŠ¡ã€‚ä¹Ÿå°±æ˜¯ç”¨æœ¬åˆ—è¡¨ç¬¬ä¸€æ¡å…ˆå¯åŠ¨ä¸€ä¸ª HTTP API æœåŠ¡ï¼Œç„¶ååœ¨é¡¹ç›®ä¸­ç›´æ¥è°ƒç”¨æ¥å£ã€‚</li>
</ul>
<h4 id="2-6-2-æ¨¡å‹é…ç½®å®è·µ"><a href="#2-6-2-æ¨¡å‹é…ç½®å®è·µ" class="headerlink" title="2.6.2 æ¨¡å‹é…ç½®å®è·µ"></a>2.6.2 æ¨¡å‹é…ç½®å®è·µ</h4><p>ä¸çŸ¥é“å¤§å®¶è¿˜æœ‰æ²¡æœ‰å°è±¡ï¼Œåœ¨ç¦»çº¿è½¬æ¢ï¼ˆ2.1.2ï¼‰ä¸€èŠ‚ï¼Œæˆ‘ä»¬æŸ¥çœ‹äº† <code>weights</code> çš„ç›®å½•ï¼Œé‡Œé¢å­˜æ”¾çš„æ˜¯æ¨¡å‹æŒ‰å±‚ã€æŒ‰å¹¶è¡Œå¡æ‹†åˆ†çš„å‚æ•°ï¼Œä¸è¿‡è¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶ <code>config.ini</code> å¹¶ä¸æ˜¯æ¨¡å‹å‚æ•°ï¼Œå®ƒé‡Œé¢å­˜çš„ä¸»è¦æ˜¯æ¨¡å‹ç›¸å…³çš„é…ç½®ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ã€‚</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[llama]</span><br><span class="hljs-attr">model_name</span> = internlm-chat-<span class="hljs-number">7</span>b<br><span class="hljs-attr">tensor_para_size</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">head_num</span> = <span class="hljs-number">32</span><br><span class="hljs-attr">kv_head_num</span> = <span class="hljs-number">32</span><br><span class="hljs-attr">vocab_size</span> = <span class="hljs-number">103168</span><br><span class="hljs-attr">num_layer</span> = <span class="hljs-number">32</span><br><span class="hljs-attr">inter_size</span> = <span class="hljs-number">11008</span><br><span class="hljs-attr">norm_eps</span> = <span class="hljs-number">1</span>e-<span class="hljs-number">06</span><br><span class="hljs-attr">attn_bias</span> = <span class="hljs-number">0</span><br><span class="hljs-attr">start_id</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">end_id</span> = <span class="hljs-number">2</span><br><span class="hljs-attr">session_len</span> = <span class="hljs-number">2056</span><br><span class="hljs-attr">weight_type</span> = fp16<br><span class="hljs-attr">rotary_embedding</span> = <span class="hljs-number">128</span><br><span class="hljs-attr">rope_theta</span> = <span class="hljs-number">10000.0</span><br><span class="hljs-attr">size_per_head</span> = <span class="hljs-number">128</span><br><span class="hljs-attr">group_size</span> = <span class="hljs-number">0</span><br><span class="hljs-attr">max_batch_size</span> = <span class="hljs-number">64</span><br><span class="hljs-attr">max_context_token_num</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">step_length</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">cache_max_entry_count</span> = <span class="hljs-number">0.5</span><br><span class="hljs-attr">cache_block_seq_len</span> = <span class="hljs-number">128</span><br><span class="hljs-attr">cache_chunk_size</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">use_context_fmha</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">quant_policy</span> = <span class="hljs-number">0</span><br><span class="hljs-attr">max_position_embeddings</span> = <span class="hljs-number">2048</span><br><span class="hljs-attr">rope_scaling_factor</span> = <span class="hljs-number">0.0</span><br><span class="hljs-attr">use_logn_attn</span> = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œæ¨¡å‹å±æ€§ç›¸å…³çš„å‚æ•°ä¸å¯æ›´æ”¹ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢è¿™äº›ã€‚</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">model_name</span> = llama2<br><span class="hljs-attr">head_num</span> = <span class="hljs-number">32</span><br><span class="hljs-attr">kv_head_num</span> = <span class="hljs-number">32</span><br><span class="hljs-attr">vocab_size</span> = <span class="hljs-number">103168</span><br><span class="hljs-attr">num_layer</span> = <span class="hljs-number">32</span><br><span class="hljs-attr">inter_size</span> = <span class="hljs-number">11008</span><br><span class="hljs-attr">norm_eps</span> = <span class="hljs-number">1</span>e-<span class="hljs-number">06</span><br><span class="hljs-attr">attn_bias</span> = <span class="hljs-number">0</span><br><span class="hljs-attr">start_id</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">end_id</span> = <span class="hljs-number">2</span><br><span class="hljs-attr">rotary_embedding</span> = <span class="hljs-number">128</span><br><span class="hljs-attr">rope_theta</span> = <span class="hljs-number">10000.0</span><br><span class="hljs-attr">size_per_head</span> = <span class="hljs-number">128</span><br></code></pre></td></tr></table></figure>
<p>å’Œæ•°æ®ç±»å‹ç›¸å…³çš„å‚æ•°ä¹Ÿä¸å¯æ›´æ”¹ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªã€‚</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">weight_type</span> = fp16<br><span class="hljs-attr">group_size</span> = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p><code>weight_type</code> è¡¨ç¤ºæƒé‡çš„æ•°æ®ç±»å‹ã€‚ç›®å‰æ”¯æŒ fp16 å’Œ int4ã€‚int4 è¡¨ç¤º 4bit æƒé‡ã€‚å½“ <code>weight_type</code> ä¸º 4bit æƒé‡æ—¶ï¼Œ<code>group_size</code> è¡¨ç¤º <code>awq</code> é‡åŒ–æƒé‡æ—¶ä½¿ç”¨çš„ group å¤§å°ã€‚</p>
<p>å‰©ä½™å‚æ•°åŒ…æ‹¬ä¸‹é¢å‡ ä¸ªã€‚</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">tensor_para_size</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">session_len</span> = <span class="hljs-number">2056</span><br><span class="hljs-attr">max_batch_size</span> = <span class="hljs-number">64</span><br><span class="hljs-attr">max_context_token_num</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">step_length</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">cache_max_entry_count</span> = <span class="hljs-number">0.5</span><br><span class="hljs-attr">cache_block_seq_len</span> = <span class="hljs-number">128</span><br><span class="hljs-attr">cache_chunk_size</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">use_context_fmha</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">quant_policy</span> = <span class="hljs-number">0</span><br><span class="hljs-attr">max_position_embeddings</span> = <span class="hljs-number">2048</span><br><span class="hljs-attr">rope_scaling_factor</span> = <span class="hljs-number">0.0</span><br><span class="hljs-attr">use_logn_attn</span> = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å¯¹è¿™äº›å‚æ•°è¿›è¡Œä¿®æ”¹ï¼Œä½†æœ‰æ—¶å€™ä¸ºäº†æ»¡è¶³ç‰¹å®šéœ€è¦ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å…¶ä¸­ä¸€éƒ¨åˆ†é…ç½®å€¼ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸‰ä¸ªå¯èƒ½éœ€è¦è°ƒæ•´çš„å‚æ•°ã€‚</p>
<ul>
<li>KV int8 å¼€å…³ï¼š<ul>
<li>å¯¹åº”å‚æ•°ä¸º <code>quant_policy</code>ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œè¡¨ç¤ºä¸ä½¿ç”¨ KV Cacheï¼Œå¦‚æœéœ€è¦å¼€å¯ï¼Œåˆ™å°†è¯¥å‚æ•°è®¾ç½®ä¸º 4ã€‚</li>
<li>KV Cache æ˜¯å¯¹åºåˆ—ç”Ÿæˆè¿‡ç¨‹ä¸­çš„ K å’Œ V è¿›è¡Œé‡åŒ–ï¼Œç”¨ä»¥èŠ‚çœæ˜¾å­˜ã€‚æˆ‘ä»¬ä¸‹ä¸€éƒ¨åˆ†ä¼šä»‹ç»å…·ä½“çš„é‡åŒ–è¿‡ç¨‹ã€‚</li>
<li>å½“æ˜¾å­˜ä¸è¶³ï¼Œæˆ–åºåˆ—æ¯”è¾ƒé•¿æ—¶ï¼Œå»ºè®®æ‰“å¼€æ­¤å¼€å…³ã€‚</li>
</ul>
</li>
<li>å¤–æ¨èƒ½åŠ›å¼€å…³ï¼š<ul>
<li>å¯¹åº”å‚æ•°ä¸º <code>rope_scaling_factor</code>ï¼Œé»˜è®¤å€¼ä¸º 0.0ï¼Œè¡¨ç¤ºä¸å…·å¤‡å¤–æ¨èƒ½åŠ›ï¼Œè®¾ç½®ä¸º 1.0ï¼Œå¯ä»¥å¼€å¯ RoPE çš„ Dynamic NTK åŠŸèƒ½ï¼Œæ”¯æŒé•¿æ–‡æœ¬æ¨ç†ã€‚å¦å¤–ï¼Œ<code>use_logn_attn</code> å‚æ•°è¡¨ç¤º Attention ç¼©æ”¾ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œå¦‚æœè¦å¼€å¯ï¼Œå¯ä»¥å°†å…¶æ”¹ä¸º 1ã€‚</li>
<li>å¤–æ¨èƒ½åŠ›æ˜¯æŒ‡æ¨ç†æ—¶ä¸Šä¸‹æ–‡çš„é•¿åº¦è¶…è¿‡è®­ç»ƒæ—¶çš„æœ€å¤§é•¿åº¦æ—¶æ¨¡å‹ç”Ÿæˆçš„èƒ½åŠ›ã€‚å¦‚æœæ²¡æœ‰å¤–æ¨èƒ½åŠ›ï¼Œå½“æ¨ç†æ—¶ä¸Šä¸‹æ–‡é•¿åº¦è¶…è¿‡è®­ç»ƒæ—¶çš„æœ€å¤§é•¿åº¦ï¼Œæ•ˆæœä¼šæ€¥å‰§ä¸‹é™ã€‚ç›¸åï¼Œåˆ™ä¸‹é™ä¸é‚£ä¹ˆæ˜æ˜¾ï¼Œå½“ç„¶å¦‚æœè¶…å‡ºå¤ªå¤šï¼Œæ•ˆæœä¹Ÿä¼šä¸‹é™çš„å‰å®³ã€‚</li>
<li>å½“æ¨ç†æ–‡æœ¬éå¸¸é•¿ï¼ˆæ˜æ˜¾è¶…è¿‡äº†è®­ç»ƒæ—¶çš„æœ€å¤§é•¿åº¦ï¼‰æ—¶ï¼Œå»ºè®®å¼€å¯å¤–æ¨èƒ½åŠ›ã€‚</li>
</ul>
</li>
<li>æ‰¹å¤„ç†å¤§å°ï¼š<ul>
<li>å¯¹åº”å‚æ•°ä¸º <code>max_batch_size</code>ï¼Œé»˜è®¤ä¸º 64ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ API Server å¯åŠ¨æ—¶çš„ <code>instance_num</code> å‚æ•°ã€‚</li>
<li>è¯¥å‚æ•°å€¼è¶Šå¤§ï¼Œååº¦é‡è¶Šå¤§ï¼ˆåŒæ—¶æ¥å—çš„è¯·æ±‚æ•°ï¼‰ï¼Œä½†ä¹Ÿä¼šå ç”¨æ›´å¤šæ˜¾å­˜ã€‚</li>
<li>å»ºè®®æ ¹æ®è¯·æ±‚é‡å’Œæœ€å¤§çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼ŒæŒ‰å®é™…æƒ…å†µè°ƒæ•´ã€‚</li>
</ul>
</li>
</ul>
<h2 id="3-æ¨¡å‹é‡åŒ–"><a href="#3-æ¨¡å‹é‡åŒ–" class="headerlink" title="3 æ¨¡å‹é‡åŒ–"></a>3 æ¨¡å‹é‡åŒ–</h2><p>æœ¬éƒ¨åˆ†å†…å®¹ä¸»è¦ä»‹ç»å¦‚ä½•å¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–ã€‚ä¸»è¦åŒ…æ‹¬ KV Cache é‡åŒ–å’Œæ¨¡å‹å‚æ•°é‡åŒ–ã€‚æ€»çš„æ¥è¯´ï¼Œé‡åŒ–æ˜¯ä¸€ç§ä»¥å‚æ•°æˆ–è®¡ç®—ä¸­é—´ç»“æœç²¾åº¦ä¸‹é™æ¢ç©ºé—´èŠ‚çœï¼ˆä»¥åŠåŒæ—¶å¸¦æ¥çš„æ€§èƒ½æå‡ï¼‰çš„ç­–ç•¥ã€‚</p>
<p>æ­£å¼ä»‹ç» LMDeploy é‡åŒ–æ–¹æ¡ˆå‰ï¼Œéœ€è¦å…ˆä»‹ç»ä¸¤ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>è®¡ç®—å¯†é›†ï¼ˆcompute-boundï¼‰: æŒ‡æ¨ç†è¿‡ç¨‹ä¸­ï¼Œç»å¤§éƒ¨åˆ†æ—¶é—´æ¶ˆè€—åœ¨æ•°å€¼è®¡ç®—ä¸Šï¼›é’ˆå¯¹è®¡ç®—å¯†é›†å‹åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨æ›´å¿«çš„ç¡¬ä»¶è®¡ç®—å•å…ƒæ¥æå‡è®¡ç®—é€Ÿã€‚</li>
<li>è®¿å­˜å¯†é›†ï¼ˆmemory-boundï¼‰: æŒ‡æ¨ç†è¿‡ç¨‹ä¸­ï¼Œç»å¤§éƒ¨åˆ†æ—¶é—´æ¶ˆè€—åœ¨æ•°æ®è¯»å–ä¸Šï¼›é’ˆå¯¹è®¿å­˜å¯†é›†å‹åœºæ™¯ï¼Œä¸€èˆ¬é€šè¿‡å‡å°‘è®¿å­˜æ¬¡æ•°ã€æé«˜è®¡ç®—è®¿å­˜æ¯”æˆ–é™ä½è®¿å­˜é‡æ¥ä¼˜åŒ–ã€‚</li>
</ul>
<p>å¸¸è§çš„ LLM æ¨¡å‹ç”±äº Decoder Only æ¶æ„çš„ç‰¹æ€§ï¼Œå®é™…æ¨ç†æ—¶å¤§å¤šæ•°çš„æ—¶é—´éƒ½æ¶ˆè€—åœ¨äº†é€ Token ç”Ÿæˆé˜¶æ®µï¼ˆDecoding é˜¶æ®µï¼‰ï¼Œæ˜¯å…¸å‹çš„è®¿å­˜å¯†é›†å‹åœºæ™¯ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•ä¼˜åŒ– LLM æ¨¡å‹æ¨ç†ä¸­çš„è®¿å­˜å¯†é›†é—®é¢˜å‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong>KV Cache é‡åŒ–</strong>å’Œ <strong>4bit Weight Only é‡åŒ–ï¼ˆW4A16ï¼‰</strong>ã€‚KV Cache é‡åŒ–æ˜¯æŒ‡å°†é€ Tokenï¼ˆDecodingï¼‰ç”Ÿæˆè¿‡ç¨‹ä¸­çš„ä¸Šä¸‹æ–‡ K å’Œ V ä¸­é—´ç»“æœè¿›è¡Œ INT8 é‡åŒ–ï¼ˆè®¡ç®—æ—¶å†åé‡åŒ–ï¼‰ï¼Œä»¥é™ä½ç”Ÿæˆè¿‡ç¨‹ä¸­çš„æ˜¾å­˜å ç”¨ã€‚4bit Weight é‡åŒ–ï¼Œå°† FP16 çš„æ¨¡å‹æƒé‡é‡åŒ–ä¸º INT4ï¼ŒKernel è®¡ç®—æ—¶ï¼Œè®¿å­˜é‡ç›´æ¥é™ä¸º FP16 æ¨¡å‹çš„ 1/4ï¼Œå¤§å¹…é™ä½äº†è®¿å­˜æˆæœ¬ã€‚Weight Only æ˜¯æŒ‡ä»…é‡åŒ–æƒé‡ï¼Œæ•°å€¼è®¡ç®—ä¾ç„¶é‡‡ç”¨ FP16ï¼ˆéœ€è¦å°† INT4 æƒé‡åé‡åŒ–ï¼‰ã€‚</p>
<h3 id="3-1-KV-Cache-é‡åŒ–"><a href="#3-1-KV-Cache-é‡åŒ–" class="headerlink" title="3.1 KV Cache é‡åŒ–"></a>3.1 KV Cache é‡åŒ–</h3><h4 id="3-1-1-é‡åŒ–æ­¥éª¤"><a href="#3-1-1-é‡åŒ–æ­¥éª¤" class="headerlink" title="3.1.1 é‡åŒ–æ­¥éª¤"></a>3.1.1 é‡åŒ–æ­¥éª¤</h4><p>KV Cache é‡åŒ–æ˜¯å°†å·²ç»ç”Ÿæˆåºåˆ—çš„ KV å˜æˆ Int8ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸€å…±åŒ…æ‹¬ä¸‰æ­¥ï¼š</p>
<p>ç¬¬ä¸€æ­¥ï¼šè®¡ç®— minmaxã€‚ä¸»è¦æ€è·¯æ˜¯é€šè¿‡è®¡ç®—ç»™å®šè¾“å…¥æ ·æœ¬åœ¨æ¯ä¸€å±‚ä¸åŒä½ç½®å¤„è®¡ç®—ç»“æœçš„ç»Ÿè®¡æƒ…å†µã€‚</p>
<ul>
<li>å¯¹äº Attention çš„ K å’Œ Vï¼šå–æ¯ä¸ª Head å„è‡ªç»´åº¦åœ¨æ‰€æœ‰Tokençš„æœ€å¤§ã€æœ€å°å’Œç»å¯¹å€¼æœ€å¤§å€¼ã€‚å¯¹æ¯ä¸€å±‚æ¥è¯´ï¼Œä¸Šé¢ä¸‰ç»„å€¼éƒ½æ˜¯ <code>(num_heads, head_dim)</code> çš„çŸ©é˜µã€‚è¿™é‡Œçš„ç»Ÿè®¡ç»“æœå°†ç”¨äºæœ¬å°èŠ‚çš„ KV Cacheã€‚</li>
<li>å¯¹äºæ¨¡å‹æ¯å±‚çš„è¾“å…¥ï¼šå–å¯¹åº”ç»´åº¦çš„æœ€å¤§ã€æœ€å°ã€å‡å€¼ã€ç»å¯¹å€¼æœ€å¤§å’Œç»å¯¹å€¼å‡å€¼ã€‚æ¯ä¸€å±‚æ¯ä¸ªä½ç½®çš„è¾“å…¥éƒ½æœ‰å¯¹åº”çš„ç»Ÿè®¡å€¼ï¼Œå®ƒä»¬å¤§å¤šæ˜¯ <code>(hidden_dim, )</code> çš„ä¸€ç»´å‘é‡ï¼Œå½“ç„¶åœ¨ FFN å±‚ç”±äºç»“æ„æ˜¯å…ˆå˜å®½åæ¢å¤ï¼Œå› æ­¤æ¢å¤çš„ä½ç½®ç»´åº¦å¹¶ä¸ç›¸åŒã€‚è¿™é‡Œçš„ç»Ÿè®¡ç»“æœç”¨äºä¸‹ä¸ªå°èŠ‚çš„æ¨¡å‹å‚æ•°é‡åŒ–ï¼Œä¸»è¦ç”¨åœ¨ç¼©æ”¾ç¯èŠ‚ï¼ˆå›é¡¾PPTå†…å®¹ï¼‰ã€‚</li>
</ul>
<p>ç¬¬ä¸€æ­¥æ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è®¡ç®— minmax</span><br>lmdeploy lite calibrate \<br>  --model  /root/share/temp/model_repos/internlm-chat-7b/ \<br>  --calib_dataset <span class="hljs-string">&quot;c4&quot;</span> \<br>  --calib_samples 128 \<br>  --calib_seqlen 2048 \<br>  --work_dir ./quant_output<br></code></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªå‘½ä»¤è¡Œä¸­ï¼Œä¼šé€‰æ‹© 128 æ¡è¾“å…¥æ ·æœ¬ï¼Œæ¯æ¡æ ·æœ¬é•¿åº¦ä¸º 2048ï¼Œæ•°æ®é›†é€‰æ‹© C4ï¼Œè¾“å…¥æ¨¡å‹åå°±ä¼šå¾—åˆ°ä¸Šé¢çš„å„ç§ç»Ÿè®¡å€¼ã€‚å€¼å¾—è¯´æ˜çš„æ˜¯ï¼Œå¦‚æœæ˜¾å­˜ä¸è¶³ï¼Œå¯ä»¥é€‚å½“è°ƒå° samples çš„æ•°é‡æˆ– sample çš„é•¿åº¦ã€‚</p>
<blockquote>
<p>è¿™ä¸€æ­¥ç”±äºé»˜è®¤éœ€è¦ä» Huggingface ä¸‹è½½æ•°æ®é›†ï¼Œå›½å†…ç»å¸¸ä¸æˆåŠŸã€‚æ‰€ä»¥æˆ‘ä»¬å¯¼å‡ºäº†éœ€è¦çš„æ•°æ®ï¼Œå¤§å®¶éœ€è¦å¯¹è¯»å–æ•°æ®é›†çš„ä»£ç æ–‡ä»¶åšä¸€ä¸‹æ›¿æ¢ã€‚å…±åŒ…æ‹¬ä¸¤æ­¥ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼šå¤åˆ¶ <code>calib_dataloader.py</code> åˆ°å®‰è£…ç›®å½•æ›¿æ¢è¯¥æ–‡ä»¶ï¼š<code>cp /root/share/temp/datasets/c4/calib_dataloader.py  /root/.conda/envs/lmdeploy/lib/python3.10/site-packages/lmdeploy/lite/utils/</code></li>
<li>ç¬¬äºŒæ­¥ï¼šå°†ç”¨åˆ°çš„æ•°æ®é›†ï¼ˆc4ï¼‰å¤åˆ¶åˆ°ä¸‹é¢çš„ç›®å½•ï¼š<code>cp -r /root/share/temp/datasets/c4/ /root/.cache/huggingface/datasets/</code> </li>
</ul>
</blockquote>
<p>ç¬¬äºŒæ­¥ï¼šé€šè¿‡ minmax è·å–é‡åŒ–å‚æ•°ã€‚ä¸»è¦å°±æ˜¯åˆ©ç”¨ä¸‹é¢è¿™ä¸ªå…¬å¼ï¼Œè·å–æ¯ä¸€å±‚çš„ K V ä¸­å¿ƒå€¼ï¼ˆzpï¼‰å’Œç¼©æ”¾å€¼ï¼ˆscaleï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">zp = (min+max) / 2<br>scale = (max-min) / 255<br>quant: q = round( (f-zp) / scale)<br>dequant: f = q * scale + zp<br></code></pre></td></tr></table></figure>
<p>æœ‰è¿™ä¸¤ä¸ªå€¼å°±å¯ä»¥è¿›è¡Œé‡åŒ–å’Œè§£é‡åŒ–æ“ä½œäº†ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å¯¹å†å²çš„ K å’Œ V å­˜å‚¨ quant åçš„å€¼ï¼Œä½¿ç”¨æ—¶åœ¨ dequantã€‚</p>
<p>ç¬¬äºŒæ­¥çš„æ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é€šè¿‡ minmax è·å–é‡åŒ–å‚æ•°</span><br>lmdeploy lite kv_qparams \<br>  --work_dir ./quant_output  \<br>  --turbomind_dir workspace/triton_models/weights/ \<br>  --kv_sym False \<br>  --num_tp 1<br></code></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªå‘½ä»¤ä¸­ï¼Œ<code>num_tp</code> çš„å«ä¹‰å‰é¢ä»‹ç»è¿‡ï¼Œè¡¨ç¤º Tensor çš„å¹¶è¡Œæ•°ã€‚æ¯ä¸€å±‚çš„ä¸­å¿ƒå€¼å’Œç¼©æ”¾å€¼ä¼šå­˜å‚¨åˆ° <code>workspace</code> çš„å‚æ•°ç›®å½•ä¸­ä»¥ä¾¿åç»­ä½¿ç”¨ã€‚<code>kv_sym</code> ä¸º <code>True</code> æ—¶ä¼šä½¿ç”¨å¦ä¸€ç§ï¼ˆå¯¹ç§°ï¼‰é‡åŒ–æ–¹æ³•ï¼Œå®ƒç”¨åˆ°äº†ç¬¬ä¸€æ­¥å­˜å‚¨çš„ç»å¯¹å€¼æœ€å¤§å€¼ï¼Œè€Œä¸æ˜¯æœ€å¤§å€¼å’Œæœ€å°å€¼ã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹é…ç½®ã€‚ä¹Ÿå°±æ˜¯ä¿®æ”¹ <code>weights/config.ini</code> æ–‡ä»¶ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨ã€Š2.6.2 æ¨¡å‹é…ç½®å®è·µã€‹ä¸­å·²ç»æåˆ°è¿‡äº†ï¼ˆKV int8 å¼€å…³ï¼‰ï¼Œåªéœ€è¦æŠŠ <code>quant_policy</code> æ”¹ä¸º 4 å³å¯ã€‚</p>
<p>è¿™ä¸€æ­¥éœ€è¦é¢å¤–è¯´æ˜çš„æ˜¯ï¼Œå¦‚æœç”¨çš„æ˜¯ TurboMind1.0ï¼Œè¿˜éœ€è¦ä¿®æ”¹å‚æ•° <code>use_context_fmha</code>ï¼Œå°†å…¶æ”¹ä¸º 0ã€‚</p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥æ­£å¸¸è¿è¡Œå‰é¢çš„å„ç§æœåŠ¡äº†ï¼Œåªä¸è¿‡å’±ä»¬ç°åœ¨å¯æ˜¯ç”¨ä¸Šäº† KV Cache é‡åŒ–ï¼Œèƒ½æ›´çœï¼ˆè¿è¡Œæ—¶ï¼‰æ˜¾å­˜äº†ã€‚</p>
<h4 id="3-1-2-é‡åŒ–æ•ˆæœ"><a href="#3-1-2-é‡åŒ–æ•ˆæœ" class="headerlink" title="3.1.2 é‡åŒ–æ•ˆæœ"></a>3.1.2 é‡åŒ–æ•ˆæœ</h4><p>å®˜æ–¹ç»™å‡ºäº† <a href="https://huggingface.co/internlm/internlm-chat-7b">internlm-chat-7b</a> æ¨¡å‹åœ¨ KV Cache é‡åŒ–å‰åçš„æ˜¾å­˜å¯¹æ¯”æƒ…å†µï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>batch_size</th>
<th>fp16 memory(MiB)</th>
<th>int8 memory(MiB)</th>
<th>diff(MiB)</th>
</tr>
</thead>
<tbody>
<tr>
<td>8</td>
<td>22337</td>
<td>18241</td>
<td>-4096</td>
</tr>
<tr>
<td>16</td>
<td>30593</td>
<td>22369</td>
<td>-8224</td>
</tr>
<tr>
<td>32</td>
<td>47073</td>
<td>30625</td>
<td>-16448</td>
</tr>
<tr>
<td>48</td>
<td>63553</td>
<td>38881</td>
<td>-24672</td>
</tr>
</tbody>
</table>
</div>
<p>å¯ä»¥çœ‹å‡ºï¼ŒKV Cache å¯ä»¥èŠ‚çº¦å¤§çº¦ 20% çš„æ˜¾å­˜ã€‚</p>
<p>åŒæ—¶ï¼Œè¿˜åœ¨ <a href="https://github.com/open-compass/opencompass">opencompass</a> å¹³å°ä¸Šæµ‹è¯•äº†é‡åŒ–å‰åçš„ç²¾å‡†åº¦ï¼ˆAccuracyï¼‰å¯¹æ¯”æƒ…å†µï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>task</th>
<th>dataset</th>
<th>metric</th>
<th>int8</th>
<th>fp16</th>
<th>diff</th>
</tr>
</thead>
<tbody>
<tr>
<td>Language</td>
<td>winogrande</td>
<td>accuracy</td>
<td>60.77</td>
<td>61.48</td>
<td>-0.71</td>
</tr>
<tr>
<td>Knowledge</td>
<td>nq</td>
<td>score</td>
<td>2.69</td>
<td>2.60</td>
<td>+0.09</td>
</tr>
<tr>
<td>Reasoning</td>
<td>gsm8k</td>
<td>accuracy</td>
<td>33.28</td>
<td>34.72</td>
<td>-1.44</td>
</tr>
<tr>
<td>Reasoning</td>
<td>bbh</td>
<td>naive_average</td>
<td>20.12</td>
<td>20.51</td>
<td>-0.39</td>
</tr>
<tr>
<td>Understanding</td>
<td>openbookqa_fact</td>
<td>accuracy</td>
<td>82.40</td>
<td>82.20</td>
<td>+0.20</td>
</tr>
<tr>
<td>Understanding</td>
<td>eprstmt-dev</td>
<td>accuracy</td>
<td>90.62</td>
<td>88.75</td>
<td>+1.87</td>
</tr>
<tr>
<td>Safety</td>
<td>crows_pairs</td>
<td>accuracy</td>
<td>32.56</td>
<td>31.43</td>
<td>+1.13</td>
</tr>
</tbody>
</table>
</div>
<p>å¯ä»¥çœ‹å‡ºï¼Œç²¾åº¦ä¸ä»…æ²¡æœ‰æ˜æ˜¾ä¸‹é™ï¼Œç›¸ååœ¨ä¸å°‘ä»»åŠ¡ä¸Šè¿˜æœ‰ä¸€å®šçš„æå‡ã€‚å¯èƒ½çš„åŸå› æ˜¯ï¼Œé‡åŒ–ä¼šå¯¼è‡´ä¸€å®šçš„è¯¯å·®ï¼Œæœ‰æ—¶å€™è¿™ç§è¯¯å·®å¯èƒ½ä¼šå‡å°‘æ¨¡å‹å¯¹è®­ç»ƒæ•°æ®çš„æ‹Ÿåˆï¼Œä»è€Œæé«˜æ³›åŒ–æ€§èƒ½ã€‚é‡åŒ–å¯ä»¥è¢«è§†ä¸ºå¼•å…¥è½»å¾®å™ªå£°çš„æ­£åˆ™åŒ–æ–¹æ³•ã€‚æˆ–è€…ï¼Œä¹Ÿæœ‰å¯èƒ½é‡åŒ–åçš„æ¨¡å‹æ­£å¥½å¯¹æŸäº›æ•°æ®é›†å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼ŒKV Cache é‡åŒ–æ—¢èƒ½æ˜æ˜¾é™ä½æ˜¾å­˜å ç”¨ï¼Œè¿˜æœ‰å¯èƒ½åŒæ—¶å¸¦æ¥ç²¾å‡†åº¦ï¼ˆAccuracyï¼‰çš„æå‡ã€‚</p>
<h3 id="3-2-W4A16-é‡åŒ–"><a href="#3-2-W4A16-é‡åŒ–" class="headerlink" title="3.2 W4A16 é‡åŒ–"></a>3.2 W4A16 é‡åŒ–</h3><h4 id="3-2-1-é‡åŒ–æ­¥éª¤"><a href="#3-2-1-é‡åŒ–æ­¥éª¤" class="headerlink" title="3.2.1 é‡åŒ–æ­¥éª¤"></a>3.2.1 é‡åŒ–æ­¥éª¤</h4><p>W4A16ä¸­çš„Aæ˜¯æŒ‡Activationï¼Œä¿æŒFP16ï¼Œåªå¯¹å‚æ•°è¿›è¡Œ 4bit é‡åŒ–ã€‚ä½¿ç”¨è¿‡ç¨‹ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸‰æ­¥ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šåŒ 3.1.1ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šé‡åŒ–æƒé‡æ¨¡å‹ã€‚åˆ©ç”¨ç¬¬ä¸€æ­¥å¾—åˆ°çš„ç»Ÿè®¡å€¼å¯¹å‚æ•°è¿›è¡Œé‡åŒ–ï¼Œå…·ä½“åˆåŒ…æ‹¬ä¸¤å°æ­¥ï¼š</p>
<ul>
<li>ç¼©æ”¾å‚æ•°ã€‚ä¸»è¦æ˜¯æ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼ˆå›é¡¾ PPTï¼‰ã€‚</li>
<li>æ•´ä½“é‡åŒ–ã€‚</li>
</ul>
<p>ç¬¬äºŒæ­¥çš„æ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é‡åŒ–æƒé‡æ¨¡å‹</span><br>lmdeploy lite auto_awq \<br>  --model  /root/share/temp/model_repos/internlm-chat-7b/ \<br>  --w_bits 4 \<br>  --w_group_size 128 \<br>  --work_dir ./quant_output<br></code></pre></td></tr></table></figure>
<p>å‘½ä»¤ä¸­ <code>w_bits</code> è¡¨ç¤ºé‡åŒ–çš„ä½æ•°ï¼Œ<code>w_group_size</code> è¡¨ç¤ºé‡åŒ–åˆ†ç»„ç»Ÿè®¡çš„å°ºå¯¸ï¼Œ<code>work_dir</code> æ˜¯é‡åŒ–åæ¨¡å‹è¾“å‡ºçš„ä½ç½®ã€‚è¿™é‡Œéœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œå› ä¸ºæ²¡æœ‰ <code>torch.int4</code>ï¼Œæ‰€ä»¥å®é™…å­˜å‚¨æ—¶ï¼Œ8ä¸ª 4bit æƒé‡ä¼šè¢«æ‰“åŒ…åˆ°ä¸€ä¸ª int32 å€¼ä¸­ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æŠŠè¿™éƒ¨åˆ†é‡åŒ–åçš„å‚æ•°åŠ è½½è¿›æ¥å°±ä¼šå‘ç°å®ƒä»¬æ˜¯ int32 ç±»å‹çš„ã€‚</p>
<p>æœ€åä¸€æ­¥ï¼šè½¬æ¢æˆ TurboMind æ ¼å¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è½¬æ¢æ¨¡å‹çš„layoutï¼Œå­˜æ”¾åœ¨é»˜è®¤è·¯å¾„ ./workspace ä¸‹</span><br>lmdeploy convert  internlm-chat-7b ./quant_output \<br>    --model-format awq \<br>    --group-size 128<br></code></pre></td></tr></table></figure>
<p>è¿™ä¸ª <code>group-size</code> å°±æ˜¯ä¸Šä¸€æ­¥çš„é‚£ä¸ª <code>w_group_size</code>ã€‚å¦‚æœä¸æƒ³å’Œä¹‹å‰çš„ <code>workspace</code> é‡å¤ï¼Œå¯ä»¥æŒ‡å®šè¾“å‡ºç›®å½•ï¼š<code>--dst_path</code>ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lmdeploy convert  internlm-chat-7b ./quant_output \<br>    --model-format awq \<br>    --group-size 128 \<br>    --dst_path ./workspace_quant<br></code></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å’Œä¸Šä¸€èŠ‚ä¸€æ ·ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œå‰é¢çš„å„ç§æœåŠ¡äº†ï¼Œä¸è¿‡å’±ä»¬ç°åœ¨ç”¨çš„æ˜¯é‡åŒ–åçš„æ¨¡å‹ã€‚</p>
<p>æœ€åå†è¡¥å……ä¸€ç‚¹ï¼Œé‡åŒ–æ¨¡å‹å’Œ KV Cache é‡åŒ–ä¹Ÿå¯ä»¥ä¸€èµ·ä½¿ç”¨ï¼Œä»¥è¾¾åˆ°æœ€å¤§é™åº¦èŠ‚çœæ˜¾å­˜ã€‚</p>
<h4 id="3-2-2-é‡åŒ–æ•ˆæœ"><a href="#3-2-2-é‡åŒ–æ•ˆæœ" class="headerlink" title="3.2.2 é‡åŒ–æ•ˆæœ"></a>3.2.2 é‡åŒ–æ•ˆæœ</h4><p>å®˜æ–¹åœ¨ NVIDIA GeForce RTX 4090 ä¸Šæµ‹è¯•äº† 4-bit çš„ Llama-2-7B-chat å’Œ Llama-2-13B-chat æ¨¡å‹çš„ token ç”Ÿæˆé€Ÿåº¦ã€‚æµ‹è¯•é…ç½®ä¸º BatchSize = 1ï¼Œprompt_tokens=1ï¼Œcompletion_tokens=512ï¼Œç»“æœå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>model</th>
<th>llm-awq</th>
<th>mlc-llm</th>
<th>turbomind</th>
</tr>
</thead>
<tbody>
<tr>
<td>Llama-2-7B-chat</td>
<td>112.9</td>
<td>159.4</td>
<td>206.4</td>
</tr>
<tr>
<td>Llama-2-13B-chat</td>
<td>N/A</td>
<td>90.7</td>
<td>115.8</td>
</tr>
</tbody>
</table>
</div>
<p>å¯ä»¥çœ‹å‡ºï¼ŒTurboMind ç›¸æ¯”å…¶ä»–æ¡†æ¶é€Ÿåº¦ä¼˜åŠ¿éå¸¸æ˜¾è‘—ï¼Œæ¯” mlc-llm å¿«äº†å°†è¿‘ 30%ã€‚</p>
<p>å¦å¤–ï¼Œä¹Ÿæµ‹è¯•äº† TurboMind åœ¨ä¸åŒç²¾åº¦å’Œä¸Šä¸‹æ–‡é•¿åº¦ä¸‹çš„æ˜¾å­˜å ç”¨æƒ…å†µï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>model(context length)</th>
<th>16bit(2048)</th>
<th>4bit(2048)</th>
<th>16bit(4096)</th>
<th>4bit(4096)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Llama-2-7B-chat</td>
<td>15.1</td>
<td>6.3</td>
<td>16.2</td>
<td>7.5</td>
</tr>
<tr>
<td>Llama-2-13B-chat</td>
<td>OOM</td>
<td>10.3</td>
<td>OOM</td>
<td>12.0</td>
</tr>
</tbody>
</table>
</div>
<p>å¯ä»¥çœ‹å‡ºï¼Œ4bit æ¨¡å‹å¯ä»¥é™ä½ 50-60% çš„æ˜¾å­˜å ç”¨ï¼Œæ•ˆæœéå¸¸æ˜æ˜¾ã€‚</p>
<p>æ€»è€Œè¨€ä¹‹ï¼ŒW4A16 å‚æ•°é‡åŒ–åèƒ½æå¤§åœ°é™ä½æ˜¾å­˜ï¼ŒåŒæ—¶ç›¸æ¯”å…¶ä»–æ¡†æ¶æ¨ç†é€Ÿåº¦å…·æœ‰æ˜æ˜¾ä¼˜åŠ¿ã€‚</p>
<h3 id="3-3-æœ€ä½³å®è·µ"><a href="#3-3-æœ€ä½³å®è·µ" class="headerlink" title="3.3 æœ€ä½³å®è·µ"></a>3.3 æœ€ä½³å®è·µ</h3><p>æœ¬èŠ‚æ˜¯é’ˆå¯¹ã€Šæ¨¡å‹é‡åŒ–ã€‹éƒ¨åˆ†çš„æœ€ä½³å®è·µã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç™½ä¸€ç‚¹ï¼ŒæœåŠ¡éƒ¨ç½²å’Œé‡åŒ–æ˜¯æ²¡æœ‰ç›´æ¥å…³è”çš„ï¼Œé‡åŒ–çš„æœ€ä¸»è¦ç›®çš„æ˜¯é™ä½æ˜¾å­˜å ç”¨ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤æ–¹é¢çš„æ˜¾å­˜ï¼šæ¨¡å‹å‚æ•°å’Œä¸­é—´è¿‡ç¨‹è®¡ç®—ç»“æœã€‚å‰è€…å¯¹åº”ã€Š3.2 W4A16 é‡åŒ–ã€‹ï¼Œåè€…å¯¹åº”ã€Š3.1 KV Cache é‡åŒ–ã€‹ã€‚</p>
<p>é‡åŒ–åœ¨é™ä½æ˜¾å­˜çš„åŒæ—¶ï¼Œä¸€èˆ¬è¿˜èƒ½å¸¦æ¥æ€§èƒ½çš„æå‡ï¼Œå› ä¸ºæ›´å°ç²¾åº¦çš„æµ®ç‚¹æ•°è¦æ¯”é«˜ç²¾åº¦çš„æµ®ç‚¹æ•°è®¡ç®—æ•ˆç‡é«˜ï¼Œè€Œæ•´å‹è¦æ¯”æµ®ç‚¹æ•°é«˜å¾ˆå¤šã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„å»ºè®®æ˜¯ï¼šåœ¨å„ç§é…ç½®ä¸‹å°è¯•ï¼Œçœ‹æ•ˆæœèƒ½å¦æ»¡è¶³éœ€è¦ã€‚è¿™ä¸€èˆ¬éœ€è¦åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè¿›è¡Œæµ‹è¯•ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ã€‚</p>
<ul>
<li>Step1ï¼šä¼˜å…ˆå°è¯•æ­£å¸¸ï¼ˆéé‡åŒ–ï¼‰ç‰ˆæœ¬ï¼Œè¯„ä¼°æ•ˆæœã€‚<ul>
<li>å¦‚æœæ•ˆæœä¸è¡Œï¼Œéœ€è¦å°è¯•æ›´å¤§å‚æ•°æ¨¡å‹æˆ–è€…å¾®è°ƒã€‚</li>
<li>å¦‚æœæ•ˆæœå¯ä»¥ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥ã€‚</li>
</ul>
</li>
<li>Step2ï¼šå°è¯•æ­£å¸¸ç‰ˆæœ¬+KV Cache é‡åŒ–ï¼Œè¯„ä¼°æ•ˆæœã€‚<ul>
<li>å¦‚æœæ•ˆæœä¸è¡Œï¼Œå›åˆ°ä¸Šä¸€æ­¥ã€‚</li>
<li>å¦‚æœæ•ˆæœå¯ä»¥ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥ã€‚</li>
</ul>
</li>
<li>Step3ï¼šå°è¯•é‡åŒ–ç‰ˆæœ¬ï¼Œè¯„ä¼°æ•ˆæœã€‚<ul>
<li>å¦‚æœæ•ˆæœä¸è¡Œï¼Œå›åˆ°ä¸Šä¸€æ­¥ã€‚</li>
<li>å¦‚æœæ•ˆæœå¯ä»¥ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥ã€‚</li>
</ul>
</li>
<li>Step4ï¼šå°è¯•é‡åŒ–ç‰ˆæœ¬+ KV Cache é‡åŒ–ï¼Œè¯„ä¼°æ•ˆæœã€‚<ul>
<li>å¦‚æœæ•ˆæœä¸è¡Œï¼Œå›åˆ°ä¸Šä¸€æ­¥ã€‚</li>
<li>å¦‚æœæ•ˆæœå¯ä»¥ï¼Œä½¿ç”¨æ–¹æ¡ˆã€‚</li>
</ul>
</li>
</ul>
<p>ç®€å•æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img  src="quant.png"  ><span class="image-caption">é‡åŒ–æµç¨‹å›¾</span></p>
<p>å¦å¤–éœ€è¦è¡¥å……è¯´æ˜çš„æ˜¯ï¼Œä½¿ç”¨å“ªç§é‡åŒ–ç‰ˆæœ¬ã€å¼€å¯å“ªäº›åŠŸèƒ½ï¼Œé™¤äº†ä¸Šè¿°æµç¨‹å¤–ï¼Œ<strong>è¿˜éœ€è¦è€ƒè™‘æ¡†æ¶ã€æ˜¾å¡çš„æ”¯æŒæƒ…å†µ</strong>ï¼Œæ¯”å¦‚æœ‰äº›æ¡†æ¶å¯èƒ½ä¸æ”¯æŒ W4A16 çš„æ¨ç†ï¼Œé‚£å³ä¾¿è½¬æ¢å¥½äº†ä¹Ÿç”¨ä¸äº†ã€‚</p>
<p>æ ¹æ®å®è·µç»éªŒï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼š</p>
<ul>
<li>ç²¾åº¦è¶Šé«˜ï¼Œæ˜¾å­˜å ç”¨è¶Šå¤šï¼Œæ¨ç†æ•ˆç‡è¶Šä½ï¼Œä½†ä¸€èˆ¬æ•ˆæœè¾ƒå¥½ã€‚</li>
<li>Server ç«¯æ¨ç†ä¸€èˆ¬ç”¨éé‡åŒ–ç‰ˆæœ¬æˆ–åŠç²¾åº¦ã€BF16ã€Int8 ç­‰ç²¾åº¦çš„é‡åŒ–ç‰ˆæœ¬ï¼Œæ¯”è¾ƒå°‘ä½¿ç”¨æ›´ä½ç²¾åº¦çš„é‡åŒ–ç‰ˆæœ¬ã€‚</li>
<li>ç«¯ä¾§æ¨ç†ä¸€èˆ¬éƒ½ä½¿ç”¨é‡åŒ–ç‰ˆæœ¬ï¼Œä¸”å¤§å¤šæ˜¯ä½ç²¾åº¦çš„é‡åŒ–ç‰ˆæœ¬ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºè®¡ç®—èµ„æºæ‰€é™ã€‚</li>
</ul>
<p>ä»¥ä¸Šæ˜¯é’ˆå¯¹é¡¹ç›®å¼€å‘æƒ…å†µï¼Œå¦‚æœæ˜¯è‡ªå·±å°è¯•ï¼ˆç©å„¿ï¼‰çš„è¯ï¼š</p>
<ul>
<li>å¦‚æœèµ„æºè¶³å¤Ÿï¼ˆæœ‰GPUå¡å¾ˆé‡è¦ï¼‰ï¼Œé‚£å°±ç”¨éé‡åŒ–çš„æ­£å¸¸ç‰ˆæœ¬ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ GPU å¡ï¼Œåªæœ‰ CPUï¼ˆä¸ç®¡ä»€ä¹ˆèŠ¯ç‰‡ï¼‰ï¼Œé‚£è¿˜æ˜¯å°è¯•é‡åŒ–ç‰ˆæœ¬ã€‚</li>
<li>å¦‚æœç”Ÿæˆæ–‡æœ¬é•¿åº¦å¾ˆé•¿ï¼Œæ˜¾å­˜ä¸å¤Ÿï¼Œå°±å¼€å¯ KV Cacheã€‚</li>
</ul>
<p>å»ºè®®å¤§å®¶æ ¹æ®å®é™…æƒ…å†µçµæ´»é€‰æ‹©æ–¹æ¡ˆã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://github.com/InternLM/lmdeploy/">InternLM/lmdeploy: LMDeploy is a toolkit for compressing, deploying, and serving LLMs.</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/665725861">ä»…éœ€ä¸€å— 3090 æ˜¾å¡ï¼Œé«˜æ•ˆéƒ¨ç½² InternLM-20B æ¨¡å‹ - çŸ¥ä¹</a></li>
</ul>
<h2 id="é™„å½•1ï¼šTritonServer-ä½œä¸ºæ¨ç†å¼•æ“"><a href="#é™„å½•1ï¼šTritonServer-ä½œä¸ºæ¨ç†å¼•æ“" class="headerlink" title="é™„å½•1ï¼šTritonServer ä½œä¸ºæ¨ç†å¼•æ“"></a>é™„å½•1ï¼šTritonServer ä½œä¸ºæ¨ç†å¼•æ“</h2><h3 id="TritonServerç¯å¢ƒé…ç½®"><a href="#TritonServerç¯å¢ƒé…ç½®" class="headerlink" title="TritonServerç¯å¢ƒé…ç½®"></a>TritonServerç¯å¢ƒé…ç½®</h3><blockquote>
<p>æ³¨æ„ï¼šæœ¬éƒ¨åˆ†å†…å®¹ä»…æ”¯æŒç‰©ç†æœºä¸Šæ‰§è¡Œï¼Œä¸æ”¯æŒè™šæ‹Ÿä¸»æœºã€‚</p>
</blockquote>
<p>ä½¿ç”¨ Triton Server éœ€è¦å®‰è£…ä¸€ä¸‹ Docker åŠå…¶ä»–ä¾èµ–ã€‚</p>
<p>å…ˆè£…ä¸€äº›åŸºæœ¬çš„ä¾èµ–ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">apt-get update<br>apt-get install cmake sudo -y<br></code></pre></td></tr></table></figure>
<p>ç„¶åæ˜¯ Docker å®‰è£…ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Add Docker&#x27;s official GPG key:</span><br>sudo apt-get install ca-certificates curl gnupg<br>sudo install -m 0755 -d /etc/apt/keyrings<br>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg<br>sudo <span class="hljs-built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg<br><br><span class="hljs-comment"># Add the repository to Apt sources:</span><br><span class="hljs-built_in">echo</span> \<br>  <span class="hljs-string">&quot;deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span><br><span class="hljs-string">  <span class="hljs-subst">$(. /etc/os-release &amp;&amp; echo <span class="hljs-string">&quot;<span class="hljs-variable">$VERSION_CODENAME</span>&quot;</span>)</span> stable&quot;</span> | \<br>  sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null<br>sudo apt-get update<br><br><span class="hljs-comment"># install</span><br>sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin<br></code></pre></td></tr></table></figure>
<p>å®‰è£…åæˆ‘ä»¬è·‘ä¸€ä¸ª HelloWorldã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># helloworld</span><br>sudo docker run hello-world<br></code></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„ç”»é¢ï¼Œè¡¨ç¤ºè¿è¡ŒæˆåŠŸã€‚</p>
<p><img  src="triton-server.png"  ><span class="image-caption">triton server</span></p>
<h3 id="TritonServeræ¨ç†-APIæœåŠ¡"><a href="#TritonServeræ¨ç†-APIæœåŠ¡" class="headerlink" title="TritonServeræ¨ç†+APIæœåŠ¡"></a>TritonServeræ¨ç†+APIæœåŠ¡</h3><blockquote>
<p>æ³¨æ„ï¼šè¿™éƒ¨åˆ†éœ€è¦ Docker æœåŠ¡ã€‚</p>
</blockquote>
<p>è¿™é‡Œæˆ‘ä»¬æŠŠæä¾›æ¨¡å‹æ¨ç†æœåŠ¡çš„å¼•æ“ä» TurboMind æ¢æˆäº† TritonServerï¼Œå¯åŠ¨å‘½ä»¤å°±ä¸€è¡Œã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ApiServer+Triton</span><br>bash workspace/service_docker_up.sh<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šå¯åŠ¨ä¸€ä¸ª TritonServer çš„å®¹å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="triton-server-run.png" alt=""></p>
<p>å¯ä»¥å†å¼€ä¸€ä¸ªçª—å£æ‰§è¡Œ Client å‘½ä»¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ChatTritonClient + TritonServerï¼ˆæ³¨æ„æ˜¯gRPCåè®®ï¼Œä¸è¦ç”¨httpï¼‰</span><br>lmdeploy serve triton_client  localhost:33337<br></code></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="triton-client.png" alt=""></p>
<h3 id="TritonServer-æœåŠ¡ä½œä¸ºåç«¯"><a href="#TritonServer-æœåŠ¡ä½œä¸ºåç«¯" class="headerlink" title="TritonServer æœåŠ¡ä½œä¸ºåç«¯"></a>TritonServer æœåŠ¡ä½œä¸ºåç«¯</h3><p>ä½¿ç”¨è¿‡ç¨‹åŒ 2.4.1 å°èŠ‚ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Gradio+TritonServerï¼ˆæ³¨æ„æ˜¯gRPCåè®®ï¼Œä¸è¦ç”¨httpï¼‰</span><br>lmdeploy serve gradio localhost:33337 \<br>	--server_name 0.0.0.0 \<br>	--server_port 6006<br></code></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="triton-client-web.png" alt=""></p>
<h2 id="ä½œä¸š"><a href="#ä½œä¸š" class="headerlink" title="ä½œä¸š"></a>ä½œä¸š</h2><h3 id="TurboMindæ¨ç†-APIæœåŠ¡"><a href="#TurboMindæ¨ç†-APIæœåŠ¡" class="headerlink" title="TurboMindæ¨ç†+APIæœåŠ¡"></a>TurboMindæ¨ç†+APIæœåŠ¡</h3><p><img  src="story.png"  ><span class="image-caption">éƒ¨ç½²å¹¶ä½¿ç”¨ api ç”Ÿæˆ 300 å­—å°æ•…äº‹</span></p>
<h3 id="TurboMind-æ¨ç†-å‘½ä»¤è¡Œæœ¬åœ°å¯¹è¯"><a href="#TurboMind-æ¨ç†-å‘½ä»¤è¡Œæœ¬åœ°å¯¹è¯" class="headerlink" title="TurboMind æ¨ç†+å‘½ä»¤è¡Œæœ¬åœ°å¯¹è¯"></a>TurboMind æ¨ç†+å‘½ä»¤è¡Œæœ¬åœ°å¯¹è¯</h3><p><img  src="chat.png"  ><span class="image-caption">ä¸æœ¬åœ°éƒ¨ç½²çš„æ¨¡å‹è¿›è¡Œå¯¹è¯</span></p>
<h3 id="TurboMind-æ¨ç†-gradio"><a href="#TurboMind-æ¨ç†-gradio" class="headerlink" title="TurboMind æ¨ç†+gradio"></a>TurboMind æ¨ç†+gradio</h3><p><img  src="gradio.png"  ><span class="image-caption">Gradio éƒ¨ç½²</span></p>
<h3 id="KV-Cache-é‡åŒ–éƒ¨ç½²"><a href="#KV-Cache-é‡åŒ–éƒ¨ç½²" class="headerlink" title="KV Cache é‡åŒ–éƒ¨ç½²"></a>KV Cache é‡åŒ–éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è®¡ç®— minmax</span><br>lmdeploy lite calibrate \<br>  --model  /root/share/temp/model_repos/internlm-chat-7b/ \<br>  --calib_dataset <span class="hljs-string">&quot;c4&quot;</span> \<br>  --calib_samples 128 \<br>  --calib_seqlen 2048 \<br>  --work_dir ./quant_output<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œåœ¨è®¡ç®—çš„æ—¶å€™éœ€è¦ä¸‹è½½ calibrate æ•°æ®é›† c4ï¼Œå›½å†…ç»å¸¸ä¸æˆåŠŸã€‚æ‰€ä»¥éœ€è¦æ‰‹åŠ¨ä¸‹è½½åå¯¹è¯»å–æ•°æ®é›†çš„ä»£ç æ–‡ä»¶åšä¸€ä¸‹æ›¿æ¢ã€‚å…±åŒ…æ‹¬ä¸¤æ­¥ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼šå¤åˆ¶ <code>calib_dataloader.py</code> åˆ°å®‰è£…ç›®å½•æ›¿æ¢è¯¥æ–‡ä»¶ï¼š<code>cp /root/share/temp/datasets/c4/calib_dataloader.py  /root/.conda/envs/lmdeploy/lib/python3.10/site-packages/lmdeploy/lite/utils/</code></li>
<li>ç¬¬äºŒæ­¥ï¼šå°†ç”¨åˆ°çš„æ•°æ®é›†ï¼ˆc4ï¼‰å¤åˆ¶åˆ°ä¸‹é¢çš„ç›®å½•ï¼š<code>cp -r /root/share/temp/datasets/c4/ /root/.cache/huggingface/datasets/</code></li>
</ul>
<p><img  src="max.png"  ><span class="image-caption">è®¡ç®—æ¯ä¸€å±‚çš„æœ€å¤§ GPU å ç”¨</span></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é€šè¿‡ minmax è·å–é‡åŒ–å‚æ•°</span><br>lmdeploy lite kv_qparams \<br>  --work_dir ./quant_output  \<br>  --turbomind_dir workspace/triton_models/weights/ \<br>  --kv_sym False \<br>  --num_tp 1<br></code></pre></td></tr></table></figure>
<p><img  src="qparam.png"  ><span class="image-caption">è·å–é‡åŒ–å‚æ•°</span></p>
<p>ä¹‹åä¿®æ”¹ <code>weights/config.ini</code> æ–‡ä»¶ <code>quant_policy=4</code> è¡¨ç¤ºå¼€å¯ KV Cache é‡åŒ–ã€‚</p>
<p>éƒ¨ç½²è¿è¡Œå†…å­˜å ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">watch vgpu-smi<br></code></pre></td></tr></table></figure>
<p><img  src="kv-cache-memory.png"  ><span class="image-caption">KV Cache å†…å­˜å ç”¨</span></p>
<h3 id="W4A16-é‡åŒ–"><a href="#W4A16-é‡åŒ–" class="headerlink" title="W4A16 é‡åŒ–"></a>W4A16 é‡åŒ–</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è®¡ç®— minmax</span><br>lmdeploy lite calibrate \<br>  --model  /root/share/temp/model_repos/internlm-chat-7b/ \<br>  --calib_dataset <span class="hljs-string">&quot;c4&quot;</span> \<br>  --calib_samples 128 \<br>  --calib_seqlen 2048 \<br>  --work_dir ./quant_output_awq<br></code></pre></td></tr></table></figure>
<p>ä¹‹åé‡åŒ–æƒé‡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é‡åŒ–æƒé‡æ¨¡å‹</span><br>lmdeploy lite auto_awq \<br>  --model  /root/share/temp/model_repos/internlm-chat-7b/ \<br>  --w_bits 4 \<br>  --w_group_size 128 \<br>  --work_dir ./quant_output_awq<br></code></pre></td></tr></table></figure>
<p>å‘½ä»¤ä¸­ <code>w_bits</code> è¡¨ç¤ºé‡åŒ–çš„ä½æ•°ï¼Œ<code>w_group_size</code> è¡¨ç¤ºé‡åŒ–åˆ†ç»„ç»Ÿè®¡çš„å°ºå¯¸ï¼Œ<code>work_dir</code> æ˜¯é‡åŒ–åæ¨¡å‹è¾“å‡ºçš„ä½ç½®ã€‚è¿™é‡Œéœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œå› ä¸ºæ²¡æœ‰ <code>torch.int4</code>ï¼Œæ‰€ä»¥å®é™…å­˜å‚¨æ—¶ï¼Œ8ä¸ª 4bit æƒé‡ä¼šè¢«æ‰“åŒ…åˆ°ä¸€ä¸ª int32 å€¼ä¸­ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æŠŠè¿™éƒ¨åˆ†é‡åŒ–åçš„å‚æ•°åŠ è½½è¿›æ¥å°±ä¼šå‘ç°å®ƒä»¬æ˜¯ int32 ç±»å‹çš„ã€‚</p>
<p><img  src="awq.png"  ><span class="image-caption">AWQ é‡åŒ–</span></p>
<p>æœ€åä¸€æ­¥ï¼šè½¬æ¢æˆ TurboMind æ ¼å¼ã€‚</p>
<p>è¿™ä¸ª <code>group-size</code> å°±æ˜¯ä¸Šä¸€æ­¥çš„é‚£ä¸ª <code>w_group_size</code>ã€‚å¦‚æœä¸æƒ³å’Œä¹‹å‰çš„ <code>workspace</code> é‡å¤ï¼Œå¯ä»¥æŒ‡å®šè¾“å‡ºç›®å½•ï¼š<code>--dst_path</code>ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lmdeploy convert  internlm-chat-7b ./quant_output_awq \<br>    --model-format awq \<br>    --group-size 128 \<br>    --dst_path ./workspace_quant_awq4<br></code></pre></td></tr></table></figure>
<p><img  src="convert-awq.png"  ><span class="image-caption">è½¬æ¢ä¸º TurboMind æ ¼å¼</span></p>
<p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img  src="tree-awq.png"  ><span class="image-caption">è½¬æ¢ä¸º TurboMind æ ¼å¼çš„ AWQ æ¨¡å‹ç»“æ„</span></p>
<p>éƒ¨ç½²ä½¿ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">lmdeploy chat turbomind ./workspace_quant_awq4<br></code></pre></td></tr></table></figure>
<p>å†…å­˜å ç”¨</p>
<p><img  src="awq-memory.png"  ><span class="image-caption">AWQ é‡åŒ–å†…å­˜å ç”¨</span></p>
<p>å¯è§å†…å­˜å ç”¨åªæœ‰ 6Gã€‚</p>
]]></content>
      <categories>
        <category>internlm</category>
      </categories>
  </entry>
</search>
